<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submissions Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            background-color: #f0f6ff;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            min-width: 250px;
            max-width: 250px;
            width: 250px;
            background-color: #d6e8ff;
            padding: 20px;
            border-right: 1px solid #b3d4ff;
            flex-shrink: 0;
        }

        .sidebar h2 {
            color: #2c5aa0;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar > ul > li {
            margin-bottom: 10px;
        }

        .sidebar a {
            display: block;
            padding: 10px 15px;
            color: #2c5aa0;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background-color: #b3d4ff;
        }

        .archive-section {
            margin-top: 20px;
        }

        .archive-heading {
            display: block;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 10px;
            padding: 10px 15px;
            background-color: #c7deff;
            border-radius: 5px;
        }

        .archive-submenu {
            margin-left: 15px;
        }

        .archive-submenu li {
            margin-bottom: 5px;
        }

        .archive-submenu a {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        header h1 {
            color: #2c5aa0;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .submissions-grid {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(44, 90, 160, 0.1);
            border: 1px solid #e0f0ff;
            padding: 20px;
            overflow-x: auto;
        }

        .grid-header {
            display: grid;
            grid-template-columns: 80px 80px 70px 120px 100px 90px 100px 90px 60px 90px 90px 120px 80px;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #d6e8ff;
            border-radius: 5px;
            font-weight: bold;
            color: #2c5aa0;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 80px 80px 70px 120px 100px 90px 100px 90px 60px 90px 90px 120px 80px;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
            min-height: 50px;
            align-items: center;
        }

        .grid-cell {
            padding: 4px;
            font-size: 11px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.2;
        }

        .grid-cell input,
        .grid-cell select,
        .grid-cell textarea {
            width: 100%;
            padding: 4px;
            border: 1px solid #b3d4ff;
            border-radius: 4px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 11px;
        }

        .grid-cell textarea {
            resize: vertical;
            min-height: 30px;
        }

        .grid-cell select[multiple] {
            height: 40px;
        }

        .add-row-btn {
            background-color: #2c5aa0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-top: 15px;
        }

        .add-row-btn:hover {
            background-color: #1e3f7a;
        }

        .add-item-btn {
            background-color: #2c5aa0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .add-item-btn:hover {
            background-color: #1e3f7a;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            color: #2c5aa0;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #2c5aa0;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #b3d4ff;
            border-radius: 4px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group select[multiple] {
            height: 100px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .form-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .btn-add {
            background-color: #2c5aa0;
            color: white;
        }

        .btn-submit-spads {
            background-color: #28a745;
            color: white;
        }

        .btn-submit-lc {
            background-color: #17a2b8;
            color: white;
        }

        .btn-submit-archive {
            background-color: #6c757d;
            color: white;
        }

        .btn-cancel {
            background-color: #dc3545;
            color: white;
        }

        .form-btn:hover {
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 9px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            white-space: nowrap;
        }

        .edit-btn {
            background-color: #28a745;
            color: white;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .user-prompt {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(44, 90, 160, 0.1);
            border: 1px solid #e0f0ff;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .user-prompt h2 {
            color: #2c5aa0;
            margin-bottom: 20px;
        }

        .user-prompt select {
            width: 100%;
            padding: 10px;
            border: 1px solid #b3d4ff;
            border-radius: 4px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .user-prompt button {
            background-color: #2c5aa0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-right: 10px;
        }

        .user-prompt button:hover {
            background-color: #1e3f7a;
        }

        .user-prompt button.secondary {
            background-color: #6c757d;
        }

        .user-prompt button.secondary:hover {
            background-color: #5a6268;
        }

        .user-info {
            background-color: #e3f2fd;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .user-info span {
            color: #2c5aa0;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .spad-comment-btn {
            background-color: #17a2b8;
            color: white;
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 9px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            white-space: nowrap;
        }

        .spad-comment-btn:hover {
            opacity: 0.8;
        }

        .spad-comment-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .spad-comment-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border: none;
            border-radius: 8px;
            width: 60%;
            max-width: 600px;
        }

        .spad-comment-form-group {
            margin-bottom: 20px;
        }

        .spad-comment-form-group label {
            display: block;
            color: #2c5aa0;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .spad-comment-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #b3d4ff;
            border-radius: 4px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }

        .spad-comment-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .spad-comment-btn-submit {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .spad-comment-btn-cancel {
            background-color: #dc3545;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .spad-comment-btn-submit:hover,
        .spad-comment-btn-cancel:hover {
            opacity: 0.9;
        }

        .url-cell {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 10px;
            color: #0066cc;
            text-decoration: none;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .url-cell:hover {
            color: #004499;
            text-decoration: underline;
        }

        .url-display {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 10px;
            color: #0066cc;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            header h1 {
                font-size: 2em;
            }

            .grid-header,
            .grid-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }

        /* Additional CSS for invite grid rows */
        #inviteGridRows .grid-row {
            display: grid;
            grid-template-columns: 190px 120px 110px 90px 90px 180px 180px 180px 110px;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
        }
        /* Add this for archive invite grid rows */
        #inviteArchiveGridRows .grid-row {
            display: grid;
            grid-template-columns: 190px 120px 110px 90px 90px 180px 180px 180px 110px;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
        }

        /* Briefings grid rows: match column widths to header */
        #briefingGridRows .grid-row {
            display: grid;
            grid-template-columns: 120px 120px 110px 90px 160px 110px 160px 140px 140px 100px;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
        }
        
        #briefingsArchiveGridRows .grid-row {
            display: grid;
            grid-template-columns: 120px 120px 110px 90px 160px 110px 160px 140px 140px 100px;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
        }

        /* Daybook grid rows: match column widths to header (no action column) */
        #daybookGridRows .grid-row {
            display: grid;
            grid-template-columns: 120px 120px 90px 160px 110px 160px 140px 140px;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
        }

        /* Commission grid rows: match column widths to header */
        .commission-header,
        #commissionGridRows .grid-row {
            display: grid;
            grid-template-columns: 300px 120px 140px 120px 100px;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
        }

        .commission-header {
            background-color: #d6e8ff;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 15px;
        }
        
        .commission-archive-header,
        #commissionArchiveGridRows .grid-row {
            display: grid;
            grid-template-columns: 300px 120px 140px 120px 120px;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
        }

        .commission-archive-header {
            background-color: #d6e8ff;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 15px;
        }

        /* Team Management Styles */
        .team-management {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .add-member-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-member-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .team-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .team-member {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .team-member:hover {
            background-color: #f0f0f0;
        }

        .team-member-name {
            font-weight: 500;
            color: #333;
        }

        .remove-member-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-member-btn:hover {
            background-color: #c82333;
        }

        .default-member {
            opacity: 0.6;
        }

        .default-member .remove-member-btn {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .default-member .remove-member-btn:hover {
            background-color: #6c757d;
        }

        /* Highlight rows that have been with SpAds for more than 5 working days */
        .overdue-spad-row {
            background-color: #ffe6e6 !important;
            border-color: #ffb3b3 !important;
        }

        .overdue-spad-row .grid-cell {
            background-color: transparent;
        }

        /* Styling for urgency reasons in comments */
        .grid-cell:has-text("[URGENT:") {
            font-weight: bold;
        }
        
        /* Alternative approach for urgency highlighting */
        .urgent-item {
            border-left: 4px solid #dc3545;
        }
        
        .urgent-item .grid-cell:first-child {
            border-left: none;
        }

        /* Search field styling */
        .search-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: white;
            border: 2px solid #2c5aa0;
            border-radius: 25px;
            padding: 10px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 250px;
        }

        .search-input {
            border: none;
            outline: none;
            flex: 1;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
            background: transparent;
        }

        .search-input::placeholder {
            color: #666;
        }

        .search-icon {
            color: #2c5aa0;
            font-size: 16px;
        }

        .search-clear {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: none;
        }

        .search-clear:hover {
            color: #666;
        }

        .search-clear.visible {
            display: block;
        }

        /* Hide/show search based on page */
        .search-container.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <h2>Navigation</h2>
            <ul>
                <li class="archive-section">
                    <span class="archive-heading">Box process</span>
                    <ul class="archive-submenu">
                        <li><a href="#" class="active" onclick="showMainDashboard()">Box work dashboard</a></li>
                        <li><a href="#" onclick="showSpAdBox()">SpAd review</a></li>
                        <li><a href="#" onclick="showLCBox()">Items ready for LC</a></li>
                        <li><a href="#" onclick="showPersonalDashboard()">Personal dashboard</a></li>
                    </ul>
                </li>
                <li class="archive-section">
                    <span class="archive-heading">Other</span>
                    <ul class="archive-submenu">
                        <li><a href="#" onclick="showBriefings()">Briefings</a></li>
                        <li><a href="#" onclick="showCommissions()">Commissions</a></li>
                        <li><a href="#" onclick="showInvites()">Invites</a></li>
                        <li><a href="#" onclick="showDaybook()">Daybook</a></li>
                    </ul>
                </li>
                <li class="archive-section">
                    <span class="archive-heading">Archives</span>
                    <ul class="archive-submenu">
                        <li><a href="#" onclick="showArchiveBox()">Archive box</a></li>
                        <li><a href="#" onclick="showInviteArchive()">Archive invites</a></li>
                        <li><a href="#" onclick="showBriefingsArchive()">Archive briefings</a></li>
                        <li><a href="#" onclick="showCommissionArchive()">Archive commissions</a></li>
                    </ul>
                </li>
                <li><a href="#" onclick="showEditTeam()">Edit team</a></li>
            </ul>
        </nav>
        
        <main class="main-content">
            <div id="mainDashboard">
                <header>
                    <h1>Box work dashboard</h1>
                </header>
                
                <button class="add-item-btn" onclick="openModal()">Add item to grid</button>
                
                <div class="submissions-grid">
                    <div class="grid-header">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Urgency</div>
                        <div>Title</div>
                        <div>SharePoint Link</div>
                        <div>Date Received</div>
                        <div>Status</div>
                        <div>Date Submitted to SpAds</div>
                        <div>Working Days with SpAds</div>
                        <div>Date of SpAd Comment</div>
                        <div>Date Boxed for LC</div>
                        <div>Comments</div>
                        <div>Actions</div>
                    </div>
                    <!-- Sample rows for demonstration -->
                    <div class="grid-row">
                        <div class="grid-cell">Ben</div>
                        <div class="grid-cell">Sophie</div>
                        <div class="grid-cell">Routine</div>
                        <div class="grid-cell">Budget Approval</div>
                        <div class="grid-cell">https://sharepoint.com/budget</div>
                        <div class="grid-cell">Saturday 1 June</div>
                        <div class="grid-cell">With SpAds</div>
                        <div class="grid-cell">Sunday 2 June</div>
                        <div class="grid-cell">2</div>
                        <div class="grid-cell">Tuesday 4 June</div>
                        <div class="grid-cell">Wednesday 5 June</div>
                        <div class="grid-cell">Reviewed by SpAd</div>
                        <div class="grid-cell">
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="alert('Edit not implemented in sample row')">Edit</button>
                                <button class="action-btn delete-btn" onclick="this.closest('.grid-row').remove()">Delete</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid-row">
                        <div class="grid-cell">Charlotte</div>
                        <div class="grid-cell">Tash</div>
                        <div class="grid-cell">Urgent</div>
                        <div class="grid-cell">Policy Review</div>
                        <div class="grid-cell">https://sharepoint.com/policy</div>
                        <div class="grid-cell">Monday 3 June</div>
                        <div class="grid-cell">Ready for the box</div>
                        <div class="grid-cell">Monday 3 June</div>
                        <div class="grid-cell">1</div>
                        <div class="grid-cell">Tuesday 4 June</div>
                        <div class="grid-cell">Wednesday 5 June</div>
                        <div class="grid-cell">Requires urgent attention</div>
                        <div class="grid-cell">
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="alert('Edit not implemented in sample row')">Edit</button>
                                <button class="action-btn delete-btn" onclick="this.closest('.grid-row').remove()">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="personalDashboard" class="hidden">
                <div id="userPrompt" class="user-prompt">
                    <h2>Enter Your Name</h2>
                    <p style="margin-bottom: 30px;">Please select your name to view your personal dashboard:</p>
                    <select id="userSelect">
                        <option value="">Select your name...</option>
                        <optgroup label="Private Secretaries">
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </optgroup>
                        <optgroup label="SpAds">
                            <option value="Sophie">Sophie</option>
                            <option value="Tash">Tash</option>
                            <option value="Poppy">Poppy</option>
                            <option value="Josh">Josh</option>
                        </optgroup>
                    </select>
                    <button onclick="loadPersonalDashboard()">View Dashboard</button>
                    <button class="secondary" onclick="showMainDashboard()">Back to Main</button>
                </div>

                <div id="personalDashboardContent" class="hidden">
                    <header>
                        <h1>Personal dashboard</h1>
                        <div class="user-info">
                            Viewing submissions for: <span id="currentUser"></span>
                            <button onclick="showUserPrompt()" style="margin-left: 15px; padding: 5px 10px; font-size: 12px;">Change User</button>
                        </div>
                    </header>
                    
                    <button class="add-item-btn" onclick="openModal()">Add item to grid</button>
                    
                    <div class="submissions-grid">
                        <div class="grid-header">
                            <div>Lead Private Secretary</div>
                            <div>Lead SpAd</div>
                            <div>Urgency</div>
                            <div>Title</div>
                            <div>SharePoint Link</div>
                            <div>Date Received</div>
                            <div>Status</div>
                            <div>Date Submitted to SpAds</div>
                            <div>Working Days with SpAds</div>
                            <div>Date of SpAd Comment</div>
                            <div>Date Boxed for LC</div>
                            <div>Comments</div>
                            <div>Actions</div>
                        </div>
                        
                        <div id="personalGridRows">
                            <!-- Filtered rows will be populated here -->
                        </div>
                    </div>
                </div>
            </div>                <div id="spadBox" class="hidden">
                <header>
                    <h1>SpAd review</h1>
                    <p style="color: #666; margin-bottom: 30px;">Items submitted to SpAds for review</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Urgency</div>
                        <div>Title</div>
                        <div>SharePoint Link</div>
                        <div>Date Received</div>
                        <div>Status</div>
                        <div>Date Submitted to SpAds</div>
                        <div>Working Days with SpAds</div>
                        <div>Date of SpAd Comment</div>
                        <div>Date Boxed for LC</div>
                        <div>Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="spadGridRows">
                        <!-- SpAd submissions will be populated here -->
                    </div>
                </div>
            </div>                <div id="lcBox" class="hidden">
                <header>
                    <h1>Items ready for LC</h1>
                    <p style="color: #666; margin-bottom: 30px;">Items ready for the LC's box</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Urgency</div>
                        <div>Title</div>
                        <div>SharePoint Link</div>
                        <div>Date Received</div>
                        <div>Status</div>
                        <div>Date Submitted to SpAds</div>
                        <div>Working Days with SpAds</div>
                        <div>Date of SpAd Comment</div>
                        <div>Date Boxed for LC</div>
                        <div>Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="lcGridRows">
                        <!-- LC submissions will be populated here -->
                    </div>
                </div>
            </div>                <div id="archiveBox" class="hidden">
                <header>
                    <h1>Archive box</h1>
                    <p style="color: #666; margin-bottom: 30px;">Completed submissions</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Urgency</div>
                        <div>Title</div>
                        <div>SharePoint Link</div>
                        <div>Date Received</div>
                        <div>Status</div>
                        <div>Date Submitted to SpAds</div>
                        <div>Working Days with SpAds</div>
                        <div>Date of SpAd Comment</div>
                        <div>Date Boxed for LC</div>
                        <div>Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="archiveGridRows">
                        <!-- Archived submissions will be populated here -->
                    </div>
                </div>
            </div>

            <div id="invites" class="hidden">
                <header>
                    <h1>Invites</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage invitations and events</p>
                </header>
                
                <button class="add-item-btn" onclick="openInviteModal()">Add invite</button>
                
                <div class="submissions-grid">
                    <div class="grid-header" style="display: grid; grid-template-columns: 190px 120px 110px 90px 90px 180px 180px 180px 110px;">
                        <div>Invite</div>
                        <div>Lead PS</div>
                        <div>Date</div>
                        <div>Start Time</div>
                        <div>End Time</div>
                        <div>Diary Manager Comments</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="inviteGridRows">
                        <!-- Invite rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="inviteArchive" class="hidden">
                <header>
                    <h1>Archive invites</h1>
                    <p style="color: #666; margin-bottom: 30px;">Archived invitations and events</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header" style="grid-template-columns: 190px 120px 110px 90px 90px 180px 180px 180px 110px;">
                        <div>Invite</div>
                        <div>Lead PS</div>
                        <div>Date</div>
                        <div>Start Time</div>
                        <div>End Time</div>
                        <div>Diary Manager Comments</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="inviteArchiveGridRows">
                        <!-- Archived invite rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="briefings" class="hidden">
                <header>
                    <h1>Briefings</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage briefings and meetings</p>
                </header>
                <button class="add-item-btn" onclick="openBriefingModal()">Add briefing</button>
                <div class="submissions-grid">
                    <div class="grid-header" style="grid-template-columns: 120px 120px 110px 90px 160px 110px 160px 140px 140px 100px;">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Date of Meeting</div>
                        <div>Time of Meeting</div>
                        <div>Title of Meeting</div>
                        <div>Commission Deadline</div>
                        <div>SharePoint Link</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    <div id="briefingGridRows">
                        <!-- Briefing rows will be populated here -->
                    </div>
                </div>
            </div>
            <div id="briefingsArchive" class="hidden">
                <header>
                    <h1>Archive briefings</h1>
                    <p style="color: #666; margin-bottom: 30px;">Archived briefings</p>
                </header>
                <div class="submissions-grid">
                    <div class="grid-header" style="grid-template-columns: 120px 120px 110px 90px 160px 110px 160px 140px 140px 100px;">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Date of Meeting</div>
                        <div>Time of Meeting</div>
                        <div>Title of Meeting</div>
                        <div>Commission Deadline</div>
                        <div>SharePoint Link</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    <div id="briefingsArchiveGridRows">
                        <!-- Archived briefing rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="commissions" class="hidden">
                <header>
                    <h1>Commissions</h1>
                    <p style="color: #666; margin-bottom: 30px;">Please use this tracker for keeping a record of all commissions from the Lord Chancellor and the SpAds (except briefing papers for meetings). For briefing commissions, please use the 'Briefings' page.</p>
                </header>
                
                <button class="add-item-btn" onclick="openCommissionModal()">Add commission</button>
                
                <div class="submissions-grid">
                    <div class="grid-header commission-header">
                        <div>Action</div>
                        <div>Lead PS</div>
                        <div>Deadline for commission</div>
                        <div>Status</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="commissionGridRows">
                        <!-- Commission rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="commissionArchive" class="hidden">
                <header>
                    <h1>Archive commissions</h1>
                    <p style="color: #666; margin-bottom: 30px;">Completed commissions</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header commission-archive-header">
                        <div>Action</div>
                        <div>Lead PS</div>
                        <div>Deadline for commission</div>
                        <div>Status</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="commissionArchiveGridRows">
                        <!-- Archived commission rows will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Daybook Section -->
            <div id="daybook" class="hidden">
                <header>
                    <h1>Daybook</h1>
                    <p style="color: #666; margin-bottom: 30px;">View briefings by date</p>
                </header>
                
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <label for="daybookDatePicker" style="font-weight: 500; min-width: 120px;">Select Date:</label>
                        <input type="date" id="daybookDatePicker" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <button onclick="filterBriefingsByDate()" style="padding: 8px 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">View Briefings</button>
                        <button onclick="clearDaybookFilter()" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Clear</button>
                    </div>
                </div>
                
                <div id="daybookResults" style="display: none;">
                    <h3 id="daybookDateHeader" style="margin-bottom: 20px; color: #333;"></h3>
                    <div class="submissions-grid">
                        <div class="grid-header" id="daybookGridHeader" style="grid-template-columns: 120px 120px 90px 160px 110px 160px 140px 140px;">
                            <div>Lead PS</div>
                            <div>Lead SpAd</div>
                            <div>Time</div>
                            <div>Title</div>
                            <div>Commission Deadline</div>
                            <div>SharePoint</div>
                            <div>PS Comments</div>
                            <div>SpAd Comments</div>
                        </div>
                        
                        <div id="daybookGridRows">
                            <!-- Filtered briefing rows will be populated here -->
                        </div>
                    </div>
                    
                    <div id="daybookNoResults" style="display: none; text-align: center; padding: 40px; color: #666; font-style: italic;">
                        No briefings found for the selected date.
                    </div>
                </div>
            </div>

            <div id="editTeam" class="hidden">
                <header>
                    <h1 style="font-weight: bold;">Edit team</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage Private Secretaries and SpAds</p>
                </header>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                    <!-- Private Secretaries Section -->
                    <div>
                        <h3>Private Secretaries</h3>
                        <div class="team-management">
                            <div class="add-member-form">
                                <input type="text" id="newPSName" placeholder="Enter new Private Secretary name" onkeypress="if(event.key==='Enter') addPrivateSecretary()">
                                <button onclick="addPrivateSecretary()" class="form-btn btn-add">Add PS</button>
                            </div>
                            <div id="privateSecretariesList" class="team-list">
                                <!-- Private Secretaries will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- SpAds Section -->
                    <div>
                        <h3>SpAds</h3>
                        <div class="team-management">
                            <div class="add-member-form">
                                <input type="text" id="newSpAdName" placeholder="Enter new SpAd name" onkeypress="if(event.key==='Enter') addSpAd()">
                                <button onclick="addSpAd()" class="form-btn btn-add">Add SpAd</button>
                            </div>
                            <div id="spAdsList" class="team-list">
                                <!-- SpAds will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="saveTeamChanges()" class="form-btn btn-add">Save Changes</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Search Field -->
    <div id="searchContainer" class="search-container">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" class="search-input" placeholder="Search items...">
        <button id="searchClear" class="search-clear" onclick="clearSearch()">√ó</button>
    </div>

    <!-- Modal Form -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Advice/briefing</h2>
            </div>
            <form id="submissionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="leadPS">Lead Private Secretary</label>
                        <select id="leadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadSpAd">Lead SpAd</label>
                        <select id="leadSpAd">
                            <option value="">Select...</option>
                            <option value="Sophie">Sophie</option>
                            <option value="Tash">Tash</option>
                            <option value="Poppy">Poppy</option>
                            <option value="Josh">Josh</option>
                            <option value="No SpAd review">No SpAd review</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="urgency">Urgency</label>
                        <select id="urgency">
                            <option value="Routine">Routine</option>
                            <option value="Priority">Priority</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="submissionType">Advice/briefing</label>
                        <select id="submissionType">
                            <option value="advice">Advice</option>
                            <option value="briefing">Briefing for meeting</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="submissionTitle">Title</label>
                        <input type="text" id="submissionTitle" placeholder="Enter submission title">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="sharepointLink">SharePoint Link</label>
                        <input type="url" id="sharepointLink" placeholder="https://sharepoint.com/..." style="font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px; color: #0066cc;">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateReceived">Date Received</label>
                        <input type="date" id="dateReceived">
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="">Select status...</option>
                            <option value="With Perm Sec/DGs">With Perm Sec/DGs</option>
                            <option value="With junior minister(s)">With junior minister(s)</option>
                            <option value="With SpAds">With SpAds</option>
                            <option value="With officials">With officials</option>
                            <option value="With PS">With PS</option>
                            <option value="Ready for the box">Ready for the box</option>
                            <option value="Readout/complete">Readout/complete</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="dateSubmittedSpads">Date Submitted to SpAds</label>
                        <input type="date" id="dateSubmittedSpads">
                    </div>
                    
                    <div class="form-group">
                        <label for="workingDays">Working Days with SpAds</label>
                        <input type="number" id="workingDays" placeholder="Auto-calculated" readonly style="background-color: #f5f5f5;">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateSpAdComment">Date of SpAd Comment</label>
                        <input type="date" id="dateSpAdComment">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateBoxed">Date Boxed for LC</label>
                        <input type="date" id="dateBoxed">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="comments">Comments</label>
                        <textarea id="comments" placeholder="Enter comments..."></textarea>
                    </div>
                </div>
                
                <div id="firstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons" id="submissionFormButtons">
                    <button type="button" class="form-btn btn-add" onclick="addSubmissionFromModal()">Add</button>
                    <button type="button" class="form-btn btn-submit-spads" onclick="submitToSpAdsFromModal()">Submit to SpAds</button>
                    <button type="button" class="form-btn btn-submit-lc" onclick="submitToLCBoxFromModal()">Submit to LC box</button>
                    <button type="button" class="form-btn btn-submit-archive" onclick="submitToArchiveFromModal()">Submit to archive</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SpAd Comment Modal -->
    <div id="spadCommentModal" class="spad-comment-modal">
        <div class="spad-comment-modal-content">
            <div class="modal-header">
                <h2>Add SpAd Comment</h2>
            </div>
            <form id="spadCommentForm">
                <div class="spad-comment-form-group">
                    <label for="psComments">Do you have any comments/queries for the Private Secretary?</label>
                    <textarea id="psComments" placeholder="Enter your comments or queries..."></textarea>
                </div>
                
                <div class="spad-comment-form-group">
                    <label for="boxNote">Have you added your comment to the box note?</label>
                    <select id="boxNote">
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                
                <div class="spad-comment-buttons">
                    <button type="button" class="spad-comment-btn-submit" onclick="submitSpAdComment()">Submit to Private Secretary</button>
                    <button type="button" class="spad-comment-btn-submit" onclick="saveSpAdDraft()" style="background-color: #6c757d;">Save and go back</button>
                    <button type="button" class="spad-comment-btn-cancel" onclick="closeSpAdCommentModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invite Modal Form -->
    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Invite</h2>
            </div>
            <form id="inviteForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="inviteTitle">Invite</label>
                        <input type="text" id="inviteTitle" placeholder="Enter invite description">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteLeadPS">Lead PS</label>
                        <select id="inviteLeadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteDate">Date (Optional)</label>
                        <input type="date" id="inviteDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteStartTime">Start Time (Optional)</label>
                        <input type="time" id="inviteStartTime">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteEndTime">End Time (Optional)</label>
                        <input type="time" id="inviteEndTime">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="diaryManagerComments">Diary Manager Comments</label>
                        <textarea id="diaryManagerComments" placeholder="Enter diary manager comments..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="psCommentsInvite">PS Comments</label>
                        <textarea id="psCommentsInvite" placeholder="Enter PS comments..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="spadCommentsInvite">SpAd Comments</label>
                        <textarea id="spadCommentsInvite" placeholder="Enter SpAd comments..."></textarea>
                    </div>
                </div>
                
                <div id="inviteFirstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="form-btn btn-add" onclick="addInvite()">Add Invite</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Briefing Modal Form -->
    <div id="briefingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="briefingModalTitle">Add New Briefing</h2>
            </div>
            <form id="briefingForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="briefingLeadPS">Lead Private Secretary</label>
                        <select id="briefingLeadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="briefingLeadSpAd">Lead SpAd</label>
                        <select id="briefingLeadSpAd">
                            <option value="">Select...</option>
                            <option value="Sophie">Sophie</option>
                            <option value="Tash">Tash</option>
                            <option value="Poppy">Poppy</option>
                            <option value="Josh">Josh</option>
                            <option value="No SpAd review">No SpAd review</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="briefingDate">Date of Meeting</label>
                        <input type="date" id="briefingDate">
                    </div>
                    <div class="form-group">
                        <label for="briefingTime">Time of Meeting</label>
                        <input type="time" id="briefingTime">
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingTitle">Title of Meeting</label>
                        <input type="text" id="briefingTitle" placeholder="Enter meeting title">
                    </div>
                    <div class="form-group">
                        <label for="briefingCommissionDeadline">Commission Deadline</label>
                        <input type="date" id="briefingCommissionDeadline">
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingSharepointLink">SharePoint Link</label>
                        <input type="url" id="briefingSharepointLink" placeholder="https://sharepoint.com/..." style="font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px; color: #0066cc;">
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingPSComments">PS Comments</label>
                        <textarea id="briefingPSComments" placeholder="Enter PS comments..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingSpAdComments">SpAd Comments</label>
                        <textarea id="briefingSpAdComments" placeholder="Enter SpAd comments..."></textarea>
                    </div>
                </div>
                
                <div id="briefingFirstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons" id="briefingFormButtons">
                    <button type="button" class="form-btn btn-add" onclick="addBriefing()">Add</button>
                    <button type="button" class="form-btn btn-submit-archive" onclick="archiveBriefingFromModal()">Ready for archive</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Urgency Reason Modal -->
    <div id="urgencyReasonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Urgency Justification Required</h2>
            </div>
            <form id="urgencyReasonForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="urgencyReason">Please explain why this item is urgent:</label>
                        <textarea id="urgencyReason" placeholder="Provide a detailed explanation for the urgent priority..." style="min-height: 100px;" required></textarea>
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="form-btn btn-add" onclick="confirmUrgencyReason()">Confirm Urgent</button>
                    <button type="button" class="form-btn btn-cancel" onclick="cancelUrgencyReason()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Commission Modal Form -->
    <div id="commissionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="commissionModalTitle">Add New Commission</h2>
            </div>
            <form id="commissionForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="commissionAction">Action</label>
                        <textarea id="commissionAction" placeholder="What has been commissioned? When was the commission made, and by who?" rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="commissionLeadPS">Lead PS</label>
                        <select id="commissionLeadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="commissionDeadline">Deadline for commission</label>
                        <input type="date" id="commissionDeadline">
                    </div>
                    
                    <div class="form-group">
                        <label for="commissionStatus">Status</label>
                        <select id="commissionStatus">
                            <option value="">Select status...</option>
                            <option value="With PS">With PS</option>
                            <option value="Commissioned the department">Commissioned the department</option>
                            <option value="With SpAds">With SpAds</option>
                            <option value="Complete">Complete</option>
                        </select>
                    </div>
                </div>
                
                <div id="commissionFirstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons" id="commissionFormButtons">
                    <button type="button" class="form-btn btn-add" onclick="addCommission()">Add</button>
                    <button type="button" class="form-btn btn-submit-archive" onclick="submitCommissionToArchive()">Submit to archive</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeCommissionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Local Storage Data Model ---
        // Keys: submissions, invites, briefings, archiveSubmissions, archiveInvites, archiveBriefings

        // --- Working Days Calculation ---
        function calculateWorkingDays(startDate, endDate) {
            if (!startDate) return '';
            
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date(); // Use today if no end date
            
            // If end date is before start date, return 0
            if (end < start) return 0;
            
            let workingDays = 0;
            const currentDate = new Date(start);
            
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                // 0 = Sunday, 6 = Saturday
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    workingDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Subtract 1 because we don't count the start date itself
            return Math.max(0, workingDays - 1);
        }

        function formatUrlForDisplay(url) {
            if (!url) return '';
            
            // If it's a valid URL, create a clickable link with truncated display text
            try {
                const urlObj = new URL(url);
                let displayText = url;
                
                // Truncate long URLs for display
                if (url.length > 30) {
                    displayText = url.substring(0, 27) + '...';
                }
                
                return `<a href="${url}" target="_blank" class="url-cell" title="${url}">${displayText}</a>`;
            } catch (e) {
                // If not a valid URL, just display as text with URL styling
                let displayText = url;
                if (url.length > 30) {
                    displayText = url.substring(0, 27) + '...';
                }
                return `<span class="url-display" title="${url}">${displayText}</span>`;
            }
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                const options = { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long'
                };
                return date.toLocaleDateString('en-GB', options);
            } catch (e) {
                return dateString; // Return original if formatting fails
            }
        }

        function formatTimestampForDisplay(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = new Date(timestamp);
                const dateOptions = { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long',
                    year: 'numeric'
                };
                const timeOptions = {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                };
                const dateStr = date.toLocaleDateString('en-GB', dateOptions);
                const timeStr = date.toLocaleTimeString('en-GB', timeOptions);
                return `First added to the grid on ${dateStr} at ${timeStr}`;
            } catch (e) {
                return '';
            }
        }

        function updateWorkingDaysForSubmission(data) {
            if (data.dateSubmittedSpads) {
                data.workingDays = calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment);
            }
            return data;
        }

        // Utility: Load and Save
        function loadData(key) {
            try {
                const data = JSON.parse(localStorage.getItem(key) || '[]');
                console.log(`Loaded data for ${key}:`, data);
                
                // Filter out any null or invalid entries
                if (Array.isArray(data)) {
                    const filteredData = data.filter(item => item !== null && typeof item === 'object');
                    if (filteredData.length !== data.length) {
                        console.warn(`Filtered out ${data.length - filteredData.length} invalid entries from ${key}`);
                        // Save the cleaned data back
                        saveData(key, filteredData);
                    }
                    return filteredData;
                }
                
                return [];
            } catch (error) {
                console.error(`Error loading data for ${key}:`, error);
                return [];
            }
        }
        function saveData(key, arr) {
            try {
                localStorage.setItem(key, JSON.stringify(arr));
                console.log(`Saved data for ${key}:`, arr);
            } catch (error) {
                console.error(`Error saving data for ${key}:`, error);
            }
        }

        // Get form data helper
        function getFormData() {
            const leadPSElement = document.getElementById('leadPS');
            const submissionTitleElement = document.getElementById('submissionTitle');
            
            console.log('leadPS element:', leadPSElement);
            console.log('submissionTitle element:', submissionTitleElement);
            
            if (!leadPSElement) {
                console.error('leadPS element not found!');
                return { leadPS: '', submissionTitle: '', leadSpAd: '', urgency: '', urgencyReason: '', submissionType: 'advice', sharepointLink: '', dateReceived: '', status: '', dateSubmittedSpads: '', workingDays: '', dateSpAdComment: '', dateBoxed: '', comments: '', firstAdded: '' };
            }
            
            if (!submissionTitleElement) {
                console.error('submissionTitle element not found!');
                return { leadPS: '', submissionTitle: '', leadSpAd: '', urgency: '', urgencyReason: '', submissionType: 'advice', sharepointLink: '', dateReceived: '', status: '', dateSubmittedSpads: '', workingDays: '', dateSpAdComment: '', dateBoxed: '', comments: '', firstAdded: '' };
            }
            
            console.log('leadPS value:', leadPSElement.value);
            console.log('submissionTitle value:', submissionTitleElement.value);
            
            return {
                leadPS: leadPSElement.value || '',
                leadSpAd: (document.getElementById('leadSpAd') || {}).value || '',
                urgency: (document.getElementById('urgency') || {}).value || '',
                urgencyReason: (document.getElementById('urgency') || {}).value === 'Urgent' ? 
                              (window.currentUrgencyReason || '') : '',
                submissionType: (document.getElementById('submissionType') || {}).value || 'advice',
                submissionTitle: submissionTitleElement.value || '',
                sharepointLink: (document.getElementById('sharepointLink') || {}).value || '',
                dateReceived: (document.getElementById('dateReceived') || {}).value || '',
                status: (document.getElementById('status') || {}).value || '',
                dateSubmittedSpads: (document.getElementById('dateSubmittedSpads') || {}).value || '',
                workingDays: (document.getElementById('workingDays') || {}).value || '',
                dateSpAdComment: (document.getElementById('dateSpAdComment') || {}).value || '',
                dateBoxed: (document.getElementById('dateBoxed') || {}).value || '',
                comments: (document.getElementById('comments') || {}).value || '',
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function getInviteFormData() {
            return {
                inviteTitle: document.getElementById('inviteTitle').value,
                inviteLeadPS: document.getElementById('inviteLeadPS').value,
                inviteDate: document.getElementById('inviteDate').value,
                inviteStartTime: document.getElementById('inviteStartTime').value,
                inviteEndTime: document.getElementById('inviteEndTime').value,
                diaryManagerComments: document.getElementById('diaryManagerComments').value,
                psCommentsInvite: document.getElementById('psCommentsInvite').value,
                spadCommentsInvite: document.getElementById('spadCommentsInvite').value,
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function getBriefingFormData() {
            return {
                leadPS: document.getElementById('briefingLeadPS').value,
                leadSpAd: document.getElementById('briefingLeadSpAd').value,
                date: document.getElementById('briefingDate').value,
                time: document.getElementById('briefingTime').value,
                title: document.getElementById('briefingTitle').value,
                sharepointLink: document.getElementById('briefingSharepointLink').value,
                commissionDeadline: document.getElementById('briefingCommissionDeadline').value,
                psComments: document.getElementById('briefingPSComments').value,
                spadComments: document.getElementById('briefingSpAdComments').value,
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function getCommissionFormData() {
            return {
                action: document.getElementById('commissionAction').value,
                leadPS: document.getElementById('commissionLeadPS').value,
                deadline: document.getElementById('commissionDeadline').value,
                status: document.getElementById('commissionStatus').value,
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function addSubmission(data) {
            console.log('addSubmission called with data:', data);
            
            // Validate that data is not null and has required properties
            if (!data || typeof data !== 'object') {
                console.error('Invalid data passed to addSubmission:', data);
                return;
            }
            
            // Calculate working days automatically
            data = updateWorkingDaysForSubmission(data);
            
            // Always add to submissions table (box work dashboard)
            const arr = loadData('submissions');
            console.log('Current submissions:', arr);
            arr.push(data);
            console.log('After adding:', arr);
            saveData('submissions', arr);
            console.log('Saved to localStorage');
            renderSubmissions();
            updateSpAdBox();
            updateLCBox();
            renderArchiveSubmissions();
            
            // Only add to briefings if it's briefing or both
            if (data.submissionType === 'briefing' || data.submissionType === 'both') {
                addToBriefings(data);
            }
            
            console.log('addSubmission completed');
        }

        // Convert submission data to briefing format and add to briefings table
        function addToBriefings(submissionData) {
            const briefingData = {
                leadPS: submissionData.leadPS,
                leadSpAd: submissionData.leadSpAd,
                date: '', // Will need to be filled in later or prompt user
                time: '', // Will need to be filled in later or prompt user
                title: submissionData.submissionTitle,
                sharepointLink: submissionData.sharepointLink,
                commissionDeadline: '', // Will need to be filled in later
                psComments: submissionData.comments || '',
                spadComments: ''
            };
            
            const briefings = loadData('briefings');
            briefings.push(briefingData);
            saveData('briefings', briefings);
            renderBriefings();
            console.log('Added to briefings:', briefingData);
        }

        function updateSubmission(idx, data) {
            const arr = loadData('submissions');
            if (data) {
                // Calculate working days automatically
                data = updateWorkingDaysForSubmission(data);
                arr[idx] = data;
            } else {
                const formData = getFormData();
                
                // Validate urgency reason if urgent
                if (formData.urgency === 'Urgent' && !window.currentUrgencyReason) {
                    alert('Please provide a reason for the urgent priority.');
                    openUrgencyReasonModal();
                    return;
                }
                
                // Calculate working days automatically
                arr[idx] = updateWorkingDaysForSubmission(formData);
            }
            saveData('submissions', arr);
            renderSubmissions();
            updateSpAdBox();
            updateLCBox();
            closeModal();
        }

        function deleteSubmissionRow(idx) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            const arr = loadData('submissions');
            arr.splice(idx, 1);
            saveData('submissions', arr);
            renderSubmissions();
            updateSpAdBox();
            updateLCBox();
        }

        function editSubmissionRow(idx) {
            const rows = loadData('submissions');
            const data = rows[idx];
            
            // Populate form fields
            document.getElementById('leadPS').value = data.leadPS || '';
            document.getElementById('leadSpAd').value = data.leadSpAd || '';
            document.getElementById('urgency').value = data.urgency || '';
            document.getElementById('submissionTitle').value = data.submissionTitle || '';
            document.getElementById('sharepointLink').value = data.sharepointLink || '';
            document.getElementById('dateReceived').value = data.dateReceived || '';
            document.getElementById('status').value = data.status || '';
            document.getElementById('dateSubmittedSpads').value = data.dateSubmittedSpads || '';
            document.getElementById('dateSpAdComment').value = data.dateSpAdComment || '';
            document.getElementById('dateBoxed').value = data.dateBoxed || '';
            document.getElementById('comments').value = data.comments || '';
            
            // Set urgency reason if it exists
            window.currentUrgencyReason = data.urgencyReason || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('firstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Calculate and display working days
            const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
            document.getElementById('workingDays').value = workingDays;
            
            // Update modal title and buttons
            document.querySelector('.modal-header h2').textContent = 'Edit Submission';
            document.getElementById('submissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateSubmission(${idx})">Update</button>
                <button type="button" class="form-btn btn-submit-spads" onclick="updateAndSubmitToSpAds(${idx})">Update & Submit to SpAds</button>
                <button type="button" class="form-btn btn-submit-lc" onclick="updateAndSubmitToLCBox(${idx})">Update & Submit to LC box</button>
                <button type="button" class="form-btn btn-submit-archive" onclick="updateAndSubmitToArchive(${idx})">Update & Submit to archive</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            document.getElementById('itemModal').style.display = 'block';
            
            // Set up event listeners for date changes and urgency
            setTimeout(() => {
                const dateSubmittedSpads = document.getElementById('dateSubmittedSpads');
                const dateSpAdComment = document.getElementById('dateSpAdComment');
                const urgencySelect = document.getElementById('urgency');
                
                if (dateSubmittedSpads) {
                    dateSubmittedSpads.addEventListener('change', updateWorkingDaysDisplay);
                }
                if (dateSpAdComment) {
                    dateSpAdComment.addEventListener('change', updateWorkingDaysDisplay);
                }
                if (urgencySelect) {
                    urgencySelect.addEventListener('change', handleUrgencyChange);
                }
            }, 100);
        }

        // --- Update and Submit Functions ---
        function updateAndSubmitToSpAds(idx) {
            const data = getFormData();
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            data.status = 'With SpAds';
            if (!data.dateSubmittedSpads) {
                data.dateSubmittedSpads = new Date().toISOString().split('T')[0];
            }
            updateSubmission(idx, data);
        }

        function updateAndSubmitToLCBox(idx) {
            const data = getFormData();
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            data.status = 'Ready for the box';
            if (!data.dateBoxed) {
                data.dateBoxed = new Date().toISOString().split('T')[0];
            }
            updateSubmission(idx, data);
        }

        function updateAndSubmitToArchive(idx) {
            const data = getFormData();
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            data.status = 'Readout/complete';
            // Add archive date for sorting
            data.archivedDate = new Date().toISOString();
            // Remove from main submissions and add to archive
            const arr = loadData('submissions');
            const archiveArr = loadData('archiveSubmissions');
            archiveArr.push(data);
            saveData('archiveSubmissions', archiveArr);
            arr.splice(idx, 1);
            saveData('submissions', arr);
            renderSubmissions();
            renderArchiveSubmissions();
            closeModal();
        }

        // --- Form submission functions ---
        function addSubmissionFromModal() {
            console.log('addSubmissionFromModal called');
            
            // Check if modal is open
            const modal = document.getElementById('itemModal');
            if (!modal || modal.style.display === 'none') {
                console.error('Modal is not open!');
                alert('Form is not available. Please try opening the form again.');
                return;
            }
            
            const data = getFormData();
            console.log('Form data:', data);
            if (!data.leadPS || !data.submissionTitle) {
                console.log('Validation failed - leadPS:', data.leadPS, 'submissionTitle:', data.submissionTitle);
                alert('Please fill in required fields (Lead PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            console.log('Validation passed, adding submission');
            // Remove sample rows if present
            removeSampleRows();
            addSubmission(data);
            closeModal();
        }

        function submitToSpAdsFromModal() {
            console.log('submitToSpAdsFromModal called');
            
            // Check if modal is open
            const modal = document.getElementById('itemModal');
            if (!modal || modal.style.display === 'none') {
                console.error('Modal is not open!');
                alert('Form is not available. Please try opening the form again.');
                return;
            }
            
            const data = getFormData();
            console.log('Form data:', data);
            if (!data.leadPS || !data.submissionTitle) {
                console.log('Validation failed - leadPS:', data.leadPS, 'submissionTitle:', data.submissionTitle);
                alert('Please fill in required fields (Lead PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            console.log('Validation passed, submitting to SpAds');
            data.status = 'With SpAds';
            if (!data.dateSubmittedSpads) {
                data.dateSubmittedSpads = new Date().toISOString().split('T')[0];
            }
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            // Remove sample rows if present
            removeSampleRows();
            addSubmission(data);
            closeModal();
        }

        function submitToLCBoxFromModal() {
            console.log('submitToLCBoxFromModal called');
            
            // Check if modal is open
            const modal = document.getElementById('itemModal');
            if (!modal || modal.style.display === 'none') {
                console.error('Modal is not open!');
                alert('Form is not available. Please try opening the form again.');
                return;
            }
            
            const data = getFormData();
            console.log('Form data:', data);
            if (!data.leadPS || !data.submissionTitle) {
                console.log('Validation failed - leadPS:', data.leadPS, 'submissionTitle:', data.submissionTitle);
                alert('Please fill in required fields (Lead PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            console.log('Validation passed, submitting to LC Box');
            data.status = 'Ready for the box';
            if (!data.dateBoxed) {
                data.dateBoxed = new Date().toISOString().split('T')[0];
            }
            // Remove sample rows if present
            removeSampleRows();
            addSubmission(data);
            closeModal();
        }

        function submitToArchiveFromModal() {
            const data = getFormData();
            if (!data.leadPS || !data.submissionTitle) {
                alert('Please fill in required fields (Lead PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            data.status = 'Readout/complete';
            // Add archive date for sorting
            data.archivedDate = new Date().toISOString();
            const archiveArr = loadData('archiveSubmissions');
            archiveArr.push(data);
            saveData('archiveSubmissions', archiveArr);
            renderArchiveSubmissions();
            closeModal();
        }

        // --- Render Functions ---
        function renderSubmissions() {
            console.log('renderSubmissions called');
            const rows = loadData('submissions');
            console.log('Loaded submissions:', rows);
            const container = document.querySelector('#mainDashboard .submissions-grid');
            console.log('Container found:', container);
            
            if (!container) {
                console.error('Could not find submissions grid container!');
                return;
            }
            
            // Remove existing rows (except header)
            const existingRows = container.querySelectorAll('.grid-row');
            console.log('Existing rows to remove:', existingRows.length);
            existingRows.forEach(row => row.remove());
            
            // Add new rows
            rows.forEach((data, idx) => {
                console.log('Processing row data:', data);
                if (!data) {
                    console.error('Row data is null or undefined at index:', idx);
                    return;
                }
                
                // Calculate working days for display
                const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
                
                // Show draft indicator in comments column
                let commentsDisplay = data.comments || '';
                if (data.spadDraftComments || data.spadDraftBoxNote) {
                    const draftComments = data.spadDraftComments || '';
                    commentsDisplay = draftComments;
                }
                
                // Add urgency reason if item is urgent
                if (data.urgency === 'Urgent' && data.urgencyReason) {
                    const urgencyNote = `[URGENT: ${data.urgencyReason}]`;
                    commentsDisplay = commentsDisplay ? `${urgencyNote} ${commentsDisplay}` : urgencyNote;
                }
                
                const row = document.createElement('div');
                row.className = 'grid-row';
                
                // Add urgent styling if item is urgent
                if (data.urgency === 'Urgent') {
                    row.classList.add('urgent-item');
                }
                
                row.innerHTML = `
                    <div class="grid-cell">${(data && data.leadPS) || ''}</div>
                    <div class="grid-cell">${(data && data.leadSpAd) || ''}</div>
                    <div class="grid-cell">${(data && data.urgency) || ''}</div>
                    <div class="grid-cell">${(data && data.submissionTitle) || ''}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateReceived)}</div>
                    <div class="grid-cell">${(data && data.status) || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSubmittedSpads)}</div>
                    <div class="grid-cell">${workingDays}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSpAdComment)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateBoxed)}</div>
                    <div class="grid-cell">${commentsDisplay}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editSubmissionRow(${idx})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteSubmissionRow(${idx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
        }

        function renderSpAdBox() {
            const rows = loadData('submissions').filter(row => row.status === 'With SpAds');
            
            // Sort by urgency first (Urgent > Priority > Routine), then by working days (highest first)
            rows.sort((a, b) => {
                // Define urgency priority order
                const urgencyOrder = { 'Urgent': 3, 'Priority': 2, 'Routine': 1 };
                
                // First sort by urgency
                const urgencyA = urgencyOrder[a.urgency] || 0;
                const urgencyB = urgencyOrder[b.urgency] || 0;
                
                if (urgencyA !== urgencyB) {
                    return urgencyB - urgencyA; // Higher urgency first
                }
                
                // If urgency is the same, sort by working days with SpAds (highest first)
                const workingDaysA = a.dateSubmittedSpads ? calculateWorkingDays(a.dateSubmittedSpads, a.dateSpAdComment) : 0;
                const workingDaysB = b.dateSubmittedSpads ? calculateWorkingDays(b.dateSubmittedSpads, b.dateSpAdComment) : 0;
                
                return workingDaysB - workingDaysA; // Higher working days first
            });
            
            const container = document.getElementById('spadGridRows');
            container.innerHTML = '';
            
            rows.forEach((data, idx) => {
                const allRows = loadData('submissions');
                const originalIdx = allRows.findIndex(row => 
                    row.submissionTitle === data.submissionTitle && 
                    row.leadPS === data.leadPS
                );
                
                // Calculate working days for display
                const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
                
                // Show draft comments if available, otherwise regular comments
                let commentsDisplay = data.comments || '';
                if (data.spadDraftComments || data.spadDraftBoxNote) {
                    const draftComments = data.spadDraftComments || '';
                    commentsDisplay = draftComments;
                }
                
                // Add urgency reason if item is urgent
                if (data.urgency === 'Urgent' && data.urgencyReason) {
                    const urgencyNote = `[URGENT: ${data.urgencyReason}]`;
                    commentsDisplay = commentsDisplay ? `${urgencyNote} ${commentsDisplay}` : urgencyNote;
                }
                
                const row = document.createElement('div');
                row.className = 'grid-row';
                
                // Check if the item has been with SpAds for more than 5 working days
                if (workingDays > 5) {
                    row.classList.add('overdue-spad-row');
                }
                
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${data.urgency || ''}</div>
                    <div class="grid-cell">${data.submissionTitle || ''}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateReceived)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSubmittedSpads)}</div>
                    <div class="grid-cell">${workingDays}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSpAdComment)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateBoxed)}</div>
                    <div class="grid-cell">${commentsDisplay}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="spad-comment-btn" onclick="openSpAdCommentModal(this)">Add SpAd comment</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
        }

        function renderLCBox() {
            const rows = loadData('submissions').filter(row => row.status === 'Ready for the box');
            const container = document.getElementById('lcGridRows');
            container.innerHTML = '';
            
            rows.forEach((data, idx) => {
                const allRows = loadData('submissions');
                const originalIdx = allRows.findIndex(row => 
                    row.submissionTitle === data.submissionTitle && 
                    row.leadPS === data.leadPS
                );
                
                // Calculate working days for display
                const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
                
                // Show draft comments if available, otherwise regular comments
                let commentsDisplay = data.comments || '';
                if (data.spadDraftComments || data.spadDraftBoxNote) {
                    const draftComments = data.spadDraftComments || '';
                    commentsDisplay = draftComments;
                }
                
                // Add urgency reason if item is urgent
                if (data.urgency === 'Urgent' && data.urgencyReason) {
                    const urgencyNote = `[URGENT: ${data.urgencyReason}]`;
                    commentsDisplay = commentsDisplay ? `${urgencyNote} ${commentsDisplay}` : urgencyNote;
                }
                
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${data.urgency || ''}</div>
                    <div class="grid-cell">${data.submissionTitle || ''}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateReceived)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSubmittedSpads)}</div>
                    <div class="grid-cell">${workingDays}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSpAdComment)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateBoxed)}</div>
                    <div class="grid-cell">${commentsDisplay}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editSubmissionRow(${originalIdx})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteSubmissionRow(${originalIdx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
        }

        function renderArchiveSubmissions() {
            const rows = loadData('archiveSubmissions');
            const container = document.getElementById('archiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA; // Most recent first (descending order)
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.submissionTitle === data.submissionTitle && 
                    row.leadPS === data.leadPS &&
                    row.archivedDate === data.archivedDate
                );
                
                // Calculate working days for display
                const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
                
                // Show draft comments if available, otherwise regular comments
                let commentsDisplay = data.comments || '';
                if (data.spadDraftComments || data.spadDraftBoxNote) {
                    const draftComments = data.spadDraftComments || '';
                    commentsDisplay = draftComments;
                }
                
                // Add urgency reason if item is urgent
                if (data.urgency === 'Urgent' && data.urgencyReason) {
                    const urgencyNote = `[URGENT: ${data.urgencyReason}]`;
                    commentsDisplay = commentsDisplay ? `${urgencyNote} ${commentsDisplay}` : urgencyNote;
                }
                
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${data.urgency || ''}</div>
                    <div class="grid-cell">${data.submissionTitle || ''}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateReceived)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSubmittedSpads)}</div>
                    <div class="grid-cell">${workingDays}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSpAdComment)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateBoxed)}</div>
                    <div class="grid-cell">${commentsDisplay}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn delete-btn" onclick="deleteArchivedSubmission(${originalIdx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteArchivedSubmission(idx) {
            if (!confirm('Are you sure you want to delete this archived submission?')) return;
            const arr = loadData('archiveSubmissions');
            arr.splice(idx, 1);
            saveData('archiveSubmissions', arr);
            renderArchiveSubmissions();
        }

        // --- Invite Functions ---
        function addInvite() {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            const arr = loadData('invites');
            arr.push(data);
            saveData('invites', arr);
            renderInvites();
            closeInviteModal();
        }

        function renderInvites() {
            const rows = loadData('invites');
            const container = document.getElementById('inviteGridRows');
            container.innerHTML = '';
            
            // Sort by date (earliest first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.inviteDate || '1900-01-01');
                const dateB = new Date(b.inviteDate || '1900-01-01');
                return dateA - dateB;
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for edit/delete operations
                const originalIdx = rows.findIndex(row => 
                    row.inviteTitle === data.inviteTitle && 
                    row.inviteDate === data.inviteDate &&
                    row.inviteStartTime === data.inviteStartTime
                );
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.inviteTitle || ''}</div>
                    <div class="grid-cell">${data.inviteLeadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.inviteDate)}</div>
                    <div class="grid-cell">${data.inviteStartTime || ''}</div>
                    <div class="grid-cell">${data.inviteEndTime || ''}</div>
                    <div class="grid-cell">${data.diaryManagerComments || ''}</div>
                    <div class="grid-cell">${data.psCommentsInvite || ''}</div>
                    <div class="grid-cell">${data.spadCommentsInvite || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editInviteRow(${originalIdx})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteInviteRow(${originalIdx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteInviteRow(idx) {
            if (!confirm('Are you sure you want to delete this invite?')) return;
            const arr = loadData('invites');
            arr.splice(idx, 1);
            saveData('invites', arr);
            renderInvites();
        }

        function editInviteRow(idx) {
            const rows = loadData('invites');
            const data = rows[idx];
            
            document.getElementById('inviteTitle').value = data.inviteTitle || '';
            document.getElementById('inviteLeadPS').value = data.inviteLeadPS || '';
            document.getElementById('inviteDate').value = data.inviteDate || '';
            document.getElementById('inviteStartTime').value = data.inviteStartTime || '';
            document.getElementById('inviteEndTime').value = data.inviteEndTime || '';
            document.getElementById('diaryManagerComments').value = data.diaryManagerComments || '';
            document.getElementById('psCommentsInvite').value = data.psCommentsInvite || '';
            document.getElementById('spadCommentsInvite').value = data.spadCommentsInvite || '';
            
            document.querySelector('#inviteModal .modal-header h2').textContent = 'Edit Invite';
            document.querySelector('#inviteModal .form-buttons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateInvite(${idx})">Update Invite</button>
                <button type="button" class="form-btn btn-submit-archive" onclick="archiveInviteFromModal(${idx})">Ready to archive</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
            `;
            
            document.getElementById('inviteModal').style.display = 'block';
        }

        function updateInvite(idx) {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            const arr = loadData('invites');
            arr[idx] = data;
            saveData('invites', arr);
            renderInvites();
            closeInviteModal();
        }

        function archiveInviteFromModal(idx) {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            // Add archive date for sorting
            data.archivedDate = new Date().toISOString();
            const arr = loadData('invites');
            const archiveArr = loadData('archiveInvites');
            archiveArr.push(data);
            saveData('archiveInvites', archiveArr);
            arr.splice(idx, 1);
            saveData('invites', arr);
            renderInvites();
            renderArchiveInvites();
            closeInviteModal();
        }

        function renderArchiveInvites() {
            const rows = loadData('archiveInvites');
            const container = document.getElementById('inviteArchiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA; // Most recent first (descending order)
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.inviteTitle === data.inviteTitle && 
                    row.inviteDate === data.inviteDate &&
                    row.inviteStartTime === data.inviteStartTime &&
                    row.archivedDate === data.archivedDate
                );
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.inviteTitle || ''}</div>
                    <div class="grid-cell">${data.inviteLeadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.inviteDate)}</div>
                    <div class="grid-cell">${data.inviteStartTime || ''}</div>
                    <div class="grid-cell">${data.inviteEndTime || ''}</div>
                    <div class="grid-cell">${data.diaryManagerComments || ''}</div>
                    <div class="grid-cell">${data.psCommentsInvite || ''}</div>
                    <div class="grid-cell">${data.spadCommentsInvite || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn delete-btn" onclick="deleteArchivedInvite(${originalIdx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteArchivedInvite(idx) {
            if (!confirm('Are you sure you want to delete this archived invite?')) return;
            const arr = loadData('archiveInvites');
            arr.splice(idx, 1);
            saveData('archiveInvites', arr);
            renderArchiveInvites();
        }

        // --- Briefing Functions ---
        function addBriefing() {
            const data = getBriefingFormData();
            if (!data.leadPS || !data.leadSpAd || !data.date || !data.time || !data.title) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            const arr = loadData('briefings');
            arr.push(data);
            saveData('briefings', arr);
            renderBriefings();
            closeBriefingModal();
        }

        function renderBriefings() {
            const rows = loadData('briefings');
            const container = document.getElementById('briefingGridRows');
            container.innerHTML = '';
            
            // Sort by date (earliest first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.date || '1900-01-01');
                const dateB = new Date(b.date || '1900-01-01');
                return dateA - dateB;
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for edit/delete operations
                const originalIdx = rows.findIndex(row => 
                    row.leadPS === data.leadPS && 
                    row.date === data.date &&
                    row.time === data.time &&
                    row.title === data.title
                );
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.date)}</div>
                    <div class="grid-cell">${data.time || ''}</div>
                    <div class="grid-cell">${data.title || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.commissionDeadline)}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${data.psComments || ''}</div>
                    <div class="grid-cell">${data.spadComments || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editBriefingRow(${originalIdx})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteBriefingRow(${originalIdx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
        }

        function deleteBriefingRow(idx) {
            if (confirm('Are you sure you want to delete this briefing?')) {
                const arr = loadData('briefings');
                arr.splice(idx, 1);
                saveData('briefings', arr);
                renderBriefings();
            }
        }

        function editBriefingRow(idx) {
            const rows = loadData('briefings');
            const data = rows[idx];
            
            document.getElementById('briefingLeadPS').value = data.leadPS || '';
            document.getElementById('briefingLeadSpAd').value = data.leadSpAd || '';
            document.getElementById('briefingDate').value = data.date || '';
            document.getElementById('briefingTime').value = data.time || '';
            document.getElementById('briefingTitle').value = data.title || '';
            document.getElementById('briefingCommissionDeadline').value = data.commissionDeadline || '';
            document.getElementById('briefingSharepointLink').value = data.sharepointLink || '';
            document.getElementById('briefingPSComments').value = data.psComments || '';
            document.getElementById('briefingSpAdComments').value = data.spadComments || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('briefingFirstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            document.getElementById('briefingModalTitle').textContent = 'Edit Briefing';
            document.getElementById('briefingFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateBriefing(${idx})">Update</button>
                <button type="button" class="form-btn btn-submit-archive" onclick="archiveBriefingFromModal(${idx})">Ready for archive</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
            `;
            
            document.getElementById('briefingModal').style.display = 'block';
        }

        function updateBriefing(idx) {
            const data = getBriefingFormData();
            if (!data.leadPS || !data.leadSpAd || !data.date || !data.time || !data.title) {
                alert('Please fill in all required fields.');
                return;
            }
            
            const arr = loadData('briefings');
            arr[idx] = data;
            saveData('briefings', arr);
            renderBriefings();
            closeBriefingModal();
        }

        function archiveBriefingFromModal(idx) {
            const data = getBriefingFormData();
            if (!data.leadPS || !data.leadSpAd || !data.date || !data.time || !data.title) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Add archive date for sorting
            data.archivedDate = new Date().toISOString();
            const arr = loadData('briefings');
            const archiveArr = loadData('archiveBriefings');
            archiveArr.push(data);
            saveData('archiveBriefings', archiveArr);
            
            if (idx !== undefined) {
                arr.splice(idx, 1);
                saveData('briefings', arr);
            }
            
            renderBriefings();
            renderArchiveBriefings();
            closeBriefingModal();
        }

        function renderArchiveBriefings() {
            const rows = loadData('archiveBriefings');
            const container = document.getElementById('briefingsArchiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA; // Most recent first (descending order)
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.leadPS === data.leadPS && 
                    row.date === data.date &&
                    row.time === data.time &&
                    row.title === data.title &&
                    row.archivedDate === data.archivedDate
                );
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.date)}</div>
                    <div class="grid-cell">${data.time || ''}</div>
                    <div class="grid-cell">${data.title || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.commissionDeadline)}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${data.psComments || ''}</div>
                    <div class="grid-cell">${data.spadComments || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn delete-btn" onclick="deleteArchivedBriefing(${originalIdx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteArchivedBriefing(idx) {
            if (!confirm('Are you sure you want to delete this archived briefing?')) return;
            const arr = loadData('archiveBriefings');
            arr.splice(idx, 1);
            saveData('archiveBriefings', arr);
            renderArchiveBriefings();
        }

        function editArchivedBriefing(idx) {
            const arr = loadData('archiveBriefings');
            const data = arr[idx];
            
            // Populate the briefing modal with archived data
            document.getElementById('briefingLeadPS').value = data.leadPS || '';
            document.getElementById('briefingLeadSpAd').value = data.leadSpAd || '';
            document.getElementById('briefingDate').value = data.date || '';
            document.getElementById('briefingTime').value = data.time || '';
            document.getElementById('briefingTitle').value = data.title || '';
            document.getElementById('briefingCommissionDeadline').value = data.commissionDeadline || '';
            document.getElementById('briefingSharepointLink').value = data.sharepointLink || '';
            document.getElementById('briefingPSComments').value = data.psComments || '';
            document.getElementById('briefingSpAdComments').value = data.spadComments || '';
            
            // Update modal title and buttons for editing archived briefing
            document.getElementById('briefingModalTitle').textContent = 'Edit Archived Briefing';
            document.getElementById('briefingFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateArchivedBriefing(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
            `;
            
            // Show the modal
            document.getElementById('briefingModal').style.display = 'block';
        }

        function updateArchivedBriefing(idx) {
            const data = getBriefingFormData();
            
            // Minimal validation - only require title since that's the most essential field
            if (!data.title) {
                alert('Please fill in at least the Title field.');
                return;
            }
            
            // Keep the archived date and status
            const arr = loadData('archiveBriefings');
            data.archivedDate = arr[idx].archivedDate;
            data.status = 'Complete'; // Keep archived status
            
            // Update the archived briefing
            arr[idx] = data;
            saveData('archiveBriefings', arr);
            renderArchiveBriefings();
            closeBriefingModal();
        }

        // --- Modal Functions ---
        function openModal() {
            document.getElementById('submissionForm').reset();
            document.querySelector('.modal-header h2').textContent = 'Add New Submission';
            document.getElementById('submissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="addSubmissionFromModal()">Add</button>
                <button type="button" class="form-btn btn-submit-spads" onclick="submitToSpAdsFromModal()">Submit to SpAds</button>
                <button type="button" class="form-btn btn-submit-lc" onclick="submitToLCBoxFromModal()">Submit to LC box</button>
                <button type="button" class="form-btn btn-submit-archive" onclick="submitToArchiveFromModal()">Submit to archive</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            // Hide timestamp for new items
            const timestampDiv = document.getElementById('firstAddedTimestamp');
            if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            document.getElementById('itemModal').style.display = 'block';
            
            // Reset urgency reason and first added timestamp
            window.currentUrgencyReason = '';
            window.currentFirstAdded = '';
            window.previousUrgencyValue = '';
            window.lastNonUrgentValue = '';
            
            // Set up event listeners for working days calculation
            setTimeout(() => {
                const dateSubmittedSpads = document.getElementById('dateSubmittedSpads');
                const dateSpAdComment = document.getElementById('dateSpAdComment');
                const urgencySelect = document.getElementById('urgency');
                
                if (dateSubmittedSpads) {
                    dateSubmittedSpads.addEventListener('change', updateWorkingDaysDisplay);
                }
                if (dateSpAdComment) {
                    dateSpAdComment.addEventListener('change', updateWorkingDaysDisplay);
                }
                if (urgencySelect) {
                    urgencySelect.addEventListener('change', handleUrgencyChange);
                }
            }, 100);
        }

        // Remove sample rows from the grid if present
        function removeSampleRows() {
            const container = document.querySelector('#mainDashboard .submissions-grid');
            const sampleRows = Array.from(container.querySelectorAll('.grid-row'));
            sampleRows.forEach(row => {
                // Only remove sample rows (those with hardcoded content, not those rendered by JS)
                // We'll check for the 'Edit not implemented in sample row' handler as a marker
                const editBtn = row.querySelector('.edit-btn');
                if (editBtn && editBtn.getAttribute('onclick') && editBtn.getAttribute('onclick').includes('Edit not implemented in sample row')) {
                    row.remove();
                }
            });
        }

        function closeModal() {
            document.getElementById('itemModal').style.display = 'none';
            document.getElementById('submissionForm').reset();
            // Reset urgency reason
            window.currentUrgencyReason = '';
        }

        // --- Commission Functions ---
        function getCommissionFormData() {
            return {
                action: document.getElementById('commissionAction').value || '',
                leadPS: document.getElementById('commissionLeadPS').value || '',
                deadline: document.getElementById('commissionDeadline').value || '',
                status: document.getElementById('commissionStatus').value || ''
            };
        }

        function openCommissionModal() {
            document.getElementById('commissionModal').style.display = 'block';
            document.getElementById('commissionModalTitle').textContent = 'Add New Commission';
            
            // Hide timestamp for new items
            const timestampDiv = document.getElementById('commissionFirstAddedTimestamp');
            if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Reset first added timestamp
            window.currentFirstAdded = '';
            
            clearCommissionForm();
        }

        function closeCommissionModal() {
            document.getElementById('commissionModal').style.display = 'none';
            clearCommissionForm();
            resetCommissionFormButtons();
        }

        function clearCommissionForm() {
            document.getElementById('commissionAction').value = '';
            document.getElementById('commissionLeadPS').value = '';
            document.getElementById('commissionDeadline').value = '';
            document.getElementById('commissionStatus').value = '';
        }

        function addCommission() {
            const data = getCommissionFormData();
            
            if (!data.action.trim()) {
                alert('Please enter an action description');
                return;
            }
            
            if (!data.leadPS) {
                alert('Please select a Lead PS');
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            const arr = loadData('commissions');
            arr.push(data);
            saveData('commissions', arr);
            renderCommissions();
            closeCommissionModal();
        }

        function submitCommissionToArchive() {
            const data = getCommissionFormData();
            
            if (!data.action.trim()) {
                alert('Please enter an action description');
                return;
            }
            
            if (!data.leadPS) {
                alert('Please select a lead PS');
                return;
            }
            
            if (!data.deadline) {
                alert('Please enter a deadline');
                return;
            }
            
            if (!data.status) {
                alert('Please select a status');
                return;
            }
            
            const archiveData = { ...data, status: 'Complete', archivedDate: new Date().toISOString().split('T')[0] };
            const archiveArr = loadData('commissionArchive');
            archiveArr.push(archiveData);
            saveData('commissionArchive', archiveArr);
            
            // If we're editing an existing commission, remove it from the main commissions grid
            const addButton = document.querySelector('#commissionFormButtons .btn-add');
            if (addButton.textContent === 'Update') {
                // We're in edit mode, so remove the item from main grid
                const commissions = loadData('commissions');
                // Find the commission being edited by checking the button's onclick function
                const onclickStr = addButton.onclick.toString();
                const indexMatch = onclickStr.match(/updateCommission\((\d+)\)/);
                if (indexMatch) {
                    const editIndex = parseInt(indexMatch[1]);
                    commissions.splice(editIndex, 1);
                    saveData('commissions', commissions);
                }
            }
            
            renderCommissions();
            renderCommissionArchive();
            closeCommissionModal();
            alert('Commission archived with status set to Complete');
        }

        function renderCommissions() {
            const rows = loadData('commissions');
            const container = document.getElementById('commissionGridRows');
            container.innerHTML = '';
            
            rows.forEach((data, idx) => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.action || ''}</div>
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.deadline)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editCommission(${idx})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteCommission(${idx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function renderCommissionArchive() {
            const rows = loadData('commissionArchive');
            const container = document.getElementById('commissionArchiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA;
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.action === data.action && 
                    row.leadPS === data.leadPS &&
                    row.deadline === data.deadline &&
                    row.status === data.status &&
                    row.archivedDate === data.archivedDate
                );
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.action || ''}</div>
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.deadline)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn delete-btn" onclick="deleteArchivedCommission(${originalIdx})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function editArchivedCommission(idx) {
            const arr = loadData('commissionArchive');
            const data = arr[idx];
            
            // Populate the commission modal with archived data
            document.getElementById('commissionAction').value = data.action || '';
            document.getElementById('commissionLeadPS').value = data.leadPS || '';
            document.getElementById('commissionDeadline').value = data.deadline || '';
            document.getElementById('commissionStatus').value = data.status || '';
            
            // Update modal title and buttons for editing archived commission
            document.getElementById('commissionModalTitle').textContent = 'Edit Archived Commission';
            document.getElementById('commissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateArchivedCommission(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeCommissionModal()">Cancel</button>
            `;
            
            // Show the modal
            document.getElementById('commissionModal').style.display = 'block';
        }

        function updateArchivedCommission(idx) {
            const data = getCommissionFormData();
            
            // Minimal validation - only require action since that's the most essential field
            if (!data.action) {
                alert('Please fill in at least the Action field.');
                return;
            }
            
            // Keep the archived date and ensure status remains Complete
            const arr = loadData('commissionArchive');
            data.archivedDate = arr[idx].archivedDate;
            data.status = 'Complete'; // Keep archived status
            
            // Update the archived commission
            arr[idx] = data;
            saveData('commissionArchive', arr);
            renderCommissionArchive();
            closeCommissionModal();
        }

        function deleteArchivedCommission(idx) {
            if (!confirm('Are you sure you want to delete this archived commission?')) return;
            const arr = loadData('commissionArchive');
            arr.splice(idx, 1);
            saveData('commissionArchive', arr);
            renderCommissionArchive();
        }

        function editCommission(idx) {
            const arr = loadData('commissions');
            const data = arr[idx];
            
            document.getElementById('commissionAction').value = data.action || '';
            document.getElementById('commissionLeadPS').value = data.leadPS || '';
            document.getElementById('commissionDeadline').value = data.deadline || '';
            document.getElementById('commissionStatus').value = data.status || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('commissionFirstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            document.getElementById('commissionModalTitle').textContent = 'Edit Commission';
            document.getElementById('commissionModal').style.display = 'block';
            
            // Change button functionality for editing
            const addButton = document.querySelector('#commissionFormButtons .btn-add');
            addButton.textContent = 'Update';
            addButton.onclick = function() { updateCommission(idx); };
        }

        function updateCommission(idx) {
            const data = getCommissionFormData();
            
            if (!data.action.trim()) {
                alert('Please enter an action description');
                return;
            }
            
            if (!data.leadPS) {
                alert('Please select a lead PS');
                return;
            }
            
            if (!data.deadline) {
                alert('Please enter a deadline');
                return;
            }
            
            if (!data.status) {
                alert('Please select a status');
                return;
            }
            
            // If status is complete, move to archive and remove from commissions
            if (data.status === 'Complete') {
                const archiveData = { ...data, archivedDate: new Date().toISOString().split('T')[0] };
                const archiveArr = loadData('commissionArchive');
                archiveArr.push(archiveData);
                saveData('commissionArchive', archiveArr);
                
                const arr = loadData('commissions');
                arr.splice(idx, 1);
                saveData('commissions', arr);
                
                renderCommissions();
                renderCommissionArchive();
                closeCommissionModal();
                resetCommissionFormButtons();
                alert('Commission marked as complete and moved to archive');
                return;
            }
            
            const arr = loadData('commissions');
            arr[idx] = data;
            saveData('commissions', arr);
            renderCommissions();
            closeCommissionModal();
            resetCommissionFormButtons();
        }

        function deleteCommission(idx) {
            if (!confirm('Are you sure you want to delete this commission?')) return;
            const arr = loadData('commissions');
            arr.splice(idx, 1);
            saveData('commissions', arr);
            renderCommissions();
        }

        function resetCommissionFormButtons() {
            const addButton = document.querySelector('#commissionFormButtons .btn-add');
            addButton.textContent = 'Add';
            addButton.onclick = addCommission;
        }

        // --- Urgency Reason Modal Functions ---
        function openUrgencyReasonModal() {
            document.getElementById('urgencyReason').value = window.currentUrgencyReason || '';
            document.getElementById('urgencyReasonModal').style.display = 'block';
        }

        function closeUrgencyReasonModal() {
            document.getElementById('urgencyReasonModal').style.display = 'none';
        }

        function confirmUrgencyReason() {
            const reason = document.getElementById('urgencyReason').value.trim();
            if (!reason) {
                alert('Please provide a reason for the urgent priority.');
                return;
            }
            window.currentUrgencyReason = reason;
            closeUrgencyReasonModal();
        }

        function cancelUrgencyReason() {
            // Reset urgency back to previous value or empty
            const urgencySelect = document.getElementById('urgency');
            if (urgencySelect) {
                urgencySelect.value = window.previousUrgencyValue || '';
            }
            window.currentUrgencyReason = '';
            closeUrgencyReasonModal();
        }

        function handleUrgencyChange() {
            const urgencySelect = document.getElementById('urgency');
            if (!urgencySelect) return;
            
            const newValue = urgencySelect.value;
            
            if (newValue === 'Urgent') {
                // Store the previous value in case user cancels
                window.previousUrgencyValue = window.lastNonUrgentValue || '';
                openUrgencyReasonModal();
            } else {
                // Store non-urgent values for potential rollback
                window.lastNonUrgentValue = newValue;
                window.currentUrgencyReason = '';
            }
        }

        function openInviteModal() {
            document.getElementById('inviteForm').reset();
            document.querySelector('#inviteModal .modal-header h2').textContent = 'Add New Invite';
            document.querySelector('#inviteModal .form-buttons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="addInvite()">Add Invite</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
            `;
            document.getElementById('inviteModal').style.display = 'block';
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
            document.getElementById('inviteForm').reset();
        }

        function openBriefingModal() {
            document.getElementById('briefingForm').reset();
            document.getElementById('briefingModalTitle').textContent = 'Add New Briefing';
            document.getElementById('briefingFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="addBriefing()">Add</button>
                <button type="button" class="form-btn btn-submit-archive" onclick="archiveBriefingFromModal()">Ready for archive</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
            `;
            
            // Hide timestamp for new items
            const timestampDiv = document.getElementById('briefingFirstAddedTimestamp');
            if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Reset first added timestamp
            window.currentFirstAdded = '';
            
            document.getElementById('briefingModal').style.display = 'block';
        }

        function closeBriefingModal() {
            document.getElementById('briefingModal').style.display = 'none';
            document.getElementById('briefingForm').reset();
        }

        // --- Navigation Functions ---
        function showMainDashboard() {
            hideAllSections();
            document.getElementById('mainDashboard').classList.remove('hidden');
            updateActiveNav('Box work dashboard');
            renderSubmissions();
        }

        function showPersonalDashboard() {
            hideAllSections();
            document.getElementById('personalDashboard').classList.remove('hidden');
            document.getElementById('userPrompt').classList.remove('hidden');
            document.getElementById('personalDashboardContent').classList.add('hidden');
            updateActiveNav('Personal dashboard');
        }

        function showSpAdBox() {
            hideAllSections();
            document.getElementById('spadBox').classList.remove('hidden');
            updateActiveNav('SpAd review');
            renderSpAdBox();
        }

        function showLCBox() {
            hideAllSections();
            document.getElementById('lcBox').classList.remove('hidden');
            updateActiveNav('Items ready for LC');
            renderLCBox();
        }

        function showArchiveBox() {
            hideAllSections();
            document.getElementById('archiveBox').classList.remove('hidden');
            updateActiveNav('Archive box');
            renderArchiveSubmissions();
        }

        function showInvites() {
            hideAllSections();
            document.getElementById('invites').classList.remove('hidden');
            updateActiveNav('Invites');
            renderInvites();
        }

        function showBriefings() {
            hideAllSections();
            document.getElementById('briefings').classList.remove('hidden');
            updateActiveNav('Briefings');
            renderBriefings();
        }

        function showInviteArchive() {
            hideAllSections();
            document.getElementById('inviteArchive').classList.remove('hidden');
            updateActiveNav('Archive invites');
            renderArchiveInvites();
        }

        function showBriefingsArchive() {
            hideAllSections();
            document.getElementById('briefingsArchive').classList.remove('hidden');
            updateActiveNav('Archive briefings');
            renderArchiveBriefings();
        }

        function showCommissions() {
            hideAllSections();
            document.getElementById('commissions').classList.remove('hidden');
            updateActiveNav('Commissions');
            renderCommissions();
        }

        function showCommissionArchive() {
            hideAllSections();
            document.getElementById('commissionArchive').classList.remove('hidden');
            updateActiveNav('Archive commissions');
            renderCommissionArchive();
        }

        function showDaybook() {
            hideAllSections();
            document.getElementById('daybook').classList.remove('hidden');
            updateActiveNav('Daybook');
            // Clear any previous results
            document.getElementById('daybookResults').style.display = 'none';
            document.getElementById('daybookDatePicker').value = '';
        }

        function hideAllSections() {
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('personalDashboard').classList.add('hidden');
            document.getElementById('spadBox').classList.add('hidden');
            document.getElementById('lcBox').classList.add('hidden');
            document.getElementById('archiveBox').classList.add('hidden');
            document.getElementById('invites').classList.add('hidden');
            document.getElementById('inviteArchive').classList.add('hidden');
            document.getElementById('briefings').classList.add('hidden');
            document.getElementById('briefingsArchive').classList.add('hidden');
            document.getElementById('commissions').classList.add('hidden');
            document.getElementById('commissionArchive').classList.add('hidden');
            document.getElementById('daybook').classList.add('hidden');
            document.getElementById('editTeam').classList.add('hidden');
        }

        function updateActiveNav(sectionName) {
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelectorAll('.sidebar a').forEach(link => {
                if (link.textContent.trim() === sectionName) {
                    link.classList.add('active');
                }
            });
        }

        function updateSpAdBox() {
            if (!document.getElementById('spadBox').classList.contains('hidden')) {
                renderSpAdBox();
            }
        }

        function updateLCBox() {
            if (!document.getElementById('lcBox').classList.contains('hidden')) {
                renderLCBox();
            }
        }

        function showUserPrompt() {
            document.getElementById('userPrompt').classList.remove('hidden');
            document.getElementById('personalDashboardContent').classList.add('hidden');
            updateSearchVisibility();
        }

        function loadPersonalDashboard() {
            const userName = document.getElementById('userSelect').value;
            if (!userName) {
                alert('Please select your name first.');
                return;
            }
            
            currentUser = userName;
            document.getElementById('currentUser').textContent = userName;
            document.getElementById('userPrompt').classList.add('hidden');
            document.getElementById('personalDashboardContent').classList.remove('hidden');
            
            filterRowsForUser(userName);
            updateSearchVisibility();
        }

        function filterRowsForUser(userName) {
            const personalGridRows = document.getElementById('personalGridRows');
            personalGridRows.innerHTML = '';
            
            const allSubmissions = loadData('submissions');
            const userSubmissions = allSubmissions.filter(submission => 
                submission.leadPS === userName || submission.leadSpAd === userName
            );
            
            userSubmissions.forEach((data, idx) => {
                const originalIdx = allSubmissions.findIndex(row => 
                    row.submissionTitle === data.submissionTitle && 
                    row.leadPS === data.leadPS
                );
                
                // Calculate working days for display
                const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
                
                // Show draft comments if available, otherwise regular comments
                let commentsDisplay = data.comments || '';
                if (data.spadDraftComments || data.spadDraftBoxNote) {
                    const draftComments = data.spadDraftComments || '';
                    commentsDisplay = draftComments;
                }
                
                // Add urgency reason if item is urgent
                if (data.urgency === 'Urgent' && data.urgencyReason) {
                    const urgencyNote = `[URGENT: ${data.urgencyReason}]`;
                    commentsDisplay = commentsDisplay ? `${urgencyNote} ${commentsDisplay}` : urgencyNote;
                }
                
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${data.urgency || ''}</div>
                    <div class="grid-cell">${data.submissionTitle || ''}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateReceived)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSubmittedSpads)}</div>
                    <div class="grid-cell">${workingDays}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateSpAdComment)}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.dateBoxed)}</div>
                    <div class="grid-cell">${commentsDisplay}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editSubmissionRow(${originalIdx})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteSubmissionRow(${originalIdx})">Delete</button>
                        </div>
                    </div>
                `;
                personalGridRows.appendChild(row);
            });
            
            if (userSubmissions.length === 0) {
                const noDataRow = document.createElement('div');
                noDataRow.className = 'grid-row';
                noDataRow.innerHTML = '<div class="grid-cell" style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">No submissions found for ' + userName + '</div>';
                personalGridRows.appendChild(noDataRow);
            }
        }

        // --- SpAd Comment Modal Functions ---
        let currentSpAdRow = null;

        function openSpAdCommentModal(button) {
            currentSpAdRow = button.closest('.grid-row');
            document.getElementById('spadCommentForm').reset();
            
            // Load any existing draft data
            const cells = currentSpAdRow.querySelectorAll('.grid-cell');
            const submissionTitle = cells[3].textContent;
            const leadPS = cells[0].textContent;
            
            const submissions = loadData('submissions');
            const submission = submissions.find(sub => 
                sub.submissionTitle === submissionTitle && sub.leadPS === leadPS
            );
            
            if (submission && (submission.spadDraftComments || submission.spadDraftBoxNote)) {
                document.getElementById('psComments').value = submission.spadDraftComments || '';
                document.getElementById('boxNote').value = submission.spadDraftBoxNote || '';
            }
            
            document.getElementById('spadCommentModal').style.display = 'block';
        }

        function closeSpAdCommentModal() {
            document.getElementById('spadCommentModal').style.display = 'none';
            document.getElementById('spadCommentForm').reset();
            currentSpAdRow = null;
        }

        function saveSpAdDraft() {
            const psComments = document.getElementById('psComments').value;
            const boxNote = document.getElementById('boxNote').value;
            
            if (!psComments.trim() && !boxNote) {
                alert('Please enter comments and/or confirm box note status before saving.');
                return;
            }
            
            const cells = currentSpAdRow.querySelectorAll('.grid-cell');
            const submissionTitle = cells[3].textContent;
            const leadPS = cells[0].textContent;
            
            // Update the submission in localStorage with draft data
            const submissions = loadData('submissions');
            const submissionIdx = submissions.findIndex(sub => 
                sub.submissionTitle === submissionTitle && sub.leadPS === leadPS
            );
            
            if (submissionIdx !== -1) {
                // Save as draft data (separate from final comments)
                submissions[submissionIdx].spadDraftComments = psComments;
                submissions[submissionIdx].spadDraftBoxNote = boxNote;
                saveData('submissions', submissions);
            }
            
            // Update all views to show draft indicator
            renderSubmissions();
            renderSpAdBox();
            renderLCBox();
            
            // Close modal and show success message
            closeSpAdCommentModal();
            alert('Draft comments saved successfully. You can continue editing later.');
        }

        function submitSpAdComment() {
            const psComments = document.getElementById('psComments').value;
            const boxNote = document.getElementById('boxNote').value;
            
            if (!psComments.trim() && !boxNote) {
                alert('Please enter comments and/or confirm box note status before submitting.');
                return;
            }
            
            const cells = currentSpAdRow.querySelectorAll('.grid-cell');
            const submissionTitle = cells[3].textContent;
            const leadPS = cells[0].textContent;
            
            // Update the SpAd comment date to today
            const today = new Date().toISOString().split('T')[0];
            cells[9].textContent = today;
            
            // Add comments to the comments field
            let existingComments = cells[11].textContent;
            let newComments = '';
            
            if (psComments.trim()) {
                newComments += `SpAd Comments: ${psComments}`;
            }
            if (boxNote) {
                if (newComments) newComments += ' | ';
                newComments += `Box Note Added: ${boxNote}`;
            }
            
            if (existingComments && existingComments.trim()) {
                cells[11].textContent = existingComments + ' | ' + newComments;
            } else {
                cells[11].textContent = newComments;
            }
            
            // Update status to "With PS"
            cells[6].textContent = 'With PS';
            
            // Update the submission in localStorage
            const submissions = loadData('submissions');
            const submissionIdx = submissions.findIndex(sub => 
                sub.submissionTitle === submissionTitle && sub.leadPS === leadPS
            );
            
            if (submissionIdx !== -1) {
                submissions[submissionIdx].dateSpAdComment = today;
                submissions[submissionIdx].comments = cells[11].textContent;
                submissions[submissionIdx].status = 'With PS';
                saveData('submissions', submissions);
            }
            
            // Update all views
            renderSubmissions();
            renderSpAdBox();
            renderLCBox();
            
            closeSpAdCommentModal();
        }

        // --- Current User for Personal Dashboard ---
        let currentUser = null;

        // --- Initialize the application ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Clear any corrupted data first
            try {
                const existingData = loadData('submissions');
                console.log('Existing submissions on load:', existingData);
            } catch (error) {
                console.error('Error loading existing submissions, clearing localStorage:', error);
                localStorage.removeItem('submissions');
            }
            
            // Initialize with sample data if localStorage is empty
            if (loadData('submissions').length === 0) {
                console.log('No submissions found, creating sample data');
                const sampleData = {
                    leadPS: 'Sample PS',
                    leadSpAd: 'Sample SpAd',
                    urgency: 'Routine',
                    submissionTitle: 'Sample Submission',
                    sharepointLink: 'https://sharepoint.com/sample',
                    dateReceived: '2024-01-15',
                    status: 'With SpAds',
                    dateSubmittedSpads: '2024-01-16',
                    workingDays: '3',
                    dateSpAdComment: '2024-01-19',
                    dateBoxed: '2024-01-20',
                    comments: 'Sample comments'
                };
                const submissions = [sampleData];
                saveData('submissions', submissions);
            }
            
            console.log('About to render all sections');
            // Load initial data and render all sections
            renderSubmissions();
            renderSpAdBox();
            renderLCBox();
            renderArchiveSubmissions();
            renderInvites();
            renderArchiveInvites();
            renderBriefings();
            renderArchiveBriefings();
            console.log('All sections rendered');
            
            // Close modals when clicking outside
            window.onclick = function(event) {
                const itemModal = document.getElementById('itemModal');
                const inviteModal = document.getElementById('inviteModal');
                const briefingModal = document.getElementById('briefingModal');
                const spadCommentModal = document.getElementById('spadCommentModal');
                const commissionModal = document.getElementById('commissionModal');
                
                if (event.target === itemModal) {
                    closeModal();
                }
                if (event.target === inviteModal) {
                    closeInviteModal();
                }
                if (event.target === briefingModal) {
                    closeBriefingModal();
                }
                if (event.target === spadCommentModal) {
                    closeSpAdCommentModal();
                }
                if (event.target === commissionModal) {
                    closeCommissionModal();
                }
            };

            const dateSubmittedSpads = document.getElementById('dateSubmittedSpads');
            const dateSpAdComment = document.getElementById('dateSpAdComment');
            
            if (dateSubmittedSpads) {
                dateSubmittedSpads.addEventListener('change', updateWorkingDaysDisplay);
            }
            if (dateSpAdComment) {
                dateSpAdComment.addEventListener('change', updateWorkingDaysDisplay);
            }
        });

        function updateWorkingDaysDisplay() {
            const dateSubmittedSpads = document.getElementById('dateSubmittedSpads').value;
            const dateSpAdComment = document.getElementById('dateSpAdComment').value;
            const workingDaysField = document.getElementById('workingDays');
            
            if (dateSubmittedSpads) {
                const workingDays = calculateWorkingDays(dateSubmittedSpads, dateSpAdComment);
                workingDaysField.value = workingDays;
            } else {
                workingDaysField.value = '';
            }
        }
        // --- Team Management Functions ---
        
        // Default team members
        const defaultPrivateSecretaries = [
            'Ben', 'James', 'Charlotte', 'Sukh', 'Katie', 'Jess', 'Louisa', 
            'Jo', 'Simran', 'Rachel', 'Hugh', 'Marisa', 'Gemma'
        ];
        
        const defaultSpAds = [
            'Sophie', 'Tash', 'Poppy', 'Josh'
        ];
        
        function loadTeamData() {
            const privateSecretaries = JSON.parse(localStorage.getItem('privateSecretaries') || JSON.stringify(defaultPrivateSecretaries));
            const spAds = JSON.parse(localStorage.getItem('spAds') || JSON.stringify(defaultSpAds));
            return { privateSecretaries, spAds };
        }
        
        function saveTeamData(privateSecretaries, spAds) {
            localStorage.setItem('privateSecretaries', JSON.stringify(privateSecretaries));
            localStorage.setItem('spAds', JSON.stringify(spAds));
        }
        
        function showEditTeam() {
            hideAllSections();
            document.getElementById('editTeam').classList.remove('hidden');
            updateActiveNav('Edit team');
            renderTeamLists();
        }
        
        function renderTeamLists() {
            const { privateSecretaries, spAds } = loadTeamData();
            
            // Render Private Secretaries
            const psContainer = document.getElementById('privateSecretariesList');
            psContainer.innerHTML = '';
            privateSecretaries.forEach((name, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <span class="team-member-name">${name}</span>
                    <button class="remove-member-btn" onclick="removePrivateSecretary(${index})">
                        Remove
                    </button>
                `;
                psContainer.appendChild(memberDiv);
            });
            
            // Render SpAds
            const spAdsContainer = document.getElementById('spAdsList');
            spAdsContainer.innerHTML = '';
            spAds.forEach((name, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <span class="team-member-name">${name}</span>
                    <button class="remove-member-btn" onclick="removeSpAd(${index})">
                        Remove
                    </button>
                `;
                spAdsContainer.appendChild(memberDiv);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
        }
        
        function addPrivateSecretary() {
            const nameInput = document.getElementById('newPSName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a name for the Private Secretary.');
                return;
            }
            
            const { privateSecretaries, spAds } = loadTeamData();
            
            if (privateSecretaries.includes(name)) {
                alert('This Private Secretary already exists.');
                return;
            }
            
            privateSecretaries.push(name);
            saveTeamData(privateSecretaries, spAds);
            nameInput.value = '';
            renderTeamLists();
        }
        
        function addSpAd() {
            const nameInput = document.getElementById('newSpAdName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a name for the SpAd.');
                return;
            }
            
            const { privateSecretaries, spAds } = loadTeamData();
            
            if (spAds.includes(name)) {
                alert('This SpAd already exists.');
                return;
            }
            
            spAds.push(name);
            saveTeamData(privateSecretaries, spAds);
            nameInput.value = '';
            renderTeamLists();
        }
        
        function removePrivateSecretary(index) {
            const { privateSecretaries, spAds } = loadTeamData();
            const nameToRemove = privateSecretaries[index];
            
            if (confirm(`Are you sure you want to remove ${nameToRemove}?`)) {
                privateSecretaries.splice(index, 1);
                saveTeamData(privateSecretaries, spAds);
                renderTeamLists();
            }
        }
        
        function removeSpAd(index) {
            const { privateSecretaries, spAds } = loadTeamData();
            const nameToRemove = spAds[index];
            
            if (confirm(`Are you sure you want to remove ${nameToRemove}?`)) {
                spAds.splice(index, 1);
                saveTeamData(privateSecretaries, spAds);
                renderTeamLists();
            }
        }
        
        function saveTeamChanges() {
            updateAllDropdowns();
            alert('Team changes saved successfully!');
        }
        
        function updateAllDropdowns() {
            const { privateSecretaries, spAds } = loadTeamData();
            
            // Update all Private Secretary dropdowns
            const psDropdowns = [
                'leadPS', 'briefingLeadPS', 'inviteLeadPS'
            ];
            
            psDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select...</option>';
                    
                    privateSecretaries.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        dropdown.appendChild(option);
                    });
                    
                    // Restore selected value if it still exists
                    if (privateSecretaries.includes(currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
            
            // Update SpAd dropdowns
            const spAdDropdowns = [
                'leadSpAd', 'briefingLeadSpAd'
            ];
            
            spAdDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select...</option>';
                    
                    spAds.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        dropdown.appendChild(option);
                    });
                    
                    // Add "No SpAd review" option
                    const noSpAdOption = document.createElement('option');
                    noSpAdOption.value = 'No SpAd review';
                    noSpAdOption.textContent = 'No SpAd review';
                    dropdown.appendChild(noSpAdOption);
                    
                    // Restore selected value if it still exists
                    if (spAds.includes(currentValue) || currentValue === 'No SpAd review') {
                        dropdown.value = currentValue;
                    }
                }
            });
            
            // Update user select dropdown in personal dashboard
            const userSelect = document.getElementById('userSelect');
            if (userSelect) {
                const currentValue = userSelect.value;
                userSelect.innerHTML = '<option value="">Select your name...</option>';
                
                // Add Private Secretaries optgroup
                const psOptgroup = document.createElement('optgroup');
                psOptgroup.label = 'Private Secretaries';
                privateSecretaries.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    psOptgroup.appendChild(option);
                });
                userSelect.appendChild(psOptgroup);
                
                // Add SpAds optgroup
                const spAdOptgroup = document.createElement('optgroup');
                spAdOptgroup.label = 'SpAds';
                spAds.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    spAdOptgroup.appendChild(option);
                });
                userSelect.appendChild(spAdOptgroup);
                
                // Restore selected value if it still exists
                if (privateSecretaries.includes(currentValue) || spAds.includes(currentValue)) {
                    userSelect.value = currentValue;
                }
            }
        }
        
        // --- Search Functionality ---
        let currentSearchTerm = '';
        
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    currentSearchTerm = searchTerm;
                    
                    if (searchTerm) {
                        searchClear.classList.add('visible');
                    } else {
                        searchClear.classList.remove('visible');
                    }
                    
                    // Perform search on current page
                    performSearch(searchTerm);
                });
                
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        clearSearch();
                    }
                });
            }
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            if (searchInput) {
                searchInput.value = '';
                currentSearchTerm = '';
                searchClear.classList.remove('visible');
                performSearch('');
            }
        }
        
        function performSearch(searchTerm) {
            // Get currently active page
            const activeSection = document.querySelector('.main-content > div:not(.hidden)');
            if (!activeSection) return;
            
            const sectionId = activeSection.id;
            
            // Apply search based on current section
            switch(sectionId) {
                case 'mainDashboard':
                    searchInGrid(searchTerm, '#mainDashboard .grid-row');
                    break;
                case 'personalDashboard':
                    if (!document.getElementById('userPrompt').classList.contains('hidden')) {
                        // User prompt is showing, no search needed
                        return;
                    }
                    searchInGrid(searchTerm, '#personalGridRows .grid-row');
                    break;
                case 'spadBox':
                    searchInGrid(searchTerm, '#spadGridRows .grid-row');
                    break;
                case 'lcBox':
                    searchInGrid(searchTerm, '#lcGridRows .grid-row');
                    break;
                case 'archiveBox':
                    searchInGrid(searchTerm, '#archiveGridRows .grid-row');
                    break;
                case 'invites':
                    searchInGrid(searchTerm, '#inviteGridRows .grid-row');
                    break;
                case 'inviteArchive':
                    searchInGrid(searchTerm, '#inviteArchiveGridRows .grid-row');
                    break;
                case 'briefings':
                    searchInGrid(searchTerm, '#briefingGridRows .grid-row');
                    break;
                case 'briefingsArchive':
                    searchInGrid(searchTerm, '#briefingsArchiveGridRows .grid-row');
                    break;
                case 'commissions':
                    searchInGrid(searchTerm, '#commissionGridRows .grid-row');
                    break;
                case 'commissionArchive':
                    searchInGrid(searchTerm, '#commissionArchiveGridRows .grid-row');
                    break;
                case 'daybook':
                    searchInGrid(searchTerm, '#daybookGridRows .grid-row');
                    break;
                case 'editTeam':
                    searchInTeam(searchTerm);
                    break;
                default:
                    break;
            }
        }
        
        function reapplyCurrentSearch() {
            if (currentSearchTerm) {
                performSearch(currentSearchTerm);
            }
        }
        
        function searchInGrid(searchTerm, selector) {
            const rows = document.querySelectorAll(selector);
            
            rows.forEach(row => {
                if (!searchTerm) {
                    row.style.display = '';
                    return;
                }
                
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function searchInTeam(searchTerm) {
            const psMembers = document.querySelectorAll('#privateSecretariesList .team-member');
            const spadMembers = document.querySelectorAll('#spAdsList .team-member');
            
            [...psMembers, ...spadMembers].forEach(member => {
                if (!searchTerm) {
                    member.style.display = '';
                    return;
                }
                
                const text = member.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    member.style.display = '';
                } else {
                    member.style.display = 'none';
                }
            });
        }
        
        function updateSearchVisibility() {
            const searchContainer = document.getElementById('searchContainer');
            const activeSection = document.querySelector('.main-content > div:not(.hidden)');
            
            if (!searchContainer || !activeSection) return;
            
            const sectionId = activeSection.id;
            
            // Show search on all pages except when user prompt is visible in personal dashboard
            if (sectionId === 'personalDashboard' && !document.getElementById('userPrompt').classList.contains('hidden')) {
                searchContainer.classList.add('hidden');
            } else {
                searchContainer.classList.remove('hidden');
            }
        }
        
        // --- Update existing navigation functions to handle search ---
        function hideAllSections() {
            const sections = document.querySelectorAll('.main-content > div');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Clear search when switching pages
            if (currentSearchTerm) {
                clearSearch();
            }
            
            // Update search visibility
            setTimeout(updateSearchVisibility, 100);
        }
        
        // Initialize dropdowns on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateAllDropdowns();
            initializeSearch();
            updateSearchVisibility();
        });

        // --- Daybook Functions ---
        function filterBriefingsByDate() {
            const selectedDate = document.getElementById('daybookDatePicker').value;
            
            if (!selectedDate) {
                alert('Please select a date to view briefings.');
                return;
            }
            
            // Load briefings data
            const briefings = loadData('briefings');
            const archiveBriefings = loadData('archiveBriefings') || [];
            const allBriefings = [...briefings, ...archiveBriefings];
            
            // Filter briefings by selected date
            const filteredBriefings = allBriefings.filter(briefing => {
                return briefing.date === selectedDate;
            });
            
            // Sort by time (earliest first)
            filteredBriefings.sort((a, b) => {
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                return timeA.localeCompare(timeB);
            });
            
            // Display results
            displayDaybookResults(selectedDate, filteredBriefings);
        }
        
        function displayDaybookResults(selectedDate, briefings) {
            const resultsContainer = document.getElementById('daybookResults');
            const dateHeader = document.getElementById('daybookDateHeader');
            const gridRows = document.getElementById('daybookGridRows');
            const noResultsDiv = document.getElementById('daybookNoResults');
            
            // Show results container
            resultsContainer.style.display = 'block';
            
            // Format and display the selected date
            const formattedDate = formatDateForDisplay(selectedDate);
            dateHeader.textContent = `Briefings for ${formattedDate}`;
            
            // Clear previous results
            gridRows.innerHTML = '';
            
            if (briefings.length === 0) {
                // Show no results message
                noResultsDiv.style.display = 'block';
                document.querySelector('.submissions-grid').style.display = 'none';
            } else {
                // Hide no results message and show grid
                noResultsDiv.style.display = 'none';
                document.querySelector('#daybookResults .submissions-grid').style.display = 'block';
                
                // Populate grid with briefings
                briefings.forEach((briefing) => {
                    const row = document.createElement('div');
                    row.className = 'grid-row';
                    row.innerHTML = `
                        <div class="grid-cell">${briefing.leadPS || ''}</div>
                        <div class="grid-cell">${briefing.leadSpAd || ''}</div>
                        <div class="grid-cell">${briefing.time || ''}</div>
                        <div class="grid-cell">${briefing.title || ''}</div>
                        <div class="grid-cell">${formatDateForDisplay(briefing.commissionDeadline)}</div>
                        <div class="grid-cell">${formatUrlForDisplay(briefing.sharepointLink)}</div>
                        <div class="grid-cell">${briefing.psComments || ''}</div>
                        <div class="grid-cell">${briefing.spadComments || ''}</div>
                    `;
                    gridRows.appendChild(row);
                });
            }
        }
        
        function clearDaybookFilter() {
            document.getElementById('daybookDatePicker').value = '';
            document.getElementById('daybookResults').style.display = 'none';
        }

    </script>
</body>
</html>
