
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Box</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            background-color: #f0f6ff;
            color: #333;
        }

        .global-header {
            background-color: #ffffff;
            color: #c41e3a;
            text-align: center;
            padding: 20px 0;
            font-size: 2.2em;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 3px solid #c41e3a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .briefcase-icon {
            width: 60px;
            height: 45px;
            border: 3px solid #c41e3a;
            border-radius: 8px;
            position: relative;
            background-color: #f8f8f8;
        }

        .briefcase-icon::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 15px;
            height: 8px;
            background-color: #c41e3a;
            border-radius: 3px 3px 0 0;
        }

        .briefcase-icon::after {
            content: 'ER';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: #c41e3a;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
        }

        .crown-symbol {
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            color: #c41e3a;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 60px); /* Adjust for header height */
        }

        .sidebar {
            min-width: 250px;
            max-width: 250px;
            width: 250px;
            background-color: #d6e8ff;
            padding: 20px;
            border-right: 1px solid #b3d4ff;
            flex-shrink: 0;
        }

        .sidebar h2 {
            color: #2c5aa0;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar > ul > li {
            margin-bottom: 10px;
        }

        .sidebar a {
            display: block;
            padding: 10px 15px;
            color: #2c5aa0;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background-color: #b3d4ff;
        }

        .archive-section {
            margin-top: 20px;
        }

        .archive-heading {
            display: block;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 10px;
            padding: 10px 15px;
            background-color: #c7deff;
            border-radius: 5px;
        }

        .archive-submenu {
            margin-left: 15px;
        }

        .archive-submenu li {
            margin-bottom: 5px;
        }

        .archive-submenu a {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        header h1 {
            color: #2c5aa0;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .submissions-grid {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(44, 90, 160, 0.1);
            border: 1px solid #e0f0ff;
            padding: 20px;
            overflow-x: auto;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            position: relative;
        }

        /* Base grid system - consistent sizing for all tables */
        .grid-header {
            display: grid;
            gap: 8px;
            margin-bottom: 15px;
            padding: 15px 10px;
            background-color: #d6e8ff;
            border-radius: 5px;
            font-weight: bold;
            color: #2c5aa0;
            align-items: center;
            min-width: 1250px; /* Minimum width to prevent compression */
            min-height: 60px; /* Allow more height for wrapped text */
        }

        .grid-header > div {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 36px;
            padding: 0 4px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.2;
            text-align: center;
        }

        /* Ensure invite headers match exactly with rows */
        .invite-header {
            display: grid;
            gap: 8px;
            grid-template-columns: 140px 120px 85px 85px 85px 160px 130px 130px 120px;
            min-width: 1055px;
        }

        /* Ensure briefing headers match exactly with rows */
        .briefing-header {
            display: grid;
            gap: 8px;
            grid-template-columns: 120px 70px 110px 100px 130px 130px 120px 115px 115px 100px;
            min-width: 1110px;
        }

        /* Ensure commission headers match exactly with rows */
        .commission-header {
            display: grid;
            gap: 8px;
            grid-template-columns: 320px 150px 150px 130px 160px;
            min-width: 910px;
        }

        /* Ensure daybook headers match exactly with rows */
        .daybook-header {
            display: grid;
            gap: 8px;
            grid-template-columns: 130px 80px 100px 170px 150px 170px 150px 150px;
            min-width: 1200px;
        }

        .grid-row {
            display: grid;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
            min-height: 50px;
            align-items: center;
            min-width: 1250px; /* Minimum width to prevent compression */
        }

        /* Default grid layout for Box work and Archive box */
        .grid-header:not(.invite-header):not(.briefing-header):not(.commission-header):not(.commission-archive-header):not(.daybook-header),
        .grid-row:not(.invite-row):not(.briefing-row):not(.commission-row):not(.daybook-row) {
            grid-template-columns: 140px 100px 90px 150px 180px 120px 130px 180px 160px;
        }

        .grid-cell {
            padding: 4px;
            font-size: 11px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.2;
            display: flex;
            align-items: center;
            min-height: 24px;
            overflow: hidden;
        }

        .grid-cell.actions-cell {
            padding: 2px;
            overflow: visible;
            min-width: 0;
        }

        .grid-cell input,
        .grid-cell select,
        .grid-cell textarea {
            width: 100%;
            padding: 4px;
            border: 1px solid #b3d4ff;
            border-radius: 4px;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 11px;
        }

        .grid-cell textarea {
            resize: vertical;
            min-height: 30px;
        }

        .grid-cell select[multiple] {
            height: 40px;
        }

        .add-row-btn {
            background-color: #2c5aa0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-top: 15px;
        }

        .add-row-btn:hover {
            background-color: #1e3f7a;
        }

        .add-item-btn {
            background-color: white;
            color: #2c5aa0;
            border: 2px solid #2c5aa0;
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }

        .add-item-btn:hover {
            background-color: #2c5aa0;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            color: #2c5aa0;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #2c5aa0;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #b3d4ff;
            border-radius: 4px;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group select[multiple] {
            height: 100px;
        }

        /* Readonly select styling */
        select[readonly] {
            pointer-events: none;
            background-color: #f5f5f5 !important;
            color: #666 !important;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* Manual override checkbox styling */
        .form-group label .manual-override-label {
            font-size: 11px;
            font-weight: normal;
            color: #666;
            margin-left: 10px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .form-group label .manual-override-label input[type="checkbox"] {
            margin: 0;
            padding: 0;
            width: auto;
            height: auto;
            transform: scale(0.9);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .form-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .btn-add {
            background-color: #2c5aa0;
            color: white;
        }

        .btn-submit-spads {
            background-color: #1e4a7a;
            color: white;
        }

        .btn-submit-lc {
            background-color: #3d6bb0;
            color: white;
        }

        .btn-submit-archive {
            background-color: #5a7cb0;
            color: white;
        }

        .btn-cancel {
            background-color: #dc3545;
            color: white;
        }

        .form-btn:hover {
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .action-btn {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-weight: 500;
            white-space: nowrap;
            margin: 0;
            min-width: 40px;
            max-width: 100%;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: all 0.2s ease;
            position: relative;
            box-sizing: border-box;
            flex: 0 0 auto;
        }

        .edit-btn {
            background-color: #4d7bc0;
            color: white;
            border: 1px solid #3c6bb5;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: 1px solid #c82333;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Tooltip styles for action buttons */
        .action-btn::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            margin-bottom: 5px;
        }

        .action-btn:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .user-prompt {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(44, 90, 160, 0.1);
            border: 1px solid #e0f0ff;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .user-prompt h2 {
            color: #2c5aa0;
            margin-bottom: 20px;
        }

        .user-prompt select {
            width: 100%;
            padding: 10px;
            border: 1px solid #b3d4ff;
            border-radius: 4px;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .user-prompt button {
            background-color: #2c5aa0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-right: 10px;
        }

        .user-prompt button:hover {
            background-color: #1e3f7a;
        }

        .user-prompt button.secondary {
            background-color: #5a88d0;
        }

        .user-prompt button.secondary:hover {
            background-color: #4d7bc0;
        }

        .user-info {
            background-color: #e3f2fd;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .user-info span {
            color: #2c5aa0;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .spad-comment-btn {
            background-color: #3d6bb0;
            color: white;
            padding: 8px 12px;
            border: 1px solid #2c5aa0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-width: 120px;
            position: relative;
        }

        .spad-comment-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Tooltip styles for SpAd comment button */
        .spad-comment-btn::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            margin-bottom: 5px;
        }

        .spad-comment-btn:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .spad-comment-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .spad-comment-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border: none;
            border-radius: 8px;
            width: 60%;
            max-width: 600px;
        }

        .spad-comment-form-group {
            margin-bottom: 20px;
        }

        .spad-comment-form-group label {
            display: block;
            color: #2c5aa0;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .spad-comment-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #b3d4ff;
            border-radius: 4px;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }

        .spad-comment-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .spad-comment-btn-submit {
            background-color: #2c5aa0;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .spad-comment-btn-cancel {
            background-color: #dc3545;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .spad-comment-btn-submit:hover,
        .spad-comment-btn-cancel:hover {
            opacity: 0.9;
        }

        .url-cell {
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 10px;
            color: #0066cc;
            text-decoration: none;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .url-cell:hover {
            color: #004499;
            text-decoration: underline;
        }

        .url-display {
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 10px;
            color: #0066cc;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Responsive improvements for action buttons */
        @media (max-width: 1200px) {
            .action-btn {
                min-width: 35px;
                padding: 4px 6px;
                font-size: 9px;
            }
            
            .action-buttons {
                gap: 2px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            header h1 {
                font-size: 2em;
            }

            /* Keep table structure intact on mobile - just enable horizontal scrolling */
            .submissions-grid {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                padding: 15px;
            }
            
            /* Reduce font sizes slightly for better mobile readability */
            .grid-header > div {
                font-size: 10px;
                padding: 0 2px;
            }
            
            .grid-cell {
                font-size: 9px;
                padding: 2px;
            }
            
            .action-buttons {
                gap: 2px;
            }
            
            .action-btn {
                min-width: 28px;
                padding: 3px 5px;
                font-size: 8px;
                height: 24px;
            }
            
            /* Add visual indicator that table is scrollable */
            .submissions-grid::after {
                content: "← Scroll horizontally to view all columns →";
                display: block;
                text-align: center;
                font-size: 11px;
                color: #666;
                font-style: italic;
                margin-top: 10px;
                padding: 5px;
            }
        }

        /* Additional styles for very narrow screens */
        @media (max-width: 480px) {
            .submissions-grid {
                padding: 10px;
                margin: 0 -10px; /* Extend to edges */
            }
            
            .grid-header > div {
                font-size: 9px;
                padding: 0 1px;
            }
            
            .grid-cell {
                font-size: 8px;
                padding: 1px;
            }
            
            .action-btn {
                min-width: 24px;
                padding: 2px 4px;
                font-size: 7px;
                height: 20px;
            }
            
            /* Make buttons slightly smaller on very narrow screens */
            .add-item-btn {
                font-size: 14px;
                padding: 10px 20px;
            }
        }

        /* Zoom stability - prevent layout shift on browser zoom */
        .submissions-grid {
            transform-origin: top left;
            will-change: transform;
        }

        /* Ensure tables maintain consistent sizing across different zoom levels */
        .grid-header,
        .grid-row {
            box-sizing: border-box;
            transform-origin: top left;
        }

        /* Prevent text wrapping that could cause layout shifts */
        .grid-cell {
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Allow specific cells to wrap when needed */
        .grid-cell textarea,
        .grid-cell input[type="text"],
        .grid-cell.comments-cell {
            white-space: normal;
            word-wrap: break-word;
        }

        /* Force table structure to remain intact on all screen sizes */
        .grid-header,
        .grid-row {
            display: grid !important;
            /* Prevent any CSS from collapsing the grid */
        }

        /* Ensure minimum widths are respected even on mobile */
        @media (max-width: 768px) {
            /* Default grid layout for Box work and Archive box - maintain structure */
            .grid-header:not(.invite-header):not(.briefing-header):not(.commission-header):not(.commission-archive-header):not(.daybook-header),
            .grid-row:not(.invite-row):not(.briefing-row):not(.commission-row):not(.daybook-row) {
                grid-template-columns: 140px 100px 90px 150px 180px 120px 130px 180px 160px;
                min-width: 1250px;
                display: grid;
                gap: 8px;
            }
            
            /* Invite tables - maintain structure */
            .invite-header,
            .invite-row,
            #inviteGridRows .grid-row,
            #inviteArchiveGridRows .grid-row {
                grid-template-columns: 140px 120px 85px 85px 85px 160px 130px 130px 120px;
                min-width: 1055px;
                display: grid;
                gap: 8px;
            }
            
            /* Briefing tables - maintain structure */
            .briefing-header,
            .briefing-row,
            #briefingGridRows .grid-row,
            #briefingsArchiveGridRows .grid-row {
                grid-template-columns: 120px 70px 110px 100px 130px 130px 120px 115px 115px 100px;
                min-width: 1110px;
                display: grid;
                gap: 8px;
            }

            /* Daybook tables - maintain structure */
            .daybook-header,
            .daybook-row,
            #daybookGridRows .grid-row {
                grid-template-columns: 130px 80px 100px 170px 150px 170px 150px 150px;
                min-width: 1200px;
                display: grid;
                gap: 8px;
            }

            /* Commission tables - maintain structure */
            .commission-header,
            .commission-row,
            #commissionGridRows .grid-row,
            .commission-archive-header,
            .commission-archive-row,
            #commissionArchiveGridRows .grid-row {
                grid-template-columns: 320px 150px 150px 130px 160px;
                min-width: 910px;
                display: grid;
                gap: 8px;
            }
        }

        /* Additional CSS for invite grid rows - consolidated and cleaned */
        .invite-header,
        .invite-row,
        #inviteGridRows .grid-row,
        #inviteArchiveGridRows .grid-row {
            grid-template-columns: 140px 120px 85px 85px 85px 160px 130px 130px 120px;
            min-width: 1055px;
            display: grid;
            gap: 8px;
        }
        
        /* Specific styling for invite data rows (not headers) */
        .invite-row,
        #inviteGridRows .grid-row,
        #inviteArchiveGridRows .grid-row {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
            min-height: 50px;
            align-items: center;
        }
        
        /* Briefings grid layout - consolidated and cleaned */
        .briefing-header,
        .briefing-row,
        #briefingGridRows .grid-row,
        #briefingsArchiveGridRows .grid-row {
            grid-template-columns: 120px 70px 110px 100px 130px 130px 120px 115px 115px 100px;
            min-width: 1110px;
            display: grid;
            gap: 8px;
        }

        /* Specific styling for briefing data rows (not headers) */
        .briefing-row,
        #briefingGridRows .grid-row,
        #briefingsArchiveGridRows .grid-row {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
            min-height: 50px;
            align-items: center;
        }

        /* Daybook grid layout (no actions column) */
        .daybook-header,
        .daybook-row,
        #daybookGridRows .grid-row {
            grid-template-columns: 130px 80px 100px 170px 150px 170px 150px 150px;
            min-width: 1200px;
        }

        /* Override the default grid-row class for daybook rows */
        #daybookGridRows .grid-row {
            display: grid;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
            min-height: 50px;
            align-items: center;
        }

        /* Commission grid layout */
        .commission-header,
        .commission-row,
        #commissionGridRows .grid-row {
            grid-template-columns: 320px 150px 150px 130px 160px;
            min-width: 910px;
        }
        
        .commission-archive-header,
        .commission-archive-row,
        #commissionArchiveGridRows .grid-row {
            grid-template-columns: 320px 150px 150px 130px 160px;
            min-width: 910px;
        }

        /* Override the default grid-row class for commission rows */
        #commissionGridRows .grid-row,
        #commissionArchiveGridRows .grid-row {
            display: grid;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8fbff;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
            min-height: 50px;
            align-items: center;
        }

        .commission-header,
        .commission-archive-header {
            background-color: #d6e8ff;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 15px;
        }

        /* Team Management Styles */
        .team-management {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .add-member-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-member-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .team-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .team-member {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .team-member:hover {
            background-color: #f0f0f0;
        }

        .team-member-name {
            font-weight: 500;
            color: #333;
        }

        .remove-member-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-member-btn:hover {
            background-color: #c82333;
        }

        .remove-member-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .remove-member-btn:disabled:hover {
            background-color: #6c757d;
        }

        .default-member {
            opacity: 0.6;
        }

        .default-member .remove-member-btn {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .default-member .remove-member-btn:hover {
            background-color: #6c757d;
        }

        /* Highlight rows that have been with SpAds for more than 5 working days */
        .overdue-spad-row {
            background-color: #ffe6e6 !important;
            border-color: #ffb3b3 !important;
        }

        .overdue-spad-row .grid-cell {
            background-color: transparent;
        }

        /* Styling for urgency reasons in comments */
        .grid-cell:has-text("[URGENT:") {
            font-weight: bold;
        }
        
        /* Alternative approach for urgency highlighting */
        .urgent-item {
            border-left: 4px solid #dc3545;
        }
        
        .urgent-item .grid-cell:first-child {
            border-left: none;
        }

        /* Search field styling */
        .search-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: white;
            border: 2px solid #2c5aa0;
            border-radius: 25px;
            padding: 10px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 250px;
        }

        .search-input {
            border: none;
            outline: none;
            flex: 1;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 14px;
            background: transparent;
        }

        .search-input::placeholder {
            color: #666;
        }

        .search-icon {
            color: #2c5aa0;
            font-size: 16px;
        }

        .search-clear {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: none;
        }

        .search-clear:hover {
            color: #666;
        }

        .search-clear.visible {
            display: block;
        }

        /* Hide/show search based on page */
        .search-container.hidden {
            display: none;
        }

        /* Dashboard Summary Cards */
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .status-card {
            background: #e8f4f8;
            color: #2c5aa0;
            border: 2px solid #2c5aa0;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.1);
            position: relative;
            overflow: hidden;
        }

        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.2);
            background: #dbeafe;
        }

        .status-card.urgent {
            background: #fee;
            color: #dc3545;
            border-color: #dc3545;
        }

        .status-card.urgent:hover {
            background: #fdd;
        }

        .status-card.warning {
            background: #e8f4f8;
            color: #2c5aa0;
            border-color: #2c5aa0;
        }

        .status-card.success {
            background: #e8f4f8;
            color: #2c5aa0;
            border-color: #2c5aa0;
        }

        .status-card h3 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            font-weight: bold;
            color: inherit;
        }

        .status-card p {
            margin: 0;
            font-size: 0.9em;
            color: inherit;
            opacity: 0.8;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(44, 90, 160, 0.05);
            transform: rotate(45deg);
            transition: all 0.3s ease;
        }

        .status-card:hover::before {
            top: -30%;
            right: -30%;
            background: rgba(44, 90, 160, 0.1);
        }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .quick-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
            margin: 0 2px;
            min-width: 50px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }

        .quick-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .urgent-btn {
            background-color: #ff8c00 !important;
            border-color: #e67c00 !important;
            color: white;
        }

        .spad-btn {
            background-color: #3d6bb0 !important;
            border-color: #2c5aa0 !important;
            color: white;
        }

        .spad-comment-btn {
            background-color: #3d6bb0 !important;
            border-color: #2c5aa0 !important;
            color: white;
        }

        .lc-btn {
            background-color: #4d7bc0 !important;
            border-color: #3c6bb5 !important;
            color: white;
        }

        /* Inline Status Editing */
        .inline-status {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #b3d4ff;
            border-radius: 3px;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            font-size: 10px;
            background-color: white;
            height: 24px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
        }

        .inline-status:focus {
            outline: 2px solid #2c5aa0;
            border-color: #2c5aa0;
        }

        /* Quick Filter Buttons */
        .quick-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            background-color: white;
            color: #2c5aa0;
            border: 2px solid #2c5aa0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
            transition: all 0.2s ease;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background-color: #2c5aa0;
            color: white;
        }

        .filter-btn.urgent {
            background-color: white;
            color: #2c5aa0;
            border: 2px solid #2c5aa0;
        }

        .filter-btn.urgent:hover,
        .filter-btn.urgent.active {
            background-color: #2c5aa0;
            color: white;
        }

        /* Daybook section font styling */
        #daybook,
        #daybook * {
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif !important;
        }

        /* Disabled checkbox styling for process management */
        .team-management input[type="checkbox"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .team-management label:has(input[type="checkbox"]:disabled) {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Process management grid styling */
        .team-management input[type="checkbox"] {
            transform: scale(1.1);
            margin-right: 8px;
        }

        .team-management label {
            user-select: none;
            transition: opacity 0.2s ease;
        }

        .team-management label:hover:not(:has(input:disabled)) {
            background-color: rgba(44, 90, 160, 0.05);
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
        }

        /* Dependency styling */
        .dependency-note {
            color: #666 !important;
            font-size: 11px !important;
            font-style: italic !important;
            margin-left: 8px !important;
        }

        /* Duty Rota Styles */
        .duty-rota-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .rota-schedule {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(44, 90, 160, 0.1);
            border: 1px solid #e0f0ff;
            padding: 20px;
        }

        .rota-controls {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(44, 90, 160, 0.1);
            border: 1px solid #e0f0ff;
            padding: 20px;
            box-sizing: border-box;
            width: 100%;
            min-width: 0;
            overflow: hidden;
        }

        .rota-week {
            margin-bottom: 30px;
            border: 2px solid #e0f0ff;
            border-radius: 8px;
            overflow: hidden;
        }

        .rota-week-header {
            background-color: #2c5aa0;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rota-week-dates {
            font-size: 14px;
            opacity: 0.9;
        }

        .rota-week-content {
            padding: 20px;
            background-color: #f8fbff;
        }

        .duty-row {
            display: grid;
            grid-template-columns: 150px 1fr 60px;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #e0f0ff;
        }

        .duty-role {
            font-weight: bold;
            color: #2c5aa0;
            font-size: 14px;
        }

        .duty-person {
            font-size: 14px;
            color: #333;
        }

        .duty-person.unavailable {
            color: #dc3545;
            font-style: italic;
        }

        .duty-person.override {
            color: #ff8c00;
            font-weight: bold;
        }

        .duty-edit-btn {
            background-color: #4d7bc0;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .duty-edit-btn:hover {
            background-color: #3c6bb5;
        }

        .leave-form {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            box-sizing: border-box;
            width: 100%;
            overflow: hidden;
        }

        .leave-form h4 {
            color: #2c5aa0;
            margin-bottom: 15px;
        }

        .leave-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .leave-input-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            width: 100%;
            min-width: 0;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
        }

        .leave-reason-input {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
        }

        .leave-submit-btn {
            background-color: #2c5aa0;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 10px;
            box-sizing: border-box;
            font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif;
        }

        .leave-submit-btn:hover {
            background-color: #1e3f7a;
        }

        .leave-list {
            margin-top: 20px;
        }

        .leave-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .leave-item.pending {
            border-color: #ff8c00;
            background-color: #fff3cd;
        }

        .leave-item.approved {
            border-color: #28a745;
            background-color: #d4edda;
        }

        .leave-remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .manual-override-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3cd;
            border: 2px solid #ff8c00;
            border-radius: 5px;
        }

        .manual-override-section h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .override-controls {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .override-controls select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rota-legend {
            margin-top: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 5px;
            font-size: 12px;
        }

        .rota-legend h4 {
            color: #2c5aa0;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 8px;
        }

        .legend-color.normal {
            background-color: #333;
        }

        .legend-color.unavailable {
            background-color: #dc3545;
        }

        .legend-color.override {
            background-color: #ff8c00;
        }

        .permission-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .permission-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border: none;
            border-radius: 8px;
            width: 60%;
            max-width: 500px;
        }

        @media (max-width: 1024px) {
            .duty-rota-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

    </style>
</head>
<body>
    <div class="global-header">
        <div class="header-content">
            <div class="header-text">
                RED BOX
            </div>
            <div class="briefcase-icon">
                <div class="crown-symbol">♔</div>
            </div>
        </div>
    </div>
    <div class="container">
        <nav class="sidebar">
            <h2>Navigation</h2>
            <ul>
                <li><a href="#" onclick="showMainDashboard()">Box work</a></li>
                <li><a href="#" onclick="showBriefings()">Briefings</a></li>
                <li><a href="#" onclick="showCommissions()">Commissions</a></li>
                <li><a href="#" onclick="showInvites()">Invites</a></li>
                <li><a href="#" onclick="showDaybook()">Daybook</a></li>
                <li><a href="#" onclick="showDutyRota()">Duty rota</a></li>
                <li class="archive-section">
                    <span class="archive-heading">Archives</span>
                    <ul class="archive-submenu">
                        <li><a href="#" onclick="showArchiveBox()">Archive box</a></li>
                        <li><a href="#" onclick="showInviteArchive()">Archive invites</a></li>
                        <li><a href="#" onclick="showBriefingsArchive()">Archive briefings</a></li>
                        <li><a href="#" onclick="showCommissionArchive()">Archive commissions</a></li>
                    </ul>
                </li>
                <li><a href="#" onclick="showEditTeam()">Settings</a></li>
            </ul>
        </nav>
        
        <main class="main-content">
            <div id="mainDashboard">
                <header>
                    <h1>Box work</h1>
                    <p style="color: #333; font-size: 16px; margin-top: 8px; margin-bottom: 20px;">Manage box work and ministerial advice</p>
                </header>
                
                <!-- Dashboard Summary Cards -->
                <div class="dashboard-summary">
                    <div class="status-card" onclick="filterByStatus('With SpAds')" title="Click to view items with SpAds">
                        <h3 id="spadCount">0</h3>
                        <p>With SpAds</p>
                    </div>
                    <div class="status-card urgent" onclick="filterByUrgency('Urgent')" title="Click to view urgent items">
                        <h3 id="urgentCount">0</h3>
                        <p>Urgent Items</p>
                    </div>
                    <div class="status-card success" onclick="filterByStatus('Ready for the box')" title="Click to view items ready for box">
                        <h3 id="lcReadyCount">0</h3>
                        <p>Ready for box</p>
                    </div>
                    <div class="status-card warning" onclick="showOverdueItems()" title="Click to view overdue items">
                        <h3 id="overdueCount">0</h3>
                        <p>Overdue (5+ days)</p>
                    </div>
                </div>

                <!-- Quick Filters -->
                <div class="quick-filters">
                    <button class="filter-btn active" onclick="clearAllFilters()">All Items</button>
                    <button class="filter-btn" onclick="filterByCurrentUser()">My Items</button>
                    <button class="filter-btn urgent" onclick="filterByUrgency('Urgent')">Urgent Only</button>
                    <button class="filter-btn" onclick="filterByStatus('With SpAds')">With SpAds</button>
                    <button class="filter-btn" onclick="filterByStatus('Ready for the box')">Ready for box</button>
                    <button class="filter-btn" onclick="showOverdueItems()">Overdue</button>
                </div>
                
                <button class="add-item-btn" onclick="openModal()">Add item to grid</button>
                
                <div class="submissions-grid">
                    <div class="grid-header">
                        <div>Private Secretary</div>
                        <div>SpAd</div>
                        <div>Urgency</div>
                        <div>Title</div>
                        <div>SharePoint Link</div>
                        <div>Status</div>
                        <div>Days with SpAds</div>
                        <div>Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="gridRows">
                        <!-- Submission rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="archiveBox" class="hidden">
                <header>
                    <h1>Archive box</h1>
                    <p style="color: #666; margin-bottom: 30px;">Completed submissions</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header">
                        <div>Private Secretary</div>
                        <div>SpAd</div>
                        <div>Urgency</div>
                        <div>Title</div>
                        <div>SharePoint Link</div>
                        <div>Status</div>
                        <div>Days with SpAds</div>
                        <div>Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="archiveGridRows">
                        <!-- Archived submissions will be populated here -->
                    </div>
                </div>
            </div>

            <div id="invites" class="hidden">
                <header>
                    <h1>Invites</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage invitations and events</p>
                </header>
                
                <button class="add-item-btn" onclick="openInviteModal()">Add invite</button>
                
                <div class="submissions-grid">
                    <div class="grid-header invite-header">
                        <div>Invite</div>
                        <div>Private Secretary</div>
                        <div>Date</div>
                        <div>Start Time</div>
                        <div>End Time</div>
                        <div>Diary Manager Comments</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="inviteGridRows">
                        <!-- Invite rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="inviteArchive" class="hidden">
                <header>
                    <h1>Archive invites</h1>
                    <p style="color: #666; margin-bottom: 30px;">Archived invitations and events</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header invite-header">
                        <div>Invite</div>
                        <div>Private Secretary</div>
                        <div>Date</div>
                        <div>Start Time</div>
                        <div>End Time</div>
                        <div>Diary Manager Comments</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="inviteArchiveGridRows">
                        <!-- Archived invite rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="briefings" class="hidden">
                <header>
                    <h1>Briefings</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage briefings and meetings</p>
                </header>
                <button class="add-item-btn" onclick="openBriefingModal()">Add briefing</button>
                <div class="submissions-grid">
                    <div class="grid-header briefing-header">
                        <div>Private Secretary</div>
                        <div>SpAd</div>
                        <div>Date of Meeting</div>
                        <div>Time of Meeting</div>
                        <div>Title of Meeting</div>
                        <div>Commission Deadline</div>
                        <div>SharePoint Link</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    <div id="briefingGridRows">
                        <!-- Briefing rows will be populated here -->
                    </div>
                </div>
            </div>
            <div id="briefingsArchive" class="hidden">
                <header>
                    <h1>Archive briefings</h1>
                    <p style="color: #666; margin-bottom: 30px;">Archived briefings</p>
                </header>
                <div class="submissions-grid">
                    <div class="grid-header briefing-header">
                        <div>Private Secretary</div>
                        <div>SpAd</div>
                        <div>Date of Meeting</div>
                        <div>Time of Meeting</div>
                        <div>Title of Meeting</div>
                        <div>Commission Deadline</div>
                        <div>SharePoint Link</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    <div id="briefingsArchiveGridRows">
                        <!-- Archived briefing rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="commissions" class="hidden">
                <header>
                    <h1>Commissions</h1>
                    <p style="color: #666; margin-bottom: 30px;">Please use this tracker for keeping a record of all commissions from the Lord Chancellor and the SpAds (except briefing papers for meetings). For briefing commissions, please use the 'Briefings' page.</p>
                </header>
                
                <button class="add-item-btn" onclick="openCommissionModal()">Add commission</button>
                
                <div class="submissions-grid">
                    <div class="grid-header commission-header">
                        <div>Action</div>
                        <div>Private Secretary</div>
                        <div>Deadline</div>
                        <div>Status</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="commissionGridRows">
                        <!-- Commission rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="commissionArchive" class="hidden">
                <header>
                    <h1>Archive commissions</h1>
                    <p style="color: #666; margin-bottom: 30px;">Completed commissions</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header commission-archive-header">
                        <div>Action</div>
                        <div>Private Secretary</div>
                        <div>Deadline</div>
                        <div>Status</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="commissionArchiveGridRows">
                        <!-- Archived commission rows will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Daybook Section -->
            <div id="daybook" class="hidden">
                <header>
                    <h1>Daybook</h1>
                    <p style="color: #666; margin-bottom: 30px;">View briefings by date</p>
                </header>
                
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <label for="daybookDatePicker" style="font-weight: 500; min-width: 120px;">Select Date:</label>
                        <input type="date" id="daybookDatePicker" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <button onclick="filterBriefingsByDate()" style="padding: 8px 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">View Briefings</button>
                        <button onclick="clearDaybookFilter()" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Clear</button>
                    </div>
                </div>
                
                <div id="daybookResults" style="display: none;">
                    <h3 id="daybookDateHeader" style="margin-bottom: 20px; color: #333;"></h3>
                    <div class="submissions-grid">
                        <div class="grid-header daybook-header">
                            <div>Private Secretary</div>
                            <div>SpAd</div>
                            <div>Time</div>
                            <div>Title</div>
                            <div>Commission Deadline</div>
                            <div>SharePoint Link</div>
                            <div>PS Comments</div>
                            <div>SpAd Comments</div>
                        </div>
                        
                        <div id="daybookGridRows">
                            <!-- Filtered briefing rows will be populated here -->
                        </div>
                    </div>
                    
                    <div id="daybookNoResults" style="display: none; text-align: center; padding: 40px; color: #666; font-style: italic;">
                        No briefings found for the selected date.
                    </div>
                </div>
            </div>

            <div id="editTeam" class="hidden">
                <header>
                    <h1 style="font-weight: bold;">Settings</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage Private Secretaries and SpAds</p>
                </header>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                    <!-- Private Secretaries Section -->
                    <div>
                        <h3>Private Secretaries</h3>
                        <div class="team-management">
                            <div class="add-member-form">
                                <input type="text" id="newPSName" placeholder="Enter new Private Secretary name" onkeypress="if(event.key==='Enter') addPrivateSecretary()">
                                <button onclick="addPrivateSecretary()" class="form-btn btn-add">Add PS</button>
                            </div>
                            <div id="privateSecretariesList" class="team-list">
                                <!-- Private Secretaries will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- SpAds Section -->
                    <div>
                        <h3>SpAds</h3>
                        <div class="team-management">
                            <div class="add-member-form">
                                <input type="text" id="newSpAdName" placeholder="Enter new SpAd name" onkeypress="if(event.key==='Enter') addSpAd()">
                                <button onclick="addSpAd()" class="form-btn btn-add">Add SpAd</button>
                            </div>
                            <div id="spAdsList" class="team-list">
                                <!-- SpAds will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Fields Management Section -->
                <div style="margin-bottom: 40px;">
                    <h3>Status Fields Management</h3>
                    <div class="team-management">
                        <p style="color: #666; margin-bottom: 20px;">Manage available status options in the dropdown menus</p>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">Current Status Options:</h4>
                            <div id="statusFieldsList" class="team-list">
                                <!-- Status options will be populated here -->
                            </div>
                        </div>
                        
                        <div class="add-member-form">
                            <input type="text" id="newStatusField" placeholder="Enter new status option" onkeypress="if(event.key==='Enter') addStatusField()">
                            <button onclick="addStatusField()" class="form-btn btn-add">Add Status</button>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="resetStatusFieldsToDefault()" class="form-btn" style="background-color: #6c757d; font-size: 14px; padding: 8px 16px;">Reset to Default Status Options</button>
                            <p style="color: #666; font-size: 12px; margin-top: 5px;">This will restore the original status options and remove any custom ones you've added</p>
                        </div>
                    </div>
                </div>
                
                <!-- SpAd Review Settings Section -->
                <div style="margin-bottom: 40px;">
                    <h3>SpAd Review Settings</h3>
                    <div class="team-management">
                        <p style="color: #666; margin-bottom: 20px;">Configure SpAd review functionality</p>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="enableSpAdReview" checked onchange="toggleSpAdReview()">
                                <span>Enable SpAd Review Process</span>
                            </label>
                            <p style="color: #666; font-size: 12px; margin: 5px 0 0 30px;">When disabled, SpAd-related fields and buttons will be hidden</p>
                        </div>
                        
                        <div id="spadReviewOptions" style="margin-top: 20px;">
                            <h4 style="margin-bottom: 10px;">SpAd Review Options:</h4>
                            <div style="margin-left: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="showSpAdComments" checked onchange="updateSpAdSettings()">
                                    <span>Show SpAd Comment functionality</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="showSpAdDaysCounter" checked onchange="updateSpAdSettings()">
                                    <span>Show "Days with SpAds" counter</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="autoSubmitToSpAds" checked onchange="updateSpAdSettings()">
                                    <span>Show "Submit to SpAds" buttons</span>
                                </label>
                            </div>
                            
                            <div style="margin-top: 15px; text-align: center;">
                                <button onclick="resetSpAdSettingsToDefault()" class="form-btn" style="background-color: #6c757d; font-size: 14px; padding: 8px 16px;">Reset to Default SpAd Settings</button>
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">This will restore the original SpAd review settings</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Process Management Section -->
                <div style="margin-bottom: 40px;">
                    <h3>Process Management</h3>
                    <div class="team-management">
                        <p style="color: #666; margin-bottom: 20px;">Enable or disable specific processes/features based on your team's workflow needs</p>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px;">Available Processes:</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-left: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableBoxWork" checked onchange="updateProcessSettings()">
                                    <span>Box Work</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableInvites" checked onchange="updateProcessSettings()">
                                    <span>Invites</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableBriefings" checked onchange="updateProcessSettings()">
                                    <span>Briefings</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableCommissions" checked onchange="updateProcessSettings()">
                                    <span>Commissions</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableDaybook" checked onchange="updateProcessSettings()">
                                    <span>Daybook</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="enableArchives" checked onchange="updateProcessSettings()">
                                    <span>Archives</span>
                                </label>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                                <p style="color: #856404; font-size: 12px; margin: 0;">
                                    <strong>⚠️ Note:</strong> Box Work cannot be disabled as it's the core functionality. 
                                    Daybook requires Briefings to function and will be automatically disabled if Briefings is disabled.
                                    Disabling other processes will hide their navigation links and prevent access to those features.
                                    Any disabled archive sections will also be hidden from the Archives submenu.
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="resetProcessSettingsToDefault()" class="form-btn" style="background-color: #6c757d; font-size: 14px; padding: 8px 16px;">Reset to Default Process Settings</button>
                            <p style="color: #666; font-size: 12px; margin-top: 5px;">This will enable all processes and restore the default navigation</p>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="saveTeamChanges()" class="form-btn btn-add">Save Changes</button>
                </div>
            </div>

            <!-- Duty Rota Section -->
            <div id="dutyRota" class="hidden">
                <header>
                    <h1>Duty rota</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage team duty schedules and leave requests</p>
                </header>

                <div class="duty-rota-container">
                    <!-- Main Rota Schedule -->
                    <div class="rota-schedule">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Current Schedule</h3>
                        </div>

                        <div id="rotaScheduleContainer">
                            <!-- Rota weeks will be populated here -->
                        </div>
                    </div>

                    <!-- Controls Panel -->
                    <div class="rota-controls">
                        <!-- Leave Request Form -->
                        <div class="leave-form">
                            <h4>Dates unavailable</h4>
                            <div class="leave-input-group">
                                <input type="date" id="leaveStartDate" placeholder="Start Date">
                                <input type="date" id="leaveEndDate" placeholder="End Date">
                            </div>
                            <input type="text" id="leaveReason" placeholder="Reason (optional)" class="leave-reason-input">
                            <button onclick="submitLeaveRequest()" class="leave-submit-btn">Submit</button>
                        </div>

                        <!-- My Leave Requests -->
                        <div>
                            <h4>My Leave Requests</h4>
                            <div id="myLeaveRequests" class="leave-list">
                                <!-- Leave requests will be populated here -->
                            </div>
                        </div>

                        <!-- Manual Override Section (Admin Only) -->
                        <div class="manual-override-section">
                            <h4>⚠️ Manual Override</h4>
                            <p style="font-size: 12px; margin-bottom: 15px;">Use with caution - this will override automatic scheduling</p>
                            
                            <div class="override-controls">
                                <select id="overrideWeek">
                                    <option value="">Select Week...</option>
                                </select>
                                <select id="overrideRole">
                                    <option value="">Select Role...</option>
                                    <option value="junior-ps">Junior PS</option>
                                    <option value="senior-ps">Senior PS (Backup)</option>
                                    <option value="spad">SpAd</option>
                                </select>
                            </div>
                            <select id="overridePerson" style="width: 100%; margin-bottom: 10px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select Person...</option>
                            </select>
                            <button onclick="applyManualOverride()" class="leave-submit-btn" style="background-color: #ff8c00;">Apply Override</button>
                        </div>

                        <!-- Legend -->
                        <div class="rota-legend">
                            <h4>Legend</h4>
                            <div class="legend-item">
                                <div class="legend-color normal"></div>
                                <span>Scheduled</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color unavailable"></div>
                                <span>On Leave</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color override"></div>
                                <span>Manual Override</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Search Field -->
    <div id="searchContainer" class="search-container">
        <span class="search-icon">🔍</span>
        <input type="text" id="searchInput" class="search-input" placeholder="Search items...">
        <button id="searchClear" class="search-clear" onclick="clearSearch()">×</button>
    </div>

    <!-- Modal Form -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Advice/briefing</h2>
            </div>
            <form id="submissionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="leadPS">Private Secretary</label>
                        <select id="leadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadSpAd">SpAd</label>
                        <select id="leadSpAd">
                            <option value="">Select...</option>
                            <option value="Sophie">Sophie</option>
                            <option value="Tash">Tash</option>
                            <option value="Poppy">Poppy</option>
                            <option value="Josh">Josh</option>
                            <option value="No SpAd review">No SpAd review</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="urgency">
                            Urgency 
                            <span style="font-size: 12px; color: #666;">(Auto-calculated based on deadline)</span>
                            <span class="manual-override-label">
                                <input type="checkbox" id="manualUrgency" onchange="toggleManualUrgency()">
                                Manual override
                            </span>
                        </label>
                        <select id="urgency" readonly style="background-color: #f5f5f5;" title="Auto-calculated based on deadline (check manual override to edit)">
                            <option value="Routine">Routine</option>
                            <option value="Priority">Priority</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="submissionType">Advice/briefing</label>
                        <select id="submissionType">
                            <option value="advice">Advice</option>
                            <option value="briefing">Briefing for meeting</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="submissionTitle">Title</label>
                        <input type="text" id="submissionTitle" placeholder="Enter submission title">
                    </div>
                    
                    <div class="form-group">
                        <label for="deadlineBoxReview">Deadline for Box review</label>
                        <input type="date" id="deadlineBoxReview">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="sharepointLink">SharePoint Link</label>
                        <input type="url" id="sharepointLink" placeholder="https://sharepoint.com/..." style="font-family: 'Trebuchet MS', 'Lucida Grande', sans-serif; font-size: 12px; color: #0066cc;">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateReceived">Date received</label>
                        <input type="date" id="dateReceived">
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="">Select status...</option>
                            <option value="With Perm Sec/DGs">With Perm Sec/DGs</option>
                            <option value="With junior minister(s)">With junior minister(s)</option>
                            <option value="With SpAds">With SpAds</option>
                            <option value="With officials">With officials</option>
                            <option value="With PS">With PS</option>
                            <option value="Ready for the box">Ready for box</option>
                            <option value="Readout">Readout</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="dateSubmittedSpads">
                            Date submitted to SpAds 
                            <span style="font-size: 12px; color: #666;">(Auto-calculated)</span>
                            <span class="manual-override-label">
                                <input type="checkbox" id="manualDateSubmittedSpads" onchange="toggleManualDate('dateSubmittedSpads')">
                                Manual override
                            </span>
                        </label>
                        <input type="date" id="dateSubmittedSpads" readonly style="background-color: #f5f5f5;" title="Auto-calculated date (check manual override to edit)">
                    </div>
                    
                    <div class="form-group">
                        <label for="workingDays">Days with SpAds <span style="font-size: 12px; color: #666;">(Auto-calculated)</span></label>
                        <input type="number" id="workingDays" placeholder="Auto-calculated" readonly style="background-color: #f5f5f5;">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateSpAdComment">
                            Date of SpAd comment 
                            <span style="font-size: 12px; color: #666;">(Auto-calculated)</span>
                            <span class="manual-override-label">
                                <input type="checkbox" id="manualDateSpAdComment" onchange="toggleManualDate('dateSpAdComment')">
                                Manual override
                            </span>
                        </label>
                        <input type="date" id="dateSpAdComment" readonly style="background-color: #f5f5f5;" title="Auto-calculated date (check manual override to edit)">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateBoxed">
                            Date ready for box 
                            <span style="font-size: 12px; color: #666;">(Auto-calculated)</span>
                            <span class="manual-override-label">
                                <input type="checkbox" id="manualDateBoxed" onchange="toggleManualDate('dateBoxed')">
                                Manual override
                            </span>
                        </label>
                        <input type="date" id="dateBoxed" readonly style="background-color: #f5f5f5;" title="Auto-calculated date (check manual override to edit)">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateReadout">
                            Date of readout 
                            <span style="font-size: 12px; color: #666;">(Auto-calculated)</span>
                            <span class="manual-override-label">
                                <input type="checkbox" id="manualDateReadout" onchange="toggleManualDate('dateReadout')">
                                Manual override
                            </span>
                        </label>
                        <input type="date" id="dateReadout" readonly style="background-color: #f5f5f5;" title="Auto-calculated date (check manual override to edit)">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="comments">Comments</label>
                        <textarea id="comments" placeholder="Enter comments..."></textarea>
                    </div>
                </div>
                
                <div id="firstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons" id="submissionFormButtons">
                    <button type="button" class="form-btn btn-add" onclick="addSubmissionFromModal()">Add</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SpAd Comment Modal -->
    <div id="spadCommentModal" class="spad-comment-modal">
        <div class="spad-comment-modal-content">
            <div class="modal-header">
                <h2>Add SpAd Comment</h2>
            </div>
            <form id="spadCommentForm">
                <div class="spad-comment-form-group">
                    <label for="psComments">Do you have any comments/queries for the Private Secretary?</label>
                    <textarea id="psComments" placeholder="Enter your comments or queries..."></textarea>
                </div>
                
                <div class="spad-comment-form-group">
                    <label for="boxNote">Have you added your comment to the box note?</label>
                    <select id="boxNote">
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                
                <div class="spad-comment-buttons">
                    <button type="button" class="spad-comment-btn-submit" onclick="submitSpAdComment()">Submit to Private Secretary</button>
                    <button type="button" class="spad-comment-btn-submit" onclick="saveSpAdDraft()" style="background-color: #5a88d0;">Save and go back</button>
                    <button type="button" class="spad-comment-btn-cancel" onclick="closeSpAdCommentModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invite Modal Form -->
    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Invite</h2>
            </div>
            <form id="inviteForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="inviteTitle">Invite</label>
                        <input type="text" id="inviteTitle" placeholder="Enter invite description">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteLeadPS">PS</label>
                        <select id="inviteLeadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteDate">Date (optional)</label>
                        <input type="date" id="inviteDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteStartTime">Start time (optional)</label>
                        <input type="time" id="inviteStartTime">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteEndTime">End time (optional)</label>
                        <input type="time" id="inviteEndTime">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="diaryManagerComments">Diary manager comments</label>
                        <textarea id="diaryManagerComments" placeholder="Enter diary manager comments..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="psCommentsInvite">PS comments</label>
                        <textarea id="psCommentsInvite" placeholder="Enter PS comments..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="spadCommentsInvite">SpAd comments</label>
                        <textarea id="spadCommentsInvite" placeholder="Enter SpAd comments..."></textarea>
                    </div>
                </div>
                
                <div id="inviteFirstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="form-btn btn-add" onclick="addInvite()">Add Invite</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Briefing Modal Form -->
    <div id="briefingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="briefingModalTitle">Add New Briefing</h2>
            </div>
            <form id="briefingForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="briefingLeadPS">Private Secretary</label>
                        <select id="briefingLeadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="briefingLeadSpAd">SpAd</label>
                        <select id="briefingLeadSpAd">
                            <option value="">Select...</option>
                            <option value="Sophie">Sophie</option>
                            <option value="Tash">Tash</option>
                            <option value="Poppy">Poppy</option>
                            <option value="Josh">Josh</option>
                            <option value="No SpAd review">No SpAd review</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="briefingDate">Date of meeting</label>
                        <input type="date" id="briefingDate">
                    </div>
                    <div class="form-group">
                        <label for="briefingTime">Time of meeting</label>
                        <input type="time" id="briefingTime">
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingTitle">Title of meeting</label>
                        <input type="text" id="briefingTitle" placeholder="Enter meeting title">
                    </div>
                    <div class="form-group">
                        <label for="briefingCommissionDeadline">Commission deadline</label>
                        <input type="date" id="briefingCommissionDeadline">
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingSharepointLink">SharePoint Link</label>
                        <input type="url" id="briefingSharepointLink" placeholder="https://sharepoint.com/..." style="font-family: 'Optima', 'Lucida Grande', sans-serif; font-size: 12px; color: #0066cc;">
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingPSComments">PS comments</label>
                        <textarea id="briefingPSComments" placeholder="Enter PS comments..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingSpAdComments">SpAd comments</label>
                        <textarea id="briefingSpAdComments" placeholder="Enter SpAd comments..."></textarea>
                    </div>
                </div>
                
                <div id="briefingFirstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons" id="briefingFormButtons">
                    <button type="button" class="form-btn btn-add" onclick="addBriefing()">Add</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Urgency Reason Modal -->
    <div id="urgencyReasonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Urgency Justification Required</h2>
            </div>
            <form id="urgencyReasonForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="urgencyReason">Please explain why this item is urgent:</label>
                        <textarea id="urgencyReason" placeholder="Provide a detailed explanation for the urgent priority..." style="min-height: 100px;" required></textarea>
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="form-btn btn-add" onclick="confirmUrgencyReason()">Confirm Urgent</button>
                    <button type="button" class="form-btn btn-cancel" onclick="cancelUrgencyReason()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Commission Modal Form -->
    <div id="commissionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="commissionModalTitle">Add New Commission</h2>
            </div>
            <form id="commissionForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="commissionAction">Action</label>
                        <textarea id="commissionAction" placeholder="What has been commissioned? When was the commission made, and by who?" rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="commissionLeadPS">PS</label>
                        <select id="commissionLeadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="commissionDeadline">Deadline</label>
                        <input type="date" id="commissionDeadline">
                    </div>
                    
                    <div class="form-group">
                        <label for="commissionStatus">Status</label>
                        <select id="commissionStatus">
                            <option value="">Select status...</option>
                            <option value="With PS">With PS</option>
                            <option value="Commissioned the department">Commissioned the department</option>
                            <option value="With SpAds">With SpAds</option>
                            <option value="Complete">Complete</option>
                        </select>
                    </div>
                </div>
                
                <div id="commissionFirstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons" id="commissionFormButtons">
                    <button type="button" class="form-btn btn-add" onclick="addCommission()">Add</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeCommissionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Permission Request Modal -->
    <div id="permissionModal" class="permission-modal">
        <div class="permission-modal-content">
            <div class="modal-header">
                <h2>Permission Required</h2>
            </div>
            <div style="margin-bottom: 20px;">
                <p>This change is within 1 month of the duty date and requires special permission.</p>
                <p><strong>Reason for urgent change:</strong></p>
                <textarea id="permissionReason" placeholder="Please explain why this change is needed urgently..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0;"></textarea>
            </div>
            <div class="form-buttons">
                <button type="button" class="form-btn btn-add" onclick="submitPermissionRequest()">Request Permission</button>
                <button type="button" class="form-btn btn-cancel" onclick="closePermissionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- Local Storage Data Model ---
        // Keys: submissions, invites, briefings, archiveSubmissions, archiveInvites, archiveBriefings

        // --- Working Days Calculation ---
        function calculateWorkingDays(startDate, endDate) {
            if (!startDate) return '';
            
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date(); // Use today if no end date
            
            // If end date is before start date, return 0
            if (end < start) return 0;
            
            let workingDays = 0;
            const currentDate = new Date(start);
            
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                // 0 = Sunday, 6 = Saturday
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    workingDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Subtract 1 because we don't count the start date itself
            return Math.max(0, workingDays - 1);
        }

        function formatUrlForDisplay(url) {
            if (!url) return '';
            
            // If it's a valid URL, create a clickable link with truncated display text
            try {
                const urlObj = new URL(url);
                let displayText = url;
                
                // Truncate long URLs for display
                if (url.length > 30) {
                    displayText = url.substring(0, 27) + '...';
                }
                
                return `<a href="${url}" target="_blank" class="url-cell" title="${url}">${displayText}</a>`;
            } catch (e) {
                // If not a valid URL, just display as text with URL styling
                let displayText = url;
                if (url.length > 30) {
                    displayText = url.substring(0, 27) + '...';
                }
                return `<span class="url-display" title="${url}">${displayText}</span>`;
            }
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                const options = { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long'
                };
                return date.toLocaleDateString('en-GB', options);
            } catch (e) {
                return dateString; // Return original if formatting fails
            }
        }

        function formatTimestampForDisplay(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = new Date(timestamp);
                const dateOptions = { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long',
                    year: 'numeric'
                };
                const timeOptions = {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                };
                const dateStr = date.toLocaleDateString('en-GB', dateOptions);
                const timeStr = date.toLocaleTimeString('en-GB', timeOptions);
                return `First added to the grid on ${dateStr} at ${timeStr}`;
            } catch (e) {
                return '';
            }
        }

        function updateWorkingDaysForSubmission(data) {
            if (data.dateSubmittedSpads) {
                data.workingDays = calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment);
            }
            return data;
        }

        // Toggle manual date override functionality
        function toggleManualDate(fieldId) {
            const checkbox = document.getElementById('manual' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));
            const dateField = document.getElementById(fieldId);
            
            if (checkbox && dateField) {
                if (checkbox.checked) {
                    // Enable manual input
                    dateField.removeAttribute('readonly');
                    dateField.style.backgroundColor = 'white';
                    dateField.title = 'Manual override enabled - you can edit this date';
                } else {
                    // Disable manual input and revert to auto-calculated
                    dateField.setAttribute('readonly', 'readonly');
                    dateField.style.backgroundColor = '#f5f5f5';
                    dateField.title = 'Auto-calculated date (check manual override to edit)';
                    
                    // Optionally clear the value to trigger auto-calculation on next status change
                    // Uncomment the line below if you want to clear manually entered dates when unchecking
                    // dateField.value = '';
                }
            }
        }

        // Toggle manual urgency override functionality
        function toggleManualUrgency() {
            const checkbox = document.getElementById('manualUrgency');
            const urgencyField = document.getElementById('urgency');
            const deadlineField = document.getElementById('deadlineBoxReview');
            
            if (checkbox && urgencyField) {
                if (checkbox.checked) {
                    // Enable manual input
                    urgencyField.removeAttribute('readonly');
                    urgencyField.style.backgroundColor = 'white';
                    urgencyField.title = 'Manual override enabled - you can edit urgency';
                } else {
                    // Disable manual input and revert to auto-calculated
                    urgencyField.setAttribute('readonly', 'readonly');
                    urgencyField.style.backgroundColor = '#f5f5f5';
                    urgencyField.title = 'Auto-calculated based on deadline (check manual override to edit)';
                    
                    // Recalculate urgency based on current deadline
                    if (deadlineField && deadlineField.value) {
                        calculateUrgencyFromDeadline();
                    }
                }
            }
        }

        // Calculate urgency based on deadline in the form
        function calculateUrgencyFromDeadline() {
            console.log('=== calculateUrgencyFromDeadline called ===');
            
            const deadlineField = document.getElementById('deadlineBoxReview');
            const urgencyField = document.getElementById('urgency');
            const manualUrgencyCheckbox = document.getElementById('manualUrgency');
            
            console.log('Deadline field:', deadlineField);
            console.log('Deadline field value:', deadlineField?.value);
            console.log('Urgency field:', urgencyField);
            console.log('Current urgency:', urgencyField?.value);
            console.log('Manual override checkbox:', manualUrgencyCheckbox);
            console.log('Manual override checked:', manualUrgencyCheckbox?.checked);
            
            // Only auto-calculate if manual override is not enabled
            if (!deadlineField || !urgencyField) {
                console.log('ERROR: Missing deadline or urgency field');
                return;
            }
            
            if (manualUrgencyCheckbox && manualUrgencyCheckbox.checked) {
                console.log('Manual override is enabled, skipping auto-calculation');
                return;
            }
            
            const deadlineValue = deadlineField.value;
            if (!deadlineValue) {
                console.log('No deadline value, setting to Routine');
                urgencyField.value = 'Routine';
                return;
            }
            
            const deadline = new Date(deadlineValue);
            const today = new Date();
            
            // Set time to start of day for comparison
            today.setHours(0, 0, 0, 0);
            deadline.setHours(0, 0, 0, 0);
            
            // Calculate days difference
            const timeDiff = deadline.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            console.log('Deadline calculation:', {
                deadline: deadline.toDateString(),
                today: today.toDateString(),
                daysDiff: daysDiff
            });
            
            // Set urgency based on days until deadline
            let newUrgency;
            if (daysDiff <= 1) {
                newUrgency = 'Urgent';
            } else if (daysDiff <= 2) {
                newUrgency = 'Priority';
            } else {
                newUrgency = 'Routine';
            }
            
            console.log('Setting urgency from', urgencyField.value, 'to:', newUrgency);
            urgencyField.value = newUrgency;
            console.log('Urgency field value after setting:', urgencyField.value);
            
            // Trigger change event on urgency field to update any dependent elements
            const changeEvent = new Event('change', { bubbles: true });
            urgencyField.dispatchEvent(changeEvent);
            
            console.log('=== calculateUrgencyFromDeadline completed ===');
        }

        // Helper function to calculate urgency from a deadline value (used in data processing)
        function calculateUrgencyFromDeadlineValue(deadlineValue) {
            if (!deadlineValue) {
                return 'Routine';
            }
            
            const deadline = new Date(deadlineValue);
            const today = new Date();
            
            // Set time to start of day for comparison
            today.setHours(0, 0, 0, 0);
            deadline.setHours(0, 0, 0, 0);
            
            // Calculate days difference
            const timeDiff = deadline.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            // Set urgency based on days until deadline
            if (daysDiff <= 1) {
                return 'Urgent';
            } else if (daysDiff <= 2) {
                return 'Priority';
            } else {
                return 'Routine';
            }
        }

        // Handle urgency field changes to show/hide reason modal
        function handleUrgencyChange() {
            const urgencyField = document.getElementById('urgency');
            if (urgencyField && urgencyField.value === 'Urgent') {
                // If urgent is selected, we may need to get a reason
                // This will be handled during form submission
            }
        }

        // Utility: Load and Save
        function loadData(key) {
            try {
                const data = JSON.parse(localStorage.getItem(key) || '[]');
                console.log(`Loaded data for ${key}:`, data);
                
                // Filter out any null or invalid entries
                if (Array.isArray(data)) {
                    const filteredData = data.filter(item => item !== null && typeof item === 'object');
                    if (filteredData.length !== data.length) {
                        console.warn(`Filtered out ${data.length - filteredData.length} invalid entries from ${key}`);
                        // Save the cleaned data back
                        saveData(key, filteredData);
                    }
                    return filteredData;
                }
                
                return [];
            } catch (error) {
                console.error(`Error loading data for ${key}:`, error);
                return [];
            }
        }
        function saveData(key, arr) {
            try {
                localStorage.setItem(key, JSON.stringify(arr));
                console.log(`Saved data for ${key}:`, arr);
            } catch (error) {
                console.error(`Error saving data for ${key}:`, error);
            }
        }

        // Get form data helper
        function getFormData() {
            const leadPSElement = document.getElementById('leadPS');
            const submissionTitleElement = document.getElementById('submissionTitle');
            
            console.log('leadPS element:', leadPSElement);
            console.log('submissionTitle element:', submissionTitleElement);
            
            if (!leadPSElement) {
                console.error('leadPS element not found!');
                return { leadPS: '', submissionTitle: '', leadSpAd: '', urgency: '', urgencyReason: '', submissionType: 'advice', deadlineBoxReview: '', sharepointLink: '', dateReceived: '', status: '', dateSubmittedSpads: '', workingDays: '', dateSpAdComment: '', dateBoxed: '', comments: '', firstAdded: '' };
            }
            
            if (!submissionTitleElement) {
                console.error('submissionTitle element not found!');
                return { leadPS: '', submissionTitle: '', leadSpAd: '', urgency: '', urgencyReason: '', submissionType: 'advice', deadlineBoxReview: '', sharepointLink: '', dateReceived: '', status: '', dateSubmittedSpads: '', workingDays: '', dateSpAdComment: '', dateBoxed: '', comments: '', firstAdded: '' };
            }
            
            console.log('leadPS value:', leadPSElement.value);
            console.log('submissionTitle value:', submissionTitleElement.value);
            
            return {
                leadPS: leadPSElement.value || '',
                leadSpAd: (document.getElementById('leadSpAd') || {}).value || '',
                urgency: (document.getElementById('urgency') || {}).value || '',
                urgencyReason: (document.getElementById('urgency') || {}).value === 'Urgent' ? 
                              (window.currentUrgencyReason || '') : '',
                submissionType: (document.getElementById('submissionType') || {}).value || 'advice',
                submissionTitle: submissionTitleElement.value || '',
                deadlineBoxReview: (document.getElementById('deadlineBoxReview') || {}).value || '',
                sharepointLink: (document.getElementById('sharepointLink') || {}).value || '',
                dateReceived: (document.getElementById('dateReceived') || {}).value || '',
                status: (document.getElementById('status') || {}).value || '',
                dateSubmittedSpads: (document.getElementById('dateSubmittedSpads') || {}).value || '',
                workingDays: (document.getElementById('workingDays') || {}).value || '',
                dateSpAdComment: (document.getElementById('dateSpAdComment') || {}).value || '',
                dateBoxed: (document.getElementById('dateBoxed') || {}).value || '',
                dateReadout: (document.getElementById('dateReadout') || {}).value || '',
                comments: (document.getElementById('comments') || {}).value || '',
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function getInviteFormData() {
            return {
                inviteTitle: document.getElementById('inviteTitle').value,
                inviteLeadPS: document.getElementById('inviteLeadPS').value,
                inviteDate: document.getElementById('inviteDate').value,
                inviteStartTime: document.getElementById('inviteStartTime').value,
                inviteEndTime: document.getElementById('inviteEndTime').value,
                diaryManagerComments: document.getElementById('diaryManagerComments').value,
                psCommentsInvite: document.getElementById('psCommentsInvite').value,
                spadCommentsInvite: document.getElementById('spadCommentsInvite').value,
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function getBriefingFormData() {
            return {
                leadPS: document.getElementById('briefingLeadPS').value,
                leadSpAd: document.getElementById('briefingLeadSpAd').value,
                date: document.getElementById('briefingDate').value,
                time: document.getElementById('briefingTime').value,
                title: document.getElementById('briefingTitle').value,
                sharepointLink: document.getElementById('briefingSharepointLink').value,
                commissionDeadline: document.getElementById('briefingCommissionDeadline').value,
                psComments: document.getElementById('briefingPSComments').value,
                spadComments: document.getElementById('briefingSpAdComments').value,
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function getCommissionFormData() {
            return {
                action: document.getElementById('commissionAction').value,
                leadPS: document.getElementById('commissionLeadPS').value,
                deadline: document.getElementById('commissionDeadline').value,
                status: document.getElementById('commissionStatus').value,
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function addSubmission(data) {
            console.log('addSubmission called with data:', data);
            
            // Validate that data is not null and has required properties
            if (!data || typeof data !== 'object') {
                console.error('Invalid data passed to addSubmission:', data);
                return;
            }
            
            // Auto-calculate urgency based on deadline if not manually overridden
            const manualUrgencyCheckbox = document.getElementById('manualUrgency');
            const isManualOverride = manualUrgencyCheckbox && manualUrgencyCheckbox.checked;
            if (data.deadlineBoxReview && !isManualOverride) {
                const calculatedUrgency = calculateUrgencyFromDeadlineValue(data.deadlineBoxReview);
                console.log('Calculated urgency for new submission deadline', data.deadlineBoxReview, ':', calculatedUrgency);
                data.urgency = calculatedUrgency;
            }
            
            // Auto-set dates based on status
            const today = new Date().toISOString().split('T')[0];
            if (data.status === 'With SpAds' && !data.dateSubmittedSpads) {
                data.dateSubmittedSpads = today;
            } else if (data.status === 'With PS' && !data.dateSpAdComment) {
                data.dateSpAdComment = today;
            } else if (data.status === 'Ready for the box' && !data.dateBoxed) {
                data.dateBoxed = today;
            } else if (data.status === 'Readout' && !data.dateReadout) {
                data.dateReadout = today;
            }
            
            // Calculate working days automatically
            data = updateWorkingDaysForSubmission(data);
            
            // Auto-archive if status is Readout
            if (data.status === 'Readout') {
                archiveSubmission(data);
                return;
            }
            
            // Always add to submissions table (box work dashboard)
            const arr = loadData('submissions');
            console.log('Current submissions:', arr);
            arr.push(data);
            console.log('After adding:', arr);
            saveData('submissions', arr);
            console.log('Saved to localStorage');
            renderSubmissions();
            renderArchiveSubmissions();
            
            // Only add to briefings if it's briefing or both
            if (data.submissionType === 'briefing' || data.submissionType === 'both') {
                addToBriefings(data);
            }
            
            console.log('addSubmission completed');
        }

        // Convert submission data to briefing format and add to briefings table
        function addToBriefings(submissionData) {
            const briefingData = {
                leadPS: submissionData.leadPS,
                leadSpAd: submissionData.leadSpAd,
                date: '', // Will need to be filled in later or prompt user
                time: '', // Will need to be filled in later or prompt user
                title: submissionData.submissionTitle,
                sharepointLink: submissionData.sharepointLink,
                commissionDeadline: '', // Will need to be filled in later
                psComments: submissionData.comments || '',
                spadComments: ''
            };
            
            const briefings = loadData('briefings');
            briefings.push(briefingData);
            saveData('briefings', briefings);
            renderBriefings();
            console.log('Added to briefings:', briefingData);
        }

        // Helper function to archive a submission
        function archiveSubmission(submissionData, originalIndex = null) {
            // Set status to Readout and add archive date
            submissionData.status = 'Readout';
            if (!submissionData.dateReadout) {
                submissionData.dateReadout = new Date().toISOString().split('T')[0];
            }
            submissionData.archivedDate = new Date().toISOString();
            
            // Add to archive
            const archiveArr = loadData('archiveSubmissions');
            archiveArr.push(submissionData);
            saveData('archiveSubmissions', archiveArr);
            
            // Remove from main submissions if this was an update (not new submission)
            if (originalIndex !== null) {
                const arr = loadData('submissions');
                arr.splice(originalIndex, 1);
                saveData('submissions', arr);
            }
            
            renderSubmissions();
            renderArchiveSubmissions();
            updateDashboardSummary();
        }

        function updateSubmission(idx, data) {
            const arr = loadData('submissions');
            const today = new Date().toISOString().split('T')[0];
            
            if (data) {
                // Auto-recalculate urgency based on deadline if not manually overridden
                const manualUrgencyCheckbox = document.getElementById('manualUrgency');
                const isManualOverride = manualUrgencyCheckbox && manualUrgencyCheckbox.checked;
                if (data.deadlineBoxReview && !isManualOverride) {
                    const calculatedUrgency = calculateUrgencyFromDeadlineValue(data.deadlineBoxReview);
                    console.log('Calculated urgency for deadline', data.deadlineBoxReview, ':', calculatedUrgency);
                    data.urgency = calculatedUrgency;
                }
                
                // Auto-set dates based on status changes
                if (data.status === 'With SpAds' && !data.dateSubmittedSpads) {
                    data.dateSubmittedSpads = today;
                } else if (data.status === 'With PS' && !data.dateSpAdComment) {
                    data.dateSpAdComment = today;
                } else if (data.status === 'Ready for the box' && !data.dateBoxed) {
                    data.dateBoxed = today;
                } else if (data.status === 'Readout' && !data.dateReadout) {
                    data.dateReadout = today;
                }
                
                // Calculate working days automatically
                data = updateWorkingDaysForSubmission(data);
                
                // Auto-archive if status is Readout
                if (data.status === 'Readout') {
                    archiveSubmission(data, idx);
                    closeModal();
                    return;
                }
                
                arr[idx] = data;
            } else {
                const formData = getFormData();
                
                // Auto-recalculate urgency based on deadline if not manually overridden
                const manualUrgencyCheckbox = document.getElementById('manualUrgency');
                const isManualOverride = manualUrgencyCheckbox && manualUrgencyCheckbox.checked;
                if (formData.deadlineBoxReview && !isManualOverride) {
                    const calculatedUrgency = calculateUrgencyFromDeadlineValue(formData.deadlineBoxReview);
                    console.log('Calculated urgency for deadline', formData.deadlineBoxReview, ':', calculatedUrgency);
                    formData.urgency = calculatedUrgency;
                }
                
                // Validate urgency reason if urgent
                if (formData.urgency === 'Urgent' && !window.currentUrgencyReason) {
                    alert('Please provide a reason for the urgent priority.');
                    openUrgencyReasonModal();
                    return;
                }
                
                // Auto-set dates based on status changes
                if (formData.status === 'With SpAds' && !formData.dateSubmittedSpads) {
                    formData.dateSubmittedSpads = today;
                } else if (formData.status === 'With PS' && !formData.dateSpAdComment) {
                    formData.dateSpAdComment = today;
                } else if (formData.status === 'Ready for the box' && !formData.dateBoxed) {
                    formData.dateBoxed = today;
                } else if (formData.status === 'Readout' && !formData.dateReadout) {
                    formData.dateReadout = today;
                }
                
                // Calculate working days automatically
                const updatedFormData = updateWorkingDaysForSubmission(formData);
                
                // Auto-archive if status is Readout
                if (updatedFormData.status === 'Readout') {
                    archiveSubmission(updatedFormData, idx);
                    closeModal();
                    return;
                }
                
                arr[idx] = updatedFormData;
            }
            saveData('submissions', arr);
            renderSubmissions();
            closeModal();
        }

        function deleteSubmissionRow(idx) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            const arr = loadData('submissions');
            arr.splice(idx, 1);
            saveData('submissions', arr);
            renderSubmissions();
        }

        function editSubmissionRow(idx) {
            const rows = loadData('submissions');
            const data = rows[idx];
            
            // Populate form fields
            document.getElementById('leadPS').value = data.leadPS || '';
            document.getElementById('leadSpAd').value = data.leadSpAd || '';
            document.getElementById('urgency').value = data.urgency || '';
            document.getElementById('submissionTitle').value = data.submissionTitle || '';
            document.getElementById('deadlineBoxReview').value = data.deadlineBoxReview || '';
            document.getElementById('sharepointLink').value = data.sharepointLink || '';
            document.getElementById('dateReceived').value = data.dateReceived || '';
            document.getElementById('status').value = data.status || '';
            document.getElementById('dateSubmittedSpads').value = data.dateSubmittedSpads || '';
            document.getElementById('dateSpAdComment').value = data.dateSpAdComment || '';
            document.getElementById('dateBoxed').value = data.dateBoxed || '';
            document.getElementById('dateReadout').value = data.dateReadout || '';
            document.getElementById('comments').value = data.comments || '';
            
            // Set urgency reason if it exists
            window.currentUrgencyReason = data.urgencyReason || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('firstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Calculate and display working days
            const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
            document.getElementById('workingDays').value = workingDays;
            
            // Update modal title and buttons
            document.querySelector('.modal-header h2').textContent = 'Edit Submission';
            document.getElementById('submissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateSubmission(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            document.getElementById('itemModal').style.display = 'block';
            
            // Set up event listeners for urgency changes
            setTimeout(() => {
                const urgencySelect = document.getElementById('urgency');
                const deadlineField = document.getElementById('deadlineBoxReview');
                
                if (urgencySelect) {
                    urgencySelect.addEventListener('change', handleUrgencyChange);
                }
                if (deadlineField) {
                    deadlineField.addEventListener('change', calculateUrgencyFromDeadline);
                }
            }, 100);
        }

        // --- Update and Submit Functions ---
        function updateAndSubmitToSpAds(idx) {
            const data = getFormData();
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            data.status = 'With SpAds';
            if (!data.dateSubmittedSpads) {
                data.dateSubmittedSpads = new Date().toISOString().split('T')[0];
            }
            updateSubmission(idx, data);
        }

        function updateAndSubmitToLCBox(idx) {
            const data = getFormData();
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            data.status = 'Ready for the box';
            if (!data.dateBoxed) {
                data.dateBoxed = new Date().toISOString().split('T')[0];
            }
            updateSubmission(idx, data);
        }

        // --- Form submission functions ---
        function addSubmissionFromModal() {
            console.log('addSubmissionFromModal called');
            
            // Check if modal is open
            const modal = document.getElementById('itemModal');
            if (!modal || modal.style.display === 'none') {
                console.error('Modal is not open!');
                alert('Form is not available. Please try opening the form again.');
                return;
            }
            
            const data = getFormData();
            console.log('Form data:', data);
            if (!data.leadPS || !data.submissionTitle) {
                console.log('Validation failed - leadPS:', data.leadPS, 'submissionTitle:', data.submissionTitle);
                alert('Please fill in required fields (PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            console.log('Validation passed, adding submission');
            // Remove sample rows if present
            removeSampleRows();
            addSubmission(data);
            closeModal();
        }

        function submitToSpAdsFromModal() {
            console.log('submitToSpAdsFromModal called');
            
            // Check if modal is open
            const modal = document.getElementById('itemModal');
            if (!modal || modal.style.display === 'none') {
                console.error('Modal is not open!');
                alert('Form is not available. Please try opening the form again.');
                return;
            }
            
            const data = getFormData();
            console.log('Form data:', data);
            if (!data.leadPS || !data.submissionTitle) {
                console.log('Validation failed - leadPS:', data.leadPS, 'submissionTitle:', data.submissionTitle);
                alert('Please fill in required fields (PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            console.log('Validation passed, submitting to SpAds');
            data.status = 'With SpAds';
            if (!data.dateSubmittedSpads) {
                data.dateSubmittedSpads = new Date().toISOString().split('T')[0];
            }
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            // Remove sample rows if present
            removeSampleRows();
            addSubmission(data);
            closeModal();
        }

        function submitToLCBoxFromModal() {
            console.log('submitToLCBoxFromModal called');
            
            // Check if modal is open
            const modal = document.getElementById('itemModal');
            if (!modal || modal.style.display === 'none') {
                console.error('Modal is not open!');
                alert('Form is not available. Please try opening the form again.');
                return;
            }
            
            const data = getFormData();
            console.log('Form data:', data);
            if (!data.leadPS || !data.submissionTitle) {
                console.log('Validation failed - leadPS:', data.leadPS, 'submissionTitle:', data.submissionTitle);
                alert('Please fill in required fields (PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            console.log('Validation passed, submitting to LC Box');
            data.status = 'Ready for the box';
            if (!data.dateBoxed) {
                data.dateBoxed = new Date().toISOString().split('T')[0];
            }
            // Remove sample rows if present
            removeSampleRows();
            addSubmission(data);
            closeModal();
        }

        // --- Render Functions ---
        function renderSubmissions() {
            console.log('renderSubmissions called');
            const rows = loadData('submissions');
            console.log('Loaded submissions:', rows);
            const container = document.querySelector('#mainDashboard .submissions-grid');
            console.log('Container found:', container);
            
            if (!container) {
                console.error('Could not find submissions grid container!');
                return;
            }
            
            // Remove existing rows (except header)
            const existingRows = container.querySelectorAll('.grid-row');
            console.log('Existing rows to remove:', existingRows.length);
            existingRows.forEach(row => row.remove());
            
            // Add new rows
            rows.forEach((data, idx) => {
                console.log('Processing row data:', data);
                if (!data) {
                    console.error('Row data is null or undefined at index:', idx);
                    return;
                }
                
                // Calculate working days for display
                const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
                
                // Show draft indicator in comments column
                let commentsDisplay = data.comments || '';
                if (data.spadDraftComments || data.spadDraftBoxNote) {
                    const draftComments = data.spadDraftComments || '';
                    commentsDisplay = draftComments;
                }
                
                // Add urgency reason if item is urgent
                if (data.urgency === 'Urgent' && data.urgencyReason) {
                    const urgencyNote = `[URGENT: ${data.urgencyReason}]`;
                    commentsDisplay = commentsDisplay ? `${urgencyNote} ${commentsDisplay}` : urgencyNote;
                }
                
                const row = document.createElement('div');
                row.className = 'grid-row';
                
                // Add urgent styling if item is urgent
                if (data.urgency === 'Urgent') {
                    row.classList.add('urgent-item');
                }
                
                row.innerHTML = `
                    <div class="grid-cell">${(data && data.leadPS) || ''}</div>
                    <div class="grid-cell">${(data && data.leadSpAd) || ''}</div>
                    <div class="grid-cell">${(data && data.urgency) || ''}</div>
                    <div class="grid-cell">${(data && data.submissionTitle) || ''}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">
                        <select class="inline-status" onchange="updateStatusQuick(${idx}, this.value)">
                            <option value="With Perm Sec/DGs" ${data.status === 'With Perm Sec/DGs' ? 'selected' : ''}>With Perm Sec/DGs</option>
                            <option value="With junior minister(s)" ${data.status === 'With junior minister(s)' ? 'selected' : ''}>With junior minister(s)</option>
                            <option value="With SpAds" ${data.status === 'With SpAds' ? 'selected' : ''}>With SpAds</option>
                            <option value="With officials" ${data.status === 'With officials' ? 'selected' : ''}>With officials</option>
                            <option value="With PS" ${data.status === 'With PS' ? 'selected' : ''}>With PS</option>
                            <option value="Ready for the box" ${data.status === 'Ready for the box' ? 'selected' : ''}>Ready for box</option>
                            <option value="Readout" ${data.status === 'Readout' ? 'selected' : ''}>Readout</option>
                        </select>
                    </div>
                    <div class="grid-cell">${workingDays}</div>
                    <div class="grid-cell">${commentsDisplay}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            ${data.status === 'With SpAds' ? `<button class="action-btn spad-comment-btn" onclick="openSpAdCommentModal(this)" data-tooltip="Add SpAd Comment">💬 SpAd Comment</button>` : ''}
                            ${data.status !== 'With SpAds' && data.status !== 'Ready for the box' ? `<button class="action-btn spad-btn" onclick="submitToSpAdsQuick(${idx})" data-tooltip="Submit to SpAds">→ SpAd</button>` : ''}
                            ${data.status !== 'Ready for the box' ? `<button class="action-btn lc-btn" onclick="submitToLCQuick(${idx})" data-tooltip="Submit to Box">→ Box</button>` : ''}
                            <button class="action-btn edit-btn" onclick="editSubmissionRow(${idx})" data-tooltip="Edit this submission">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteSubmissionRow(${idx})" data-tooltip="Delete this submission">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
            
            // Update dashboard summary counts
            updateDashboardSummary();
        }

        // --- Dashboard Summary and Quick Action Functions ---
        function updateDashboardSummary() {
            const submissions = loadData('submissions');
            
            // Count items with SpAds
            const spadCount = submissions.filter(s => s.status === 'With SpAds').length;
            document.getElementById('spadCount').textContent = spadCount;
            
            // Count urgent items
            const urgentCount = submissions.filter(s => s.urgency === 'Urgent').length;
            document.getElementById('urgentCount').textContent = urgentCount;
            
            // Count items ready for box
            const lcReadyCount = submissions.filter(s => s.status === 'Ready for the box').length;
            document.getElementById('lcReadyCount').textContent = lcReadyCount;
            
            // Count overdue items (with SpAds for 5+ working days)
            const overdueCount = submissions.filter(s => {
                if (s.status === 'With SpAds' && s.dateSubmittedSpads) {
                    const workingDays = calculateWorkingDays(s.dateSubmittedSpads, s.dateSpAdComment);
                    return workingDays >= 5;
                }
                return false;
            }).length;
            document.getElementById('overdueCount').textContent = overdueCount;
        }

        function updateStatusQuick(idx, newStatus) {
            const submissions = loadData('submissions');
            if (submissions[idx]) {
                // If status is changed to Readout, archive the item automatically
                if (newStatus === 'Readout') {
                    const submissionData = submissions[idx];
                    submissionData.status = 'Readout';
                    
                    // Set readout date if not already set
                    if (!submissionData.dateReadout) {
                        submissionData.dateReadout = new Date().toISOString().split('T')[0];
                    }
                    
                    // Archive the submission
                    archiveSubmission(submissionData, idx);
                    return;
                }
                
                submissions[idx].status = newStatus;
                
                // Set appropriate dates based on status
                const today = new Date().toISOString().split('T')[0];
                if (newStatus === 'With SpAds' && !submissions[idx].dateSubmittedSpads) {
                    submissions[idx].dateSubmittedSpads = today;
                } else if (newStatus === 'With PS' && !submissions[idx].dateSpAdComment) {
                    submissions[idx].dateSpAdComment = today;
                } else if (newStatus === 'Ready for the box' && !submissions[idx].dateBoxed) {
                    submissions[idx].dateBoxed = today;
                }
                
                // Update working days calculation
                submissions[idx] = updateWorkingDaysForSubmission(submissions[idx]);
                
                saveData('submissions', submissions);
                renderSubmissions();
                updateDashboardSummary();
            }
        }

        function markUrgentQuick(idx) {
            // Open urgency reason modal
            window.currentEditingIdx = idx;
            window.currentUrgencyReason = '';
            openUrgencyReasonModal();
        }

        function submitToSpAdsQuick(idx) {
            const submissions = loadData('submissions');
            if (submissions[idx]) {
                submissions[idx].status = 'With SpAds';
                if (!submissions[idx].dateSubmittedSpads) {
                    submissions[idx].dateSubmittedSpads = new Date().toISOString().split('T')[0];
                }
                // Update working days calculation
                submissions[idx] = updateWorkingDaysForSubmission(submissions[idx]);
                saveData('submissions', submissions);
                renderSubmissions();
            }
        }

        function submitToLCQuick(idx) {
            const submissions = loadData('submissions');
            if (submissions[idx]) {
                submissions[idx].status = 'Ready for the box';
                if (!submissions[idx].dateBoxed) {
                    submissions[idx].dateBoxed = new Date().toISOString().split('T')[0];
                }
                // Update working days calculation
                submissions[idx] = updateWorkingDaysForSubmission(submissions[idx]);
                saveData('submissions', submissions);
                renderSubmissions();
            }
        }

        // --- Filter Functions ---
        let currentFilter = null;

        function clearAllFilters() {
            currentFilter = null;
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            allRows.forEach(row => row.style.display = '');
            updateFilterButtons('all');
        }

        function filterByStatus(status) {
            currentFilter = { type: 'status', value: status };
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            allRows.forEach(row => {
                const statusCell = row.querySelector('.grid-cell:nth-child(6) select');
                if (statusCell && statusCell.value === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterButtons('status');
        }

        function filterByUrgency(urgency) {
            currentFilter = { type: 'urgency', value: urgency };
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            allRows.forEach(row => {
                const urgencyCell = row.querySelector('.grid-cell:nth-child(3)');
                if (urgencyCell && urgencyCell.textContent.trim() === urgency) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterButtons('urgent');
        }

        function showOverdueItems() {
            currentFilter = { type: 'overdue' };
            const submissions = loadData('submissions');
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            
            allRows.forEach((row, idx) => {
                const submission = submissions[idx];
                if (submission && submission.status === 'With SpAds' && submission.dateSubmittedSpads) {
                    const workingDays = calculateWorkingDays(submission.dateSubmittedSpads, submission.dateSpAdComment);
                    if (workingDays >= 5) {
                        row.style.display = '';
                        row.classList.add('overdue-spad-row');
                    } else {
                        row.style.display = 'none';
                    }
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterButtons('overdue');
        }

        function filterByCurrentUser() {
            // Create a simple name selection modal instead of requiring a separate dashboard
            const userName = prompt('Enter your name to filter your items:');
            if (!userName) {
                return;
            }
            
            currentFilter = { type: 'user', value: userName };
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            allRows.forEach(row => {
                const psCell = row.querySelector('.grid-cell:nth-child(1)');
                const spadCell = row.querySelector('.grid-cell:nth-child(2)');
                if ((psCell && psCell.textContent.trim() === userName) || 
                    (spadCell && spadCell.textContent.trim() === userName)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterButtons('user');
        }

        function updateFilterButtons(activeType) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (activeType === 'all') {
                document.querySelector('.filter-btn').classList.add('active');
            } else if (activeType === 'status' && currentFilter && currentFilter.value) {
                // Only highlight the specific status button that was clicked
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    // Handle the special case where button text "Ready for box" maps to status "Ready for the box"
                    if ((currentFilter.value === 'Ready for the box' && btn.textContent === 'Ready for box') ||
                        btn.textContent === currentFilter.value) {
                        btn.classList.add('active');
                    }
                });
            } else if (activeType === 'urgent') {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.textContent === 'Urgent Only') {
                        btn.classList.add('active');
                    }
                });
            } else if (activeType === 'overdue') {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.textContent === 'Overdue') {
                        btn.classList.add('active');
                    }
                });
            } else if (activeType === 'user') {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.textContent === 'My Items') {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function renderArchiveSubmissions() {
            const rows = loadData('archiveSubmissions');
            const container = document.getElementById('archiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA; // Most recent first (descending order)
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.submissionTitle === data.submissionTitle && 
                    row.leadPS === data.leadPS &&
                    row.archivedDate === data.archivedDate
                );
                
                // Calculate working days for display
                const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
                
                // Show draft comments if available, otherwise regular comments
                let commentsDisplay = data.comments || '';
                if (data.spadDraftComments || data.spadDraftBoxNote) {
                    const draftComments = data.spadDraftComments || '';
                    commentsDisplay = draftComments;
                }
                
                // Add urgency reason if item is urgent
                if (data.urgency === 'Urgent' && data.urgencyReason) {
                    const urgencyNote = `[URGENT: ${data.urgencyReason}]`;
                    commentsDisplay = commentsDisplay ? `${urgencyNote} ${commentsDisplay}` : urgencyNote;
                }
                
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${data.urgency || ''}</div>
                    <div class="grid-cell">${data.submissionTitle || ''}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell">${workingDays}</div>
                    <div class="grid-cell">${commentsDisplay}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editArchivedSubmission(${originalIdx})" data-tooltip="Edit this archived submission">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteArchivedSubmission(${originalIdx})" data-tooltip="Delete this archived submission">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteArchivedSubmission(idx) {
            if (!confirm('Are you sure you want to delete this archived submission?')) return;
            const arr = loadData('archiveSubmissions');
            arr.splice(idx, 1);
            saveData('archiveSubmissions', arr);
            renderArchiveSubmissions();
        }

        function editArchivedSubmission(idx) {
            const rows = loadData('archiveSubmissions');
            const data = rows[idx];
            
            // Populate form fields
            document.getElementById('leadPS').value = data.leadPS || '';
            document.getElementById('leadSpAd').value = data.leadSpAd || '';
            document.getElementById('urgency').value = data.urgency || '';
            document.getElementById('submissionType').value = data.submissionType || 'advice';
            document.getElementById('submissionTitle').value = data.submissionTitle || '';
            document.getElementById('deadlineBoxReview').value = data.deadlineBoxReview || '';
            document.getElementById('sharepointLink').value = data.sharepointLink || '';
            document.getElementById('dateReceived').value = data.dateReceived || '';
            document.getElementById('status').value = data.status || '';
            document.getElementById('dateSubmittedSpads').value = data.dateSubmittedSpads || '';
            document.getElementById('dateSpAdComment').value = data.dateSpAdComment || '';
            document.getElementById('dateBoxed').value = data.dateBoxed || '';
            document.getElementById('dateReadout').value = data.dateReadout || '';
            document.getElementById('comments').value = data.comments || '';
            
            // Set urgency reason if it exists
            window.currentUrgencyReason = data.urgencyReason || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('firstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            }
            
            // Change form buttons to show update options
            const buttonsContainer = document.getElementById('submissionFormButtons');
            buttonsContainer.innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateArchivedSubmission(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            // Open the modal
            document.getElementById('itemModal').style.display = 'block';
            
            // Set up event listeners
            setTimeout(() => {
                const urgencySelect = document.getElementById('urgency');
                const deadlineField = document.getElementById('deadlineBoxReview');
                
                if (urgencySelect) {
                    urgencySelect.addEventListener('change', handleUrgencyChange);
                }
                if (deadlineField) {
                    deadlineField.addEventListener('change', calculateUrgencyFromDeadline);
                }
            }, 100);
        }

        function updateArchivedSubmission(idx) {
            const data = getFormData();
            
            // Auto-recalculate urgency based on deadline if not manually overridden
            const manualUrgencyCheckbox = document.getElementById('manualUrgency');
            const isManualOverride = manualUrgencyCheckbox && manualUrgencyCheckbox.checked;
            if (data.deadlineBoxReview && !isManualOverride) {
                const calculatedUrgency = calculateUrgencyFromDeadlineValue(data.deadlineBoxReview);
                console.log('Calculated urgency for archived submission deadline', data.deadlineBoxReview, ':', calculatedUrgency);
                data.urgency = calculatedUrgency;
            }
            
            const archiveArr = loadData('archiveSubmissions');
            
            // If status changed from "Readout", move back to main submissions
            if (data.status !== 'Readout') {
                // Remove from archive
                archiveArr.splice(idx, 1);
                saveData('archiveSubmissions', archiveArr);
                
                // Add to main submissions with updated data
                const mainArr = loadData('submissions');
                // Remove the archived date since it's no longer archived
                delete data.archivedDate;
                mainArr.push(data);
                saveData('submissions', mainArr);
                
                renderSubmissions();
                renderArchiveSubmissions();
                updateDashboardSummary();
                closeModal();
                
                // Switch to main dashboard to show the moved item
                showMainDashboard();
                alert('Item moved back to main submissions due to status change.');
            } else {
                // Keep in archive with updated data
                archiveArr[idx] = data;
                saveData('archiveSubmissions', archiveArr);
                renderArchiveSubmissions();
                closeModal();
            }
        }

        // --- Invite Functions ---
        function addInvite() {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            const arr = loadData('invites');
            arr.push(data);
            saveData('invites', arr);
            renderInvites();
            closeInviteModal();
        }

        function renderInvites() {
            const rows = loadData('invites');
            const container = document.getElementById('inviteGridRows');
            container.innerHTML = '';
            
            // Sort by date (earliest first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.inviteDate || '1900-01-01');
                const dateB = new Date(b.inviteDate || '1900-01-01');
                return dateA - dateB;
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for edit/delete operations
                const originalIdx = rows.findIndex(row => 
                    row.inviteTitle === data.inviteTitle && 
                    row.inviteDate === data.inviteDate &&
                    row.inviteStartTime === data.inviteStartTime
                );
                const row = document.createElement('div');
                row.className = 'grid-row invite-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.inviteTitle || ''}</div>
                    <div class="grid-cell">${data.inviteLeadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.inviteDate)}</div>
                    <div class="grid-cell">${data.inviteStartTime || ''}</div>
                    <div class="grid-cell">${data.inviteEndTime || ''}</div>
                    <div class="grid-cell">${data.diaryManagerComments || ''}</div>
                    <div class="grid-cell">${data.psCommentsInvite || ''}</div>
                    <div class="grid-cell">${data.spadCommentsInvite || ''}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editInviteRow(${originalIdx})" data-tooltip="Edit this invite">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteInviteRow(${originalIdx})" data-tooltip="Delete this invite">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteInviteRow(idx) {
            if (!confirm('Are you sure you want to delete this invite?')) return;
            const arr = loadData('invites');
            arr.splice(idx, 1);
            saveData('invites', arr);
            renderInvites();
        }

        function editInviteRow(idx) {
            const rows = loadData('invites');
            const data = rows[idx];
            
            document.getElementById('inviteTitle').value = data.inviteTitle || '';
            document.getElementById('inviteLeadPS').value = data.inviteLeadPS || '';
            document.getElementById('inviteDate').value = data.inviteDate || '';
            document.getElementById('inviteStartTime').value = data.inviteStartTime || '';
            document.getElementById('inviteEndTime').value = data.inviteEndTime || '';
            document.getElementById('diaryManagerComments').value = data.diaryManagerComments || '';
            document.getElementById('psCommentsInvite').value = data.psCommentsInvite || '';
            document.getElementById('spadCommentsInvite').value = data.spadCommentsInvite || '';
            
            document.querySelector('#inviteModal .modal-header h2').textContent = 'Edit Invite';
            document.querySelector('#inviteModal .form-buttons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateInvite(${idx})">Update Invite</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
            `;
            
            document.getElementById('inviteModal').style.display = 'block';
        }

        function updateInvite(idx) {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            const arr = loadData('invites');
            arr[idx] = data;
            saveData('invites', arr);
            renderInvites();
            closeInviteModal();
        }

        function renderArchiveInvites() {
            const rows = loadData('archiveInvites');
            const container = document.getElementById('inviteArchiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA; // Most recent first (descending order)
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.inviteTitle === data.inviteTitle && 
                    row.inviteDate === data.inviteDate &&
                    row.inviteStartTime === data.inviteStartTime &&
                    row.archivedDate === data.archivedDate
                );
                const row = document.createElement('div');
                row.className = 'grid-row invite-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.inviteTitle || ''}</div>
                    <div class="grid-cell">${data.inviteLeadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.inviteDate)}</div>
                    <div class="grid-cell">${data.inviteStartTime || ''}</div>
                    <div class="grid-cell">${data.inviteEndTime || ''}</div>
                    <div class="grid-cell">${data.diaryManagerComments || ''}</div>
                    <div class="grid-cell">${data.psCommentsInvite || ''}</div>
                    <div class="grid-cell">${data.spadCommentsInvite || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn delete-btn" onclick="deleteArchivedInvite(${originalIdx})" data-tooltip="Delete this archived invite">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteArchivedInvite(idx) {
            if (!confirm('Are you sure you want to delete this archived invite?')) return;
            const arr = loadData('archiveInvites');
            arr.splice(idx, 1);
            saveData('archiveInvites', arr);
            renderArchiveInvites();
        }

        // --- Briefing Functions ---
        function addBriefing() {
            const data = getBriefingFormData();
            if (!data.leadPS || !data.leadSpAd || !data.date || !data.time || !data.title) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            const arr = loadData('briefings');
            arr.push(data);
            saveData('briefings', arr);
            renderBriefings();
            closeBriefingModal();
        }

        function renderBriefings() {
            const rows = loadData('briefings');
            const container = document.getElementById('briefingGridRows');
            container.innerHTML = '';
            
            // Sort by date (earliest first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.date || '1900-01-01');
                const dateB = new Date(b.date || '1900-01-01');
                return dateA - dateB;
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for edit/delete operations
                const originalIdx = rows.findIndex(row => 
                    row.leadPS === data.leadPS && 
                    row.date === data.date &&
                    row.time === data.time &&
                    row.title === data.title
                );
                const row = document.createElement('div');
                row.className = 'grid-row briefing-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.date)}</div>
                    <div class="grid-cell">${data.time || ''}</div>
                    <div class="grid-cell">${data.title || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.commissionDeadline)}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${data.psComments || ''}</div>
                    <div class="grid-cell">${data.spadComments || ''}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editBriefingRow(${originalIdx})" data-tooltip="Edit this briefing">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteBriefingRow(${originalIdx})" data-tooltip="Delete this briefing">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
        }

        function deleteBriefingRow(idx) {
            if (confirm('Are you sure you want to delete this briefing?')) {
                const arr = loadData('briefings');
                arr.splice(idx, 1);
                saveData('briefings', arr);
                renderBriefings();
            }
        }

        function editBriefingRow(idx) {
            const rows = loadData('briefings');
            const data = rows[idx];
            
            document.getElementById('briefingLeadPS').value = data.leadPS || '';
            document.getElementById('briefingLeadSpAd').value = data.leadSpAd || '';
            document.getElementById('briefingDate').value = data.date || '';
            document.getElementById('briefingTime').value = data.time || '';
            document.getElementById('briefingTitle').value = data.title || '';
            document.getElementById('briefingCommissionDeadline').value = data.commissionDeadline || '';
            document.getElementById('briefingSharepointLink').value = data.sharepointLink || '';
            document.getElementById('briefingPSComments').value = data.psComments || '';
            document.getElementById('briefingSpAdComments').value = data.spadComments || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('briefingFirstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            document.getElementById('briefingModalTitle').textContent = 'Edit Briefing';
            document.getElementById('briefingFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateBriefing(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
            `;
            
            document.getElementById('briefingModal').style.display = 'block';
        }

        function updateBriefing(idx) {
            const data = getBriefingFormData();
            if (!data.leadPS || !data.leadSpAd || !data.date || !data.time || !data.title) {
                alert('Please fill in all required fields.');
                return;
            }
            
            const arr = loadData('briefings');
            arr[idx] = data;
            saveData('briefings', arr);
            renderBriefings();
            closeBriefingModal();
        }

        function renderArchiveBriefings() {
            const rows = loadData('archiveBriefings');
            const container = document.getElementById('briefingsArchiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA; // Most recent first (descending order)
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.leadPS === data.leadPS && 
                    row.date === data.date &&
                    row.time === data.time &&
                    row.title === data.title &&
                    row.archivedDate === data.archivedDate
                );
                const row = document.createElement('div');
                row.className = 'grid-row briefing-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.date)}</div>
                    <div class="grid-cell">${data.time || ''}</div>
                    <div class="grid-cell">${data.title || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.commissionDeadline)}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${data.psComments || ''}</div>
                    <div class="grid-cell">${data.spadComments || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn delete-btn" onclick="deleteArchivedBriefing(${originalIdx})" data-tooltip="Delete this archived briefing">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteArchivedBriefing(idx) {
            if (!confirm('Are you sure you want to delete this archived briefing?')) return;
            const arr = loadData('archiveBriefings');
            arr.splice(idx, 1);
            saveData('archiveBriefings', arr);
            renderArchiveBriefings();
        }

        function editArchivedBriefing(idx) {
            const arr = loadData('archiveBriefings');
            const data = arr[idx];
            
            // Populate the briefing modal with archived data
            document.getElementById('briefingLeadPS').value = data.leadPS || '';
            document.getElementById('briefingLeadSpAd').value = data.leadSpAd || '';
            document.getElementById('briefingDate').value = data.date || '';
            document.getElementById('briefingTime').value = data.time || '';
            document.getElementById('briefingTitle').value = data.title || '';
            document.getElementById('briefingCommissionDeadline').value = data.commissionDeadline || '';
            document.getElementById('briefingSharepointLink').value = data.sharepointLink || '';
            document.getElementById('briefingPSComments').value = data.psComments || '';
            document.getElementById('briefingSpAdComments').value = data.spadComments || '';
            
            // Update modal title and buttons for editing archived briefing
            document.getElementById('briefingModalTitle').textContent = 'Edit Archived Briefing';
            document.getElementById('briefingFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateArchivedBriefing(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
            `;
            
            // Show the modal
            document.getElementById('briefingModal').style.display = 'block';
        }

        function updateArchivedBriefing(idx) {
            const data = getBriefingFormData();
            
            // Minimal validation - only require title since that's the most essential field
            if (!data.title) {
                alert('Please fill in at least the Title field.');
                return;
            }
            
            // Keep the archived date and status
            const arr = loadData('archiveBriefings');
            data.archivedDate = arr[idx].archivedDate;
            data.status = 'Complete'; // Keep archived status
            
            // Update the archived briefing
            arr[idx] = data;
            saveData('archiveBriefings', arr);
            renderArchiveBriefings();
            closeBriefingModal();
        }

        // --- Smart Defaults Function ---
        function applySmartDefaults() {
            // Set today's date as default for date received
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateReceived').value = today;
            
            // Get current page context for smart status defaults
            const activeSection = document.querySelector('.main-content > div:not(.hidden)');
            if (activeSection) {
                const statusSelect = document.getElementById('status');
                switch(activeSection.id) {
                    case 'spadBox':
                        statusSelect.value = 'With SpAds';
                        break;
                    case 'lcBox':
                        statusSelect.value = 'Ready for the box';
                        break;
                    default:
                        // Check user's most common status from recent submissions
                        const recentSubmissions = loadData('submissions').slice(-5);
                        const statusCounts = {};
                        recentSubmissions.forEach(sub => {
                            if (sub.status) {
                                statusCounts[sub.status] = (statusCounts[sub.status] || 0) + 1;
                            }
                        });
                        const mostCommonStatus = Object.keys(statusCounts).reduce((a, b) => 
                            statusCounts[a] > statusCounts[b] ? a : b, 'With SpAds');
                        statusSelect.value = mostCommonStatus;
                        break;
                }
            }
            
            // Pre-select most commonly used SpAd
            const recentSubmissions = loadData('submissions').slice(-10);
            const spadCounts = {};
            recentSubmissions.forEach(sub => {
                if (sub.leadSpAd && sub.leadSpAd !== 'No SpAd review') {
                    spadCounts[sub.leadSpAd] = (spadCounts[sub.leadSpAd] || 0) + 1;
                }
            });
            if (Object.keys(spadCounts).length > 0) {
                const mostCommonSpAd = Object.keys(spadCounts).reduce((a, b) => 
                    spadCounts[a] > spadCounts[b] ? a : b);
                document.getElementById('leadSpAd').value = mostCommonSpAd;
            }
        }

        // --- Modal Functions ---
        function openModal() {
            document.getElementById('submissionForm').reset();
            document.querySelector('.modal-header h2').textContent = 'Add New Submission';
            document.getElementById('submissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="addSubmissionFromModal()">Add</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            // Hide timestamp for new items
            const timestampDiv = document.getElementById('firstAddedTimestamp');
            if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            document.getElementById('itemModal').style.display = 'block';
            
            // Apply smart defaults
            applySmartDefaults();
            
            // Reset urgency reason and first added timestamp
            window.currentUrgencyReason = '';
            window.currentFirstAdded = '';
            window.previousUrgencyValue = '';
            window.lastNonUrgentValue = '';
            
            // Set up event listeners for working days calculation
            setTimeout(() => {
                const dateSubmittedSpads = document.getElementById('dateSubmittedSpads');
                const dateSpAdComment = document.getElementById('dateSpAdComment');
                const urgencySelect = document.getElementById('urgency');
                const deadlineField = document.getElementById('deadlineBoxReview');
                
                if (dateSubmittedSpads) {
                    dateSubmittedSpads.addEventListener('change', updateWorkingDaysDisplay);
                }
                if (dateSpAdComment) {
                    dateSpAdComment.addEventListener('change', updateWorkingDaysDisplay);
                }
                if (urgencySelect) {
                    urgencySelect.addEventListener('change', handleUrgencyChange);
                }
                if (deadlineField) {
                    deadlineField.addEventListener('change', calculateUrgencyFromDeadline);
                }
            }, 100);
        }

        // Remove sample rows from the grid if present
        function removeSampleRows() {
            const container = document.querySelector('#mainDashboard .submissions-grid');
            const sampleRows = Array.from(container.querySelectorAll('.grid-row'));
            sampleRows.forEach(row => {
                // Only remove sample rows (those with hardcoded content, not those rendered by JS)
                // We'll check for the 'Edit not implemented in sample row' handler as a marker
                const editBtn = row.querySelector('.edit-btn');
                if (editBtn && editBtn.getAttribute('onclick') && editBtn.getAttribute('onclick').includes('Edit not implemented in sample row')) {
                    row.remove();
                }
            });
        }

        function closeModal() {
            document.getElementById('itemModal').style.display = 'none';
            document.getElementById('submissionForm').reset();
            // Reset urgency reason
            window.currentUrgencyReason = '';
        }

        // --- Commission Functions ---
        function getCommissionFormData() {
            return {
                action: document.getElementById('commissionAction').value || '',
                leadPS: document.getElementById('commissionLeadPS').value || '',
                deadline: document.getElementById('commissionDeadline').value || '',
                status: document.getElementById('commissionStatus').value || ''
            };
        }

        function openCommissionModal() {
            document.getElementById('commissionModal').style.display = 'block';
            document.getElementById('commissionModalTitle').textContent = 'Add New Commission';
            
            // Hide timestamp for new items
            const timestampDiv = document.getElementById('commissionFirstAddedTimestamp');
            if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Reset first added timestamp
            window.currentFirstAdded = '';
            
            clearCommissionForm();
        }

        function closeCommissionModal() {
            document.getElementById('commissionModal').style.display = 'none';
            clearCommissionForm();
            resetCommissionFormButtons();
        }

        function clearCommissionForm() {
            document.getElementById('commissionAction').value = '';
            document.getElementById('commissionLeadPS').value = '';
            document.getElementById('commissionDeadline').value = '';
            document.getElementById('commissionStatus').value = '';
        }

        function addCommission() {
            const data = getCommissionFormData();
            
            if (!data.action.trim()) {
                alert('Please enter an action description');
                return;
            }
            
            if (!data.leadPS) {
                alert('Please select a PS');
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            const arr = loadData('commissions');
            arr.push(data);
            saveData('commissions', arr);
            renderCommissions();
            closeCommissionModal();
        }

        function renderCommissions() {
            const rows = loadData('commissions');
            const container = document.getElementById('commissionGridRows');
            container.innerHTML = '';
            
            rows.forEach((data, idx) => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.action || ''}</div>
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.deadline)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editCommission(${idx})" data-tooltip="Edit this commission">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteCommission(${idx})" data-tooltip="Delete this commission">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function renderCommissionArchive() {
            const rows = loadData('commissionArchive');
            const container = document.getElementById('commissionArchiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA;
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.action === data.action && 
                    row.leadPS === data.leadPS &&
                    row.deadline === data.deadline &&
                    row.status === data.status &&
                    row.archivedDate === data.archivedDate
                );
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.action || ''}</div>
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.deadline)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn delete-btn" onclick="deleteArchivedCommission(${originalIdx})" data-tooltip="Delete this archived commission">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function editArchivedCommission(idx) {
            const arr = loadData('commissionArchive');
            const data = arr[idx];
            
            // Populate the commission modal with archived data
            document.getElementById('commissionAction').value = data.action || '';
            document.getElementById('commissionLeadPS').value = data.leadPS || '';
            document.getElementById('commissionDeadline').value = data.deadline || '';
            document.getElementById('commissionStatus').value = data.status || '';
            
            // Update modal title and buttons for editing archived commission
            document.getElementById('commissionModalTitle').textContent = 'Edit Archived Commission';
            document.getElementById('commissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateArchivedCommission(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeCommissionModal()">Cancel</button>
            `;
            
            // Show the modal
            document.getElementById('commissionModal').style.display = 'block';
        }

        function updateArchivedCommission(idx) {
            const data = getCommissionFormData();
            
            // Minimal validation - only require action since that's the most essential field
            if (!data.action) {
                alert('Please fill in at least the Action field.');
                return;
            }
            
            // Keep the archived date and ensure status remains Complete
            const arr = loadData('commissionArchive');
            data.archivedDate = arr[idx].archivedDate;
            data.status = 'Complete'; // Keep archived status
            
            // Update the archived commission
            arr[idx] = data;
            saveData('commissionArchive', arr);
            renderCommissionArchive();
            closeCommissionModal();
        }

        function deleteArchivedCommission(idx) {
            if (!confirm('Are you sure you want to delete this archived commission?')) return;
            const arr = loadData('commissionArchive');
            arr.splice(idx, 1);
            saveData('commissionArchive', arr);
            renderCommissionArchive();
        }

        function editCommission(idx) {
            const arr = loadData('commissions');
            const data = arr[idx];
            
            document.getElementById('commissionAction').value = data.action || '';
            document.getElementById('commissionLeadPS').value = data.leadPS || '';
            document.getElementById('commissionDeadline').value = data.deadline || '';
            document.getElementById('commissionStatus').value = data.status || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('commissionFirstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            document.getElementById('commissionModalTitle').textContent = 'Edit Commission';
            document.getElementById('commissionModal').style.display = 'block';
            
            // Change button functionality for editing
            const addButton = document.querySelector('#commissionFormButtons .btn-add');
            addButton.textContent = 'Update';
            addButton.onclick = function() { updateCommission(idx); };
        }

        function updateCommission(idx) {
            const data = getCommissionFormData();
            
            if (!data.action.trim()) {
                alert('Please enter an action description');
                return;
            }
            
            if (!data.leadPS) {
                alert('Please select a PS');
                return;
            }
            
            if (!data.deadline) {
                alert('Please enter a deadline');
                return;
            }
            
            if (!data.status) {
                alert('Please select a status');
                return;
            }
            
            // If status is complete, move to archive and remove from commissions
            if (data.status === 'Complete') {
                const archiveData = { ...data, archivedDate: new Date().toISOString().split('T')[0] };
                const archiveArr = loadData('commissionArchive');
                archiveArr.push(archiveData);
                saveData('commissionArchive', archiveArr);
                
                const arr = loadData('commissions');
                arr.splice(idx, 1);
                saveData('commissions', arr);
                
                renderCommissions();
                renderCommissionArchive();
                closeCommissionModal();
                resetCommissionFormButtons();
                alert('Commission marked as complete and moved to archive');
                return;
            }
            
            const arr = loadData('commissions');
            arr[idx] = data;
            saveData('commissions', arr);
            renderCommissions();
            closeCommissionModal();
            resetCommissionFormButtons();
        }

        function deleteCommission(idx) {
            if (!confirm('Are you sure you want to delete this commission?')) return;
            const arr = loadData('commissions');
            arr.splice(idx, 1);
            saveData('commissions', arr);
            renderCommissions();
        }

        function resetCommissionFormButtons() {
            const addButton = document.querySelector('#commissionFormButtons .btn-add');
            addButton.textContent = 'Add';
            addButton.onclick = addCommission;
        }

        // --- Urgency Reason Modal Functions ---
        function openUrgencyReasonModal() {
            document.getElementById('urgencyReason').value = window.currentUrgencyReason || '';
            document.getElementById('urgencyReasonModal').style.display = 'block';
        }

        function closeUrgencyReasonModal() {
            document.getElementById('urgencyReasonModal').style.display = 'none';
        }

        function confirmUrgencyReason() {
            const reason = document.getElementById('urgencyReason').value.trim();
            if (!reason) {
                alert('Please provide a reason for the urgent priority.');
                return;
            }
            window.currentUrgencyReason = reason;
            
            // If we're editing from quick action, update the submission
            if (window.currentEditingIdx !== undefined) {
                const submissions = loadData('submissions');
                if (submissions[window.currentEditingIdx]) {
                    submissions[window.currentEditingIdx].urgency = 'Urgent';
                    submissions[window.currentEditingIdx].urgencyReason = reason;
                    saveData('submissions', submissions);
                    renderSubmissions();
                }
                window.currentEditingIdx = undefined;
            }
            
            closeUrgencyReasonModal();
        }

        function cancelUrgencyReason() {
            // Reset urgency back to previous value or empty
            const urgencySelect = document.getElementById('urgency');
            if (urgencySelect) {
                urgencySelect.value = window.previousUrgencyValue || '';
            }
            window.currentUrgencyReason = '';
            closeUrgencyReasonModal();
        }

        function handleUrgencyChange() {
            const urgencySelect = document.getElementById('urgency');
            if (!urgencySelect) return;
            
            const newValue = urgencySelect.value;
            
            if (newValue === 'Urgent') {
                // Store the previous value in case user cancels
                window.previousUrgencyValue = window.lastNonUrgentValue || '';
                openUrgencyReasonModal();
            } else {
                // Store non-urgent values for potential rollback
                window.lastNonUrgentValue = newValue;
                window.currentUrgencyReason = '';
            }
        }

        function openInviteModal() {
            document.getElementById('inviteForm').reset();
            document.querySelector('#inviteModal .modal-header h2').textContent = 'Add New Invite';
            document.querySelector('#inviteModal .form-buttons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="addInvite()">Add Invite</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
            `;
            document.getElementById('inviteModal').style.display = 'block';
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
            document.getElementById('inviteForm').reset();
        }

        function openBriefingModal() {
            document.getElementById('briefingForm').reset();
            document.getElementById('briefingModalTitle').textContent = 'Add New Briefing';
            document.getElementById('briefingFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="addBriefing()">Add</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
            `;
            
            // Hide timestamp for new items
            const timestampDiv = document.getElementById('briefingFirstAddedTimestamp');
            if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Reset first added timestamp
            window.currentFirstAdded = '';
            
            document.getElementById('briefingModal').style.display = 'block';
        }

        function closeBriefingModal() {
            document.getElementById('briefingModal').style.display = 'none';
            document.getElementById('briefingForm').reset();
        }

        // --- Page State Management ---
        function saveCurrentPage(pageId) {
            try {
                localStorage.setItem('currentPage', pageId);
            } catch (error) {
                console.error('Error saving current page:', error);
            }
        }

        function loadCurrentPage() {
            try {
                return localStorage.getItem('currentPage') || 'mainDashboard';
            } catch (error) {
                console.error('Error loading current page:', error);
                return 'mainDashboard';
            }
        }

        function restoreCurrentPage() {
            const currentPage = loadCurrentPage();
            console.log('Restoring page:', currentPage);
            
            // Map page IDs to their show functions
            const pageMap = {
                'mainDashboard': showMainDashboard,
                'archiveBox': showArchiveBox,
                'invites': showInvites,
                'briefings': showBriefings,
                'inviteArchive': showInviteArchive,
                'briefingsArchive': showBriefingsArchive,
                'commissions': showCommissions,
                'commissionArchive': showCommissionArchive,
                'daybook': showDaybook,
                'editTeam': showEditTeam
            };
            
            // Call the appropriate show function, defaulting to main dashboard
            const showFunction = pageMap[currentPage] || showMainDashboard;
            showFunction();
        }

        // --- Navigation Functions ---
        function showMainDashboard() {
            hideAllSections();
            document.getElementById('mainDashboard').classList.remove('hidden');
            updateActiveNav('Box work');
            renderSubmissions();
            saveCurrentPage('mainDashboard');
        }

        function showArchiveBox() {
            hideAllSections();
            document.getElementById('archiveBox').classList.remove('hidden');
            updateActiveNav('Archive box');
            renderArchiveSubmissions();
            saveCurrentPage('archiveBox');
        }

        function showInvites() {
            hideAllSections();
            document.getElementById('invites').classList.remove('hidden');
            updateActiveNav('Invites');
            renderInvites();
            saveCurrentPage('invites');
        }

        function showBriefings() {
            hideAllSections();
            document.getElementById('briefings').classList.remove('hidden');
            updateActiveNav('Briefings');
            renderBriefings();
            saveCurrentPage('briefings');
        }

        function showInviteArchive() {
            hideAllSections();
            document.getElementById('inviteArchive').classList.remove('hidden');
            updateActiveNav('Archive invites');
            renderArchiveInvites();
            saveCurrentPage('inviteArchive');
        }

        function showBriefingsArchive() {
            hideAllSections();
            document.getElementById('briefingsArchive').classList.remove('hidden');
            updateActiveNav('Archive briefings');
            renderArchiveBriefings();
            saveCurrentPage('briefingsArchive');
        }

        function showCommissions() {
            hideAllSections();
            document.getElementById('commissions').classList.remove('hidden');
            updateActiveNav('Commissions');
            renderCommissions();
            saveCurrentPage('commissions');
        }

        function showCommissionArchive() {
            hideAllSections();
            document.getElementById('commissionArchive').classList.remove('hidden');
            updateActiveNav('Archive commissions');
            renderCommissionArchive();
            saveCurrentPage('commissionArchive');
        }

        function showDaybook() {
            hideAllSections();
            document.getElementById('daybook').classList.remove('hidden');
            updateActiveNav('Daybook');
            // Clear any previous results
            document.getElementById('daybookResults').style.display = 'none';
            document.getElementById('daybookDatePicker').value = '';
            saveCurrentPage('daybook');
        }

        function hideAllSections() {
            const sections = document.querySelectorAll('.main-content > div');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Clear search when switching pages
            if (currentSearchTerm) {
                clearSearch();
            }
            
            // Update search visibility
            setTimeout(updateSearchVisibility, 100);
        }

        function updateActiveNav(sectionName) {
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelectorAll('.sidebar a').forEach(link => {
                if (link.textContent.trim() === sectionName) {
                    link.classList.add('active');
                }
            });
        }

        // --- SpAd Comment Modal Functions ---
        let currentSpAdRow = null;

        function openSpAdCommentModal(button) {
            currentSpAdRow = button.closest('.grid-row');
            document.getElementById('spadCommentForm').reset();
            
            // Load any existing draft data
            const cells = currentSpAdRow.querySelectorAll('.grid-cell');
            const submissionTitle = cells[3].textContent;
            const leadPS = cells[0].textContent;
            
            const submissions = loadData('submissions');
            const submission = submissions.find(sub => 
                sub.submissionTitle === submissionTitle && sub.leadPS === leadPS
            );
            
            if (submission && (submission.spadDraftComments || submission.spadDraftBoxNote)) {
                document.getElementById('psComments').value = submission.spadDraftComments || '';
                document.getElementById('boxNote').value = submission.spadDraftBoxNote || '';
            }
            
            document.getElementById('spadCommentModal').style.display = 'block';
        }

        function closeSpAdCommentModal() {
            document.getElementById('spadCommentModal').style.display = 'none';
            document.getElementById('spadCommentForm').reset();
            currentSpAdRow = null;
        }

        function saveSpAdDraft() {
            const psComments = document.getElementById('psComments').value;
            const boxNote = document.getElementById('boxNote').value;
            
            if (!psComments.trim() && !boxNote) {
                alert('Please enter comments and/or confirm box note status before saving.');
                return;
            }
            
            const cells = currentSpAdRow.querySelectorAll('.grid-cell');
            const submissionTitle = cells[3].textContent;
            const leadPS = cells[0].textContent;
            
            // Update the submission in localStorage with draft data
            const submissions = loadData('submissions');
            const submissionIdx = submissions.findIndex(sub => 
                sub.submissionTitle === submissionTitle && sub.leadPS === leadPS
            );
            
            if (submissionIdx !== -1) {
                // Save as draft data (separate from final comments)
                submissions[submissionIdx].spadDraftComments = psComments;
                submissions[submissionIdx].spadDraftBoxNote = boxNote;
                saveData('submissions', submissions);
            }
            
            // Update all views to show draft indicator
            renderSubmissions();
            
            // Close modal and show success message
            closeSpAdCommentModal();
            alert('Draft comments saved successfully. You can continue editing later.');
        }

        function submitSpAdComment() {
            const psComments = document.getElementById('psComments').value;
            const boxNote = document.getElementById('boxNote').value;
            
            if (!psComments.trim() && !boxNote) {
                alert('Please enter comments and/or confirm box note status before submitting.');
                return;
            }
            
            const cells = currentSpAdRow.querySelectorAll('.grid-cell');
            const submissionTitle = cells[3].textContent;
            const leadPS = cells[0].textContent;
            
            // Update the SpAd comment date to today (stored only in data, not displayed in grid)
            const today = new Date().toISOString().split('T')[0];
            
            // Add comments to the comments field
            let existingComments = cells[7].textContent;
            let newComments = '';
            
            if (psComments.trim()) {
                newComments += `SpAd Comments: ${psComments}`;
            }
            if (boxNote) {
                if (newComments) newComments += ' | ';
                newComments += `Box Note Added: ${boxNote}`;
            }
            
            if (existingComments && existingComments.trim()) {
                cells[7].textContent = existingComments + ' | ' + newComments;
            } else {
                cells[7].textContent = newComments;
            }
            
            // Update status to "With PS"
            cells[5].textContent = 'With PS';
            
            // Update the submission in localStorage
            const submissions = loadData('submissions');
            const submissionIdx = submissions.findIndex(sub => 
                sub.submissionTitle === submissionTitle && sub.leadPS === leadPS
            );
            
            if (submissionIdx !== -1) {
                submissions[submissionIdx].dateSpAdComment = today;
                submissions[submissionIdx].comments = cells[7].textContent;
                submissions[submissionIdx].status = 'With PS';
                // Update working days calculation
                submissions[submissionIdx] = updateWorkingDaysForSubmission(submissions[submissionIdx]);
                saveData('submissions', submissions);
            }
            
            // Update all views
            renderSubmissions();
            
            closeSpAdCommentModal();
        }

        // --- Initialize the application ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Clear any corrupted data first
            try {
                const existingData = loadData('submissions');
                console.log('Existing submissions on load:', existingData);
            } catch (error) {
                console.error('Error loading existing submissions, clearing localStorage:', error);
                localStorage.removeItem('submissions');
            }
            
            // Initialize with sample data if localStorage is empty
            if (loadData('submissions').length === 0) {
                console.log('No submissions found, creating sample data');
                const sampleData = {
                    leadPS: 'Sample PS',
                    leadSpAd: 'Sample SpAd',
                    urgency: 'Routine',
                    submissionTitle: 'Sample Submission',
                    sharepointLink: 'https://sharepoint.com/sample',
                    dateReceived: '2024-01-15',
                    status: 'With SpAds',
                    dateSubmittedSpads: '2024-01-16',
                    workingDays: '3',
                    dateSpAdComment: '2024-01-19',
                    dateBoxed: '2024-01-20',
                    comments: 'Sample comments'
                };
                const submissions = [sampleData];
                saveData('submissions', submissions);
            }
            
            console.log('About to render all sections');
            // Load initial data and render all sections
            renderSubmissions();
            renderArchiveSubmissions();
            renderInvites();
            renderArchiveInvites();
            renderBriefings();
            renderArchiveBriefings();
            console.log('All sections rendered');
            
            // Initialize status dropdowns with saved fields
            updateAllStatusDropdowns();
            
            // Apply SpAd settings on page load
            applySpAdSettings();
            
            // Apply process settings on page load
            applyProcessSettings();
            
            // Restore the last visited page
            restoreCurrentPage();
            
            // Close modals when clicking outside
            window.onclick = function(event) {
                const itemModal = document.getElementById('itemModal');
                const inviteModal = document.getElementById('inviteModal');
                const briefingModal = document.getElementById('briefingModal');
                const spadCommentModal = document.getElementById('spadCommentModal');
                const commissionModal = document.getElementById('commissionModal');
                
                if (event.target === itemModal) {
                    closeModal();
                }
                if (event.target === inviteModal) {
                    closeInviteModal();
                }
                if (event.target === briefingModal) {
                    closeBriefingModal();
                }
                if (event.target === spadCommentModal) {
                    closeSpAdCommentModal();
                }
                if (event.target === commissionModal) {
                    closeCommissionModal();
                }
            };

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Only activate shortcuts if no modal is open and not typing in an input
                if (document.querySelector('.modal[style*="block"]') || 
                    ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
                    return;
                }
                
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'n':
                            e.preventDefault();
                            openModal();
                            break;
                        case 'f':
                            e.preventDefault();
                            document.getElementById('searchInput').focus();
                            break;
                    }
                } else {
                    switch(e.key.toLowerCase()) {
                        case 'u':
                            e.preventDefault();
                            filterByUrgency('Urgent');
                            break;
                        case 's':
                            e.preventDefault();
                            filterByStatus('With SpAds');
                            break;
                        case 'l':
                            e.preventDefault();
                            filterByStatus('Ready for the box');
                            break;
                        case 'escape':
                            clearAllFilters();
                            break;
                    }
                }
            });
        });

        function updateWorkingDaysDisplay() {
            const dateSubmittedSpads = document.getElementById('dateSubmittedSpads').value;
            const dateSpAdComment = document.getElementById('dateSpAdComment').value;
            const workingDaysField = document.getElementById('workingDays');
            
            if (dateSubmittedSpads) {
                const workingDays = calculateWorkingDays(dateSubmittedSpads, dateSpAdComment);
                workingDaysField.value = workingDays;
            } else {
                workingDaysField.value = '';
            }
        }
        // --- Team Management Functions ---
        
        // Default team members
        const defaultPrivateSecretaries = [
            'Ben', 'James', 'Charlotte', 'Sukh', 'Katie', 'Jess', 'Louisa', 
            'Jo', 'Simran', 'Rachel', 'Hugh', 'Marisa', 'Gemma'
        ];
        
        const defaultSpAds = [
            'Sophie', 'Tash', 'Poppy', 'Josh'
        ];
        
        function loadTeamData() {
            const privateSecretaries = JSON.parse(localStorage.getItem('privateSecretaries') || JSON.stringify(defaultPrivateSecretaries));
            const spAds = JSON.parse(localStorage.getItem('spAds') || JSON.stringify(defaultSpAds));
            return { privateSecretaries, spAds };
        }
        
        function saveTeamData(privateSecretaries, spAds) {
            localStorage.setItem('privateSecretaries', JSON.stringify(privateSecretaries));
            localStorage.setItem('spAds', JSON.stringify(spAds));
        }
        
        function showEditTeam() {
            hideAllSections();
            document.getElementById('editTeam').classList.remove('hidden');
            updateActiveNav('Edit team');
            renderTeamLists();
            renderStatusFieldsList();
            loadSpAdSettingsUI();
            loadProcessSettingsUI();
            saveCurrentPage('editTeam');
        }
        
        function renderTeamLists() {
            const { privateSecretaries, spAds } = loadTeamData();
            
            // Render Private Secretaries
            const psContainer = document.getElementById('privateSecretariesList');
            psContainer.innerHTML = '';
            privateSecretaries.forEach((name, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <span class="team-member-name">${name}</span>
                    <button class="remove-member-btn" onclick="removePrivateSecretary(${index})">
                        Remove
                    </button>
                `;
                psContainer.appendChild(memberDiv);
            });
            
            // Render SpAds
            const spAdsContainer = document.getElementById('spAdsList');
            spAdsContainer.innerHTML = '';
            spAds.forEach((name, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <span class="team-member-name">${name}</span>
                    <button class="remove-member-btn" onclick="removeSpAd(${index})">
                        Remove
                    </button>
                `;
                spAdsContainer.appendChild(memberDiv);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
        }
        
        function addPrivateSecretary() {
            const nameInput = document.getElementById('newPSName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a name for the Private Secretary.');
                return;
            }
            
            const { privateSecretaries, spAds } = loadTeamData();
            
            if (privateSecretaries.includes(name)) {
                alert('This Private Secretary already exists.');
                return;
            }
            
            privateSecretaries.push(name);
            saveTeamData(privateSecretaries, spAds);
            nameInput.value = '';
            renderTeamLists();
        }
        
        function addSpAd() {
            const nameInput = document.getElementById('newSpAdName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a name for the SpAd.');
                return;
            }
            
            const { privateSecretaries, spAds } = loadTeamData();
            
            if (spAds.includes(name)) {
                alert('This SpAd already exists.');
                return;
            }
            
            spAds.push(name);
            saveTeamData(privateSecretaries, spAds);
            nameInput.value = '';
            renderTeamLists();
        }
        
        function removePrivateSecretary(index) {
            const { privateSecretaries, spAds } = loadTeamData();
            const nameToRemove = privateSecretaries[index];
            
            if (confirm(`Are you sure you want to remove ${nameToRemove}?`)) {
                privateSecretaries.splice(index, 1);
                saveTeamData(privateSecretaries, spAds);
                renderTeamLists();
            }
        }
        
        function removeSpAd(index) {
            const { privateSecretaries, spAds } = loadTeamData();
            const nameToRemove = spAds[index];
            
            if (confirm(`Are you sure you want to remove ${nameToRemove}?`)) {
                spAds.splice(index, 1);
                saveTeamData(privateSecretaries, spAds);
                renderTeamLists();
            }
        }
        
        function saveTeamChanges() {
            updateAllDropdowns();
            updateAllStatusDropdowns();
            alert('Settings saved successfully!');
        }

        // --- Status Fields Management ---
        function getDefaultStatusFields() {
            return [
                "With Perm Sec/DGs",
                "With junior minister(s)", 
                "With SpAds",
                "With officials",
                "With PS",
                "Ready for the box",
                "Readout"
            ];
        }

        function loadStatusFields() {
            const stored = localStorage.getItem('statusFields');
            if (stored) {
                return JSON.parse(stored);
            }
            // Return default status options
            return getDefaultStatusFields();
        }

        function saveStatusFields(statusFields) {
            localStorage.setItem('statusFields', JSON.stringify(statusFields));
        }

        function renderStatusFieldsList() {
            const statusFields = loadStatusFields();
            const container = document.getElementById('statusFieldsList');
            if (!container) return;
            
            container.innerHTML = '';
            statusFields.forEach((status, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <span class="team-member-name">${status}</span>
                    <button class="remove-member-btn" onclick="removeStatusField(${index})" 
                            ${status === 'Readout' ? 'disabled title="Readout status cannot be removed as it\'s required for archiving"' : ''}>
                        Remove
                    </button>
                `;
                container.appendChild(memberDiv);
            });
        }

        function addStatusField() {
            const nameInput = document.getElementById('newStatusField');
            const status = nameInput.value.trim();
            
            if (!status) {
                alert('Please enter a status option.');
                return;
            }
            
            const statusFields = loadStatusFields();
            
            if (statusFields.includes(status)) {
                alert('This status option already exists.');
                return;
            }
            
            statusFields.push(status);
            saveStatusFields(statusFields);
            nameInput.value = '';
            renderStatusFieldsList();
            updateAllStatusDropdowns();
        }

        // Helper function to check if SpAd review should be automatically disabled
        function checkAndDisableSpAdReview() {
            const statusFields = loadStatusFields();
            const spAdSettings = loadSpAdSettings();
            
            // If "With SpAds" is not in status fields but SpAd review is enabled
            if (!statusFields.includes('With SpAds') && spAdSettings.enableSpAdReview) {
                spAdSettings.enableSpAdReview = false;
                saveSpAdSettings(spAdSettings);
                
                // Update the UI to reflect the changes
                loadSpAdSettingsUI();
                applySpAdSettings();
                updateAllStatusDropdowns();
                
                return true; // Indicates that SpAd review was disabled
            }
            return false; // No change was needed
        }

        function removeStatusField(index) {
            const statusFields = loadStatusFields();
            const statusToRemove = statusFields[index];
            
            // Prevent removal of Readout status as it's required for archiving
            if (statusToRemove === 'Readout') {
                alert('Cannot remove "Readout" status as it is required for the archiving process.');
                return;
            }
            
            // Special handling for "With SpAds" removal
            if (statusToRemove === 'With SpAds') {
                const spAdSettings = loadSpAdSettings();
                if (spAdSettings.enableSpAdReview) {
                    const confirmMessage = `Are you sure you want to remove "${statusToRemove}"?\n\nThis will automatically disable the SpAd review process and hide all SpAd-related functionality.\n\nNote: Existing items with this status will keep their status, but you won't be able to select this status for new items.`;
                    
                    if (confirm(confirmMessage)) {
                        // Remove the status field
                        statusFields.splice(index, 1);
                        saveStatusFields(statusFields);
                        
                        // Automatically disable the SpAd review process
                        spAdSettings.enableSpAdReview = false;
                        saveSpAdSettings(spAdSettings);
                        
                        // Update the UI to reflect the changes
                        loadSpAdSettingsUI();
                        applySpAdSettings();
                        renderStatusFieldsList();
                        updateAllStatusDropdowns();
                        
                        alert('SpAd review process has been automatically disabled because "With SpAds" status was removed.');
                    }
                } else {
                    // SpAd review is already disabled, proceed with normal removal
                    if (confirm(`Are you sure you want to remove "${statusToRemove}"?\n\nNote: Existing items with this status will keep their status, but you won't be able to select this status for new items.`)) {
                        statusFields.splice(index, 1);
                        saveStatusFields(statusFields);
                        renderStatusFieldsList();
                        updateAllStatusDropdowns();
                    }
                }
            } else {
                // Normal status field removal
                if (confirm(`Are you sure you want to remove "${statusToRemove}"?\n\nNote: Existing items with this status will keep their status, but you won't be able to select this status for new items.`)) {
                    statusFields.splice(index, 1);
                    saveStatusFields(statusFields);
                    renderStatusFieldsList();
                    updateAllStatusDropdowns();
                }
            }
        }

        function resetStatusFieldsToDefault() {
            if (confirm('Are you sure you want to reset to the default status options?\n\nThis will remove any custom status options you\'ve added and restore the original status list.')) {
                // Get the default status options
                const defaultStatuses = getDefaultStatusFields();
                
                // Save the default statuses
                saveStatusFields(defaultStatuses);
                
                // Update the UI
                renderStatusFieldsList();
                updateAllStatusDropdowns();
                
                alert('Status options have been reset to defaults successfully!');
            }
        }

        function updateAllStatusDropdowns() {
            const statusFields = loadStatusFields();
            const spAdSettings = loadSpAdSettings();
            const statusDropdowns = ['status'];
            
            statusDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select status...</option>';
                    
                    statusFields.forEach(status => {
                        // Skip SpAd-related statuses if SpAd review is disabled
                        if (!spAdSettings.enableSpAdReview && status === 'With SpAds') {
                            return;
                        }
                        
                        const option = document.createElement('option');
                        option.value = status;
                        option.textContent = status;
                        dropdown.appendChild(option);
                    });
                    
                    // Restore selected value if it still exists and is allowed
                    const allowedStatuses = statusFields.filter(status => 
                        spAdSettings.enableSpAdReview || status !== 'With SpAds'
                    );
                    if (allowedStatuses.includes(currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
            
            // Also update commission status dropdown with predefined commission statuses
            const commissionDropdown = document.getElementById('commissionStatus');
            if (commissionDropdown) {
                const currentValue = commissionDropdown.value;
                const commissionStatuses = [
                    "With PS",
                    "Commissioned the department", 
                    "With SpAds",
                    "Complete"
                ];
                
                commissionDropdown.innerHTML = '<option value="">Select status...</option>';
                commissionStatuses.forEach(status => {
                    // Skip SpAd-related statuses if SpAd review is disabled
                    if (!spAdSettings.enableSpAdReview && status === 'With SpAds') {
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    commissionDropdown.appendChild(option);
                });
                
                // Restore selected value if it still exists and is allowed
                const allowedCommissionStatuses = commissionStatuses.filter(status => 
                    spAdSettings.enableSpAdReview || status !== 'With SpAds'
                );
                if (allowedCommissionStatuses.includes(currentValue)) {
                    commissionDropdown.value = currentValue;
                }
            }
        }

        // --- SpAd Review Settings ---
        function getDefaultSpAdSettings() {
            return {
                enableSpAdReview: true,
                showSpAdComments: true,
                showSpAdDaysCounter: true,
                autoSubmitToSpAds: true
            };
        }

        function loadSpAdSettings() {
            const stored = localStorage.getItem('spAdSettings');
            if (stored) {
                return JSON.parse(stored);
            }
            // Return default settings
            return getDefaultSpAdSettings();
        }

        function saveSpAdSettings(settings) {
            localStorage.setItem('spAdSettings', JSON.stringify(settings));
        }

        function loadSpAdSettingsUI() {
            const settings = loadSpAdSettings();
            
            document.getElementById('enableSpAdReview').checked = settings.enableSpAdReview;
            document.getElementById('showSpAdComments').checked = settings.showSpAdComments;
            document.getElementById('showSpAdDaysCounter').checked = settings.showSpAdDaysCounter;
            document.getElementById('autoSubmitToSpAds').checked = settings.autoSubmitToSpAds;
            
            // Show/hide SpAd options based on enableSpAdReview
            const spadOptions = document.getElementById('spadReviewOptions');
            if (spadOptions) {
                spadOptions.style.display = settings.enableSpAdReview ? 'block' : 'none';
            }
        }

        function toggleSpAdReview() {
            const enableSpAdReview = document.getElementById('enableSpAdReview').checked;
            const settings = loadSpAdSettings();
            settings.enableSpAdReview = enableSpAdReview;
            saveSpAdSettings(settings);
            
            // Automatically manage "With SpAds" status option
            const statusFields = loadStatusFields();
            const withSpAdsIndex = statusFields.indexOf('With SpAds');
            
            if (!enableSpAdReview && withSpAdsIndex !== -1) {
                // Remove "With SpAds" from status options when SpAd review is disabled
                statusFields.splice(withSpAdsIndex, 1);
                saveStatusFields(statusFields);
                renderStatusFieldsList();
            } else if (enableSpAdReview && withSpAdsIndex === -1) {
                // Add "With SpAds" back to status options when SpAd review is enabled
                // Insert it after "With junior minister(s)" to maintain the original order
                const juniorMinisterIndex = statusFields.indexOf('With junior minister(s)');
                const insertIndex = juniorMinisterIndex !== -1 ? juniorMinisterIndex + 1 : 2;
                statusFields.splice(insertIndex, 0, 'With SpAds');
                saveStatusFields(statusFields);
                renderStatusFieldsList();
            }
            
            // Show/hide SpAd options
            const spadOptions = document.getElementById('spadReviewOptions');
            if (spadOptions) {
                spadOptions.style.display = enableSpAdReview ? 'block' : 'none';
            }
            
            // Apply changes to UI elements
            applySpAdSettings();
            
            // Update status dropdowns to include/exclude SpAd-related statuses
            updateAllStatusDropdowns();
        }

        function updateSpAdSettings() {
            const settings = loadSpAdSettings();
            settings.showSpAdComments = document.getElementById('showSpAdComments').checked;
            settings.showSpAdDaysCounter = document.getElementById('showSpAdDaysCounter').checked;
            settings.autoSubmitToSpAds = document.getElementById('autoSubmitToSpAds').checked;
            saveSpAdSettings(settings);
            
            // Apply changes to UI elements
            applySpAdSettings();
            
            // Update status dropdowns in case SpAd-related options changed
            updateAllStatusDropdowns();
        }

        function applySpAdSettings() {
            const settings = loadSpAdSettings();
            
            // Apply visibility based on settings
            if (!settings.enableSpAdReview) {
                // Hide all SpAd-related elements when SpAd review is disabled
                
                // 1. Hide SpAd form fields and labels
                const spAdFormFields = document.querySelectorAll('[id*="leadSpAd"], [for*="leadSpAd"]');
                spAdFormFields.forEach(el => el.style.display = 'none');
                
                // 2. Hide SpAd date fields
                const spAdDateFields = document.querySelectorAll(
                    '[id="dateSubmittedSpads"], [for="dateSubmittedSpads"], ' +
                    '[id="workingDays"], [for="workingDays"], ' +
                    '[id="dateSpAdComment"], [for="dateSpAdComment"]'
                );
                spAdDateFields.forEach(el => {
                    if (el.closest('.form-group')) {
                        el.closest('.form-group').style.display = 'none';
                    } else {
                        el.style.display = 'none';
                    }
                });
                
                // 3. Hide dashboard summary card for "With SpAds"
                const spadSummaryCard = document.querySelector('.status-card[onclick*="With SpAds"]');
                if (spadSummaryCard) {
                    spadSummaryCard.style.display = 'none';
                }
                
                // 4. Hide "With SpAds" filter button
                const spadFilterButton = document.querySelector('.filter-btn[onclick*="With SpAds"]');
                if (spadFilterButton) {
                    spadFilterButton.style.display = 'none';
                }
                
                // 5. Hide SpAd-related grid columns (SpAd, Days with SpAds)
                // Hide header cells
                const gridHeaders = document.querySelectorAll('.grid-header > div');
                gridHeaders.forEach((header, index) => {
                    if (header.textContent.includes('SpAd') || header.textContent.includes('Days with SpAds')) {
                        header.style.display = 'none';
                        
                        // Also hide corresponding data cells in all grid rows
                        const allGrids = document.querySelectorAll('.submissions-grid');
                        allGrids.forEach(grid => {
                            const rows = grid.querySelectorAll('.grid-row');
                            rows.forEach(row => {
                                const cells = row.querySelectorAll('.grid-cell');
                                if (cells[index]) {
                                    cells[index].style.display = 'none';
                                }
                            });
                        });
                    }
                });
                
                // 6. Hide SpAd comment fields and buttons
                const spAdCommentElements = document.querySelectorAll('[id*="spAdComments"], [for*="spAdComments"]');
                spAdCommentElements.forEach(el => el.style.display = 'none');
                
                // 7. Hide submit to SpAds buttons
                const submitSpAdButtons = document.querySelectorAll('button[onclick*="submitToSpAds"]');
                submitSpAdButtons.forEach(el => el.style.display = 'none');
                
                // 8. Hide SpAd comment modal
                const spadCommentModal = document.getElementById('spadCommentModal');
                if (spadCommentModal) {
                    spadCommentModal.style.display = 'none';
                }
                
                // 9. Update grid column layout to account for hidden columns
                const mainGridHeaders = document.querySelectorAll('.submissions-grid .grid-header');
                mainGridHeaders.forEach(gridHeader => {
                    // Adjust grid template columns by removing SpAd-related columns
                    const currentColumns = gridHeader.style.gridTemplateColumns || '';
                    if (!currentColumns) {
                        // Set a modified grid template that excludes SpAd columns
                        gridHeader.style.gridTemplateColumns = '110px 100px 150px 140px 120px 160px 160px minmax(120px, 1fr)';
                    }
                });
                
            } else {
                // Show SpAd-related elements and apply individual settings
                
                // 1. Show SpAd form fields
                const spAdFormFields = document.querySelectorAll('[id*="leadSpAd"], [for*="leadSpAd"]');
                spAdFormFields.forEach(el => el.style.display = '');
                
                // 2. Show/hide SpAd date fields based on individual settings
                const spAdDateFields = document.querySelectorAll(
                    '[id="dateSubmittedSpads"], [for="dateSubmittedSpads"], ' +
                    '[id="workingDays"], [for="workingDays"], ' +
                    '[id="dateSpAdComment"], [for="dateSpAdComment"]'
                );
                spAdDateFields.forEach(el => {
                    const isVisible = settings.showSpAdDaysCounter;
                    if (el.closest('.form-group')) {
                        el.closest('.form-group').style.display = isVisible ? '' : 'none';
                    } else {
                        el.style.display = isVisible ? '' : 'none';
                    }
                });
                
                // 3. Show dashboard summary card
                const spadSummaryCard = document.querySelector('.status-card[onclick*="With SpAds"]');
                if (spadSummaryCard) {
                    spadSummaryCard.style.display = '';
                }
                
                // 4. Show "With SpAds" filter button
                const spadFilterButton = document.querySelector('.filter-btn[onclick*="With SpAds"]');
                if (spadFilterButton) {
                    spadFilterButton.style.display = '';
                }
                
                // 5. Show/hide SpAd-related grid columns based on settings
                const gridHeaders = document.querySelectorAll('.grid-header > div');
                gridHeaders.forEach((header, index) => {
                    if (header.textContent.includes('SpAd')) {
                        header.style.display = '';
                        
                        // Show corresponding data cells in all grid rows
                        const allGrids = document.querySelectorAll('.submissions-grid');
                        allGrids.forEach(grid => {
                            const rows = grid.querySelectorAll('.grid-row');
                            rows.forEach(row => {
                                const cells = row.querySelectorAll('.grid-cell');
                                if (cells[index]) {
                                    cells[index].style.display = '';
                                }
                            });
                        });
                    } else if (header.textContent.includes('Days with SpAds')) {
                        const isVisible = settings.showSpAdDaysCounter;
                        header.style.display = isVisible ? '' : 'none';
                        
                        // Show/hide corresponding data cells in all grid rows
                        const allGrids = document.querySelectorAll('.submissions-grid');
                        allGrids.forEach(grid => {
                            const rows = grid.querySelectorAll('.grid-row');
                            rows.forEach(row => {
                                const cells = row.querySelectorAll('.grid-cell');
                                if (cells[index]) {
                                    cells[index].style.display = isVisible ? '' : 'none';
                                }
                            });
                        });
                    }
                });
                
                // 6. Show/hide SpAd comment fields based on settings
                const spAdCommentElements = document.querySelectorAll('[id*="spAdComments"], [for*="spAdComments"]');
                spAdCommentElements.forEach(el => {
                    el.style.display = settings.showSpAdComments ? '' : 'none';
                });
                
                // 7. Show/hide submit to SpAds buttons based on settings
                const submitSpAdButtons = document.querySelectorAll('button[onclick*="submitToSpAds"]');
                submitSpAdButtons.forEach(el => {
                    el.style.display = settings.autoSubmitToSpAds ? '' : 'none';
                });
                
                // 8. Restore normal grid column layout
                const mainGridHeaders = document.querySelectorAll('.submissions-grid .grid-header');
                mainGridHeaders.forEach(gridHeader => {
                    // Reset to original grid template
                    gridHeader.style.gridTemplateColumns = '';
                });
            }
        }

        function resetSpAdSettingsToDefault() {
            if (confirm('Are you sure you want to reset SpAd review settings to defaults?\n\nThis will enable all SpAd review functionality and restore the original settings.')) {
                // Get the default SpAd settings
                const defaultSettings = getDefaultSpAdSettings();
                
                // Save the default settings
                saveSpAdSettings(defaultSettings);
                
                // Update the UI
                loadSpAdSettingsUI();
                applySpAdSettings();
                
                alert('SpAd review settings have been reset to defaults successfully!');
            }
        }

        // --- Process Management ---
        function getDefaultProcessSettings() {
            return {
                enableBoxWork: true,
                enableInvites: true,
                enableBriefings: true,
                enableCommissions: true,
                enableDaybook: true,
                enableArchives: true
            };
        }

        function loadProcessSettings() {
            const stored = localStorage.getItem('processSettings');
            if (stored) {
                return JSON.parse(stored);
            }
            // Return default settings
            return getDefaultProcessSettings();
        }

        function saveProcessSettings(settings) {
            localStorage.setItem('processSettings', JSON.stringify(settings));
        }

        function loadProcessSettingsUI() {
            const settings = loadProcessSettings();
            
            document.getElementById('enableBoxWork').checked = settings.enableBoxWork;
            document.getElementById('enableInvites').checked = settings.enableInvites;
            document.getElementById('enableBriefings').checked = settings.enableBriefings;
            document.getElementById('enableCommissions').checked = settings.enableCommissions;
            document.getElementById('enableDaybook').checked = settings.enableDaybook;
            document.getElementById('enableArchives').checked = settings.enableArchives;
            
            // Box Work cannot be disabled - always check it and disable the checkbox
            document.getElementById('enableBoxWork').checked = true;
            document.getElementById('enableBoxWork').disabled = true;
            
            // Update dependencies after loading settings
            updateProcessDependencies();
        }

        function updateProcessSettings() {
            const settings = loadProcessSettings();
            
            // Box Work is always enabled
            settings.enableBoxWork = true;
            settings.enableInvites = document.getElementById('enableInvites').checked;
            settings.enableBriefings = document.getElementById('enableBriefings').checked;
            settings.enableCommissions = document.getElementById('enableCommissions').checked;
            settings.enableDaybook = document.getElementById('enableDaybook').checked;
            settings.enableArchives = document.getElementById('enableArchives').checked;
            
            // Handle dependency: Daybook requires Briefings to function
            if (!settings.enableBriefings && settings.enableDaybook) {
                settings.enableDaybook = false;
                document.getElementById('enableDaybook').checked = false;
                
                // Show notification to user
                alert('Daybook has been automatically disabled because it requires Briefings to function.\n\nDaybook displays briefings organized by date, so it cannot work without the Briefings process enabled.');
            }
            
            // Handle reverse dependency: When re-enabling Briefings, don't auto-enable Daybook
            // but remove the disabled state so user can choose
            
            saveProcessSettings(settings);
            
            // Update UI to reflect dependencies
            updateProcessDependencies();
            
            // Apply changes to navigation
            applyProcessSettings();
        }

        function updateProcessDependencies() {
            const settings = loadProcessSettings();
            
            // Handle Daybook dependency on Briefings
            const daybookCheckbox = document.getElementById('enableDaybook');
            const briefingsCheckbox = document.getElementById('enableBriefings');
            
            if (!settings.enableBriefings) {
                // Disable Daybook checkbox if Briefings is disabled
                daybookCheckbox.disabled = true;
                daybookCheckbox.checked = false;
                
                // Add visual indication that it's dependent
                const daybookLabel = daybookCheckbox.parentElement;
                if (!daybookLabel.querySelector('.dependency-note')) {
                    const dependencyNote = document.createElement('span');
                    dependencyNote.className = 'dependency-note';
                    dependencyNote.style.color = '#666';
                    dependencyNote.style.fontSize = '11px';
                    dependencyNote.style.fontStyle = 'italic';
                    dependencyNote.style.marginLeft = '8px';
                    dependencyNote.textContent = '(requires Briefings)';
                    daybookLabel.appendChild(dependencyNote);
                }
            } else {
                // Enable Daybook checkbox if Briefings is enabled
                daybookCheckbox.disabled = false;
                
                // Remove dependency note
                const daybookLabel = daybookCheckbox.parentElement;
                const dependencyNote = daybookLabel.querySelector('.dependency-note');
                if (dependencyNote) {
                    dependencyNote.remove();
                }
            }
        }

        function applyProcessSettings() {
            const settings = loadProcessSettings();
            
            // Get navigation links
            const navigationLinks = {
                invites: document.querySelector('a[onclick="showInvites()"]'),
                briefings: document.querySelector('a[onclick="showBriefings()"]'),
                commissions: document.querySelector('a[onclick="showCommissions()"]'),
                daybook: document.querySelector('a[onclick="showDaybook()"]'),
                archiveSection: document.querySelector('.archive-section'),
                archiveBox: document.querySelector('a[onclick="showArchiveBox()"]'),
                archiveInvites: document.querySelector('a[onclick="showInviteArchive()"]'),
                archiveBriefings: document.querySelector('a[onclick="showBriefingsArchive()"]'),
                archiveCommissions: document.querySelector('a[onclick="showCommissionArchive()"]')
            };
            
            // Show/hide main navigation links based on settings
            if (navigationLinks.invites) {
                navigationLinks.invites.parentElement.style.display = settings.enableInvites ? 'block' : 'none';
            }
            
            if (navigationLinks.briefings) {
                navigationLinks.briefings.parentElement.style.display = settings.enableBriefings ? 'block' : 'none';
            }
            
            if (navigationLinks.commissions) {
                navigationLinks.commissions.parentElement.style.display = settings.enableCommissions ? 'block' : 'none';
            }
            
            if (navigationLinks.daybook) {
                navigationLinks.daybook.parentElement.style.display = settings.enableDaybook ? 'block' : 'none';
            }
            
            // Handle archive section visibility
            if (navigationLinks.archiveSection) {
                if (settings.enableArchives) {
                    navigationLinks.archiveSection.style.display = 'block';
                    
                    // Show/hide individual archive subsections based on their main process settings
                    if (navigationLinks.archiveBox) {
                        navigationLinks.archiveBox.parentElement.style.display = 'block'; // Box work archive is always available
                    }
                    if (navigationLinks.archiveInvites) {
                        navigationLinks.archiveInvites.parentElement.style.display = settings.enableInvites ? 'block' : 'none';
                    }
                    if (navigationLinks.archiveBriefings) {
                        navigationLinks.archiveBriefings.parentElement.style.display = settings.enableBriefings ? 'block' : 'none';
                    }
                    if (navigationLinks.archiveCommissions) {
                        navigationLinks.archiveCommissions.parentElement.style.display = settings.enableCommissions ? 'block' : 'none';
                    }
                } else {
                    navigationLinks.archiveSection.style.display = 'none';
                }
            }
            
            // If currently viewing a disabled section, redirect to box work
            const currentSection = getCurrentActiveSection();
            const disabledSections = [];
            
            if (!settings.enableInvites) {
                disabledSections.push('invites', 'inviteArchive');
            }
            if (!settings.enableBriefings) {
                disabledSections.push('briefings', 'briefingsArchive');
            }
            if (!settings.enableCommissions) {
                disabledSections.push('commissions', 'commissionArchive');
            }
            if (!settings.enableDaybook) {
                disabledSections.push('daybook');
            }
            if (!settings.enableArchives) {
                disabledSections.push('archiveBox', 'inviteArchive', 'briefingsArchive', 'commissionArchive');
            }
            
            if (disabledSections.includes(currentSection)) {
                showMainDashboard();
            }
        }

        function getCurrentActiveSection() {
            const sections = ['mainDashboard', 'invites', 'briefings', 'commissions', 'daybook', 'archiveBox', 'inviteArchive', 'briefingsArchive', 'commissionArchive', 'editTeam'];
            
            for (const section of sections) {
                const element = document.getElementById(section);
                if (element && !element.classList.contains('hidden')) {
                    return section;
                }
            }
            
            return 'mainDashboard'; // Default fallback
        }

        function resetProcessSettingsToDefault() {
            if (confirm('Are you sure you want to reset process settings to defaults?\n\nThis will enable all processes and restore the full navigation menu.')) {
                // Get the default process settings
                const defaultSettings = getDefaultProcessSettings();
                
                // Save the default settings
                saveProcessSettings(defaultSettings);
                
                // Update the UI
                loadProcessSettingsUI();
                applyProcessSettings();
                
                alert('Process settings have been reset to defaults successfully!');
            }
        }
        
        function updateAllDropdowns() {
            const { privateSecretaries, spAds } = loadTeamData();
            
            // Update all Private Secretary dropdowns
            const psDropdowns = [
                'leadPS', 'briefingLeadPS', 'inviteLeadPS'
            ];
            
            psDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select...</option>';
                    
                    privateSecretaries.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        dropdown.appendChild(option);
                    });
                    
                    // Restore selected value if it still exists
                    if (privateSecretaries.includes(currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
            
            // Update SpAd dropdowns
            const spAdDropdowns = [
                'leadSpAd', 'briefingLeadSpAd'
            ];
            
            spAdDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select...</option>';
                    
                    spAds.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        dropdown.appendChild(option);
                    });
                    
                    // Add "No SpAd review" option
                    const noSpAdOption = document.createElement('option');
                    noSpAdOption.value = 'No SpAd review';
                    noSpAdOption.textContent = 'No SpAd review';
                    dropdown.appendChild(noSpAdOption);
                    
                    // Restore selected value if it still exists
                    if (spAds.includes(currentValue) || currentValue === 'No SpAd review') {
                        dropdown.value = currentValue;
                    }
                }
            });
            
            // Update user select dropdown in personal dashboard
            const userSelect = document.getElementById('userSelect');
            if (userSelect) {
                const currentValue = userSelect.value;
                userSelect.innerHTML = '<option value="">Select your name...</option>';
                
                // Add Private Secretaries optgroup
                const psOptgroup = document.createElement('optgroup');
                psOptgroup.label = 'Private Secretaries';
                privateSecretaries.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    psOptgroup.appendChild(option);
                });
                userSelect.appendChild(psOptgroup);
                
                // Add SpAds optgroup
                const spAdOptgroup = document.createElement('optgroup');
                spAdOptgroup.label = 'SpAds';
                spAds.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    spAdOptgroup.appendChild(option);
                });
                userSelect.appendChild(spAdOptgroup);
                
                // Restore selected value if it still exists
                if (privateSecretaries.includes(currentValue) || spAds.includes(currentValue)) {
                    userSelect.value = currentValue;
                }
            }
        }
        
        // --- Search Functionality ---
        let currentSearchTerm = '';
        
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    currentSearchTerm = searchTerm;
                    
                    if (searchTerm) {
                        searchClear.classList.add('visible');
                    } else {
                        searchClear.classList.remove('visible');
                    }
                    
                    // Perform search on current page
                    performSearch(searchTerm);
                });
                
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        clearSearch();
                    }
                });
            }
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            if (searchInput) {
                searchInput.value = '';
                currentSearchTerm = '';
                searchClear.classList.remove('visible');
                performSearch('');
            }
        }
        
        function performSearch(searchTerm) {
            // Get currently active page
            const activeSection = document.querySelector('.main-content > div:not(.hidden)');
            if (!activeSection) return;
            
            const sectionId = activeSection.id;
            
            // Apply search based on current section
            switch(sectionId) {
                case 'mainDashboard':
                    searchInGrid(searchTerm, '#mainDashboard .grid-row');
                    break;
                case 'personalDashboard':
                    if (!document.getElementById('userPrompt').classList.contains('hidden')) {
                        // User prompt is showing, no search needed
                        return;
                    }
                    searchInGrid(searchTerm, '#personalGridRows .grid-row');
                    break;
                case 'spadBox':
                    searchInGrid(searchTerm, '#spadGridRows .grid-row');
                    break;
                case 'lcBox':
                    searchInGrid(searchTerm, '#lcGridRows .grid-row');
                    break;
                case 'archiveBox':
                    searchInGrid(searchTerm, '#archiveGridRows .grid-row');
                    break;
                case 'invites':
                    searchInGrid(searchTerm, '#inviteGridRows .grid-row');
                    break;
                case 'inviteArchive':
                    searchInGrid(searchTerm, '#inviteArchiveGridRows .grid-row');
                    break;
                case 'briefings':
                    searchInGrid(searchTerm, '#briefingGridRows .grid-row');
                    break;
                case 'briefingsArchive':
                    searchInGrid(searchTerm, '#briefingsArchiveGridRows .grid-row');
                    break;
                case 'commissions':
                    searchInGrid(searchTerm, '#commissionGridRows .grid-row');
                    break;
                case 'commissionArchive':
                    searchInGrid(searchTerm, '#commissionArchiveGridRows .grid-row');
                    break;
                case 'daybook':
                    searchInGrid(searchTerm, '#daybookGridRows .grid-row');
                    break;
                case 'editTeam':
                    searchInTeam(searchTerm);
                    break;
                default:
                    break;
            }
        }
        
        function reapplyCurrentSearch() {
            // Reapply search filter if active
            if (currentSearchTerm) {
                performSearch(currentSearchTerm);
            }
            
            // Reapply current filter if active
            if (currentFilter) {
                switch (currentFilter.type) {
                    case 'status':
                        filterByStatus(currentFilter.value);
                        break;
                    case 'urgency':
                        filterByUrgency(currentFilter.value);
                        break;
                    case 'overdue':
                        showOverdueItems();
                        break;
                    case 'user':
                        filterByCurrentUser();
                        break;
                }
            } else {
                // If no filter is active, update buttons to show "All Items" as active
                updateFilterButtons('all');
            }
        }
        
        function searchInGrid(searchTerm, selector) {
            const rows = document.querySelectorAll(selector);
            
            rows.forEach(row => {
                if (!searchTerm) {
                    row.style.display = '';
                    return;
                }
                
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function searchInTeam(searchTerm) {
            const psMembers = document.querySelectorAll('#privateSecretariesList .team-member');
            const spadMembers = document.querySelectorAll('#spAdsList .team-member');
            
            [...psMembers, ...spadMembers].forEach(member => {
                if (!searchTerm) {
                    member.style.display = '';
                    return;
                }
                
                const text = member.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    member.style.display = '';
                } else {
                    member.style.display = 'none';
                }
            });
        }
        
        function updateSearchVisibility() {
            const searchContainer = document.getElementById('searchContainer');
            const activeSection = document.querySelector('.main-content > div:not(.hidden)');
            
            if (!searchContainer || !activeSection) return;
            
            const sectionId = activeSection.id;
            
            // Show search on all pages except when user prompt is visible in personal dashboard
            if (sectionId === 'personalDashboard' && !document.getElementById('userPrompt').classList.contains('hidden')) {
                searchContainer.classList.add('hidden');
            } else {
                searchContainer.classList.remove('hidden');
            }
        }
        
        // --- Update existing navigation functions to handle search ---
        
        // Initialize dropdowns on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateAllDropdowns();
            initializeSearch();
            updateSearchVisibility();
        });

        // --- Daybook Functions ---
        function filterBriefingsByDate() {
            const selectedDate = document.getElementById('daybookDatePicker').value;
            
            if (!selectedDate) {
                alert('Please select a date to view briefings.');
                return;
            }
            
            // Load briefings data
            const briefings = loadData('briefings');
            const archiveBriefings = loadData('archiveBriefings') || [];
            const allBriefings = [...briefings, ...archiveBriefings];
            
            // Filter briefings by selected date
            const filteredBriefings = allBriefings.filter(briefing => {
                return briefing.date === selectedDate;
            });
            
            // Sort by time (earliest first)
            filteredBriefings.sort((a, b) => {
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                return timeA.localeCompare(timeB);
            });
            
            // Display results
            displayDaybookResults(selectedDate, filteredBriefings);
        }
        
        function displayDaybookResults(selectedDate, briefings) {
            const resultsContainer = document.getElementById('daybookResults');
            const dateHeader = document.getElementById('daybookDateHeader');
            const gridRows = document.getElementById('daybookGridRows');
            const noResultsDiv = document.getElementById('daybookNoResults');
            
            // Show results container
            resultsContainer.style.display = 'block';
            
            // Format and display the selected date
            const formattedDate = formatDateForDisplay(selectedDate);
            dateHeader.textContent = `Briefings for ${formattedDate}`;
            
            // Clear previous results
            gridRows.innerHTML = '';
            
            if (briefings.length === 0) {
                // Show no results message
                noResultsDiv.style.display = 'block';
                document.querySelector('.submissions-grid').style.display = 'none';
            } else {
                // Hide no results message and show grid
                noResultsDiv.style.display = 'none';
                document.querySelector('#daybookResults .submissions-grid').style.display = 'block';
                
                // Populate grid with briefings
                briefings.forEach((briefing) => {
                    const row = document.createElement('div');
                    row.className = 'grid-row';
                    row.innerHTML = `
                        <div class="grid-cell">${briefing.leadPS || ''}</div>
                        <div class="grid-cell">${briefing.leadSpAd || ''}</div>
                        <div class="grid-cell">${briefing.time || ''}</div>
                        <div class="grid-cell">${briefing.title || ''}</div>
                        <div class="grid-cell">${formatDateForDisplay(briefing.commissionDeadline)}</div>
                        <div class="grid-cell">${formatUrlForDisplay(briefing.sharepointLink)}</div>
                        <div class="grid-cell">${briefing.psComments || ''}</div>
                        <div class="grid-cell">${briefing.spadComments || ''}</div>
                    `;
                    gridRows.appendChild(row);
                });
            }
        }
        
        function clearDaybookFilter() {
            document.getElementById('daybookDatePicker').value = '';
            document.getElementById('daybookResults').style.display = 'none';
        }

        // --- Duty Rota Functions ---
        let currentUser = 'Ben'; // This should be set based on login

        // Team member categories
        const teamMembers = {
            juniorPS: ['Ben', 'James', 'Charlotte', 'Sukh', 'Katie', 'Jess'],
            seniorPS: ['Louisa', 'Jo', 'Simran', 'Rachel', 'Hugh', 'Marisa', 'Gemma'],
            spads: ['Sophie', 'Tash', 'Poppy', 'Josh']
        };

        function showDutyRota() {
            hideAllSections();
            document.getElementById('dutyRota').classList.remove('hidden');
            generateRotaSchedule();
            populateOverrideControls();
            renderLeaveRequests();
        }

        function hideAllSections() {
            const sections = ['mainDashboard', 'archiveBox', 'invites', 'inviteArchive', 'briefings', 'briefingsArchive', 'commissions', 'commissionArchive', 'daybook', 'editTeam', 'dutyRota'];
            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });
        }

        function generateRotaSchedule() {
            const container = document.getElementById('rotaScheduleContainer');
            container.innerHTML = '';

            const startDate = new Date();
            const currentDay = startDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Find the next Monday
            const daysUntilMonday = currentDay === 0 ? 1 : (8 - currentDay);
            const nextMonday = new Date(startDate);
            nextMonday.setDate(startDate.getDate() + daysUntilMonday);

            // Generate 8 weeks of rota
            for (let week = 0; week < 8; week++) {
                const weekStart = new Date(nextMonday);
                weekStart.setDate(nextMonday.getDate() + (week * 7));
                
                const weekEnd1 = new Date(weekStart);
                weekEnd1.setDate(weekStart.getDate() + 3); // Thursday
                
                const weekEnd2 = new Date(weekStart);
                weekEnd2.setDate(weekStart.getDate() + 6); // Sunday

                // Create two duty periods per week
                createDutyWeek(container, weekStart, weekEnd1, week * 2, 'Mon-Thu');
                
                const fridayStart = new Date(weekStart);
                fridayStart.setDate(weekStart.getDate() + 4);
                createDutyWeek(container, fridayStart, weekEnd2, week * 2 + 1, 'Fri-Sun');
            }
        }

        function createDutyWeek(container, startDate, endDate, weekIndex, label) {
            const weekElement = document.createElement('div');
            weekElement.className = 'rota-week';
            
            const assignments = getWeekAssignments(weekIndex);
            const weekId = `week-${weekIndex}`;
            
            weekElement.innerHTML = `
                <div class="rota-week-header">
                    <span>${label} Duty</span>
                    <span class="rota-week-dates">${formatDateRange(startDate, endDate)}</span>
                </div>
                <div class="rota-week-content">
                    <div class="duty-row">
                        <div class="duty-role">Junior PS (Primary)</div>
                        <div class="duty-person ${getPersonStatus(assignments.juniorPS, startDate)}" id="${weekId}-junior">
                            ${assignments.juniorPS}
                        </div>
                        <button class="duty-edit-btn" onclick="editDutyAssignment('${weekId}', 'junior-ps', '${assignments.juniorPS}', '${startDate.toISOString()}')">Edit</button>
                    </div>
                    <div class="duty-row">
                        <div class="duty-role">Senior PS (Backup)</div>
                        <div class="duty-person ${getPersonStatus(assignments.seniorPS, startDate)}" id="${weekId}-senior">
                            ${assignments.seniorPS}
                        </div>
                        <button class="duty-edit-btn" onclick="editDutyAssignment('${weekId}', 'senior-ps', '${assignments.seniorPS}', '${startDate.toISOString()}')">Edit</button>
                    </div>
                    <div class="duty-row">
                        <div class="duty-role">SpAd</div>
                        <div class="duty-person ${getPersonStatus(assignments.spad, startDate)}" id="${weekId}-spad">
                            ${assignments.spad}
                        </div>
                        <button class="duty-edit-btn" onclick="editDutyAssignment('${weekId}', 'spad', '${assignments.spad}', '${startDate.toISOString()}')">Edit</button>
                    </div>
                </div>
            `;
            
            container.appendChild(weekElement);
        }

        function getWeekAssignments(weekIndex) {
            const savedAssignments = loadData('dutyRota') || {};
            
            if (savedAssignments[weekIndex]) {
                return savedAssignments[weekIndex];
            }

            // Auto-generate assignments using round-robin
            const assignments = {
                juniorPS: teamMembers.juniorPS[weekIndex % teamMembers.juniorPS.length],
                seniorPS: teamMembers.seniorPS[weekIndex % teamMembers.seniorPS.length],
                spad: teamMembers.spads[weekIndex % teamMembers.spads.length]
            };

            // Check for leave conflicts and reassign if necessary
            const leaveRequests = loadData('leaveRequests') || [];
            assignments.juniorPS = findAvailablePerson(assignments.juniorPS, teamMembers.juniorPS, weekIndex, leaveRequests);
            assignments.seniorPS = findAvailablePerson(assignments.seniorPS, teamMembers.seniorPS, weekIndex, leaveRequests);
            assignments.spad = findAvailablePerson(assignments.spad, teamMembers.spads, weekIndex, leaveRequests);

            return assignments;
        }

        function findAvailablePerson(originalPerson, teamList, weekIndex, leaveRequests) {
            const weekStart = getWeekStartDate(weekIndex);
            
            // Check if original person is on leave
            if (isPersonOnLeave(originalPerson, weekStart, leaveRequests)) {
                // Find next available person
                for (let i = 0; i < teamList.length; i++) {
                    const nextIndex = (weekIndex + i + 1) % teamList.length;
                    const candidate = teamList[nextIndex];
                    if (!isPersonOnLeave(candidate, weekStart, leaveRequests)) {
                        return candidate;
                    }
                }
            }
            
            return originalPerson;
        }

        function isPersonOnLeave(person, dutyDate, leaveRequests) {
            return leaveRequests.some(leave => 
                leave.person === person && 
                leave.status === 'approved' &&
                new Date(leave.startDate) <= dutyDate && 
                new Date(leave.endDate) >= dutyDate
            );
        }

        function getWeekStartDate(weekIndex) {
            const today = new Date();
            const currentDay = today.getDay();
            const daysUntilMonday = currentDay === 0 ? 1 : (8 - currentDay);
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);
            
            const periodStart = new Date(nextMonday);
            const daysToAdd = Math.floor(weekIndex / 2) * 7 + (weekIndex % 2) * 4;
            periodStart.setDate(nextMonday.getDate() + daysToAdd);
            
            return periodStart;
        }

        function getPersonStatus(person, dutyDate) {
            const overrides = loadData('dutyOverrides') || {};
            const leaveRequests = loadData('leaveRequests') || [];
            
            if (overrides[`${dutyDate.toDateString()}-${person}`]) {
                return 'override';
            }
            
            if (isPersonOnLeave(person, dutyDate, leaveRequests)) {
                return 'unavailable';
            }
            
            return '';
        }

        function formatDateRange(startDate, endDate) {
            const options = { month: 'short', day: 'numeric' };
            return `${startDate.toLocaleDateString('en-GB', options)} - ${endDate.toLocaleDateString('en-GB', options)}`;
        }

        function editDutyAssignment(weekId, role, currentPerson, dutyDateStr) {
            const dutyDate = new Date(dutyDateStr);
            const today = new Date();
            const daysDifference = Math.ceil((dutyDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysDifference < 30) {
                // Requires permission
                window.pendingDutyChange = { weekId, role, currentPerson, dutyDate: dutyDateStr };
                document.getElementById('permissionModal').style.display = 'block';
            } else {
                // Can change directly
                showDutyChangeOptions(weekId, role, currentPerson);
            }
        }

        function showDutyChangeOptions(weekId, role, currentPerson) {
            const roleTeams = {
                'junior-ps': teamMembers.juniorPS,
                'senior-ps': teamMembers.seniorPS,
                'spad': teamMembers.spads
            };
            
            const options = roleTeams[role];
            const newPerson = prompt(
                `Current: ${currentPerson}\nSelect new person (${options.join(', ')}):`,
                currentPerson
            );
            
            if (newPerson && options.includes(newPerson)) {
                updateDutyAssignment(weekId, role, newPerson);
            }
        }

        function updateDutyAssignment(weekId, role, newPerson) {
            const assignments = loadData('dutyRota') || {};
            const weekIndex = parseInt(weekId.split('-')[1]);
            
            if (!assignments[weekIndex]) {
                assignments[weekIndex] = getWeekAssignments(weekIndex);
            }
            
            const roleMap = {
                'junior-ps': 'juniorPS',
                'senior-ps': 'seniorPS',
                'spad': 'spad'
            };
            
            assignments[weekIndex][roleMap[role]] = newPerson;
            saveData('dutyRota', assignments);
            
            // Update the display
            const elementMap = {
                'junior-ps': 'junior',
                'senior-ps': 'senior',
                'spad': 'spad'
            };
            
            const element = document.getElementById(`${weekId}-${elementMap[role]}`);
            if (element) {
                element.textContent = newPerson;
                element.className = `duty-person override`;
            }
        }

        function submitLeaveRequest() {
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('End date must be after start date.');
                return;
            }
            
            const leaveRequests = loadData('leaveRequests') || [];
            const newRequest = {
                id: Date.now(),
                person: currentUser,
                startDate: startDate,
                endDate: endDate,
                reason: reason,
                status: 'pending',
                submittedDate: new Date().toISOString()
            };
            
            leaveRequests.push(newRequest);
            saveData('leaveRequests', leaveRequests);
            
            // Clear form
            document.getElementById('leaveStartDate').value = '';
            document.getElementById('leaveEndDate').value = '';
            document.getElementById('leaveReason').value = '';
            
            renderLeaveRequests();
            generateRotaSchedule(); // Refresh to show impact
            
            alert('Leave request submitted successfully!');
        }

        function renderLeaveRequests() {
            const container = document.getElementById('myLeaveRequests');
            const leaveRequests = loadData('leaveRequests') || [];
            const myRequests = leaveRequests.filter(req => req.person === currentUser);
            
            if (myRequests.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No leave requests</p>';
                return;
            }
            
            container.innerHTML = myRequests.map(request => {
                const startDate = new Date(request.startDate).toLocaleDateString('en-GB');
                const endDate = new Date(request.endDate).toLocaleDateString('en-GB');
                
                return `
                    <div class="leave-item ${request.status}">
                        <div>
                            <strong>${startDate} - ${endDate}</strong>
                            <br><small>${request.reason || 'No reason provided'}</small>
                            <br><small>Status: ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}</small>
                        </div>
                        <button class="leave-remove-btn" onclick="removeLeaveRequest(${request.id})">Remove</button>
                    </div>
                `;
            }).join('');
        }

        function removeLeaveRequest(requestId) {
            if (!confirm('Are you sure you want to remove this leave request?')) return;
            
            const leaveRequests = loadData('leaveRequests') || [];
            const updatedRequests = leaveRequests.filter(req => req.id !== requestId);
            saveData('leaveRequests', updatedRequests);
            
            renderLeaveRequests();
            generateRotaSchedule();
        }

        function populateOverrideControls() {
            const weekSelect = document.getElementById('overrideWeek');
            const personSelect = document.getElementById('overridePerson');
            
            // Populate weeks
            weekSelect.innerHTML = '<option value="">Select Week...</option>';
            for (let i = 0; i < 16; i++) {
                const weekStart = getWeekStartDate(i);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + (i % 2 === 0 ? 3 : 2));
                const label = i % 2 === 0 ? 'Mon-Thu' : 'Fri-Sun';
                
                weekSelect.innerHTML += `<option value="${i}">${label} - ${formatDateRange(weekStart, weekEnd)}</option>`;
            }
            
            // Populate all team members
            const allMembers = [...teamMembers.juniorPS, ...teamMembers.seniorPS, ...teamMembers.spads];
            personSelect.innerHTML = '<option value="">Select Person...</option>' + 
                allMembers.map(person => `<option value="${person}">${person}</option>`).join('');
        }

        function applyManualOverride() {
            const weekIndex = document.getElementById('overrideWeek').value;
            const role = document.getElementById('overrideRole').value;
            const person = document.getElementById('overridePerson').value;
            
            if (!weekIndex || !role || !person) {
                alert('Please select all fields for the override.');
                return;
            }
            
            // Validate person can do this role
            const roleTeams = {
                'junior-ps': teamMembers.juniorPS,
                'senior-ps': teamMembers.seniorPS,
                'spad': teamMembers.spads
            };
            
            if (!roleTeams[role].includes(person)) {
                alert(`${person} cannot be assigned to ${role} role.`);
                return;
            }
            
            updateDutyAssignment(`week-${weekIndex}`, role, person);
            
            // Clear selections
            document.getElementById('overrideWeek').value = '';
            document.getElementById('overrideRole').value = '';
            document.getElementById('overridePerson').value = '';
            
            alert('Manual override applied successfully!');
        }

        function submitPermissionRequest() {
            const reason = document.getElementById('permissionReason').value;
            
            if (!reason.trim()) {
                alert('Please provide a reason for the urgent change.');
                return;
            }
            
            // In a real system, this would send to management for approval
            // For now, we'll simulate auto-approval
            const { weekId, role, currentPerson } = window.pendingDutyChange;
            
            alert('Permission request submitted. For demo purposes, this has been auto-approved.');
            showDutyChangeOptions(weekId, role, currentPerson);
            closePermissionModal();
        }

        function closePermissionModal() {
            document.getElementById('permissionModal').style.display = 'none';
            document.getElementById('permissionReason').value = '';
            window.pendingDutyChange = null;
        }

        function exportRotaToCalendar() {
            // This would generate an ICS file or integrate with calendar systems
            alert('Calendar export functionality would be implemented here.\n\nThis would generate:\n- ICS file for import\n- Outlook integration\n- Google Calendar sync');
        }

        // Recalculate urgency for all existing submissions based on current date
        function recalculateAllUrgencies() {
            const submissions = loadData('submissions');
            let updated = false;
            
            submissions.forEach(submission => {
                if (submission.deadlineBoxReview) {
                    const newUrgency = calculateUrgencyFromDeadlineValue(submission.deadlineBoxReview);
                    if (submission.urgency !== newUrgency) {
                        console.log(`Updating urgency for "${submission.submissionTitle}" from ${submission.urgency} to ${newUrgency}`);
                        submission.urgency = newUrgency;
                        updated = true;
                    }
                }
            });
            
            if (updated) {
                saveData('submissions', submissions);
                console.log('Updated urgencies for existing submissions based on current date');
            }
        }

        // Initialize page - recalculate urgencies and render
        function initializePage() {
            recalculateAllUrgencies();
            renderSubmissions();
            updateDashboardSummary();
        }

        // Run initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // Also run on window load as fallback
        window.addEventListener('load', function() {
            initializePage();
        });

    </script>
</body>
</html>
