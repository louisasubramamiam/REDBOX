<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Box</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Responsive table sizing for different zoom levels */
        .submissions-grid,
        .grid-container {
            max-width: min(1400px, 95vw);
            margin: 0 auto;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Ensure grids adapt to container width */
        .grid-header,
        .grid-row,
        .invite-header,
        .briefings-header,
        .commission-header,
        .commission-archive-header,
        #inviteGridRows .grid-row,
        #inviteArchiveGridRows .grid-row,
        #briefingGridRows .grid-row,
        #briefingsArchiveGridRows .grid-row,
        #commissionGridRows .grid-row,
        #commissionArchiveGridRows .grid-row,
        #daybookGridRows .grid-row {
            min-width: 0;
            max-width: 100%;
        }

        /* Better responsive behavior at different zoom levels */
        @media (max-width: 1600px) {
            .grid-header,
            .grid-row {
                gap: 6px;
                padding: 8px;
                font-size: 10px;
            }
            
            .grid-cell {
                padding: 3px;
                font-size: 10px;
            }
        }

        @media (max-width: 1200px) {
            .submissions-grid {
                max-width: 100%;
                padding: 10px;
            }
            
            .grid-header,
            .grid-row {
                gap: 4px;
                padding: 6px;
                font-size: 9px;
            }
            
            .grid-cell {
                padding: 2px;
                font-size: 9px;
            }
        }

        /* Ultra-compact mode for very small screens or high zoom */
        @media (max-width: 900px) {
            .grid-header,
            .grid-row {
                gap: 2px;
                padding: 4px;
                font-size: 8px;
            }
            
            .grid-cell {
                padding: 1px 2px;
                font-size: 8px;
                min-height: 18px;
            }
            
            .action-btn {
                min-width: 20px;
                padding: 1px 2px;
                font-size: 7px;
                height: 20px;
            }
        }

        body {
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            background-color: #fefdf9;
            color: #2d3748;
        }

        .global-header {
            background: linear-gradient(135deg, #ffffff 0%, #faf8f5 100%);
            color: #c41e3a;
            text-align: center;
            padding: 20px 0;
            font-size: 2.2em;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 3px solid #c41e3a;
            box-shadow: 0 4px 12px rgba(196, 30, 58, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .briefcase-icon {
            width: 60px;
            height: 45px;
            border: 3px solid #c41e3a;
            border-radius: 8px;
            position: relative;
            background-color: #f8f8f8;
        }

        .briefcase-icon::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 15px;
            height: 8px;
            background-color: #c41e3a;
            border-radius: 3px 3px 0 0;
        }

        .briefcase-icon::after {
            content: 'CR';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: #c41e3a;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
        }

        .crown-symbol {
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            color: #c41e3a;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 60px); /* Adjust for header height */
        }

        .sidebar {
            min-width: 250px;
            max-width: 250px;
            width: 250px;
            background: linear-gradient(135deg, #f8f6f2 0%, #f5f3ef 100%);
            padding: 20px;
            border-right: 1px solid #e2ddd6;
            flex-shrink: 0;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }

        .sidebar h2 {
            color: #2c5aa0;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar > ul > li {
            margin-bottom: 10px;
        }

        .sidebar a {
            display: block;
            padding: 10px 15px;
            color: #2c5aa0;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.6);
            margin-bottom: 4px;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: linear-gradient(135deg, #2c5aa0 0%, #4d7bc0 100%);
            color: white;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(44, 90, 160, 0.2);
        }

        .archive-section {
            margin-top: 20px;
        }

        .archive-heading {
            display: block;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 10px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #e8f0ff 0%, #f0f6ff 100%);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(44, 90, 160, 0.1);
        }

        .archive-submenu {
            margin-left: 15px;
        }

        .archive-submenu li {
            margin-bottom: 5px;
        }

        .archive-submenu a {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        header h1 {
            color: #2c5aa0;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(44, 90, 160, 0.1);
        }

        /* Ensure table containers properly constrain content */
        .submissions-grid {
            background: linear-gradient(135deg, #ffffff 0%, #fefcf9 100%);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(44, 90, 160, 0.12);
            border: 1px solid #e8e5e0;
            padding: 20px;
            overflow-x: auto;
            width: 100%;
            max-width: 1400px; /* Limit maximum width */
            box-sizing: border-box;
            contain: layout; /* Ensure content is contained */
            margin: 0 auto; /* Center the table */
        }

        .grid-header {
            display: grid;
            grid-template-columns: minmax(80px, 1fr) minmax(80px, 1fr) minmax(60px, 0.8fr) minmax(100px, 1.2fr) minmax(120px, 1.3fr) minmax(90px, 1fr) minmax(70px, 0.9fr) minmax(120px, 1.3fr) minmax(100px, 1.1fr);
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #e8f0ff 0%, #f0f6ff 100%);
            border-radius: 8px;
            font-weight: bold;
            color: #2c5aa0;
            align-items: center;
            box-sizing: border-box;
            box-shadow: 0 2px 6px rgba(44, 90, 160, 0.08);
            max-width: 100%;
            overflow-x: auto;
        }

        .grid-header > div {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 40px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.2;
            padding: 8px 4px;
        }

        /* Ensure all grid items fit within their allocated space */
        .grid-header > *,
        .grid-row > * {
            min-width: 0; /* Allow shrinking */
            overflow: hidden;
            box-sizing: border-box;
        }

        .grid-row {
            display: grid;
            grid-template-columns: minmax(80px, 1fr) minmax(80px, 1fr) minmax(60px, 0.8fr) minmax(100px, 1.2fr) minmax(120px, 1.3fr) minmax(90px, 1fr) minmax(70px, 0.9fr) minmax(120px, 1.3fr) minmax(100px, 1.1fr);
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fefefe 0%, #fdfbf7 100%);
            border-radius: 8px;
            border: 1px solid #e8e5e0;
            min-height: 50px;
            align-items: start; /* Changed from center to start to accommodate wrapped text */
            box-sizing: border-box;
            transition: all 0.2s ease;
            max-width: 100%;
            overflow: visible;
        }

        .grid-row:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.1);
            border-color: #d0c8c0;
        }

        .grid-cell {
            padding: 4px;
            font-size: 11px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            -ms-word-wrap: break-word; /* Microsoft Edge specific */
            word-break: break-word; /* Additional support for Edge */
            line-height: 1.2;
            display: flex;
            align-items: flex-start; /* Changed to flex-start for better text wrapping */
            min-height: 24px;
            overflow: hidden;
            color: #2d3748;
        }

        /* Specific handling for action cells to prevent overflow */
        .grid-cell.actions-cell {
            padding: 2px;
            overflow: hidden; /* Changed from visible to hidden */
            min-width: 0;
            max-width: 100%;
            position: relative;
        }

        .grid-cell input,
        .grid-cell select,
        .grid-cell textarea {
            width: 100%;
            padding: 4px;
            border: 1px solid #d0c8c0;
            border-radius: 6px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 11px;
            background-color: #fefdf9;
            transition: border-color 0.2s ease;
        }

        .grid-cell input:focus,
        .grid-cell select:focus,
        .grid-cell textarea:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }

        .grid-cell textarea {
            resize: vertical;
            min-height: 30px;
        }

        .grid-cell select[multiple] {
            height: 40px;
        }

        .add-row-btn {
            background: linear-gradient(135deg, #2c5aa0 0%, #4d7bc0 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(44, 90, 160, 0.2);
        }

        .add-row-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(44, 90, 160, 0.3);
        }

        .add-item-btn {
            background: linear-gradient(135deg, #ffffff 0%, #faf8f5 100%);
            color: #2c5aa0;
            border: 2px solid #2c5aa0;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(44, 90, 160, 0.1);
        }

        .add-item-btn:hover {
            background: linear-gradient(135deg, #2c5aa0 0%, #4d7bc0 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(44, 90, 160, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #fefcf9 100%);
            margin: 5% auto;
            padding: 30px;
            border: none;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(44, 90, 160, 0.15);
        }

        .modal-header {
            color: #2c5aa0;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #2c5aa0;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #d0c8c0;
            border-radius: 8px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
            background-color: #fefdf9;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group select[multiple] {
            height: 100px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .form-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .btn-add {
            background: linear-gradient(135deg, #2c5aa0 0%, #4d7bc0 100%);
            color: white;
        }

        .btn-submit-spads {
            background: linear-gradient(135deg, #1e4a7a 0%, #2c5aa0 100%);
            color: white;
        }

        .btn-submit-lc {
            background: linear-gradient(135deg, #3d6bb0 0%, #5a7cb0 100%);
            color: white;
        }

        .btn-submit-archive {
            background: linear-gradient(135deg, #5a7cb0 0%, #7a90c0 100%);
            color: white;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
        }

        .form-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .action-btn {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-weight: 500;
            white-space: nowrap;
            margin: 0;
            min-width: 40px;
            max-width: 100%;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: all 0.2s ease;
            position: relative;
            box-sizing: border-box;
            flex: 0 0 auto;
            overflow: hidden;
        }

        .edit-btn {
            background: linear-gradient(135deg, #4d7bc0 0%, #6a8fd0 100%);
            color: white;
            border: 1px solid #3c6bb5;
        }

        .delete-btn {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            border: 1px solid #c82333;
        }

        .archive-btn {
            background: linear-gradient(135deg, #5a7cb0 0%, #7a90c0 100%);
            color: white;
            border: 1px solid #4a6ba0;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Action button container in narrow columns */
        .action-buttons.compact {
            gap: 1px;
            flex-wrap: nowrap;
        }

        .action-buttons.compact .action-btn {
            min-width: 28px;
            padding: 4px;
            font-size: 8px;
        }

        /* For very narrow action columns, show icons only or abbreviated text */
        .action-btn.icon-only {
            min-width: 24px;
            padding: 2px;
            text-overflow: clip;
        }

        /* Ensure tooltips don't interfere with table layout */
        .action-btn::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            margin-bottom: 5px;
            pointer-events: none; /* Prevent tooltip from interfering with layout */
        }

        .action-btn:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* Grid container overflow control */
        .grid-container {
            overflow-x: auto;
            overflow-y: visible;
            width: 100%;
            box-sizing: border-box;
        }

        /* Ensure all grid cells contain their content */
        .grid-header > div,
        .grid-row > div {
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 24px;
            max-width: 100%;
        }
        
        /* Special handling for header cells to allow wrapping */
        .grid-header > div {
            white-space: normal;
            word-wrap: break-word;
            overflow: visible;
            min-height: 40px;
            padding: 8px 4px;
            line-height: 1.2;
        }

        /* Specific handling for action columns */
        .grid-header > div:last-child,
        .grid-row > div:last-child {
            overflow: visible; /* Allow action buttons to be visible but contained */
        }

        /* Make sure text content doesn't overflow in regular cells */
        .grid-row > div:not(:last-child) {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Allow header text to wrap */
        .grid-header > div:not(:last-child) {
            white-space: normal;
            word-wrap: break-word;
            overflow: visible;
        }

        /* Force text wrapping in all comment and text cells across all browsers */
        .grid-cell,
        .grid-row > div {
            hyphens: auto;
            -webkit-hyphens: auto;
            -ms-hyphens: auto;
            -moz-hyphens: auto;
        }

        /* Ensure specific comment columns in each grid type allow text wrapping */
        /* Main grid - Comments column (8th column) */
        .grid-row > div:nth-child(8) {
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: break-word !important;
            overflow: visible !important;
            text-overflow: clip !important;
            hyphens: auto !important;
            -webkit-hyphens: auto !important;
            -ms-hyphens: auto !important;
            -moz-hyphens: auto !important;
        }

        /* Briefings grid - Comments columns (8th and 9th columns) */
        #briefingGridRows .grid-row > div:nth-child(8),
        #briefingGridRows .grid-row > div:nth-child(9),
        #briefingsArchiveGridRows .grid-row > div:nth-child(8),
        #briefingsArchiveGridRows .grid-row > div:nth-child(9) {
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: break-word !important;
            overflow: visible !important;
            text-overflow: clip !important;
        }

        /* Invites grid - Comment columns (9th and 10th columns) */
        #inviteGridRows .grid-row > div:nth-child(9),
        #inviteGridRows .grid-row > div:nth-child(10),
        #inviteArchiveGridRows .grid-row > div:nth-child(9),
        #inviteArchiveGridRows .grid-row > div:nth-child(10) {
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: break-word !important;
            overflow: visible !important;
            text-overflow: clip !important;
        }

        /* Commission grid - Commission details column (1st column) and comments */
        #commissionGridRows .grid-row > div:nth-child(1),
        #commissionArchiveGridRows .grid-row > div:nth-child(1) {
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: break-word !important;
            overflow: visible !important;
            text-overflow: clip !important;
        }

        /* Microsoft Edge specific fixes for text wrapping */
        @media screen and (-ms-high-contrast: active), screen and (-ms-high-contrast: none) {
            /* Target Microsoft Edge specifically */
            .grid-cell {
                word-wrap: break-word;
                -ms-word-wrap: break-word;
                word-break: break-word;
                overflow-wrap: break-word;
            }
            
            .grid-row > div:nth-child(8),  
            .grid-row > div:nth-child(9),  
            .grid-row > div:nth-child(10),
            .grid-cell.comments-cell {
                word-wrap: break-word !important;
                -ms-word-wrap: break-word !important;
                word-break: break-word !important;
                white-space: normal !important;
            }
            
            .grid-cell textarea {
                word-wrap: break-word;
                -ms-word-wrap: break-word;
                word-break: break-word;
                white-space: normal;
            }
            
            .spad-comment-form-group textarea {
                word-wrap: break-word;
                -ms-word-wrap: break-word;
                word-break: break-word;
                white-space: normal;
            }
        }

        /* Universal text wrapping fixes that work across all browsers */
        .grid-cell textarea,
        .form-group textarea,
        .spad-comment-form-group textarea {
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: break-word !important;
            -ms-word-wrap: break-word !important;
        }

        .user-prompt {
            background: linear-gradient(135deg, #ffffff 0%, #fefcf9 100%);
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(44, 90, 160, 0.12);
            border: 1px solid #e8e5e0;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .user-prompt h2 {
            color: #2c5aa0;
            margin-bottom: 20px;
        }

        .user-prompt select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0c8c0;
            border-radius: 8px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-bottom: 20px;
            background-color: #fefdf9;
        }

        .user-prompt button {
            background: linear-gradient(135deg, #2c5aa0 0%, #4d7bc0 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 16px;
            margin-right: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(44, 90, 160, 0.2);
        }

        .user-prompt button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(44, 90, 160, 0.3);
        }

        .user-prompt button.secondary {
            background-color: #5a88d0;
        }

        .user-prompt button.secondary:hover {
            background-color: #4d7bc0;
        }

        .user-info {
            background: linear-gradient(135deg, #e8f0ff 0%, #f0f6ff 100%);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid #d6e8ff;
        }

        .user-info span {
            color: #2c5aa0;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .spad-comment-btn {
            background-color: #3d6bb0;
            color: white;
            padding: 8px 12px;
            border: 1px solid #2c5aa0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-width: 120px;
            position: relative;
        }

        .spad-comment-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Tooltip styles for SpAd comment button */
        .spad-comment-btn::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            margin-bottom: 5px;
        }

        .spad-comment-btn:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .spad-comment-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .spad-comment-modal-content {
            background-color: #fefdf9;
            margin: 15% auto;
            padding: 30px;
            border: none;
            border-radius: 8px;
            width: 60%;
            max-width: 600px;
        }

        .spad-comment-form-group {
            margin-bottom: 20px;
        }

        .spad-comment-form-group label {
            display: block;
            color: #2c5aa0;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .spad-comment-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #b3d4ff;
            border-radius: 4px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }

        .spad-comment-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .spad-comment-btn-submit {
            background-color: #2c5aa0;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .spad-comment-btn-cancel {
            background-color: #dc3545;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
        }

        .spad-comment-btn-submit:hover,
        .spad-comment-btn-cancel:hover {
            opacity: 0.9;
        }

        .url-cell {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 10px;
            color: #0066cc;
            text-decoration: none;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .url-cell:hover {
            color: #004499;
            text-decoration: underline;
        }

        .url-display {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 10px;
            color: #0066cc;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* For very narrow screens, make action buttons more compact */
        @media (max-width: 480px) {
            .action-btn {
                min-width: 24px;
                padding: 2px 4px;
                font-size: 8px;
                gap: 1px;
            }
            
            .action-buttons {
                gap: 1px;
            }
        }

        /* Responsive improvements for action buttons */
        @media (max-width: 1200px) {
            .action-btn {
                min-width: 35px;
                padding: 4px 6px;
                font-size: 9px;
            }
            
            .action-buttons {
                gap: 2px;
            }
        }

        /* Enhanced Mobile/Tablet UI - Improved Responsiveness */
        @media (max-width: 768px) {
            /* Global container improvements */
            .container {
                flex-direction: column;
                padding: 0;
                margin: 0;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .sidebar {
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
            }
            
            .main-content {
                padding: 10px;
                box-sizing: border-box;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            header h1 {
                font-size: 1.8em;
                margin: 10px 0;
            }

            /* Improved table container with scroll indicators */
            .submissions-grid::before {
                content: '← Scroll horizontally to view all columns →';
                display: block;
                text-align: center;
                font-size: 11px;
                color: #666;
                font-style: italic;
                padding: 8px;
                background: linear-gradient(135deg, #f5f3ef 0%, #f8f6f2 100%);
                border-radius: 6px;
                margin-bottom: 8px;
                border: 1px solid #e2ddd6;
            }
            
            /* Enhanced table scrolling */
            .submissions-grid {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                width: 100%;
                box-sizing: border-box;
                border: 1px solid #e8e5e0;
                border-radius: 8px;
                background: linear-gradient(135deg, #ffffff 0%, #fefcf9 100%);
                padding: 8px;
                margin-bottom: 15px;
            }
            
            /* Better scrollbar styling */
            .submissions-grid::-webkit-scrollbar {
                height: 10px;
            }
            
            .submissions-grid::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 6px;
            }
            
            .submissions-grid::-webkit-scrollbar-thumb {
                background: #2c5aa0;
                border-radius: 6px;
                border: 2px solid #f1f1f1;
            }
            
            .submissions-grid::-webkit-scrollbar-thumb:hover {
                background: #1e3f7a;
            }

            /* Optimized grid layouts for mobile readability */
            .grid-header,
            .grid-row {
                min-width: 100%;
                box-sizing: border-box;
                border-radius: 4px;
                margin-bottom: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            /* Box work grid - optimized column widths */
            .grid-header {
                grid-template-columns: 90px 90px 70px 130px 140px 100px 80px 130px 120px;
                min-width: 850px;
                font-size: 10px;
            }
            
            .grid-row {
                grid-template-columns: 90px 90px 70px 130px 140px 100px 80px 130px 120px;
                min-width: 850px;
            }
            
            /* Invite grids - compact mobile layout */
            .invite-header,
            #inviteGridRows .grid-row,
            #inviteArchiveGridRows .grid-row {
                grid-template-columns: 100px 70px 70px 50px 50px 70px 85px 85px 85px 85px;
                min-width: 750px;
                gap: 6px;
            }
            
            .invite-header {
                font-size: 10px;
            }
            
            /* Briefings grids - optimized for mobile */
            .briefings-header,
            #briefingGridRows .grid-row,
            #briefingsArchiveGridRows .grid-row {
                grid-template-columns: 95px 95px 85px 70px 130px 85px 120px 110px 110px 130px;
                min-width: 930px;
                gap: 6px;
            }
            
            .briefings-header {
                font-size: 10px;
            }
            
            /* Commission grids - mobile optimized */
            .commission-header,
            #commissionGridRows .grid-row {
                grid-template-columns: 250px 100px 120px 100px;
                min-width: 570px;
                gap: 6px;
            }
            
            .commission-archive-header,
            #commissionArchiveGridRows .grid-row {
                grid-template-columns: 250px 100px 120px 100px 100px;
                min-width: 670px;
                gap: 6px;
            }
            
            /* Daybook grids - mobile layout */
            #daybookGridRows .grid-row {
                grid-template-columns: 100px 100px 80px 140px 95px 140px 120px 120px;
                min-width: 795px;
                gap: 6px;
            }
            
            /* Duty Rota grids - mobile optimized */
            #rotaContainer .grid-header,
            #rotaContainer .grid-row {
                grid-template-columns: 160px 120px 120px 120px 80px;
                min-width: 600px;
                gap: 10px;
            }
            
            /* Enhanced mobile grid cells */
            .grid-cell {
                font-size: 10px;
                padding: 6px 4px;
                line-height: 1.3;
                min-height: 20px;
                overflow: hidden;
                text-overflow: ellipsis;
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
                -webkit-hyphens: auto;
                -ms-hyphens: auto;
            }
            
            /* Better action buttons on mobile */
            .action-buttons {
                justify-content: flex-start;
                gap: 1px;
                flex-wrap: nowrap;
                overflow: hidden;
                max-width: 100%;
                padding: 2px;
            }
            
            .action-btn {
                min-width: 28px;
                max-width: 28px;
                padding: 2px 4px;
                font-size: 8px;
                border-radius: 3px;
                flex-shrink: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Mobile form improvements */
            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 10px;
            }
            
            .form-grid input,
            .form-grid select,
            .form-grid textarea {
                font-size: 14px;
                padding: 8px;
                border-radius: 6px;
            }
            
            .form-grid textarea {
                min-height: 60px;
            }
            
            /* Enhanced quick filters */
            .quick-filters {
                flex-wrap: wrap;
                gap: 4px;
                justify-content: flex-start;
                margin-bottom: 10px;
            }
            
            .filter-btn {
                font-size: 10px;
                padding: 5px 10px;
                border-radius: 4px;
                flex-shrink: 0;
                white-space: nowrap;
            }
            
            /* Improved dashboard cards */
            .dashboard-summary {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
                padding: 10px 0;
            }
            
            .status-card {
                padding: 12px;
                border-radius: 6px;
                text-align: center;
            }
            
            .status-card h3 {
                font-size: 1.6em;
                margin-bottom: 5px;
            }
            
            .status-card p {
                font-size: 12px;
                margin: 0;
            }
            
            /* Mobile search container */
            .search-container {
                position: fixed;
                bottom: 10px;
                right: 10px;
                min-width: 180px;
                max-width: calc(100vw - 20px);
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-radius: 8px;
            }
            
            .search-container input {
                font-size: 14px;
                padding: 8px;
            }
            
            /* Enhanced modal for mobile */
            .modal-content {
                margin: 5% auto;
                width: 95%;
                max-width: 500px;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
                border-radius: 8px;
                box-sizing: border-box;
            }
            
            .modal h2 {
                font-size: 1.4em;
                margin-bottom: 15px;
            }
            
            /* Improved sidebar navigation */
            .sidebar ul {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
                padding: 0;
                margin: 0;
            }
            
            .sidebar li {
                margin-bottom: 0;
                list-style: none;
            }
            
            .sidebar a {
                padding: 8px 12px;
                font-size: 13px;
                border-radius: 6px;
                display: block;
                white-space: nowrap;
                text-decoration: none;
                background: linear-gradient(135deg, #f5f3ef 0%, #f8f6f2 100%);
                color: #2c5aa0;
                border: 1px solid #e2ddd6;
                transition: all 0.2s ease;
            }
            
            .sidebar a:hover,
            .sidebar a.active {
                background: linear-gradient(135deg, #2c5aa0 0%, #4d7bc0 100%);
                color: white;
            }
            
            .archive-submenu {
                margin-left: 0;
                margin-top: 5px;
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .archive-submenu a {
                font-size: 12px;
                padding: 6px 10px;
            }
            
            /* Mobile-specific improvements for text content */
            .grid-cell textarea {
                font-size: 12px;
                min-height: 40px;
                padding: 6px;
                border-radius: 4px;
                resize: vertical;
            }
            
            .grid-cell input,
            .grid-cell select {
                font-size: 12px;
                padding: 4px 6px;
                border-radius: 4px;
                min-height: 24px;
            }
            
            /* Ensure proper spacing and containment */
            .main-content > div {
                margin-bottom: 15px;
            }
            
            /* Hide scroll indicators on very small screens */
            @media (max-width: 480px) {
                .submissions-grid::before {
                    font-size: 10px;
                    padding: 6px;
                }
                
                .grid-cell {
                    font-size: 9px;
                    padding: 4px 2px;
                }
                
                .action-btn {
                    font-size: 7px;
                    min-width: 24px;
                    max-width: 24px;
                    padding: 1px 3px;
                }
            }
        }

        /* Additional CSS for invite grid rows */
        #inviteGridRows .grid-row {
            display: grid;
            grid-template-columns: minmax(100px, 1.2fr) minmax(60px, 0.8fr) minmax(60px, 0.8fr) minmax(50px, 0.6fr) minmax(50px, 0.6fr) minmax(60px, 0.8fr) minmax(80px, 1fr) minmax(80px, 1fr) minmax(80px, 1fr) minmax(80px, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fefefe 0%, #fdfbf7 100%);
            border-radius: 8px;
            border: 1px solid #e8e5e0;
            align-items: start;
            box-sizing: border-box;
            max-width: 100%;
        }
        /* Add this for archive invite grid rows */
        #inviteArchiveGridRows .grid-row {
            display: grid;
            grid-template-columns: minmax(100px, 1.2fr) minmax(60px, 0.8fr) minmax(60px, 0.8fr) minmax(50px, 0.6fr) minmax(50px, 0.6fr) minmax(60px, 0.8fr) minmax(80px, 1fr) minmax(80px, 1fr) minmax(80px, 1fr) minmax(80px, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fefefe 0%, #fdfbf7 100%);
            border-radius: 8px;
            border: 1px solid #e8e5e0;
            align-items: start;
            box-sizing: border-box;
            max-width: 100%;
        }

        /* Invite grid headers - ensure consistent alignment */
        .invite-header {
            display: grid;
            grid-template-columns: minmax(100px, 1.2fr) minmax(60px, 0.8fr) minmax(60px, 0.8fr) minmax(50px, 0.6fr) minmax(50px, 0.6fr) minmax(60px, 0.8fr) minmax(80px, 1fr) minmax(80px, 1fr) minmax(80px, 1fr) minmax(80px, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #e8f0ff 0%, #f0f6ff 100%);
            border-radius: 8px;
            font-weight: bold;
            color: #2c5aa0;
            align-items: center;
            box-sizing: border-box;
            box-shadow: 0 2px 6px rgba(44, 90, 160, 0.08);
            max-width: 100%;
        }

        .invite-header > div {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 40px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.2;
            padding: 8px 4px;
        }

        /* Briefings grid rows: match column widths to header */
        #briefingGridRows .grid-row {
            display: grid;
            grid-template-columns: minmax(80px, 1fr) minmax(80px, 1fr) minmax(70px, 0.9fr) minmax(60px, 0.8fr) minmax(100px, 1.2fr) minmax(70px, 0.9fr) minmax(100px, 1.2fr) minmax(90px, 1.1fr) minmax(90px, 1.1fr) minmax(100px, 1.2fr);
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fefefe 0%, #fdfbf7 100%);
            border-radius: 8px;
            border: 1px solid #e8e5e0;
            align-items: start;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        #briefingsArchiveGridRows .grid-row {
            display: grid;
            grid-template-columns: minmax(80px, 1fr) minmax(80px, 1fr) minmax(70px, 0.9fr) minmax(60px, 0.8fr) minmax(100px, 1.2fr) minmax(70px, 0.9fr) minmax(100px, 1.2fr) minmax(90px, 1.1fr) minmax(90px, 1.1fr) minmax(100px, 1.2fr);
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fefefe 0%, #fdfbf7 100%);
            border-radius: 8px;
            border: 1px solid #e8e5e0;
            align-items: start;
            box-sizing: border-box;
            max-width: 100%;
        }

        /* Briefings grid headers - ensure consistent alignment */
        .briefings-header {
            display: grid;
            grid-template-columns: minmax(80px, 1fr) minmax(80px, 1fr) minmax(70px, 0.9fr) minmax(60px, 0.8fr) minmax(100px, 1.2fr) minmax(70px, 0.9fr) minmax(100px, 1.2fr) minmax(90px, 1.1fr) minmax(90px, 1.1fr) minmax(100px, 1.2fr);
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #e8f0ff 0%, #f0f6ff 100%);
            border-radius: 8px;
            font-weight: bold;
            color: #2c5aa0;
            align-items: center;
            box-sizing: border-box;
            box-shadow: 0 2px 6px rgba(44, 90, 160, 0.08);
            max-width: 100%;
        }

        .briefings-header > div {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 40px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.2;
            padding: 8px 4px;
        }

        /* Daybook grid rows: match column widths to header (no action column) */
        #daybookGridRows .grid-row {
            display: grid;
            grid-template-columns: minmax(90px, 1fr) minmax(90px, 1fr) minmax(70px, 0.8fr) minmax(120px, 1.3fr) minmax(80px, 0.9fr) minmax(120px, 1.3fr) minmax(100px, 1.1fr) minmax(100px, 1.1fr);
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fefefe 0%, #fdfbf7 100%);
            border-radius: 8px;
            border: 1px solid #e8e5e0;
            max-width: 100%;
        }

        /* Commission grid rows: match column widths to header */
        .commission-header,
        #commissionGridRows .grid-row {
            display: grid;
            grid-template-columns: minmax(200px, 2fr) minmax(80px, 1fr) minmax(100px, 1.2fr) minmax(80px, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fefefe 0%, #fdfbf7 100%);
            border-radius: 8px;
            border: 1px solid #e8e5e0;
            align-items: start;
            max-width: 100%;
        }

        .commission-header {
            background: linear-gradient(135deg, #e8f0ff 0%, #f0f6ff 100%);
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(44, 90, 160, 0.08);
        }
        
        .commission-archive-header,
        #commissionArchiveGridRows .grid-row {
            display: grid;
            grid-template-columns: minmax(200px, 2fr) minmax(80px, 1fr) minmax(100px, 1.2fr) minmax(80px, 1fr) minmax(80px, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fefefe 0%, #fdfbf7 100%);
            border-radius: 8px;
            border: 1px solid #e8e5e0;
            box-sizing: border-box;
            align-items: start;
            max-width: 100%;
        }

        .commission-archive-header {
            background: linear-gradient(135deg, #e8f0ff 0%, #f0f6ff 100%);
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 15px;
            align-items: start;
            box-sizing: border-box;
            box-shadow: 0 2px 6px rgba(44, 90, 160, 0.08);
        }

        .commission-archive-header > div {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 40px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.2;
            padding: 8px 4px;
        }

        /* Team Management Styles */
        .team-management {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .add-member-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-member-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .team-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .team-member {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .team-member:hover {
            background-color: #f0f0f0;
        }

        .team-member-name {
            font-weight: 500;
            color: #333;
        }

        .remove-member-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-member-btn:hover {
            background-color: #c82333;
        }

        .remove-member-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .remove-member-btn:disabled:hover {
            background-color: #6c757d;
        }

        .default-member {
            opacity: 0.6;
        }

        .default-member .remove-member-btn {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .default-member .remove-member-btn:hover {
            background-color: #6c757d;
        }

        /* Highlight rows that have been with SpAds for more than 5 working days */
        .overdue-spad-row {
            background-color: #ffe6e6 !important;
            border-color: #ffb3b3 !important;
        }

        .overdue-spad-row .grid-cell {
            background-color: transparent;
        }

        /* RSVP deadline highlighting */
        .rsvp-overdue {
            background-color: #ffe6e6 !important;
            border-color: #ffb3b3 !important;
            border-left: 4px solid #dc3545 !important;
        }

        .rsvp-overdue .grid-cell {
            background-color: transparent;
        }

        .rsvp-overdue-indicator {
            display: inline-block;
            background-color: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Styling for urgency reasons in comments */
        .grid-cell:has-text("[URGENT:") {
            font-weight: bold;
        }
        
        /* Alternative approach for urgency highlighting */
        .urgent-item {
            border-left: 4px solid #dc3545;
        }
        
        .urgent-item .grid-cell:first-child {
            border-left: none;
        }

        /* Search field styling */
        .search-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #ffffff 0%, #fefcf9 100%);
            border: 2px solid #2c5aa0;
            border-radius: 25px;
            padding: 10px 15px;
            box-shadow: 0 6px 18px rgba(44, 90, 160, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 250px;
        }

        .search-input {
            border: none;
            outline: none;
            flex: 1;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 14px;
            background: transparent;
        }

        .search-input::placeholder {
            color: #666;
        }

        .search-icon {
            color: #2c5aa0;
            font-size: 16px;
        }

        .search-clear {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: none;
        }

        .search-clear:hover {
            color: #666;
        }

        .search-clear.visible {
            display: block;
        }

        /* Hide/show search based on page */
        .search-container.hidden {
            display: none;
        }

        /* Dashboard Summary Cards */
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .status-card {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fc 100%);
            color: #2c5aa0;
            border: 2px solid #2c5aa0;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 6px 18px rgba(44, 90, 160, 0.12);
            position: relative;
            overflow: hidden;
        }

        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(44, 90, 160, 0.2);
            background: linear-gradient(135deg, #dbeafe 0%, #e8f4f8 100%);
        }

        .status-card.urgent {
            background: linear-gradient(135deg, #fee 0%, #fef5f5 100%);
            color: #dc3545;
            border-color: #dc3545;
        }

        .status-card.urgent:hover {
            background: linear-gradient(135deg, #fdd 0%, #fee 100%);
        }

        .status-card.warning {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fc 100%);
            color: #2c5aa0;
            border-color: #2c5aa0;
        }

        .status-card.success {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fc 100%);
            color: #2c5aa0;
            border-color: #2c5aa0;
        }

        .status-card h3 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            font-weight: bold;
            color: inherit;
        }

        .status-card p {
            margin: 0;
            font-size: 0.9em;
            color: inherit;
            opacity: 0.8;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(44, 90, 160, 0.05);
            transform: rotate(45deg);
            transition: all 0.3s ease;
        }

        .status-card:hover::before {
            top: -30%;
            right: -30%;
            background: rgba(44, 90, 160, 0.1);
        }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .quick-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
            margin: 0 2px;
            min-width: 50px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }

        .quick-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .urgent-btn {
            background-color: #ff8c00 !important;
            border-color: #e67c00 !important;
            color: white;
        }

        .spad-btn {
            background-color: #3d6bb0 !important;
            border-color: #2c5aa0 !important;
            color: white;
        }

        .spad-comment-btn {
            background-color: #3d6bb0 !important;
            border-color: #2c5aa0 !important;
            color: white;
        }

        .lc-btn {
            background-color: #4d7bc0 !important;
            border-color: #3c6bb5 !important;
            color: white;
        }

        /* Inline Status Editing */
        .inline-status {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #b3d4ff;
            border-radius: 3px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            font-size: 10px;
            background-color: white;
            height: 24px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
        }

        .inline-status:focus {
            outline: 2px solid #2c5aa0;
            border-color: #2c5aa0;
        }

        /* Quick Filter Buttons */
        .quick-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #ffffff 0%, #fefcf9 100%);
            color: #2c5aa0;
            border: 2px solid #2c5aa0;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Optima', 'Lucida Grande', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(44, 90, 160, 0.1);
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: linear-gradient(135deg, #2c5aa0 0%, #4d7bc0 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.2);
        }

        .filter-btn.urgent {
            background-color: white;
            color: #2c5aa0;
            border: 2px solid #2c5aa0;
        }

        .filter-btn.urgent:hover,
        .filter-btn.urgent.active {
            background-color: #2c5aa0;
            color: white;
        }

        /* Daybook section font styling */
        #daybook,
        #daybook * {
            font-family: 'Optima', 'Lucida Grande', sans-serif !important;
        }

        /* Duty Rota specific styles */
        #rotaContainer .grid-header {
            grid-template-columns: 200px 150px 150px 150px 100px;
            gap: 12px;
        }
        
        #rotaContainer .grid-row {
            grid-template-columns: 200px 150px 150px 150px 100px;
            gap: 12px;
        }
        
        .duty-shift-type {
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .duty-person {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fc 100%);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #d0c8c0;
            font-size: 11px;
        }
        
        .unavailable-person {
            border-left: 4px solid #dc3545;
        }
        
        .manual-override {
            border-left: 4px solid #ff8c00;
        }
        
        .manual-override::after {
            content: ' ⚠️';
            color: #ff8c00;
        }

        /* Duty rota shift cell - allow multi-line content */
        .duty-shift-cell {
            display: block !important; /* Override flex display */
            align-items: unset !important;
            white-space: normal !important;
            line-height: 1.4;
            padding: 8px 4px;
            min-height: 40px;
        }

        .duty-shift-cell strong {
            display: block;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 4px;
        }

        .duty-shift-cell span {
            display: block;
            font-size: 10px;
            color: #666;
            line-height: 1.2;
        }

    </style>
</head>
<body>
    <div class="global-header">
        <div class="header-content">
            <div class="header-text">
                RED BOX
            </div>
            <div class="briefcase-icon">
                <div class="crown-symbol">♔</div>
            </div>
        </div>
    </div>
    <div class="container">
        <nav class="sidebar">
            <h2>Navigation</h2>
            <ul>
                <li><a href="#" onclick="showMainDashboard()">Box work</a></li>
                <li><a href="#" onclick="showBriefings()">Briefings</a></li>
                <li><a href="#" onclick="showCommissions()">Commissions</a></li>
                <li><a href="#" onclick="showInvites()">Invites</a></li>
                <li><a href="#" onclick="showDaybook()">Daybook</a></li>
                <li><a href="#" onclick="showDutyRota()">Duty rota</a></li>
                <li class="archive-section">
                    <span class="archive-heading">Archives</span>
                    <ul class="archive-submenu">
                        <li><a href="#" onclick="showArchiveBox()">Archive box</a></li>
                        <li><a href="#" onclick="showInviteArchive()">Archive invites</a></li>
                        <li><a href="#" onclick="showBriefingsArchive()">Archive briefings</a></li>
                        <li><a href="#" onclick="showCommissionArchive()">Archive commissions</a></li>
                    </ul>
                </li>
                <li><a href="#" onclick="showEditTeam()">Settings</a></li>
            </ul>
        </nav>
        
        <main class="main-content">
            <div id="mainDashboard">
                <header>
                    <h1>Box work</h1>
                    <p style="color: #333; font-size: 16px; margin-top: 8px; margin-bottom: 20px;">Manage box work and ministerial advice</p>
                </header>
                
                <!-- Dashboard Summary Cards -->
                <div class="dashboard-summary">
                    <div class="status-card urgent" onclick="filterByUrgency('Urgent')" title="Click to view urgent items">
                        <h3 id="urgentCount">0</h3>
                        <p>Urgent Items</p>
                    </div>
                    <div class="status-card" onclick="filterByStatus('With SpAds')" title="Click to view items with SpAds">
                        <h3 id="spadCount">0</h3>
                        <p>With SpAds</p>
                    </div>
                    <div class="status-card success" onclick="filterByStatus('Ready for the box')" title="Click to view items ready for box">
                        <h3 id="lcReadyCount">0</h3>
                        <p>Ready for box</p>
                    </div>
                    <div class="status-card warning" onclick="showOverdueItems()" title="Click to view overdue items">
                        <h3 id="overdueCount">0</h3>
                        <p>Overdue (5+ days)</p>
                    </div>
                </div>

                <!-- Quick Filters -->
                <div class="quick-filters">
                    <button class="filter-btn active" onclick="clearAllFilters()">All Items</button>
                    <button class="filter-btn" onclick="filterByCurrentUser()">My Items</button>
                    <button class="filter-btn urgent" onclick="filterByUrgency('Urgent')">Urgent Only</button>
                    <button class="filter-btn" onclick="filterByStatus('With SpAds')">With SpAds</button>
                    <button class="filter-btn" onclick="filterByStatus('Ready for the box')">Ready for box</button>
                    <button class="filter-btn" onclick="showOverdueItems()">Overdue</button>
                </div>
                
                <button class="add-item-btn" onclick="openModal()">Add item</button>
                
                <div class="submissions-grid">
                    <div class="grid-header">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Urgency</div>
                        <div>Title</div>
                        <div>SharePoint Link</div>
                        <div>Status</div>
                        <div>Days with SpAds</div>
                        <div>Comments</div>
                        <div>Actions</div>
                    </div>
                </div>
            </div>

            <div id="archiveBox" class="hidden">
                <header>
                    <h1>Archive box</h1>
                    <p style="color: #666; margin-bottom: 30px;">Completed submissions</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Urgency</div>
                        <div>Title</div>
                        <div>SharePoint Link</div>
                        <div>Status</div>
                        <div>Days with SpAds</div>
                        <div>Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="archiveGridRows">
                        <!-- Archived submissions will be populated here -->
                    </div>
                </div>
            </div>

            <div id="invites" class="hidden">
                <header>
                    <h1>Invites</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage invitations and events</p>
                </header>
                
                <!-- Quick Filters -->
                <div class="quick-filters">
                    <button class="filter-btn active" onclick="clearInviteFilters()">All Items</button>
                    <button class="filter-btn" onclick="filterInvitesByStatus('With SpAds')">With SpAds</button>
                    <button class="filter-btn" onclick="filterInvitesByStatus('PS to get more information')">PS to get more information</button>
                    <button class="filter-btn" onclick="filterInvitesByStatus('Diary manager to test with minister')">Diary manager to test with minister</button>
                    <button class="filter-btn" onclick="filterInvitesByStatus('Accept')">Accept</button>
                    <button class="filter-btn" onclick="filterInvitesByStatus('Decline')">Decline</button>
                    <button class="filter-btn" onclick="filterInvitesByStatus('Delegate')">Delegate</button>
                </div>
                
                <button class="add-item-btn" onclick="openInviteModal()">Add invite</button>
                
                <div class="submissions-grid">
                    <div class="grid-header invite-header">
                        <div>Invite</div>
                        <div>Lead PS</div>
                        <div>Date</div>
                        <div>Start Time</div>
                        <div>End Time</div>
                        <div>Status</div>
                        <div>Diary Manager Comments</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="inviteGridRows">
                        <!-- Invite rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="inviteArchive" class="hidden">
                <header>
                    <h1>Archive invites</h1>
                    <p style="color: #666; margin-bottom: 30px;">Archived invitations and events</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header invite-header">
                        <div>Invite</div>
                        <div>Lead PS</div>
                        <div>Date</div>
                        <div>Start Time</div>
                        <div>End Time</div>
                        <div>Status</div>
                        <div>Diary Manager Comments</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="inviteArchiveGridRows">
                        <!-- Archived invite rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="briefings" class="hidden">
                <header>
                    <h1>Briefings</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage briefings and meetings</p>
                </header>
                <button class="add-item-btn" onclick="openBriefingModal()">Add briefing</button>
                <div class="submissions-grid">
                    <div class="grid-header briefings-header">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Date of Meeting</div>
                        <div>Time of Meeting</div>
                        <div>Title of Meeting</div>
                        <div>Commission Deadline</div>
                        <div>SharePoint Link</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    <div id="briefingGridRows">
                        <!-- Briefing rows will be populated here -->
                    </div>
                </div>
            </div>
            <div id="briefingsArchive" class="hidden">
                <header>
                    <h1>Archive briefings</h1>
                    <p style="color: #666; margin-bottom: 30px;">Archived briefings</p>
                </header>
                <div class="submissions-grid">
                    <div class="grid-header briefings-header">
                        <div>Lead Private Secretary</div>
                        <div>Lead SpAd</div>
                        <div>Date of Meeting</div>
                        <div>Time of Meeting</div>
                        <div>Title of Meeting</div>
                        <div>Commission Deadline</div>
                        <div>SharePoint Link</div>
                        <div>PS Comments</div>
                        <div>SpAd Comments</div>
                        <div>Actions</div>
                    </div>
                    <div id="briefingsArchiveGridRows">
                        <!-- Archived briefing rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="commissions" class="hidden">
                <header>
                    <h1>Commissions</h1>
                    <p style="color: #666; margin-bottom: 30px;">Please use this tracker for keeping a record of all commissions from the Lord Chancellor and the SpAds (except briefing papers for meetings). For briefing commissions, please use the 'Briefings' page.</p>
                </header>
                
                <button class="add-item-btn" onclick="openCommissionModal()">Add commission</button>
                
                <div class="submissions-grid">
                    <div class="grid-header commission-header">
                        <div>Action</div>
                        <div>Lead PS</div>
                        <div>Deadline</div>
                        <div>Status</div>
                    </div>
                    
                    <div id="commissionGridRows">
                        <!-- Commission rows will be populated here -->
                    </div>
                </div>
            </div>

            <div id="commissionArchive" class="hidden">
                <header>
                    <h1>Archive commissions</h1>
                    <p style="color: #666; margin-bottom: 30px;">Completed commissions</p>
                </header>
                
                <div class="submissions-grid">
                    <div class="grid-header commission-archive-header">
                        <div>Action</div>
                        <div>Lead PS</div>
                        <div>Deadline</div>
                        <div>Status</div>
                        <div>Actions</div>
                    </div>
                    
                    <div id="commissionArchiveGridRows">
                        <!-- Archived commission rows will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Daybook Section -->
            <div id="daybook" class="hidden">
                <header>
                    <h1>Daybook</h1>
                    <p style="color: #666; margin-bottom: 30px;">View briefings by date</p>
                </header>
                
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <label for="daybookDatePicker" style="font-weight: 500; min-width: 120px;">Select Date:</label>
                        <input type="date" id="daybookDatePicker" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <button onclick="filterBriefingsByDate()" style="padding: 8px 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">View Briefings</button>
                        <button onclick="clearDaybookFilter()" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Clear</button>
                    </div>
                </div>
                
                <div id="daybookResults" style="display: none;">
                    <h3 id="daybookDateHeader" style="margin-bottom: 20px; color: #333;"></h3>
                    <div class="submissions-grid">
                        <div class="grid-header" id="daybookGridHeader" style="grid-template-columns: 120px 120px 90px 160px 110px 160px 140px 140px;">
                            <div>Lead PS</div>
                            <div>Lead SpAd</div>
                            <div>Time</div>
                            <div>Title</div>
                            <div>Commission Deadline</div>
                            <div>SharePoint</div>
                            <div>PS Comments</div>
                            <div>SpAd Comments</div>
                        </div>
                        
                        <div id="daybookGridRows">
                            <!-- Filtered briefing rows will be populated here -->
                        </div>
                    </div>
                    
                    <div id="daybookNoResults" style="display: none; text-align: center; padding: 40px; color: #666; font-style: italic;">
                        No briefings found for the selected date.
                    </div>
                </div>
            </div>

            <!-- Duty Rota Section -->
            <div id="dutyRota" class="hidden">
                <header>
                    <h1>Duty rota</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage duty shifts and availability</p>
                </header>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 40px; margin-bottom: 30px;">
                    <!-- Main Rota Display -->
                    <div>
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                            <h3>Current Rota</h3>
                            <button onclick="generateRota()" class="form-btn btn-add">Generate New Rota</button>
                            <button onclick="exportRota()" class="form-btn" style="background-color: #6c757d;">Export Rota</button>
                        </div>
                        
                        <div class="submissions-grid">
                            <div id="rotaContainer">
                                <!-- Rota schedule will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Side Panel -->
                    <div>
                        <!-- Date Unavailable Section -->
                        <div class="team-management" style="margin-bottom: 30px;">
                            <h4 style="margin-bottom: 15px; color: #2c5aa0;">Date Unavailable</h4>
                            <div class="form-grid" style="grid-template-columns: 1fr;">
                                <div class="form-group">
                                    <label>Your Name:</label>
                                    <select id="unavailablePerson">
                                        <option value="">Select person</option>
                                        <!-- Will be populated with team members -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Start Date:</label>
                                    <input type="date" id="unavailableStartDate">
                                </div>
                                <div class="form-group">
                                    <label>End Date:</label>
                                    <input type="date" id="unavailableEndDate">
                                </div>
                                <div class="form-group" id="justificationGroup" style="display: none;">
                                    <label>Justification (required for dates within 1 month):</label>
                                    <textarea id="unavailableJustification" placeholder="Please explain why you cannot be on duty during this period"></textarea>
                                </div>
                                <div style="text-align: center;">
                                    <button onclick="addUnavailableDate()" class="form-btn btn-add">Add Unavailable Period</button>
                                </div>
                            </div>
                            
                            <!-- Current Unavailable Dates -->
                            <div style="margin-top: 20px;">
                                <h5 style="margin-bottom: 10px; color: #2c5aa0;">Current Unavailable Dates:</h5>
                                <div id="unavailableDatesList" style="max-height: 200px; overflow-y: auto;">
                                    <!-- Unavailable dates will be listed here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manual Override Section -->
                        <div class="team-management">
                            <h4 style="margin-bottom: 15px; color: #2c5aa0;">Manual Override</h4>
                            <div class="form-grid" style="grid-template-columns: 1fr;">
                                <div class="form-group">
                                    <label>Select Shift:</label>
                                    <select id="overrideShift">
                                        <option value="">Select shift to override</option>
                                        <!-- Will be populated with current shifts -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Junior PS:</label>
                                    <select id="overrideJuniorPS">
                                        <option value="">Select Junior PS</option>
                                        <!-- Will be populated with junior PS -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Senior PS (Backup):</label>
                                    <select id="overrideSeniorPS">
                                        <option value="">Select Senior PS</option>
                                        <!-- Will be populated with senior PS -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>SpAd:</label>
                                    <select id="overrideSpAd">
                                        <option value="">Select SpAd</option>
                                        <!-- Will be populated with SpAds -->
                                    </select>
                                </div>
                                <div style="text-align: center;">
                                    <button onclick="applyManualOverride()" class="form-btn btn-add">Apply Override</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="editTeam" class="hidden">
                <header>
                    <h1 style="font-weight: bold;">Settings</h1>
                    <p style="color: #666; margin-bottom: 30px;">Manage Private Secretaries and SpAds</p>
                </header>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                    <!-- Private Secretaries Section -->
                    <div>
                        <h3>Private Secretaries</h3>
                        <div class="team-management">
                            <div class="add-member-form">
                                <input type="text" id="newPSName" placeholder="Enter new Private Secretary name" onkeypress="if(event.key==='Enter') addPrivateSecretary()">
                                <select id="newPSSeniority">
                                    <option value="junior">Junior</option>
                                    <option value="senior">Senior</option>
                                </select>
                                <button onclick="addPrivateSecretary()" class="form-btn btn-add">Add PS</button>
                            </div>
                            <div id="privateSecretariesList" class="team-list">
                                <!-- Private Secretaries will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- SpAds Section -->
                    <div>
                        <h3>SpAds</h3>
                        <div class="team-management">
                            <div class="add-member-form">
                                <input type="text" id="newSpAdName" placeholder="Enter new SpAd name" onkeypress="if(event.key==='Enter') addSpAd()">
                                <button onclick="addSpAd()" class="form-btn btn-add">Add SpAd</button>
                            </div>
                            <div id="spAdsList" class="team-list">
                                <!-- SpAds will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Fields Management Section -->
                <div style="margin-bottom: 40px;">
                    <h3>Status Fields Management</h3>
                    <div class="team-management">
                        <p style="color: #666; margin-bottom: 20px;">Manage available status options in the dropdown menus</p>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">Current Status Options:</h4>
                            <div id="statusFieldsList" class="team-list">
                                <!-- Status options will be populated here -->
                            </div>
                        </div>
                        
                        <div class="add-member-form">
                            <input type="text" id="newStatusField" placeholder="Enter new status option" onkeypress="if(event.key==='Enter') addStatusField()">
                            <button onclick="addStatusField()" class="form-btn btn-add">Add Status</button>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="resetStatusFieldsToDefault()" class="form-btn" style="background-color: #6c757d; font-size: 14px; padding: 8px 16px;">Reset to Default Status Options</button>
                            <p style="color: #666; font-size: 12px; margin-top: 5px;">This will restore the original status options and remove any custom ones you've added</p>
                        </div>
                    </div>
                </div>
                
                <!-- SpAd Review Settings Section -->
                <div style="margin-bottom: 40px;">
                    <h3>SpAd Review Settings</h3>
                    <div class="team-management">
                        <p style="color: #666; margin-bottom: 20px;">Configure SpAd review functionality</p>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="enableSpAdReview" checked onchange="toggleSpAdReview()">
                                <span>Enable SpAd Review Process</span>
                            </label>
                            <p style="color: #666; font-size: 12px; margin: 5px 0 0 30px;">When disabled, SpAd-related fields and buttons will be hidden</p>
                        </div>
                        
                        <div id="spadReviewOptions" style="margin-top: 20px;">
                            <h4 style="margin-bottom: 10px;">SpAd Review Options:</h4>
                            <div style="margin-left: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="showSpAdComments" checked onchange="updateSpAdSettings()">
                                    <span>Show SpAd Comment functionality</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="showSpAdDaysCounter" checked onchange="updateSpAdSettings()">
                                    <span>Show "Days with SpAds" counter</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="autoSubmitToSpAds" checked onchange="updateSpAdSettings()">
                                    <span>Show "Submit to SpAds" buttons</span>
                                </label>
                            </div>
                            
                            <div style="margin-top: 15px; text-align: center;">
                                <button onclick="resetSpAdSettingsToDefault()" class="form-btn" style="background-color: #6c757d; font-size: 14px; padding: 8px 16px;">Reset to Default SpAd Settings</button>
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">This will restore the original SpAd review settings</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="saveTeamChanges()" class="form-btn btn-add">Save Changes</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Search Field -->
    <div id="searchContainer" class="search-container">
        <span class="search-icon">🔍</span>
        <input type="text" id="searchInput" class="search-input" placeholder="Search items...">
        <button id="searchClear" class="search-clear" onclick="clearSearch()">×</button>
    </div>

    <!-- Modal Form -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Advice/briefing</h2>
            </div>
            <form id="submissionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="leadPS">Lead private secretary</label>
                        <select id="leadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadSpAd">Lead SpAd</label>
                        <select id="leadSpAd">
                            <option value="">Select...</option>
                            <option value="Sophie">Sophie</option>
                            <option value="Tash">Tash</option>
                            <option value="Poppy">Poppy</option>
                            <option value="Josh">Josh</option>
                            <option value="No SpAd review">No SpAd review</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="boxReviewDeadline">Box review deadline</label>
                        <input type="date" id="boxReviewDeadline" onchange="updateUrgencyFromDeadline()">
                    </div>
                    
                    <div class="form-group">
                        <label for="urgency">Urgency <span style="font-size: 12px; color: #666;">(Auto-calculated from deadline)</span></label>
                        <select id="urgency">
                            <option value="Routine">Routine</option>
                            <option value="Priority">Priority</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="submissionType">Advice/briefing</label>
                        <select id="submissionType">
                            <option value="advice">Advice</option>
                            <option value="briefing">Briefing for meeting</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="submissionTitle">Title</label>
                        <input type="text" id="submissionTitle" placeholder="Enter submission title">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="sharepointLink">Sharepoint link</label>
                        <input type="url" id="sharepointLink" placeholder="https://sharepoint.com/..." style="font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px; color: #0066cc;">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateReceived">Date received</label>
                        <input type="date" id="dateReceived">
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="">Select status...</option>
                            <option value="With Perm Sec/DGs">With Perm Sec/DGs</option>
                            <option value="With junior minister(s)">With junior minister(s)</option>
                            <option value="With SpAds">With SpAds</option>
                            <option value="With officials">With officials</option>
                            <option value="With PS">With PS</option>
                            <option value="Ready for the box">Ready for box</option>
                            <option value="Readout">Readout</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="dateSubmittedSpads">Date submitted to SpAds <span style="font-size: 12px; color: #666;">(Auto-calculated)</span></label>
                        <input type="date" id="dateSubmittedSpads" readonly style="background-color: #f5f5f5;">
                    </div>
                    
                    <div class="form-group">
                        <label for="workingDays">Days with SpAds <span style="font-size: 12px; color: #666;">(Auto-calculated)</span></label>
                        <input type="number" id="workingDays" placeholder="Auto-calculated" readonly style="background-color: #f5f5f5;">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateSpAdComment">Date of SpAd comment <span style="font-size: 12px; color: #666;">(Auto-calculated)</span></label>
                        <input type="date" id="dateSpAdComment" readonly style="background-color: #f5f5f5;">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateBoxed">Date ready for box <span style="font-size: 12px; color: #666;">(Auto-calculated)</span></label>
                        <input type="date" id="dateBoxed" readonly style="background-color: #f5f5f5;">
                    </div>
                    
                    <div class="form-group">
                        <label for="dateReadout">Date of readout <span style="font-size: 12px; color: #666;">(Auto-calculated)</span></label>
                        <input type="date" id="dateReadout" readonly style="background-color: #f5f5f5;">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="comments">Comments</label>
                        <textarea id="comments" placeholder="Enter comments..."></textarea>
                    </div>
                </div>
                
                <div id="firstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons" id="submissionFormButtons">
                    <button type="button" class="form-btn btn-add" onclick="addSubmissionFromModal()">Add</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SpAd Comment Modal -->
    <div id="spadCommentModal" class="spad-comment-modal">
        <div class="spad-comment-modal-content">
            <div class="modal-header">
                <h2>Add SpAd Comment</h2>
            </div>
            <form id="spadCommentForm">
                <div class="spad-comment-form-group">
                    <label for="psComments">Do you have any comments/queries for the private secretary?</label>
                    <textarea id="psComments" placeholder="Enter your comments or queries..."></textarea>
                </div>
                
                <div class="spad-comment-form-group">
                    <label for="boxNote">Have you added your comment to the box note?</label>
                    <select id="boxNote">
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                
                <div class="spad-comment-buttons">
                    <button type="button" class="spad-comment-btn-submit" onclick="submitSpAdComment()">Submit to Private Secretary</button>
                    <button type="button" class="spad-comment-btn-submit" onclick="saveSpAdDraft()" style="background-color: #5a88d0;">Save and go back</button>
                    <button type="button" class="spad-comment-btn-cancel" onclick="closeSpAdCommentModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invite Modal Form -->
    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Invite</h2>
            </div>
            <form id="inviteForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="inviteTitle">Invite</label>
                        <input type="text" id="inviteTitle" placeholder="Enter invite description">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteLeadPS">Lead PS</label>
                        <select id="inviteLeadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteDate">Date (optional)</label>
                        <input type="date" id="inviteDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteStartTime">Start time (optional)</label>
                        <input type="time" id="inviteStartTime">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteEndTime">End time (optional)</label>
                        <input type="time" id="inviteEndTime">
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteRSVPDeadline">RSVP deadline</label>
                        <input type="date" id="inviteRSVPDeadline">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="diaryManagerComments">Diary manager comments</label>
                        <textarea id="diaryManagerComments" placeholder="Enter diary manager comments..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="psCommentsInvite">PS comments</label>
                        <textarea id="psCommentsInvite" placeholder="Enter PS comments..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="spadCommentsInvite">SpAd comments</label>
                        <textarea id="spadCommentsInvite" placeholder="Enter SpAd comments..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteStatus">Status</label>
                        <select id="inviteStatus">
                            <option value="">Select status...</option>
                            <option value="With SpAds">With SpAds</option>
                            <option value="PS to get more information">PS to get more information</option>
                            <option value="Diary manager to test with minister">Diary manager to test with minister</option>
                            <option value="Accept">Accept</option>
                            <option value="Decline">Decline</option>
                            <option value="Delegate">Delegate</option>
                        </select>
                    </div>
                </div>
                
                <div id="inviteFirstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="form-btn btn-add" onclick="addInvite()">Add Invite</button>
                    <button type="button" class="form-btn btn-submit-archive" onclick="submitInviteToArchive()">Submit to Archive</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Briefing Modal Form -->
    <div id="briefingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="briefingModalTitle">Add New Briefing</h2>
            </div>
            <form id="briefingForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="briefingLeadPS">Lead private secretary</label>
                        <select id="briefingLeadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="briefingLeadSpAd">Lead SpAd</label>
                        <select id="briefingLeadSpAd">
                            <option value="">Select...</option>
                            <option value="Sophie">Sophie</option>
                            <option value="Tash">Tash</option>
                            <option value="Poppy">Poppy</option>
                            <option value="Josh">Josh</option>
                            <option value="No SpAd review">No SpAd review</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="briefingDate">Date of meeting</label>
                        <input type="date" id="briefingDate">
                    </div>
                    <div class="form-group">
                        <label for="briefingTime">Time of meeting</label>
                        <input type="time" id="briefingTime">
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingTitle">Title of meeting</label>
                        <input type="text" id="briefingTitle" placeholder="Enter meeting title">
                    </div>
                    <div class="form-group">
                        <label for="briefingCommissionDeadline">Commission deadline</label>
                        <input type="date" id="briefingCommissionDeadline">
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingSharepointLink">Sharepoint link</label>
                        <input type="url" id="briefingSharepointLink" placeholder="https://sharepoint.com/..." style="font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px; color: #0066cc;">
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingPSComments">PS comments</label>
                        <textarea id="briefingPSComments" placeholder="Enter PS comments..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="briefingSpAdComments">SpAd comments</label>
                        <textarea id="briefingSpAdComments" placeholder="Enter SpAd comments..."></textarea>
                    </div>
                </div>
                
                <div id="briefingFirstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons" id="briefingFormButtons">
                    <button type="button" class="form-btn btn-add" onclick="addBriefing()">Add</button>
                    <button type="button" class="form-btn btn-submit-archive" onclick="submitBriefingToArchive()">Submit to Archive</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Urgency Reason Modal -->
    <div id="urgencyReasonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Urgency Justification Required</h2>
            </div>
            <form id="urgencyReasonForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="urgencyReason">Please explain why this item is urgent:</label>
                        <textarea id="urgencyReason" placeholder="Provide a detailed explanation for the urgent priority..." style="min-height: 100px;" required></textarea>
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="form-btn btn-add" onclick="confirmUrgencyReason()">Confirm Urgent</button>
                                       <button type="button" class="form-btn btn-cancel" onclick="cancelUrgencyReason()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Commission Modal Form -->
    <div id="commissionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="commissionModalTitle">Add New Commission</h2>
            </div>
            <form id="commissionForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="commissionAction">Action</label>
                        <textarea id="commissionAction" placeholder="What has been commissioned? When was the commission made, and by who?" rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="commissionLeadPS">Lead PS</label>
                        <select id="commissionLeadPS">
                            <option value="">Select...</option>
                            <option value="Ben">Ben</option>
                            <option value="James">James</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Sukh">Sukh</option>
                            <option value="Katie">Katie</option>
                            <option value="Jess">Jess</option>
                            <option value="Louisa">Louisa</option>
                            <option value="Jo">Jo</option>
                            <option value="Simran">Simran</option>
                            <option value="Rachel">Rachel</option>
                            <option value="Hugh">Hugh</option>
                            <option value="Marisa">Marisa</option>
                            <option value="Gemma">Gemma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="commissionDeadline">Deadline</label>
                        <input type="date" id="commissionDeadline">
                    </div>
                    
                    <div class="form-group">
                        <label for="commissionStatus">Status</label>
                        <select id="commissionStatus">
                            <option value="">Select status...</option>
                            <option value="With PS">With PS</option>
                            <option value="Commissioned the department">Commissioned the department</option>
                            <option value="With SpAds">With SpAds</option>
                            <option value="Complete">Complete</option>
                        </select>
                    </div>
                </div>
                
                <div id="commissionFirstAddedTimestamp" class="first-added-timestamp" style="display: none; text-align: center; margin: 15px 0; font-size: 12px; color: #666; font-style: italic;">
                    <!-- Timestamp will be populated here -->
                </div>
                
                <div class="form-buttons" id="commissionFormButtons">
                    <button type="button" class="form-btn btn-add" onclick="addCommission()">Add</button>
                    <button type="button" class="form-btn btn-cancel" onclick="closeCommissionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Local Storage Data Model ---
        // Keys: submissions, invites, briefings, archiveSubmissions, archiveInvites, archiveBriefings

        // --- Working Days Calculation ---
        function calculateWorkingDays(startDate, endDate) {
            if (!startDate) return '';
            
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date(); // Use today if no end date
            
            // If end date is before start date, return 0
            if (end < start) return 0;
            
            let workingDays = 0;
            const currentDate = new Date(start);
            
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                // 0 = Sunday, 6 = Saturday
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    workingDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Subtract 1 because we don't count the start date itself
            return Math.max(0, workingDays - 1);
        }

        // --- Urgency Calculation Based on Deadline ---
        function updateUrgencyFromDeadline() {
            const deadlineInput = document.getElementById('boxReviewDeadline');
            const urgencySelect = document.getElementById('urgency');
            
            if (!deadlineInput || !urgencySelect || !deadlineInput.value) {
                return;
            }
            
            const deadline = new Date(deadlineInput.value);
            const today = new Date();
            
            // Reset time to start of day for accurate comparison
            deadline.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            
            const diffTime = deadline.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let urgency = 'Routine';
            if (diffDays <= 1) {
                urgency = 'Urgent';
            } else if (diffDays === 2) {
                urgency = 'Priority';
            }
            
            urgencySelect.value = urgency;
            
            // If urgent, trigger urgency reason modal
            if (urgency === 'Urgent') {
                // Set a timeout to allow the urgency dropdown to update first
                setTimeout(() => {
                    openUrgencyReasonModal();
                }, 100);
            } else {
                // Clear any existing urgency reason if not urgent
                window.currentUrgencyReason = '';
            }
        }

        function formatUrlForDisplay(url) {
            if (!url) return '';
            
            // If it's a valid URL, create a clickable link with truncated display text
            try {
                const urlObj = new URL(url);
                let displayText = url;
                
                // Truncate long URLs for display
                if (url.length > 30) {
                    displayText = url.substring(0, 27) + '...';
                }
                
                return `<a href="${url}" target="_blank" class="url-cell" title="${url}">${displayText}</a>`;
            } catch (e) {
                // If not a valid URL, just display as text with URL styling
                let displayText = url;
                if (url.length > 30) {
                    displayText = url.substring(0, 27) + '...';
                }
                return `<span class="url-display" title="${url}">${displayText}</span>`;
            }
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                const options = { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long'
                };
                return date.toLocaleDateString('en-GB', options);
            } catch (e) {
                return dateString; // Return original if formatting fails
            }
        }

        function formatTimestampForDisplay(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = new Date(timestamp);
                const dateOptions = { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long',
                    year: 'numeric'
                };
                const timeOptions = {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                };
                const dateStr = date.toLocaleDateString('en-GB', dateOptions);
                const timeStr = date.toLocaleTimeString('en-GB', timeOptions);
                return `First added to the grid on ${dateStr} at ${timeStr}`;
            } catch (e) {
                return '';
            }
        }

        function updateWorkingDaysForSubmission(data) {
            if (data.dateSubmittedSpads) {
                data.workingDays = calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment);
            }
            return data;
        }

        // Utility: Load and Save
        function loadData(key) {
            try {
                const data = JSON.parse(localStorage.getItem(key) || '[]');
                console.log(`Loaded data for ${key}:`, data);
                
                // Filter out any null or invalid entries
                if (Array.isArray(data)) {
                    const filteredData = data.filter(item => item !== null && typeof item === 'object');
                    if (filteredData.length !== data.length) {
                        console.warn(`Filtered out ${data.length - filteredData.length} invalid entries from ${key}`);
                        // Save the cleaned data back
                        saveData(key, filteredData);
                    }
                    return filteredData;
                }
                
                return [];
            } catch (error) {
                console.error(`Error loading data for ${key}:`, error);
                return [];
            }
        }
        function saveData(key, arr) {
            try {
                localStorage.setItem(key, JSON.stringify(arr));
                console.log(`Saved data for ${key}:`, arr);
            } catch (error) {
                console.error(`Error saving data for ${key}:`, error);
            }
        }

        // Get form data helper
        function getFormData() {
            const leadPSElement = document.getElementById('leadPS');
            const submissionTitleElement = document.getElementById('submissionTitle');
            
            console.log('leadPS element:', leadPSElement);
            console.log('submissionTitle element:', submissionTitleElement);
            
            if (!leadPSElement) {
                console.error('leadPS element not found!');
                return { leadPS: '', submissionTitle: '', leadSpAd: '', urgency: '', urgencyReason: '', submissionType: 'advice', sharepointLink: '', boxReviewDeadline: '', dateReceived: '', status: '', dateSubmittedSpads: '', workingDays: '', dateSpAdComment: '', dateBoxed: '', comments: '', firstAdded: '' };
            }
            
            if (!submissionTitleElement) {
                console.error('submissionTitle element not found!');
                return { leadPS: '', submissionTitle: '', leadSpAd: '', urgency: '', urgencyReason: '', submissionType: 'advice', sharepointLink: '', boxReviewDeadline: '', dateReceived: '', status: '', dateSubmittedSpads: '', workingDays: '', dateSpAdComment: '', dateBoxed: '', comments: '', firstAdded: '' };
            }
            
            console.log('leadPS value:', leadPSElement.value);
            console.log('submissionTitle value:', submissionTitleElement.value);
            
            return {
                leadPS: leadPSElement.value || '',
                leadSpAd: (document.getElementById('leadSpAd') || {}).value || '',
                urgency: (document.getElementById('urgency') || {}).value || '',
                urgencyReason: (document.getElementById('urgency') || {}).value === 'Urgent' ? 
                              (window.currentUrgencyReason || '') : '',
                submissionType: (document.getElementById('submissionType') || {}).value || 'advice',
                submissionTitle: submissionTitleElement.value || '',
                sharepointLink: (document.getElementById('sharepointLink') || {}).value || '',
                boxReviewDeadline: (document.getElementById('boxReviewDeadline') || {}).value || '',
                dateReceived: (document.getElementById('dateReceived') || {}).value || '',
                status: (document.getElementById('status') || {}).value || '',
                dateSubmittedSpads: (document.getElementById('dateSubmittedSpads') || {}).value || '',
                workingDays: (document.getElementById('workingDays') || {}).value || '',
                dateSpAdComment: (document.getElementById('dateSpAdComment') || {}).value || '',
                dateBoxed: (document.getElementById('dateBoxed') || {}).value || '',
                dateReadout: (document.getElementById('dateReadout') || {}).value || '',
                comments: (document.getElementById('comments') || {}).value || '',
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function getInviteFormData() {
            return {
                inviteTitle: document.getElementById('inviteTitle').value,
                inviteLeadPS: document.getElementById('inviteLeadPS').value,
                inviteDate: document.getElementById('inviteDate').value,
                inviteStartTime: document.getElementById('inviteStartTime').value,
                inviteEndTime: document.getElementById('inviteEndTime').value,
                inviteRSVPDeadline: document.getElementById('inviteRSVPDeadline').value,
                inviteStatus: document.getElementById('inviteStatus').value,
                diaryManagerComments: document.getElementById('diaryManagerComments').value,
                psCommentsInvite: document.getElementById('psCommentsInvite').value,
                spadCommentsInvite: document.getElementById('spadCommentsInvite').value,
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function getBriefingFormData() {
            return {
                leadPS: document.getElementById('briefingLeadPS').value,
                leadSpAd: document.getElementById('briefingLeadSpAd').value,
                date: document.getElementById('briefingDate').value,
                time: document.getElementById('briefingTime').value,
                title: document.getElementById('briefingTitle').value,
                sharepointLink: document.getElementById('briefingSharepointLink').value,
                commissionDeadline: document.getElementById('briefingCommissionDeadline').value,
                psComments: document.getElementById('briefingPSComments').value,
                spadComments: document.getElementById('briefingSpAdComments').value,
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function getCommissionFormData() {
            return {
                action: document.getElementById('commissionAction').value,
                leadPS: document.getElementById('commissionLeadPS').value,
                deadline: document.getElementById('commissionDeadline').value,
                status: document.getElementById('commissionStatus').value,
                firstAdded: window.currentFirstAdded || ''
            };
        }

        function addSubmission(data) {
            console.log('addSubmission called with data:', data);
            
            // Validate that data is not null and has required properties
            if (!data || typeof data !== 'object') {
                console.error('Invalid data passed to addSubmission:', data);
                return;
            }
            
            // Auto-set dates based on status
            const today = new Date().toISOString().split('T')[0];
            if (data.status === 'With SpAds' && !data.dateSubmittedSpads) {
                data.dateSubmittedSpads = today;
            } else if (data.status === 'With PS' && !data.dateSpAdComment) {
                data.dateSpAdComment = today;
            } else if (data.status === 'Ready for the box' && !data.dateBoxed) {
                data.dateBoxed = today;
            } else if (data.status === 'Readout' && !data.dateReadout) {
                data.dateReadout = today;
            }
            
            // Calculate working days automatically
            data = updateWorkingDaysForSubmission(data);
            
            // Auto-archive if status is Readout
            if (data.status === 'Readout') {
                archiveSubmission(data);
                return;
            }
            
            // Always add to submissions table (box work dashboard)
            const arr = loadData('submissions');
            console.log('Current submissions:', arr);
            arr.push(data);
            console.log('After adding:', arr);
            saveData('submissions', arr);
            console.log('Saved to localStorage');
            renderSubmissions();
            renderArchiveSubmissions();
            
            // Only add to briefings if it's briefing or both
            if (data.submissionType === 'briefing' || data.submissionType === 'both') {
                addToBriefings(data);
            }
            
            console.log('addSubmission completed');
        }

        // Convert submission data to briefing format and add to briefings table
        function addToBriefings(submissionData) {
            const briefingData = {
                leadPS: submissionData.leadPS,
                leadSpAd: submissionData.leadSpAd,
                date: '', // Will need to be filled in later or prompt user
                time: '', // Will need to be filled in later or prompt user
                title: submissionData.submissionTitle,
                sharepointLink: submissionData.sharepointLink,
                commissionDeadline: '', // Will need to be filled in later
                psComments: submissionData.comments || '',
                spadComments: ''
            };
            
            const briefings = loadData('briefings');
            briefings.push(briefingData);
            saveData('briefings', briefings);
            renderBriefings();
            console.log('Added to briefings:', briefingData);
        }

        // Helper function to archive a submission
        function archiveSubmission(submissionData, originalIndex = null) {
            // Set status to Readout and add archive date
            submissionData.status = 'Readout';
            if (!submissionData.dateReadout) {
                submissionData.dateReadout = new Date().toISOString().split('T')[0];
            }
            submissionData.archivedDate = new Date().toISOString();
            
            // Add to archive
            const archiveArr = loadData('archiveSubmissions');
            archiveArr.push(submissionData);
            saveData('archiveSubmissions', archiveArr);
            
            // Remove from main submissions if this was an update (not new submission)
            if (originalIndex !== null) {
                const arr = loadData('submissions');
                arr.splice(originalIndex, 1);
                saveData('submissions', arr);
            }
            
            renderSubmissions();
            renderArchiveSubmissions();
            updateDashboardSummary();
        }

        function updateSubmission(idx, data) {
            const arr = loadData('submissions');
            const today = new Date().toISOString().split('T')[0];
            
            if (data) {
                // Auto-set dates based on status changes
                if (data.status === 'With SpAds' && !data.dateSubmittedSpads) {
                    data.dateSubmittedSpads = today;
                } else if (data.status === 'With PS' && !data.dateSpAdComment) {
                    data.dateSpAdComment = today;
                } else if (data.status === 'Ready for the box' && !data.dateBoxed) {
                    data.dateBoxed = today;
                } else if (data.status === 'Readout' && !data.dateReadout) {
                    data.dateReadout = today;
                }
                
                // Calculate working days automatically
                data = updateWorkingDaysForSubmission(data);
                
                // Auto-archive if status is Readout
                if (data.status === 'Readout') {
                    archiveSubmission(data, idx);
                    closeModal();
                    return;
                }
                
                arr[idx] = data;
            } else {
                const formData = getFormData();
                
                // Validate urgency reason if urgent
                if (formData.urgency === 'Urgent' && !window.currentUrgencyReason) {
                    alert('Please provide a reason for the urgent priority.');
                    openUrgencyReasonModal();
                    return;
                }
                
                // Auto-set dates based on status changes
                if (formData.status === 'With SpAds' && !formData.dateSubmittedSpads) {
                    formData.dateSubmittedSpads = today;
                } else if (formData.status === 'With PS' && !formData.dateSpAdComment) {
                    formData.dateSpAdComment = today;
                } else if (formData.status === 'Ready for the box' && !formData.dateBoxed) {
                    formData.dateBoxed = today;
                } else if (formData.status === 'Readout' && !formData.dateReadout) {
                    formData.dateReadout = today;
                }
                
                // Calculate working days automatically
                const updatedFormData = updateWorkingDaysForSubmission(formData);
                
                // Auto-archive if status is Readout
                if (updatedFormData.status === 'Readout') {
                    archiveSubmission(updatedFormData, idx);
                    closeModal();
                    return;
                }
                
                arr[idx] = updatedFormData;
            }
            saveData('submissions', arr);
            renderSubmissions();
            closeModal();
        }

        function deleteSubmissionRow(idx) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            const arr = loadData('submissions');
            arr.splice(idx, 1);
            saveData('submissions', arr);
            renderSubmissions();
        }

        function editSubmissionRow(idx) {
            const rows = loadData('submissions');
            const data = rows[idx];
            
            // Populate form fields
            document.getElementById('leadPS').value = data.leadPS || '';
            document.getElementById('leadSpAd').value = data.leadSpAd || '';
            document.getElementById('urgency').value = data.urgency || '';
            document.getElementById('submissionTitle').value = data.submissionTitle || '';
            document.getElementById('sharepointLink').value = data.sharepointLink || '';
            document.getElementById('boxReviewDeadline').value = data.boxReviewDeadline || '';
            document.getElementById('dateReceived').value = data.dateReceived || '';
            document.getElementById('status').value = data.status || '';
            document.getElementById('dateSubmittedSpads').value = data.dateSubmittedSpads || '';
            document.getElementById('dateSpAdComment').value = data.dateSpAdComment || '';
            document.getElementById('dateBoxed').value = data.dateBoxed || '';
            document.getElementById('dateReadout').value = data.dateReadout || '';
            document.getElementById('comments').value = data.comments || '';
            
            // Set urgency reason if it exists
            window.currentUrgencyReason = data.urgencyReason || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('firstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Calculate and display working days
            const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
            document.getElementById('workingDays').value = workingDays;
            
            // Update modal title and buttons
            document.querySelector('.modal-header h2').textContent = 'Edit Submission';
            document.getElementById('submissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateSubmission(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            document.getElementById('itemModal').style.display = 'block';
            
            // Set up event listeners for urgency changes
            setTimeout(() => {
                const urgencySelect = document.getElementById('urgency');
                
                if (urgencySelect) {
                    urgencySelect.addEventListener('change', handleUrgencyChange);
                }
            }, 100);
        }

        // --- Update and Submit Functions ---
        function updateAndSubmitToSpAds(idx) {
            const data = getFormData();
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            data.status = 'With SpAds';
            if (!data.dateSubmittedSpads) {
                data.dateSubmittedSpads = new Date().toISOString().split('T')[0];
            }
            updateSubmission(idx, data);
        }

        function updateAndSubmitToLCBox(idx) {
            const data = getFormData();
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            data.status = 'Ready for the box';
            if (!data.dateBoxed) {
                data.dateBoxed = new Date().toISOString().split('T')[0];
            }
            updateSubmission(idx, data);
        }

        // --- Form submission functions ---
        function addSubmissionFromModal() {
            console.log('addSubmissionFromModal called');
            
            // Check if modal is open
            const modal = document.getElementById('itemModal');
            if (!modal || modal.style.display === 'none') {
                console.error('Modal is not open!');
                alert('Form is not available. Please try opening the form again.');
                return;
            }
            
            const data = getFormData();
            console.log('Form data:', data);
            if (!data.leadPS || !data.submissionTitle) {
                console.log('Validation failed - leadPS:', data.leadPS, 'submissionTitle:', data.submissionTitle);
                alert('Please fill in required fields (Lead PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            console.log('Validation passed, adding submission');
            addSubmission(data);
            closeModal();
        }

        function submitToSpAdsFromModal() {
            console.log('submitToSpAdsFromModal called');
            
            // Check if modal is open
            const modal = document.getElementById('itemModal');
            if (!modal || modal.style.display === 'none') {
                console.error('Modal is not open!');
                alert('Form is not available. Please try opening the form again.');
                return;
            }
            
            const data = getFormData();
            console.log('Form data:', data);
            if (!data.leadPS || !data.submissionTitle) {
                console.log('Validation failed - leadPS:', data.leadPS, 'submissionTitle:', data.submissionTitle);
                alert('Please fill in required fields (Lead PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            console.log('Validation passed, submitting to SpAds');
            data.status = 'With SpAds';
            if (!data.dateSubmittedSpads) {
                data.dateSubmittedSpads = new Date().toISOString().split('T')[0];
            }
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            addSubmission(data);
            closeModal();
        }

        function submitToLCBoxFromModal() {
            console.log('submitToLCBoxFromModal called');
            
            // Check if modal is open
            const modal = document.getElementById('itemModal');
            if (!modal || modal.style.display === 'none') {
                console.error('Modal is not open!');
                alert('Form is not available. Please try opening the form again.');
                return;
            }
            
            const data = getFormData();
            console.log('Form data:', data);
            if (!data.leadPS || !data.submissionTitle) {
                console.log('Validation failed - leadPS:', data.leadPS, 'submissionTitle:', data.submissionTitle);
                alert('Please fill in required fields (Lead PS and Submission Title).');
                return;
            }
            
            // Validate urgency reason if urgent
            if (data.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            console.log('Validation passed, submitting to LC Box');
            data.status = 'Ready for the box';
            if (!data.dateBoxed) {
                data.dateBoxed = new Date().toISOString().split('T')[0];
            }
            addSubmission(data);
            closeModal();
        }

        // --- Render Functions ---
        function renderSubmissions() {
            console.log('renderSubmissions called');
            const rows = loadData('submissions');
            console.log('Loaded submissions:', rows);
            const container = document.querySelector('#mainDashboard .submissions-grid');
            console.log('Container found:', container);
            
            if (!container) {
                console.error('Could not find submissions grid container!');
                return;
            }
            
            // Remove existing rows (except header)
            const existingRows = container.querySelectorAll('.grid-row');
            console.log('Existing rows to remove:', existingRows.length);
            existingRows.forEach(row => row.remove());
            
            // Add new rows
            rows.forEach((data, idx) => {
                console.log('Processing row data:', data);
                if (!data) {
                    console.error('Row data is null or undefined at index:', idx);
                    return;
                }
                
                // Calculate working days for display
                const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
                
                // Show draft indicator in comments column
                let commentsDisplay = data.comments || '';
                if (data.spadDraftComments || data.spadDraftBoxNote) {
                    const draftComments = data.spadDraftComments || '';
                    commentsDisplay = draftComments;
                }
                
                // Add urgency reason if item is urgent
                if (data.urgency === 'Urgent' && data.urgencyReason) {
                    const urgencyNote = `[URGENT: ${data.urgencyReason}]`;
                    commentsDisplay = commentsDisplay ? `${urgencyNote} ${commentsDisplay}` : urgencyNote;
                }
                
                const row = document.createElement('div');
                row.className = 'grid-row';
                
                // Add urgent styling if item is urgent
                if (data.urgency === 'Urgent') {
                    row.classList.add('urgent-item');
                }
                
                row.innerHTML = `
                    <div class="grid-cell">${(data && data.leadPS) || ''}</div>
                    <div class="grid-cell">${(data && data.leadSpAd) || ''}</div>
                    <div class="grid-cell">${(data && data.urgency) || ''}</div>
                    <div class="grid-cell">${(data && data.submissionTitle) || ''}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">
                        <select class="inline-status" onchange="updateStatusQuick(${idx}, this.value)">
                            <option value="With Perm Sec/DGs" ${data.status === 'With Perm Sec/DGs' ? 'selected' : ''}>With Perm Sec/DGs</option>
                            <option value="With junior minister(s)" ${data.status === 'With junior minister(s)' ? 'selected' : ''}>With junior minister(s)</option>
                            <option value="With SpAds" ${data.status === 'With SpAds' ? 'selected' : ''}>With SpAds</option>
                            <option value="With officials" ${data.status === 'With officials' ? 'selected' : ''}>With officials</option>
                            <option value="With PS" ${data.status === 'With PS' ? 'selected' : ''}>With PS</option>
                            <option value="Ready for the box" ${data.status === 'Ready for the box' ? 'selected' : ''}>Ready for box</option>
                            <option value="Readout" ${data.status === 'Readout' ? 'selected' : ''}>Readout</option>
                        </select>
                    </div>
                    <div class="grid-cell">${workingDays}</div>
                    <div class="grid-cell">${commentsDisplay}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            ${data.status === 'With SpAds' ? `<button class="action-btn spad-comment-btn" onclick="openSpAdCommentModal(this)" data-tooltip="Add SpAd Comment">💬 SpAd Comment</button>` : ''}
                            ${data.status !== 'With SpAds' && data.status !== 'Ready for the box' ? `<button class="action-btn spad-btn" onclick="submitToSpAdsQuick(${idx})" data-tooltip="Submit to SpAds">→ SpAd</button>` : ''}
                            ${data.status !== 'Ready for the box' ? `<button class="action-btn lc-btn" onclick="submitToLCQuick(${idx})" data-tooltip="Submit to Box">→ Box</button>` : ''}
                            <button class="action-btn edit-btn" onclick="editSubmissionRow(${idx})" data-tooltip="Edit this submission">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteSubmissionRow(${idx})" data-tooltip="Delete this submission">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
            
            // Update dashboard summary counts
            updateDashboardSummary();
        }

        // --- Dashboard Summary and Quick Action Functions ---
        function updateDashboardSummary() {
            const submissions = loadData('submissions');
            
            // Count items with SpAds
            const spadCount = submissions.filter(s => s.status === 'With SpAds').length;
            document.getElementById('spadCount').textContent = spadCount;
            
            // Count urgent items
            const urgentCount = submissions.filter(s => s.urgency === 'Urgent').length;
            document.getElementById('urgentCount').textContent = urgentCount;
            
            // Count items ready for box
            const lcReadyCount = submissions.filter(s => s.status === 'Ready for the box').length;
            document.getElementById('lcReadyCount').textContent = lcReadyCount;
            
            // Count overdue items (with SpAds for 5+ working days)
            const overdueCount = submissions.filter(s => {
                if (s.status === 'With SpAds' && s.dateSubmittedSpads) {
                    const workingDays = calculateWorkingDays(s.dateSubmittedSpads, s.dateSpAdComment);
                    return workingDays >= 5;
                }
                return false;
            }).length;
            document.getElementById('overdueCount').textContent = overdueCount;
        }

        function updateStatusQuick(idx, newStatus) {
            const submissions = loadData('submissions');
            if (submissions[idx]) {
                // If status is changed to Readout, archive the item automatically
                if (newStatus === 'Readout') {
                    const submissionData = submissions[idx];
                    submissionData.status = 'Readout';
                    
                    // Set readout date if not already set
                    if (!submissionData.dateReadout) {
                        submissionData.dateReadout = new Date().toISOString().split('T')[0];
                    }
                    
                    // Archive the submission
                    archiveSubmission(submissionData, idx);
                    return;
                }
                
                submissions[idx].status = newStatus;
                
                // Set appropriate dates based on status
                const today = new Date().toISOString().split('T')[0];
                if (newStatus === 'With SpAds' && !submissions[idx].dateSubmittedSpads) {
                    submissions[idx].dateSubmittedSpads = today;
                } else if (newStatus === 'With PS' && !submissions[idx].dateSpAdComment) {
                    submissions[idx].dateSpAdComment = today;
                } else if (newStatus === 'Ready for the box' && !submissions[idx].dateBoxed) {
                    submissions[idx].dateBoxed = today;
                }
                
                // Update working days calculation
                submissions[idx] = updateWorkingDaysForSubmission(submissions[idx]);
                
                saveData('submissions', submissions);
                renderSubmissions();
                updateDashboardSummary();
            }
        }

        function markUrgentQuick(idx) {
            // Open urgency reason modal
            window.currentEditingIdx = idx;
            window.currentUrgencyReason = '';
            openUrgencyReasonModal();
        }

        function submitToSpAdsQuick(idx) {
            const submissions = loadData('submissions');
            if (submissions[idx]) {
                submissions[idx].status = 'With SpAds';
                if (!submissions[idx].dateSubmittedSpads) {
                    submissions[idx].dateSubmittedSpads = new Date().toISOString().split('T')[0];
                }
                // Update working days calculation
                submissions[idx] = updateWorkingDaysForSubmission(submissions[idx]);
                saveData('submissions', submissions);
                renderSubmissions();
            }
        }

        function submitToLCQuick(idx) {
            const submissions = loadData('submissions');
            if (submissions[idx]) {
                submissions[idx].status = 'Ready for the box';
                if (!submissions[idx].dateBoxed) {
                    submissions[idx].dateBoxed = new Date().toISOString().split('T')[0];
                }
                // Update working days calculation
                submissions[idx] = updateWorkingDaysForSubmission(submissions[idx]);
                saveData('submissions', submissions);
                renderSubmissions();
            }
        }

        // --- Filter Functions ---
        let currentFilter = null;

        function clearAllFilters() {
            currentFilter = null;
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            allRows.forEach(row => row.style.display = '');
            updateFilterButtons('all');
        }

        function filterByStatus(status) {
            currentFilter = { type: 'status', value: status };
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            allRows.forEach(row => {
                const statusCell = row.querySelector('.grid-cell:nth-child(6) select');
                if (statusCell && statusCell.value === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterButtons('status');
        }

        function filterByUrgency(urgency) {
            currentFilter = { type: 'urgency', value: urgency };
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            allRows.forEach(row => {
                const urgencyCell = row.querySelector('.grid-cell:nth-child(3)');
                if (urgencyCell && urgencyCell.textContent.trim() === urgency) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterButtons('urgent');
        }

        function showOverdueItems() {
            currentFilter = { type: 'overdue' };
            const submissions = loadData('submissions');
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            
            allRows.forEach((row, idx) => {
                const submission = submissions[idx];
                if (submission && submission.status === 'With SpAds' && submission.dateSubmittedSpads) {
                    const workingDays = calculateWorkingDays(submission.dateSubmittedSpads, submission.dateSpAdComment);
                    if (workingDays >= 5) {
                        row.style.display = '';
                        row.classList.add('overdue-spad-row');
                    } else {
                        row.style.display = 'none';
                    }
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterButtons('overdue');
        }

        function filterByCurrentUser() {
            // Create a simple name selection modal instead of requiring a separate dashboard
            const userName = prompt('Enter your name to filter your items:');
            if (!userName) {
                return;
            }
            
            currentFilter = { type: 'user', value: userName };
            const allRows = document.querySelectorAll('#mainDashboard .grid-row');
            allRows.forEach(row => {
                const psCell = row.querySelector('.grid-cell:nth-child(1)');
                const spadCell = row.querySelector('.grid-cell:nth-child(2)');
                if ((psCell && psCell.textContent.trim() === userName) || 
                    (spadCell && spadCell.textContent.trim() === userName)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterButtons('user');
        }

        function updateFilterButtons(activeType) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (activeType === 'all') {
                document.querySelector('.filter-btn').classList.add('active');
            } else if (activeType === 'status' && currentFilter && currentFilter.value) {
                // Only highlight the specific status button that was clicked
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    // Handle the special case where button text "Ready for box" maps to status "Ready for the box"
                    if ((currentFilter.value === 'Ready for the box' && btn.textContent === 'Ready for box') ||
                        btn.textContent === currentFilter.value) {
                        btn.classList.add('active');
                    }
                });
            } else if (activeType === 'urgent') {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.textContent === 'Urgent Only') {
                        btn.classList.add('active');
                    }
                });
            } else if (activeType === 'overdue') {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.textContent === 'Overdue') {
                        btn.classList.add('active');
                    }
                });
            } else if (activeType === 'user') {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.textContent === 'My Items') {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function renderArchiveSubmissions() {
            const rows = loadData('archiveSubmissions');
            const container = document.getElementById('archiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA; // Most recent first (descending order)
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.submissionTitle === data.submissionTitle && 
                    row.leadPS === data.leadPS &&
                    row.archivedDate === data.archivedDate
                );
                
                // Calculate working days for display
                const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
                
                // Show draft comments if available, otherwise regular comments
                let commentsDisplay = data.comments || '';
                if (data.spadDraftComments || data.spadDraftBoxNote) {
                    const draftComments = data.spadDraftComments || '';
                    commentsDisplay = draftComments;
                }
                
                // Add urgency reason if item is urgent
                if (data.urgency === 'Urgent' && data.urgencyReason) {
                    const urgencyNote = `[URGENT: ${data.urgencyReason}]`;
                    commentsDisplay = commentsDisplay ? `${urgencyNote} ${commentsDisplay}` : urgencyNote;
                }
                
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${data.urgency || ''}</div>
                    <div class="grid-cell">${data.submissionTitle || ''}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell">${workingDays}</div>
                    <div class="grid-cell">${commentsDisplay}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editArchivedSubmission(${originalIdx})" data-tooltip="Edit this archived submission">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteArchivedSubmission(${originalIdx})" data-tooltip="Delete this archived submission">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteArchivedSubmission(idx) {
            if (!confirm('Are you sure you want to delete this archived submission?')) return;
            const arr = loadData('archiveSubmissions');
            arr.splice(idx, 1);
            saveData('archiveSubmissions', arr);
            renderArchiveSubmissions();
        }

        function editArchivedSubmission(idx) {
            const rows = loadData('archiveSubmissions');
            const data = rows[idx];
            
            // Populate form fields
            document.getElementById('leadPS').value = data.leadPS || '';
            document.getElementById('leadSpAd').value = data.leadSpAd || '';
            document.getElementById('urgency').value = data.urgency || '';
            document.getElementById('submissionTitle').value = data.submissionTitle || '';
            document.getElementById('sharepointLink').value = data.sharepointLink || '';
            document.getElementById('boxReviewDeadline').value = data.boxReviewDeadline || '';
            document.getElementById('dateReceived').value = data.dateReceived || '';
            document.getElementById('status').value = data.status || '';
            document.getElementById('dateSubmittedSpads').value = data.dateSubmittedSpads || '';
            document.getElementById('dateSpAdComment').value = data.dateSpAdComment || '';
            document.getElementById('dateBoxed').value = data.dateBoxed || '';
            document.getElementById('dateReadout').value = data.dateReadout || '';
            document.getElementById('comments').value = data.comments || '';
            
            // Set urgency reason if it exists
            window.currentUrgencyReason = data.urgencyReason || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('firstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Calculate and display working days
            const workingDays = data.dateSubmittedSpads ? calculateWorkingDays(data.dateSubmittedSpads, data.dateSpAdComment) : '';
            document.getElementById('workingDays').value = workingDays;
            
            // Update modal title and buttons
            document.querySelector('.modal-header h2').textContent = 'Edit Archived Submission';
            document.getElementById('submissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateArchivedSubmission(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            document.getElementById('itemModal').style.display = 'block';
            
            // Set up event listeners for urgency changes
            setTimeout(() => {
                const urgencySelect = document.getElementById('urgency');
                
                if (urgencySelect) {
                    urgencySelect.addEventListener('change', handleUrgencyChange);
                }
            }, 100);
        }

        function updateArchivedSubmission(idx) {
            const arr = loadData('archiveSubmissions');
            const formData = getFormData();
            
            // Validate urgency reason if urgent
            if (formData.urgency === 'Urgent' && !window.currentUrgencyReason) {
                alert('Please provide a reason for the urgent priority.');
                openUrgencyReasonModal();
                return;
            }
            
            // Preserve archived date and other archive-specific data
            const originalData = arr[idx];
            formData.archivedDate = originalData.archivedDate;
            formData.firstAdded = originalData.firstAdded;
            
            // Calculate working days automatically
            const updatedFormData = updateWorkingDaysForSubmission(formData);
            
            arr[idx] = updatedFormData;
            saveData('archiveSubmissions', arr);
            renderArchiveSubmissions();
            closeModal();
        }

        // --- Invite Functions ---
        function addInvite() {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            const arr = loadData('invites');
            arr.push(data);
            saveData('invites', arr);
            renderInvites();
            closeInviteModal();
        }

        function renderInvites() {
            const rows = loadData('invites');
            const container = document.getElementById('inviteGridRows');
            container.innerHTML = '';
            
            // Sort by date (earliest first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.inviteDate || '1900-01-01');
                const dateB = new Date(b.inviteDate || '1900-01-01');
                return dateA - dateB;
            });
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to beginning of day for accurate comparison
            
            sortedRows.forEach((data, idx) => {
                // Find original index for edit/delete operations
                const originalIdx = rows.findIndex(row => 
                    row.inviteTitle === data.inviteTitle && 
                    row.inviteDate === data.inviteDate &&
                    row.inviteStartTime === data.inviteStartTime
                );
                
                // Check if RSVP deadline has passed
                let isRSVPOverdue = false;
                if (data.inviteRSVPDeadline) {
                    const rsvpDeadline = new Date(data.inviteRSVPDeadline);
                    rsvpDeadline.setHours(23, 59, 59, 999); // Set to end of deadline day
                    if (today > rsvpDeadline) {
                        isRSVPOverdue = true;
                    }
                }
                
                const row = document.createElement('div');
                row.className = isRSVPOverdue ? 'grid-row rsvp-overdue' : 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.inviteTitle || ''}</div>
                    <div class="grid-cell">${data.inviteLeadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.inviteDate)}</div>
                    <div class="grid-cell">${data.inviteStartTime || ''}</div>
                    <div class="grid-cell">${data.inviteEndTime || ''}</div>
                    <div class="grid-cell">${data.inviteStatus || ''}</div>
                    <div class="grid-cell">${data.diaryManagerComments || ''}</div>
                    <div class="grid-cell">${data.psCommentsInvite || ''}</div>
                    <div class="grid-cell">${data.spadCommentsInvite || ''}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editInviteRow(${originalIdx})" data-tooltip="Edit this invite">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteInviteRow(${originalIdx})" data-tooltip="Delete this invite">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Apply current filter if any
            if (currentInviteFilter && currentInviteFilter.type === 'status') {
                filterInvitesByStatus(currentInviteFilter.value);
            }
        }

        function deleteInviteRow(idx) {
            if (!confirm('Are you sure you want to delete this invite?')) return;
            const arr = loadData('invites');
            arr.splice(idx, 1);
            saveData('invites', arr);
            renderInvites();
        }

        function editInviteRow(idx) {
            const rows = loadData('invites');
            const data = rows[idx];
            
            document.getElementById('inviteTitle').value = data.inviteTitle || '';
            document.getElementById('inviteLeadPS').value = data.inviteLeadPS || '';
            document.getElementById('inviteDate').value = data.inviteDate || '';
            document.getElementById('inviteStartTime').value = data.inviteStartTime || '';
            document.getElementById('inviteEndTime').value = data.inviteEndTime || '';
            document.getElementById('inviteRSVPDeadline').value = data.inviteRSVPDeadline || '';
            document.getElementById('inviteStatus').value = data.inviteStatus || '';
            document.getElementById('diaryManagerComments').value = data.diaryManagerComments || '';
            document.getElementById('psCommentsInvite').value = data.psCommentsInvite || '';
            document.getElementById('spadCommentsInvite').value = data.spadCommentsInvite || '';
            
            document.querySelector('#inviteModal .modal-header h2').textContent = 'Edit Invite';
            document.querySelector('#inviteModal .form-buttons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateInvite(${idx})">Update Invite</button>
                <button type="button" class="form-btn btn-submit-archive" onclick="updateAndArchiveInvite(${idx})">Update & Archive</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
            `;
            
            document.getElementById('inviteModal').style.display = 'block';
        }

        function updateInvite(idx) {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            const arr = loadData('invites');
            arr[idx] = data;
            saveData('invites', arr);
            renderInvites();
            closeInviteModal();
        }

        function submitInviteToArchive() {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            // Add archived date
            data.archivedDate = new Date().toISOString();
            
            // Add directly to archive
            const archiveArr = loadData('archiveInvites');
            archiveArr.push(data);
            saveData('archiveInvites', archiveArr);
            
            renderArchiveInvites();
            closeInviteModal();
            alert('Invite has been submitted to archive successfully!');
        }

        function archiveInviteRow(idx) {
            if (!confirm('Are you sure you want to archive this invite?')) return;
            
            const arr = loadData('invites');
            const inviteData = arr[idx];
            
            // Add archived date
            inviteData.archivedDate = new Date().toISOString();
            
            // Add to archive
            const archiveArr = loadData('archiveInvites');
            archiveArr.push(inviteData);
            saveData('archiveInvites', archiveArr);
            
            // Remove from main invites
            arr.splice(idx, 1);
            saveData('invites', arr);
            
            renderInvites();
            renderArchiveInvites();
            alert('Invite has been archived successfully!');
        }

        function updateAndArchiveInvite(idx) {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            // Add archived date
            data.archivedDate = new Date().toISOString();
            
            // Add to archive
            const archiveArr = loadData('archiveInvites');
            archiveArr.push(data);
            saveData('archiveInvites', archiveArr);
            
            // Remove from main invites
            const arr = loadData('invites');
            arr.splice(idx, 1);
            saveData('invites', arr);
            
            renderInvites();
            renderArchiveInvites();
            closeInviteModal();
            alert('Invite has been updated and archived successfully!');
        }

        function renderArchiveInvites() {
            const rows = loadData('archiveInvites');
            const container = document.getElementById('inviteArchiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA; // Most recent first (descending order)
            });
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to beginning of day for accurate comparison
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.inviteTitle === data.inviteTitle && 
                    row.inviteDate === data.inviteDate &&
                    row.inviteStartTime === data.inviteStartTime &&
                    row.archivedDate === data.archivedDate
                );
                
                // Check if RSVP deadline had passed (for archived items)
                let isRSVPOverdue = false;
                if (data.inviteRSVPDeadline) {
                    const rsvpDeadline = new Date(data.inviteRSVPDeadline);
                    rsvpDeadline.setHours(23, 59, 59, 999); // Set to end of deadline day
                    const archiveDate = new Date(data.archivedDate || today);
                    if (archiveDate > rsvpDeadline) {
                        isRSVPOverdue = true;
                    }
                }
                
                const row = document.createElement('div');
                row.className = isRSVPOverdue ? 'grid-row rsvp-overdue' : 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.inviteTitle || ''}</div>
                    <div class="grid-cell">${data.inviteLeadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.inviteDate)}</div>
                    <div class="grid-cell">${data.inviteStartTime || ''}</div>
                    <div class="grid-cell">${data.inviteEndTime || ''}</div>
                    <div class="grid-cell">${data.inviteStatus || ''}</div>
                    <div class="grid-cell">${data.diaryManagerComments || ''}</div>
                    <div class="grid-cell">${data.psCommentsInvite || ''}</div>
                    <div class="grid-cell">${data.spadCommentsInvite || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editArchivedInvite(${originalIdx})" data-tooltip="Edit this archived invite">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteArchivedInvite(${originalIdx})" data-tooltip="Delete this archived invite">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteArchivedInvite(idx) {
            if (!confirm('Are you sure you want to delete this archived invite?')) return;
            const arr = loadData('archiveInvites');
            arr.splice(idx, 1);
            saveData('archiveInvites', arr);
            renderArchiveInvites();
        }

        function editArchivedInvite(idx) {
            const rows = loadData('archiveInvites');
            const data = rows[idx];
            
            document.getElementById('inviteTitle').value = data.inviteTitle || '';
            document.getElementById('inviteLeadPS').value = data.inviteLeadPS || '';
            document.getElementById('inviteDate').value = data.inviteDate || '';
            document.getElementById('inviteStartTime').value = data.inviteStartTime || '';
            document.getElementById('inviteEndTime').value = data.inviteEndTime || '';
            document.getElementById('inviteRSVPDeadline').value = data.inviteRSVPDeadline || '';
            document.getElementById('inviteStatus').value = data.inviteStatus || '';
            document.getElementById('diaryManagerComments').value = data.diaryManagerComments || '';
            document.getElementById('psCommentsInvite').value = data.psCommentsInvite || '';
            document.getElementById('spadCommentsInvite').value = data.spadCommentsInvite || '';
            
            document.querySelector('#inviteModal .modal-header h2').textContent = 'Edit Archived Invite';
            document.querySelector('#inviteModal .form-buttons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateArchivedInvite(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
            `;
            
            document.getElementById('inviteModal').style.display = 'block';
        }

        function updateArchivedInvite(idx) {
            const data = getInviteFormData();
            if (!data.inviteTitle) {
                alert('Please fill in the required field (Invite).');
                return;
            }
            
            const arr = loadData('archiveInvites');
            // Preserve archived date and other archive-specific data
            const originalData = arr[idx];
            data.archivedDate = originalData.archivedDate;
            data.firstAdded = originalData.firstAdded;
            
            arr[idx] = data;
            saveData('archiveInvites', arr);
            renderArchiveInvites();
            closeInviteModal();
        }

        // --- Invite Filter Functions ---
        let currentInviteFilter = null;

        function clearInviteFilters() {
            currentInviteFilter = null;
            const allRows = document.querySelectorAll('#invites .grid-row');
            allRows.forEach(row => row.style.display = '');
            updateInviteFilterButtons('all');
        }

        function filterInvitesByStatus(status) {
            currentInviteFilter = { type: 'status', value: status };
            const allRows = document.querySelectorAll('#invites .grid-row');
            allRows.forEach(row => {
                const statusCell = row.querySelector('.grid-cell:nth-child(6)');
                if (statusCell && statusCell.textContent.trim() === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            updateInviteFilterButtons('status');
        }

        function updateInviteFilterButtons(activeType) {
            document.querySelectorAll('#invites .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (activeType === 'all') {
                document.querySelector('#invites .filter-btn').classList.add('active');
            } else if (activeType === 'status' && currentInviteFilter && currentInviteFilter.value) {
                document.querySelectorAll('#invites .filter-btn').forEach(btn => {
                    if (btn.textContent === currentInviteFilter.value) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        // --- Briefing Functions ---
        function addBriefing() {
            const data = getBriefingFormData();
            if (!data.leadPS || !data.leadSpAd || !data.date || !data.time || !data.title) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            const arr = loadData('briefings');
            arr.push(data);
            saveData('briefings', arr);
            renderBriefings();
            closeBriefingModal();
        }

        function submitBriefingToArchive() {
            const data = getBriefingFormData();
            if (!data.leadPS || !data.leadSpAd || !data.date || !data.time || !data.title) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            // Add archived date
            data.archivedDate = new Date().toISOString();
            
            // Add directly to archive
            const archiveArr = loadData('archiveBriefings');
            archiveArr.push(data);
            saveData('archiveBriefings', archiveArr);
            
            renderArchiveBriefings();
            closeBriefingModal();
            alert('Briefing has been submitted to archive successfully!');
        }

        function archiveBriefingRow(idx) {
            if (!confirm('Are you sure you want to archive this briefing?')) return;
            
            const arr = loadData('briefings');
            const briefingData = arr[idx];
            
            // Add archived date
            briefingData.archivedDate = new Date().toISOString();
            
            // Add to archive
            const archiveArr = loadData('archiveBriefings');
            archiveArr.push(briefingData);
            saveData('archiveBriefings', archiveArr);
            
            // Remove from main briefings
            arr.splice(idx, 1);
            saveData('briefings', arr);
            
            renderBriefings();
            renderArchiveBriefings();
            closeBriefingModal();
            alert('Briefing has been archived successfully!');
        }

        function renderBriefings() {
            const rows = loadData('briefings');
            const container = document.getElementById('briefingGridRows');
            container.innerHTML = '';
            
            // Sort by date (earliest first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.date || '1900-01-01');
                const dateB = new Date(b.date || '1900-01-01');
                return dateA - dateB;
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for edit/delete operations
                const originalIdx = rows.findIndex(row => 
                    row.leadPS === data.leadPS && 
                    row.date === data.date &&
                    row.time === data.time &&
                    row.title === data.title
                );
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.date)}</div>
                    <div class="grid-cell">${data.time || ''}</div>
                    <div class="grid-cell">${data.title || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.commissionDeadline)}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${data.psComments || ''}</div>
                    <div class="grid-cell">${data.spadComments || ''}</div>
                    <div class="grid-cell actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editBriefingRow(${originalIdx})" data-tooltip="Edit this briefing">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteBriefingRow(${originalIdx})" data-tooltip="Delete this briefing">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
        }

        function deleteBriefingRow(idx) {
            if (confirm('Are you sure you want to delete this briefing?')) {
                const arr = loadData('briefings');
                arr.splice(idx, 1);
                saveData('briefings', arr);
                renderBriefings();
            }
        }

        function editBriefingRow(idx) {
            const rows = loadData('briefings');
            const data = rows[idx];
            
            document.getElementById('briefingLeadPS').value = data.leadPS || '';
            document.getElementById('briefingLeadSpAd').value = data.leadSpAd || '';
            document.getElementById('briefingDate').value = data.date || '';
            document.getElementById('briefingTime').value = data.time || '';
            document.getElementById('briefingTitle').value = data.title || '';
            document.getElementById('briefingCommissionDeadline').value = data.commissionDeadline || '';
            document.getElementById('briefingSharepointLink').value = data.sharepointLink || '';
            document.getElementById('briefingPSComments').value = data.psComments || '';
            document.getElementById('briefingSpAdComments').value = data.spadComments || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('briefingFirstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            document.getElementById('briefingModalTitle').textContent = 'Edit Briefing';
            document.getElementById('briefingFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateBriefing(${idx})">Update</button>
                <button type="button" class="form-btn btn-submit-archive" onclick="archiveBriefingRow(${idx})">Submit to Archive</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
            `;
            
            document.getElementById('briefingModal').style.display = 'block';
        }

        function updateBriefing(idx) {
            const data = getBriefingFormData();
            if (!data.leadPS || !data.leadSpAd || !data.date || !data.time || !data.title) {
                alert('Please fill in all required fields.');
                return;
            }
            
            const arr = loadData('briefings');
            arr[idx] = data;
            saveData('briefings', arr);
            renderBriefings();
            closeBriefingModal();
        }

        function renderArchiveBriefings() {
            const rows = loadData('archiveBriefings');
            const container = document.getElementById('briefingsArchiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA; // Most recent first (descending order)
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.leadPS === data.leadPS && 
                    row.date === data.date &&
                    row.time === data.time &&
                    row.title === data.title &&
                    row.archivedDate === data.archivedDate
                );
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${data.leadSpAd || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.date)}</div>
                    <div class="grid-cell">${data.time || ''}</div>
                    <div class="grid-cell">${data.title || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.commissionDeadline)}</div>
                    <div class="grid-cell">${formatUrlForDisplay(data.sharepointLink)}</div>
                    <div class="grid-cell">${data.psComments || ''}</div>
                    <div class="grid-cell">${data.spadComments || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editArchivedBriefing(${originalIdx})" data-tooltip="Edit this archived briefing">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteArchivedBriefing(${originalIdx})" data-tooltip="Delete this archived briefing">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function deleteArchivedBriefing(idx) {
            if (!confirm('Are you sure you want to delete this archived briefing?')) return;
            const arr = loadData('archiveBriefings');
            arr.splice(idx, 1);
            saveData('archiveBriefings', arr);
            renderArchiveBriefings();
        }

        function editArchivedBriefing(idx) {
            const arr = loadData('archiveBriefings');
            const data = arr[idx];
            
            // Populate the briefing modal with archived data
            document.getElementById('briefingLeadPS').value = data.leadPS || '';
            document.getElementById('briefingLeadSpAd').value = data.leadSpAd || '';
            document.getElementById('briefingDate').value = data.date || '';
            document.getElementById('briefingTime').value = data.time || '';
            document.getElementById('briefingTitle').value = data.title || '';
            document.getElementById('briefingCommissionDeadline').value = data.commissionDeadline || '';
            document.getElementById('briefingSharepointLink').value = data.sharepointLink || '';
            document.getElementById('briefingPSComments').value = data.psComments || '';
            document.getElementById('briefingSpAdComments').value = data.spadComments || '';
            
            // Update modal title and buttons for editing archived briefing
            document.getElementById('briefingModalTitle').textContent = 'Edit Archived Briefing';
            document.getElementById('briefingFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateArchivedBriefing(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
            `;
            
            // Show the modal
            document.getElementById('briefingModal').style.display = 'block';
        }

        function updateArchivedBriefing(idx) {
            const data = getBriefingFormData();
            
            // Minimal validation - only require title since that's the most essential field
            if (!data.title) {
                alert('Please fill in at least the Title field.');
                return;
            }
            
            // Keep the archived date and status
            const arr = loadData('archiveBriefings');
            data.archivedDate = arr[idx].archivedDate;
            data.status = 'Complete'; // Keep archived status
            
            // Update the archived briefing
            arr[idx] = data;
            saveData('archiveBriefings', arr);
            renderArchiveBriefings();
            closeBriefingModal();
        }

        // --- Smart Defaults Function ---
        function applySmartDefaults() {
            // Set today's date as default for date received
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateReceived').value = today;
            
            // Get current page context for smart status defaults
            const activeSection = document.querySelector('.main-content > div:not(.hidden)');
            if (activeSection) {
                const statusSelect = document.getElementById('status');
                switch(activeSection.id) {
                    case 'spadBox':
                        statusSelect.value = 'With SpAds';
                        break;
                    case 'lcBox':
                        statusSelect.value = 'Ready for the box';
                        break;
                    default:
                        // Check user's most common status from recent submissions
                        const recentSubmissions = loadData('submissions').slice(-5);
                        const statusCounts = {};
                        recentSubmissions.forEach(sub => {
                            if (sub.status) {
                                statusCounts[sub.status] = (statusCounts[sub.status] || 0) + 1;
                            }
                        });
                        const mostCommonStatus = Object.keys(statusCounts).reduce((a, b) => 
                            statusCounts[a] > statusCounts[b] ? a : b, 'With SpAds');
                        statusSelect.value = mostCommonStatus;
                        break;
                }
            }
            
            // Pre-select most commonly used SpAd
            const recentSubmissions = loadData('submissions').slice(-10);
            const spadCounts = {};
            recentSubmissions.forEach(sub => {
                if (sub.leadSpAd && sub.leadSpAd !== 'No SpAd review') {
                    spadCounts[sub.leadSpAd] = (spadCounts[sub.leadSpAd] || 0) + 1;
                }
            });
            if (Object.keys(spadCounts).length > 0) {
                const mostCommonSpAd = Object.keys(spadCounts).reduce((a, b) => 
                    spadCounts[a] > spadCounts[b] ? a : b);
                document.getElementById('leadSpAd').value = mostCommonSpAd;
            }
        }

        // --- Modal Functions ---
        function openModal() {
            document.getElementById('submissionForm').reset();
            document.querySelector('.modal-header h2').textContent = 'Add New Submission';
            document.getElementById('submissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="addSubmissionFromModal()">Add</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            // Hide timestamp for new items
            const timestampDiv = document.getElementById('firstAddedTimestamp');
            if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            document.getElementById('itemModal').style.display = 'block';
            
            // Apply smart defaults
            applySmartDefaults();
            
            // Reset urgency reason and first added timestamp
            window.currentUrgencyReason = '';
            window.currentFirstAdded = '';
            window.previousUrgencyValue = '';
            window.lastNonUrgentValue = '';
            
            // Set up event listeners for working days calculation
            setTimeout(() => {
                const dateSubmittedSpads = document.getElementById('dateSubmittedSpads');
                const dateSpAdComment = document.getElementById('dateSpAdComment');
                const urgencySelect = document.getElementById('urgency');
                
                if (dateSubmittedSpads) {
                    dateSubmittedSpads.addEventListener('change', updateWorkingDaysDisplay);
                }
                if (dateSpAdComment) {
                    dateSpAdComment.addEventListener('change', updateWorkingDaysDisplay);
                }
                if (urgencySelect) {
                    urgencySelect.addEventListener('change', handleUrgencyChange);
                }
            }, 100);
        }

        function closeModal() {
            document.getElementById('itemModal').style.display = 'none';
            document.getElementById('submissionForm').reset();
            // Reset urgency reason
            window.currentUrgencyReason = '';
        }

        // --- Commission Functions ---
        function getCommissionFormData() {
            return {
                action: document.getElementById('commissionAction').value || '',
                leadPS: document.getElementById('commissionLeadPS').value || '',
                deadline: document.getElementById('commissionDeadline').value || '',
                status: document.getElementById('commissionStatus').value || ''
            };
        }

        function openCommissionModal() {
            document.getElementById('commissionModal').style.display = 'block';
            document.getElementById('commissionModalTitle').textContent = 'Add New Commission';
            
            // Hide timestamp for new items
            const timestampDiv = document.getElementById('commissionFirstAddedTimestamp');
            if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Reset first added timestamp
            window.currentFirstAdded = '';
            
            clearCommissionForm();
        }

        function closeCommissionModal() {
            document.getElementById('commissionModal').style.display = 'none';
            clearCommissionForm();
            resetCommissionFormButtons();
        }

        function clearCommissionForm() {
            document.getElementById('commissionAction').value = '';
            document.getElementById('commissionLeadPS').value = '';
            document.getElementById('commissionDeadline').value = '';
            document.getElementById('commissionStatus').value = '';
        }

        function addCommission() {
            const data = getCommissionFormData();
            
            if (!data.action.trim()) {
                alert('Please enter an action description');
                return;
            }
            
            if (!data.leadPS) {
                alert('Please select a Lead PS');
                return;
            }
            
            // Set first added timestamp for new items
            if (!data.firstAdded) {
                data.firstAdded = new Date().toISOString();
            }
            
            const arr = loadData('commissions');
            arr.push(data);
            saveData('commissions', arr);
            renderCommissions();
            closeCommissionModal();
        }

        function renderCommissions() {
            const rows = loadData('commissions');
            const container = document.getElementById('commissionGridRows');
            container.innerHTML = '';
            
            rows.forEach((data, idx) => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.action || ''}</div>
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.deadline)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                `;
                container.appendChild(row);
            });
        }

        function renderCommissionArchive() {
            const rows = loadData('commissionArchive');
            const container = document.getElementById('commissionArchiveGridRows');
            container.innerHTML = '';
            
            // Sort by archive date (most recent first)
            const sortedRows = rows.sort((a, b) => {
                const dateA = new Date(a.archivedDate || '1900-01-01');
                const dateB = new Date(b.archivedDate || '1900-01-01');
                return dateB - dateA;
            });
            
            sortedRows.forEach((data, idx) => {
                // Find original index for delete operations
                const originalIdx = rows.findIndex(row => 
                    row.action === data.action && 
                    row.leadPS === data.leadPS &&
                    row.deadline === data.deadline &&
                    row.status === data.status &&
                    row.archivedDate === data.archivedDate
                );
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.innerHTML = `
                    <div class="grid-cell">${data.action || ''}</div>
                    <div class="grid-cell">${data.leadPS || ''}</div>
                    <div class="grid-cell">${formatDateForDisplay(data.deadline)}</div>
                    <div class="grid-cell">${data.status || ''}</div>
                    <div class="grid-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editArchivedCommission(${originalIdx})" data-tooltip="Edit this archived commission">✏️ Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteArchivedCommission(${originalIdx})" data-tooltip="Delete this archived commission">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function editArchivedCommission(idx) {
            const arr = loadData('commissionArchive');
            const data = arr[idx];
            
            // Populate the commission modal with archived data
            document.getElementById('commissionAction').value = data.action || '';
            document.getElementById('commissionLeadPS').value = data.leadPS || '';
            document.getElementById('commissionDeadline').value = data.deadline || '';
            document.getElementById('commissionStatus').value = data.status || '';
            
            // Update modal title and buttons for editing archived commission
            document.getElementById('commissionModalTitle').textContent = 'Edit Archived Commission';
            document.getElementById('commissionFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="updateArchivedCommission(${idx})">Update</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeCommissionModal()">Cancel</button>
            `;
            
            // Show the modal
            document.getElementById('commissionModal').style.display = 'block';
        }

        function updateArchivedCommission(idx) {
            const data = getCommissionFormData();
            
            // Minimal validation - only require action since that's the most essential field
            if (!data.action) {
                alert('Please fill in at least the Action field.');
                return;
            }
            
            // Keep the archived date and ensure status remains Complete
            const arr = loadData('commissionArchive');
            data.archivedDate = arr[idx].archivedDate;
            data.status = 'Complete'; // Keep archived status
            
            // Update the archived commission
            arr[idx] = data;
            saveData('commissionArchive', arr);
            renderCommissionArchive();
            closeCommissionModal();
        }

        function deleteArchivedCommission(idx) {
            if (!confirm('Are you sure you want to delete this archived commission?')) return;
            const arr = loadData('commissionArchive');
            arr.splice(idx, 1);
            saveData('commissionArchive', arr);
            renderCommissionArchive();
        }

        function editCommission(idx) {
            const arr = loadData('commissions');
            const data = arr[idx];
            
            document.getElementById('commissionAction').value = data.action || '';
            document.getElementById('commissionLeadPS').value = data.leadPS || '';
            document.getElementById('commissionDeadline').value = data.deadline || '';
            document.getElementById('commissionStatus').value = data.status || '';
            
            // Set first added timestamp
            window.currentFirstAdded = data.firstAdded || '';
            
            // Show first added timestamp if it exists
            const timestampDiv = document.getElementById('commissionFirstAddedTimestamp');
            if (data.firstAdded && timestampDiv) {
                timestampDiv.innerHTML = formatTimestampForDisplay(data.firstAdded);
                timestampDiv.style.display = 'block';
            } else if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            document.getElementById('commissionModalTitle').textContent = 'Edit Commission';
            document.getElementById('commissionModal').style.display = 'block';
            
            // Change button functionality for editing
            const addButton = document.querySelector('#commissionFormButtons .btn-add');
            addButton.textContent = 'Update';
            addButton.onclick = function() { updateCommission(idx); };
        }

        function updateCommission(idx) {
            const data = getCommissionFormData();
            
            if (!data.action.trim()) {
                alert('Please enter an action description');
                return;
            }
            
            if (!data.leadPS) {
                alert('Please select a lead PS');
                return;
            }
            
            if (!data.deadline) {
                alert('Please enter a deadline');
                return;
            }
            
            if (!data.status) {
                alert('Please select a status');
                return;
            }
            
            // If status is complete, move to archive and remove from commissions
            if (data.status === 'Complete') {
                const archiveData = { ...data, archivedDate: new Date().toISOString().split('T')[0] };
                const archiveArr = loadData('commissionArchive');
                archiveArr.push(archiveData);
                saveData('commissionArchive', archiveArr);
                
                const arr = loadData('commissions');
                arr.splice(idx, 1);
                saveData('commissions', arr);
                
                renderCommissions();
                renderCommissionArchive();
                closeCommissionModal();
                resetCommissionFormButtons();
                alert('Commission marked as complete and moved to archive');
                return;
            }
            
            const arr = loadData('commissions');
            arr[idx] = data;
            saveData('commissions', arr);
            renderCommissions();
            closeCommissionModal();
            resetCommissionFormButtons();
        }

        function deleteCommission(idx) {
            if (!confirm('Are you sure you want to delete this commission?')) return;
            const arr = loadData('commissions');
            arr.splice(idx, 1);
            saveData('commissions', arr);
            renderCommissions();
        }

        function resetCommissionFormButtons() {
            const addButton = document.querySelector('#commissionFormButtons .btn-add');
            addButton.textContent = 'Add';
            addButton.onclick = addCommission;
        }

        // --- Urgency Reason Modal Functions ---
        function openUrgencyReasonModal() {
            document.getElementById('urgencyReason').value = window.currentUrgencyReason || '';
            document.getElementById('urgencyReasonModal').style.display = 'block';
        }

        function closeUrgencyReasonModal() {
            document.getElementById('urgencyReasonModal').style.display = 'none';
        }

        function confirmUrgencyReason() {
            const reason = document.getElementById('urgencyReason').value.trim();
            if (!reason) {
                alert('Please provide a reason for the urgent priority.');
                return;
            }
            window.currentUrgencyReason = reason;
            
            // If we're editing from quick action, update the submission
            if (window.currentEditingIdx !== undefined) {
                const submissions = loadData('submissions');
                if (submissions[window.currentEditingIdx]) {
                    submissions[window.currentEditingIdx].urgency = 'Urgent';
                    submissions[window.currentEditingIdx].urgencyReason = reason;
                    saveData('submissions', submissions);
                    renderSubmissions();
                }
                window.currentEditingIdx = undefined;
            }
            
            closeUrgencyReasonModal();
        }

        function cancelUrgencyReason() {
            // Reset urgency back to previous value or empty
            const urgencySelect = document.getElementById('urgency');
            if (urgencySelect) {
                urgencySelect.value = window.previousUrgencyValue || '';
            }
            window.currentUrgencyReason = '';
            closeUrgencyReasonModal();
        }

        function handleUrgencyChange() {
            const urgencySelect = document.getElementById('urgency');
            if (!urgencySelect) return;
            
            const newValue = urgencySelect.value;
            
            if (newValue === 'Urgent') {
                // Store the previous value in case user cancels
                window.previousUrgencyValue = window.lastNonUrgentValue || '';
                openUrgencyReasonModal();
            } else {
                // Store non-urgent values for potential rollback
                window.lastNonUrgentValue = newValue;
                window.currentUrgencyReason = '';
            }
        }

        function openInviteModal() {
            document.getElementById('inviteForm').reset();
            document.querySelector('#inviteModal .modal-header h2').textContent = 'Add New Invite';
            document.querySelector('#inviteModal .form-buttons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="addInvite()">Add Invite</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeInviteModal()">Cancel</button>
            `;
            document.getElementById('inviteModal').style.display = 'block';
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
            document.getElementById('inviteForm').reset();
        }

        function openBriefingModal() {
            document.getElementById('briefingForm').reset();
            document.getElementById('briefingModalTitle').textContent = 'Add New Briefing';
            document.getElementById('briefingFormButtons').innerHTML = `
                <button type="button" class="form-btn btn-add" onclick="addBriefing()">Add</button>
                <button type="button" class="form-btn btn-submit-archive" onclick="submitBriefingToArchive()">Submit to Archive</button>
                <button type="button" class="form-btn btn-cancel" onclick="closeBriefingModal()">Cancel</button>
            `;
            
            // Hide timestamp for new items
            const timestampDiv = document.getElementById('briefingFirstAddedTimestamp');
            if (timestampDiv) {
                timestampDiv.style.display = 'none';
            }
            
            // Reset first added timestamp
            window.currentFirstAdded = '';
            
            document.getElementById('briefingModal').style.display = 'block';
        }

        function closeBriefingModal() {
            document.getElementById('briefingModal').style.display = 'none';
            document.getElementById('briefingForm').reset();
        }

        // --- Page State Management ---
        function saveCurrentPage(pageId) {
            try {
                localStorage.setItem('currentPage', pageId);
            } catch (error) {
                console.error('Error saving current page:', error);
            }
        }

        function loadCurrentPage() {
            try {
                return localStorage.getItem('currentPage') || 'mainDashboard';
            } catch (error) {
                console.error('Error loading current page:', error);
                return 'mainDashboard';
            }
        }

        function restoreCurrentPage() {
            const currentPage = loadCurrentPage();
            console.log('Restoring page:', currentPage);
            
            // Map page IDs to their show functions
            const pageMap = {
                'mainDashboard': showMainDashboard,
                'archiveBox': showArchiveBox,
                'invites': showInvites,
                'briefings': showBriefings,
                'inviteArchive': showInviteArchive,
                'briefingsArchive': showBriefingsArchive,
                'commissions': showCommissions,
                'commissionArchive': showCommissionArchive,
                'daybook': showDaybook,
                'dutyRota': showDutyRota,
                'editTeam': showEditTeam
            };
            
            // Call the appropriate show function, defaulting to main dashboard
            const showFunction = pageMap[currentPage] || showMainDashboard;
            showFunction();
        }

        // --- Navigation Functions ---
        function showMainDashboard() {
            hideAllSections();
            document.getElementById('mainDashboard').classList.remove('hidden');
            updateActiveNav('Box work');
            renderSubmissions();
            saveCurrentPage('mainDashboard');
        }

        function showArchiveBox() {
            hideAllSections();
            document.getElementById('archiveBox').classList.remove('hidden');
            updateActiveNav('Archive box');
            renderArchiveSubmissions();
            saveCurrentPage('archiveBox');
        }

        function showInvites() {
            hideAllSections();
            document.getElementById('invites').classList.remove('hidden');
            updateActiveNav('Invites');
            renderInvites();
            saveCurrentPage('invites');
        }

        function showBriefings() {
            hideAllSections();
            document.getElementById('briefings').classList.remove('hidden');
            updateActiveNav('Briefings');
            renderBriefings();
            saveCurrentPage('briefings');
        }

        function showInviteArchive() {
            hideAllSections();
            document.getElementById('inviteArchive').classList.remove('hidden');
            updateActiveNav('Archive invites');
            renderArchiveInvites();
            saveCurrentPage('inviteArchive');
        }

        function showBriefingsArchive() {
            hideAllSections();
            document.getElementById('briefingsArchive').classList.remove('hidden');
            updateActiveNav('Archive briefings');
            renderArchiveBriefings();
            saveCurrentPage('briefingsArchive');
        }

        function showCommissions() {
            hideAllSections();
            document.getElementById('commissions').classList.remove('hidden');
            updateActiveNav('Commissions');
            renderCommissions();
            saveCurrentPage('commissions');
        }

        function showCommissionArchive() {
            hideAllSections();
            document.getElementById('commissionArchive').classList.remove('hidden');
            updateActiveNav('Archive commissions');
            renderCommissionArchive();
            saveCurrentPage('commissionArchive');
        }

        function showDaybook() {
            hideAllSections();
            document.getElementById('daybook').classList.remove('hidden');
            updateActiveNav('Daybook');
            // Clear any previous results
            document.getElementById('daybookResults').style.display = 'none';
            document.getElementById('daybookDatePicker').value = '';
            saveCurrentPage('daybook');
        }

        function hideAllSections() {
            const sections = document.querySelectorAll('.main-content > div');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Clear search when switching pages
            if (currentSearchTerm) {
                clearSearch();
            }
            
            // Update search visibility
            setTimeout(updateSearchVisibility, 100);
        }

        function updateActiveNav(sectionName) {
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelectorAll('.sidebar a').forEach(link => {
                if (link.textContent.trim() === sectionName) {
                    link.classList.add('active');
                }
            });
        }

        // --- SpAd Comment Modal Functions ---
        let currentSpAdRow = null;

        function openSpAdCommentModal(button) {
            currentSpAdRow = button.closest('.grid-row');
            document.getElementById('spadCommentForm').reset();
            
            // Load any existing draft data
            const cells = currentSpAdRow.querySelectorAll('.grid-cell');
            const submissionTitle = cells[3].textContent;
            const leadPS = cells[0].textContent;
            
            const submissions = loadData('submissions');
            const submission = submissions.find(sub => 
                sub.submissionTitle === submissionTitle && sub.leadPS === leadPS
            );
            
            if (submission && (submission.spadDraftComments || submission.spadDraftBoxNote)) {
                document.getElementById('psComments').value = submission.spadDraftComments || '';
                document.getElementById('boxNote').value = submission.spadDraftBoxNote || '';
            }
            
            document.getElementById('spadCommentModal').style.display = 'block';
        }

        function closeSpAdCommentModal() {
            document.getElementById('spadCommentModal').style.display = 'none';
            document.getElementById('spadCommentForm').reset();
            currentSpAdRow = null;
        }

        function saveSpAdDraft() {
            const psComments = document.getElementById('psComments').value;
            const boxNote = document.getElementById('boxNote').value;
            
            if (!psComments.trim() && !boxNote) {
                alert('Please enter comments and/or confirm box note status before saving.');
                return;
            }
            
            const cells = currentSpAdRow.querySelectorAll('.grid-cell');
            const submissionTitle = cells[3].textContent;
            const leadPS = cells[0].textContent;
            
            // Update the submission in localStorage with draft data
            const submissions = loadData('submissions');
            const submissionIdx = submissions.findIndex(sub => 
                sub.submissionTitle === submissionTitle && sub.leadPS === leadPS
            );
            
            if (submissionIdx !== -1) {
                // Save as draft data (separate from final comments)
                submissions[submissionIdx].spadDraftComments = psComments;
                submissions[submissionIdx].spadDraftBoxNote = boxNote;
                saveData('submissions', submissions);
            }
            
            // Update all views to show draft indicator
            renderSubmissions();
            
            // Close modal and show success message
            closeSpAdCommentModal();
            alert('Draft comments saved successfully. You can continue editing later.');
        }

        function submitSpAdComment() {
            const psComments = document.getElementById('psComments').value;
            const boxNote = document.getElementById('boxNote').value;
            
            if (!psComments.trim() && !boxNote) {
                alert('Please enter comments and/or confirm box note status before submitting.');
                return;
            }
            
            const cells = currentSpAdRow.querySelectorAll('.grid-cell');
            const submissionTitle = cells[3].textContent;
            const leadPS = cells[0].textContent;
            
            // Update the SpAd comment date to today (stored only in data, not displayed in grid)
            const today = new Date().toISOString().split('T')[0];
            
            // Add comments to the comments field
            let existingComments = cells[7].textContent;
            let newComments = '';
            
            if (psComments.trim()) {
                newComments += `SpAd Comments: ${psComments}`;
            }
            if (boxNote) {
                if (newComments) newComments += ' | ';
                newComments += `Box Note Added: ${boxNote}`;
            }
            
            if (existingComments && existingComments.trim()) {
                cells[7].textContent = existingComments + ' | ' + newComments;
            } else {
                cells[7].textContent = newComments;
            }
            
            // Update status to "With PS"
            cells[5].textContent = 'With PS';
            
            // Update the submission in localStorage
            const submissions = loadData('submissions');
            const submissionIdx = submissions.findIndex(sub => 
                sub.submissionTitle === submissionTitle && sub.leadPS === leadPS
            );
            
            if (submissionIdx !== -1) {
                submissions[submissionIdx].dateSpAdComment = today;
                submissions[submissionIdx].comments = cells[7].textContent;
                submissions[submissionIdx].status = 'With PS';
                // Update working days calculation
                submissions[submissionIdx] = updateWorkingDaysForSubmission(submissions[submissionIdx]);
                saveData('submissions', submissions);
            }
            
            // Update all views
            renderSubmissions();
            
            closeSpAdCommentModal();
        }

        // --- Initialize the application ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Clear any corrupted data first
            try {
                const existingData = loadData('submissions');
                console.log('Existing submissions on load:', existingData);
            } catch (error) {
                console.error('Error loading existing submissions, clearing localStorage:', error);
                localStorage.removeItem('submissions');
            }
            
            console.log('About to render all sections');
            // Load initial data and render all sections
            renderSubmissions();
            renderArchiveSubmissions();
            renderInvites();
            renderArchiveInvites();
            renderBriefings();
            renderArchiveBriefings();
            console.log('All sections rendered');
            
            // Initialize status dropdowns with saved fields
            updateAllStatusDropdowns();
            
            // Apply SpAd settings on page load
            applySpAdSettings();
            
            // Restore the last visited page
            restoreCurrentPage();
            
            // Close modals when clicking outside
            window.onclick = function(event) {
                const itemModal = document.getElementById('itemModal');
                const inviteModal = document.getElementById('inviteModal');
                const briefingModal = document.getElementById('briefingModal');
                const spadCommentModal = document.getElementById('spadCommentModal');
                const commissionModal = document.getElementById('commissionModal');
                
                if (event.target === itemModal) {
                    closeModal();
                }
                if (event.target === inviteModal) {
                    closeInviteModal();
                }
                if (event.target === briefingModal) {
                    closeBriefingModal();
                }
                if (event.target === spadCommentModal) {
                    closeSpAdCommentModal();
                }
                if (event.target === commissionModal) {
                    closeCommissionModal();
                }
            };

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Only activate shortcuts if no modal is open and not typing in an input
                if (document.querySelector('.modal[style*="block"]') || 
                    ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
                    return;
                }
                
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'n':
                            e.preventDefault();
                            openModal();
                            break;
                        case 'f':
                            e.preventDefault();
                            document.getElementById('searchInput').focus();
                            break;
                    }
                } else {
                    switch(e.key.toLowerCase()) {
                        case 'u':
                            e.preventDefault();
                            filterByUrgency('Urgent');
                            break;
                        case 's':
                            e.preventDefault();
                            filterByStatus('With SpAds');
                            break;
                        case 'l':
                            e.preventDefault();
                            filterByStatus('Ready for the box');
                            break;
                        case 'escape':
                            clearAllFilters();
                            break;
                    }
                }
            });
        });

        function updateWorkingDaysDisplay() {
            const dateSubmittedSpads = document.getElementById('dateSubmittedSpads').value;
            const dateSpAdComment = document.getElementById('dateSpAdComment').value;
            const workingDaysField = document.getElementById('workingDays');
            
            if (dateSubmittedSpads) {
                const workingDays = calculateWorkingDays(dateSubmittedSpads, dateSpAdComment);
                workingDaysField.value = workingDays;
            } else {
                workingDaysField.value = '';
            }
        }
        // --- Team Management Functions ---
        
        // Default team members
        const defaultPrivateSecretaries = [
            'Ben', 'James', 'Charlotte', 'Sukh', 'Katie', 'Jess', 'Louisa', 
            'Jo', 'Simran', 'Rachel', 'Hugh', 'Marisa', 'Gemma'
        ];
        
        const defaultSpAds = [
            'Sophie', 'Tash', 'Poppy', 'Josh'
        ];
        
        function loadTeamData() {
            // Migration: Convert old string arrays to new object arrays if needed
            migrateTeamDataStructure();
            
            const privateSecretaries = loadData('privateSecretaries') || [];
            const spAds = loadData('spads') || [];
            return { privateSecretaries, spAds };
        }
        
        function migrateTeamDataStructure() {
            // Migrate privateSecretaries from string array to object array
            const oldPS = JSON.parse(localStorage.getItem('privateSecretaries') || '[]');
            if (oldPS.length > 0 && typeof oldPS[0] === 'string') {
                const newPS = oldPS.map(name => ({ name: name, seniority: 'junior' }));
                saveData('privateSecretaries', newPS);
                localStorage.removeItem('privateSecretaries'); // Remove old format
            }
            
            // Migrate spAds from string array to object array  
            const oldSpAds = JSON.parse(localStorage.getItem('spAds') || '[]');
            if (oldSpAds.length > 0 && typeof oldSpAds[0] === 'string') {
                const newSpAds = oldSpAds.map(name => ({ name: name }));
                saveData('spads', newSpAds);
                localStorage.removeItem('spAds'); // Remove old format
            }
        }
        
        function saveTeamData(privateSecretaries, spAds) {
            saveData('privateSecretaries', privateSecretaries);
            saveData('spads', spAds);
        }
        
        function showEditTeam() {
            hideAllSections();
            document.getElementById('editTeam').classList.remove('hidden');
            updateActiveNav('Edit team');
            renderTeamLists();
            renderStatusFieldsList();
            loadSpAdSettingsUI();
            saveCurrentPage('editTeam');
        }
        
        function renderTeamLists() {
            const privateSecretaries = loadData('privateSecretaries') || [];
            const spAds = loadData('spads') || [];
            
            // Render Private Secretaries
            const psContainer = document.getElementById('privateSecretariesList');
            psContainer.innerHTML = '';
            privateSecretaries.forEach((ps, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <div>
                        <span class="team-member-name">${ps.name}</span>
                        <span style="font-size: 12px; color: #666; margin-left: 8px;">(${ps.seniority})</span>
                        <br>
                        <select onchange="updatePSSeniority(${index}, this.value)" style="font-size: 12px; margin-top: 4px;">
                            <option value="junior" ${ps.seniority === 'junior' ? 'selected' : ''}>Junior</option>
                            <option value="senior" ${ps.seniority === 'senior' ? 'selected' : ''}>Senior</option>
                        </select>
                    </div>
                    <button class="remove-member-btn" onclick="removePrivateSecretary(${index})">
                        Remove
                    </button>
                `;
                psContainer.appendChild(memberDiv);
            });
            
            // Render SpAds
            const spAdsContainer = document.getElementById('spAdsList');
            spAdsContainer.innerHTML = '';
            spAds.forEach((spad, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <span class="team-member-name">${spad.name}</span>
                    <button class="remove-member-btn" onclick="removeSpAd(${index})">
                        Remove
                    </button>
                `;
                spAdsContainer.appendChild(memberDiv);
            });
            
            // Reapply current search filter if any
            reapplyCurrentSearch();
        }
        
        function updatePSSeniority(index, newSeniority) {
            const privateSecretaries = loadData('privateSecretaries') || [];
            if (privateSecretaries[index]) {
                privateSecretaries[index].seniority = newSeniority;
                saveData('privateSecretaries', privateSecretaries);
            }
        }
        
        function addPrivateSecretary() {
            const nameInput = document.getElementById('newPSName');
            const senioritySelect = document.getElementById('newPSSeniority');
            const name = nameInput.value.trim();
            const seniority = senioritySelect.value;
            
            if (!name) {
                alert('Please enter a name for the Private Secretary.');
                return;
            }
            
            const privateSecretaries = loadData('privateSecretaries') || [];
            const spAds = loadData('spads') || [];
            
            if (privateSecretaries.some(ps => ps.name === name)) {
                alert('This Private Secretary already exists.');
                return;
            }
            
            privateSecretaries.push({ name: name, seniority: seniority });
            saveData('privateSecretaries', privateSecretaries);
            nameInput.value = '';
            renderTeamLists();
        }
        
        function addSpAd() {
            const nameInput = document.getElementById('newSpAdName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a name for the SpAd.');
                return;
            }
            
            const spAds = loadData('spads') || [];
            
            if (spAds.some(spad => spad.name === name)) {
                alert('This SpAd already exists.');
                return;
            }
            
            spAds.push({ name: name });
            saveData('spads', spAds);
            nameInput.value = '';
            renderTeamLists();
        }
        
        function removePrivateSecretary(index) {
            const privateSecretaries = loadData('privateSecretaries') || [];
            const psToRemove = privateSecretaries[index];
            
            if (confirm(`Are you sure you want to remove ${psToRemove ? psToRemove.name : 'this person'}?`)) {
                privateSecretaries.splice(index, 1);
                saveData('privateSecretaries', privateSecretaries);
                renderTeamLists();
            }
        }
        
        function removeSpAd(index) {
            const spAds = loadData('spads') || [];
            const spadToRemove = spAds[index];
            
            if (confirm(`Are you sure you want to remove ${spadToRemove ? spadToRemove.name : 'this person'}?`)) {
                spAds.splice(index, 1);
                saveData('spads', spAds);
                renderTeamLists();
            }
        }
        
        function saveTeamChanges() {
            updateAllDropdowns();
            updateAllStatusDropdowns();
            alert('Settings saved successfully!');
        }

        // --- Status Fields Management ---
        function getDefaultStatusFields() {
            return [
                "With Perm Sec/DGs",
                "With junior minister(s)", 
                "With SpAds",
                "With officials",
                "With PS",
                "Ready for the box",
                "Readout"
            ];
        }

        function loadStatusFields() {
            const stored = localStorage.getItem('statusFields');
            if (stored) {
                return JSON.parse(stored);
            }
            // Return default status options
            return getDefaultStatusFields();
        }

        function saveStatusFields(statusFields) {
            localStorage.setItem('statusFields', JSON.stringify(statusFields));
        }

        function renderStatusFieldsList() {
            const statusFields = loadStatusFields();
            const container = document.getElementById('statusFieldsList');
            if (!container) return;
            
            container.innerHTML = '';
            statusFields.forEach((status, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <span class="team-member-name">${status}</span>
                    <button class="remove-member-btn" onclick="removeStatusField(${index})" 
                            ${status === 'Readout' ? 'disabled title="Readout status cannot be removed as it\'s required for archiving"' : ''}>
                        Remove
                    </button>
                `;
                container.appendChild(memberDiv);
            });
        }

        function addStatusField() {
            const nameInput = document.getElementById('newStatusField');
            const status = nameInput.value.trim();
            
            if (!status) {
                alert('Please enter a status option.');
                return;
            }
            
            const statusFields = loadStatusFields();
            
            if (statusFields.includes(status)) {
                alert('This status option already exists.');
                return;
            }
            
            statusFields.push(status);
            saveStatusFields(statusFields);
            nameInput.value = '';
            renderStatusFieldsList();
            updateAllStatusDropdowns();
        }

        function removeStatusField(index) {
            const statusFields = loadStatusFields();
            const statusToRemove = statusFields[index];
            
            // Prevent removal of Readout status as it's required for archiving
            if (statusToRemove === 'Readout') {
                alert('Cannot remove "Readout" status as it is required for the archiving process.');
                return;
            }
            
            if (confirm(`Are you sure you want to remove "${statusToRemove}"?\n\nNote: Existing items with this status will keep their status, but you won't be able to select this status for new items.`)) {
                statusFields.splice(index, 1);
                saveStatusFields(statusFields);
                renderStatusFieldsList();
                updateAllStatusDropdowns();
            }
        }

        function resetStatusFieldsToDefault() {
            if (confirm('Are you sure you want to reset to the default status options?\n\nThis will remove any custom status options you\'ve added and restore the original status list.')) {
                // Get the default status options
                const defaultStatuses = getDefaultStatusFields();
                
                // Save the default statuses
                saveStatusFields(defaultStatuses);
                
                // Update the UI
                renderStatusFieldsList();
                updateAllStatusDropdowns();
                
                alert('Status options have been reset to defaults successfully!');
            }
        }

        function updateAllStatusDropdowns() {
            const statusFields = loadStatusFields();
            const spAdSettings = loadSpAdSettings();
            const statusDropdowns = ['status'];
            
            statusDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select status...</option>';
                    
                    statusFields.forEach(status => {
                        // Skip SpAd-related statuses if SpAd review is disabled
                        if (!spAdSettings.enableSpAdReview && status === 'With SpAds') {
                            return;
                        }
                        
                        const option = document.createElement('option');
                        option.value = status;
                        option.textContent = status;
                        dropdown.appendChild(option);
                    });
                    
                    // Restore selected value if it still exists and is allowed
                    const allowedStatuses = statusFields.filter(status => 
                        spAdSettings.enableSpAdReview || status !== 'With SpAds'
                    );
                    if (allowedStatuses.includes(currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
            
            // Also update commission status dropdown with predefined commission statuses
            const commissionDropdown = document.getElementById('commissionStatus');
            if (commissionDropdown) {
                const currentValue = commissionDropdown.value;
                const commissionStatuses = [
                    "With PS",
                    "Commissioned the department", 
                    "With SpAds",
                    "Complete"
                ];
                
                commissionDropdown.innerHTML = '<option value="">Select status...</option>';
                commissionStatuses.forEach(status => {
                    // Skip SpAd-related statuses if SpAd review is disabled
                    if (!spAdSettings.enableSpAdReview && status === 'With SpAds') {
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    commissionDropdown.appendChild(option);
                });
                
                // Restore selected value if it still exists and is allowed
                const allowedCommissionStatuses = commissionStatuses.filter(status => 
                    spAdSettings.enableSpAdReview || status !== 'With SpAds'
                );
                if (allowedCommissionStatuses.includes(currentValue)) {
                    commissionDropdown.value = currentValue;
                }
            }
        }

        // --- SpAd Review Settings ---
        function getDefaultSpAdSettings() {
            return {
                enableSpAdReview: true,
                showSpAdComments: true,
                showSpAdDaysCounter: true,
                autoSubmitToSpAds: true
            };
        }

        function loadSpAdSettings() {
            const stored = localStorage.getItem('spAdSettings');
            if (stored) {
                return JSON.parse(stored);
            }
            // Return default settings
            return getDefaultSpAdSettings();
        }

        function saveSpAdSettings(settings) {
            localStorage.setItem('spAdSettings', JSON.stringify(settings));
        }

        function loadSpAdSettingsUI() {
            const settings = loadSpAdSettings();
            
            document.getElementById('enableSpAdReview').checked = settings.enableSpAdReview;
            document.getElementById('showSpAdComments').checked = settings.showSpAdComments;
            document.getElementById('showSpAdDaysCounter').checked = settings.showSpAdDaysCounter;
            document.getElementById('autoSubmitToSpAds').checked = settings.autoSubmitToSpAds;
            
            // Show/hide SpAd options based on enableSpAdReview
            const spadOptions = document.getElementById('spadReviewOptions');
            if (spadOptions) {
                spadOptions.style.display = settings.enableSpAdReview ? 'block' : 'none';
            }
        }

        function toggleSpAdReview() {
            const enableSpAdReview = document.getElementById('enableSpAdReview').checked;
            const settings = loadSpAdSettings();
            settings.enableSpAdReview = enableSpAdReview;
            saveSpAdSettings(settings);
            
            // Automatically manage "With SpAds" status option
            const statusFields = loadStatusFields();
            const withSpAdsIndex = statusFields.indexOf('With SpAds');
            
            if (!enableSpAdReview && withSpAdsIndex !== -1) {
                // Remove "With SpAds" from status options when SpAd review is disabled
                statusFields.splice(withSpAdsIndex, 1);
                saveStatusFields(statusFields);
                renderStatusFieldsList();
            } else if (enableSpAdReview && withSpAdsIndex === -1) {
                // Add "With SpAds" back to status options when SpAd review is enabled
                // Insert it after "With junior minister(s)" to maintain the original order
                const juniorMinisterIndex = statusFields.indexOf('With junior minister(s)');
                const insertIndex = juniorMinisterIndex !== -1 ? juniorMinisterIndex + 1 : 2;
                statusFields.splice(insertIndex, 0, 'With SpAds');
                saveStatusFields(statusFields);
                renderStatusFieldsList();
            }
            
            // Show/hide SpAd options
            const spadOptions = document.getElementById('spadReviewOptions');
            if (spadOptions) {
                spadOptions.style.display = enableSpAdReview ? 'block' : 'none';
            }
            
            // Apply changes to UI elements
            applySpAdSettings();
            
            // Update status dropdowns to include/exclude SpAd-related statuses
            updateAllStatusDropdowns();
        }

        function updateSpAdSettings() {
            const settings = loadSpAdSettings();
            settings.showSpAdComments = document.getElementById('showSpAdComments').checked;
            settings.showSpAdDaysCounter = document.getElementById('showSpAdDaysCounter').checked;
            settings.autoSubmitToSpAds = document.getElementById('autoSubmitToSpAds').checked;
            saveSpAdSettings(settings);
            
            // Apply changes to UI elements
            applySpAdSettings();
            
            // Update status dropdowns in case SpAd-related options changed
            updateAllStatusDropdowns();
        }

        function applySpAdSettings() {
            const settings = loadSpAdSettings();
            
            // Apply visibility based on settings
            if (!settings.enableSpAdReview) {
                // Hide all SpAd-related elements when SpAd review is disabled
                
                // 1. Hide SpAd form fields and labels
                const spAdFormFields = document.querySelectorAll('[id*="leadSpAd"], [for*="leadSpAd"]');
                spAdFormFields.forEach(el => el.style.display = 'none');
                
                // 2. Hide SpAd date fields
                const spAdDateFields = document.querySelectorAll(
                    '[id="dateSubmittedSpads"], [for="dateSubmittedSpads"], ' +
                    '[id="workingDays"], [for="workingDays"], ' +
                    '[id="dateSpAdComment"], [for="dateSpAdComment"]'
                );
                spAdDateFields.forEach(el => {
                    if (el.closest('.form-group')) {
                        el.closest('.form-group').style.display = 'none';
                    } else {
                        el.style.display = 'none';
                    }
                });
                
                // 3. Hide dashboard summary card for "With SpAds"
                const spadSummaryCard = document.querySelector('.status-card[onclick*="With SpAds"]');
                if (spadSummaryCard) {
                    spadSummaryCard.style.display = 'none';
                }
                
                // 4. Hide "With SpAds" filter button
                const spadFilterButton = document.querySelector('.filter-btn[onclick*="With SpAds"]');
                if (spadFilterButton) {
                    spadFilterButton.style.display = 'none';
                }
                
                // 5. Hide SpAd-related grid columns (Lead SpAd, Days with SpAds)
                // Hide header cells
                const gridHeaders = document.querySelectorAll('.grid-header > div');
                gridHeaders.forEach((header, index) => {
                    if (header.textContent.includes('Lead SpAd') || header.textContent.includes('Days with SpAds')) {
                        header.style.display = 'none';
                        
                        // Also hide corresponding data cells in all grid rows
                        const allGrids = document.querySelectorAll('.submissions-grid');
                        allGrids.forEach(grid => {
                            const rows = grid.querySelectorAll('.grid-row');
                            rows.forEach(row => {
                                const cells = row.querySelectorAll('.grid-cell');
                                if (cells[index]) {
                                    cells[index].style.display = 'none';
                                }
                            });
                        });
                    }
                });
                
                // 6. Hide SpAd comment fields and buttons
                const spAdCommentElements = document.querySelectorAll('[id*="spAdComments"], [for*="spAdComments"]');
                spAdCommentElements.forEach(el => el.style.display = 'none');
                
                // 7. Hide submit to SpAds buttons
                const submitSpAdButtons = document.querySelectorAll('button[onclick*="submitToSpAds"]');
                submitSpAdButtons.forEach(el => el.style.display = 'none');
                
                // 8. Hide SpAd comment modal
                const spadCommentModal = document.getElementById('spadCommentModal');
                if (spadCommentModal) {
                    spadCommentModal.style.display = 'none';
                }
                
                // 9. Update grid column layout to account for hidden columns
                const mainGridHeaders = document.querySelectorAll('.submissions-grid .grid-header');
                mainGridHeaders.forEach(gridHeader => {
                    // Adjust grid template columns by removing SpAd-related columns
                    const currentColumns = gridHeader.style.gridTemplateColumns || '';
                    if (!currentColumns) {
                        // Set a modified grid template that excludes SpAd columns
                        gridHeader.style.gridTemplateColumns = '110px 100px 150px 140px 120px 160px 160px minmax(120px, 1fr)';
                    }
                });
                
            } else {
                // Show SpAd-related elements and apply individual settings
                
                // 1. Show SpAd form fields
                const spAdFormFields = document.querySelectorAll('[id*="leadSpAd"], [for*="leadSpAd"]');
                spAdFormFields.forEach(el => el.style.display = '');
                
                // 2. Show/hide SpAd date fields based on individual settings
                const spAdDateFields = document.querySelectorAll(
                    '[id="dateSubmittedSpads"], [for="dateSubmittedSpads"], ' +
                    '[id="workingDays"], [for="workingDays"], ' +
                    '[id="dateSpAdComment"], [for="dateSpAdComment"]'
                );
                spAdDateFields.forEach(el => {
                    const isVisible = settings.showSpAdDaysCounter;
                    if (el.closest('.form-group')) {
                        el.closest('.form-group').style.display = isVisible ? '' : 'none';
                    } else {
                        el.style.display = isVisible ? '' : 'none';
                    }
                });
                
                // 3. Show dashboard summary card
                const spadSummaryCard = document.querySelector('.status-card[onclick*="With SpAds"]');
                if (spadSummaryCard) {
                    spadSummaryCard.style.display = '';
                }
                
                // 4. Show "With SpAds" filter button
                const spadFilterButton = document.querySelector('.filter-btn[onclick*="With SpAds"]');
                if (spadFilterButton) {
                    spadFilterButton.style.display = '';
                }
                
                // 5. Show/hide SpAd-related grid columns based on settings
                const gridHeaders = document.querySelectorAll('.grid-header > div');
                gridHeaders.forEach((header, index) => {
                    if (header.textContent.includes('Lead SpAd')) {
                        header.style.display = '';
                        
                        // Show corresponding data cells in all grid rows
                        const allGrids = document.querySelectorAll('.submissions-grid');
                        allGrids.forEach(grid => {
                            const rows = grid.querySelectorAll('.grid-row');
                            rows.forEach(row => {
                                const cells = row.querySelectorAll('.grid-cell');
                                if (cells[index]) {
                                    cells[index].style.display = '';
                                }
                            });
                        });
                    } else if (header.textContent.includes('Days with SpAds')) {
                        const isVisible = settings.showSpAdDaysCounter;
                        header.style.display = isVisible ? '' : 'none';
                        
                        // Show/hide corresponding data cells in all grid rows
                        const allGrids = document.querySelectorAll('.submissions-grid');
                        allGrids.forEach(grid => {
                            const rows = grid.querySelectorAll('.grid-row');
                            rows.forEach(row => {
                                const cells = row.querySelectorAll('.grid-cell');
                                if (cells[index]) {
                                    cells[index].style.display = isVisible ? '' : 'none';
                                }
                            });
                        });
                    }
                });
                
                // 6. Show/hide SpAd comment fields based on settings
                const spAdCommentElements = document.querySelectorAll('[id*="spAdComments"], [for*="spAdComments"]');
                spAdCommentElements.forEach(el => {
                    el.style.display = settings.showSpAdComments ? '' : 'none';
                });
                
                // 7. Show/hide submit to SpAds buttons based on settings
                const submitSpAdButtons = document.querySelectorAll('button[onclick*="submitToSpAds"]');
                submitSpAdButtons.forEach(el => {
                    el.style.display = settings.autoSubmitToSpAds ? '' : 'none';
                });
                
                // 8. Restore normal grid column layout
                const mainGridHeaders = document.querySelectorAll('.submissions-grid .grid-header');
                mainGridHeaders.forEach(gridHeader => {
                    // Reset to original grid template
                    gridHeader.style.gridTemplateColumns = '';
                });
            }
        }

        function resetSpAdSettingsToDefault() {
            if (confirm('Are you sure you want to reset SpAd review settings to defaults?\n\nThis will enable all SpAd review functionality and restore the original settings.')) {
                // Get the default SpAd settings
                const defaultSettings = getDefaultSpAdSettings();
                
                // Save the default settings
                saveSpAdSettings(defaultSettings);
                
                // Update the UI
                loadSpAdSettingsUI();
                applySpAdSettings();
                
                alert('SpAd review settings have been reset to defaults successfully!');
            }
        }
        
        function updateAllDropdowns() {
            const privateSecretaries = loadData('privateSecretaries') || [];
            const spAds = loadData('spads') || [];
            
            // Update all Private Secretary dropdowns
            const psDropdowns = [
                'leadPS', 'briefingLeadPS', 'inviteLeadPS'
            ];
            
            psDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select...</option>';
                    
                    privateSecretaries.forEach(ps => {
                        const option = document.createElement('option');
                        option.value = ps.name;
                        option.textContent = ps.name;
                        dropdown.appendChild(option);
                    });
                    
                    // Restore selected value if it still exists
                    if (privateSecretaries.some(ps => ps.name === currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
            
            // Update SpAd dropdowns
            const spAdDropdowns = [
                'leadSpAd', 'briefingLeadSpAd'
            ];
            
            spAdDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select...</option>';
                    
                    spAds.forEach(spad => {
                        const option = document.createElement('option');
                        option.value = spad.name;
                        option.textContent = spad.name;
                        dropdown.appendChild(option);
                    });
                    
                    // Add "No SpAd review" option
                    const noSpAdOption = document.createElement('option');
                    noSpAdOption.value = 'No SpAd review';
                    noSpAdOption.textContent = 'No SpAd review';
                    dropdown.appendChild(noSpAdOption);
                    
                    // Restore selected value if it still exists
                    if (spAds.some(spad => spad.name === currentValue) || currentValue === 'No SpAd review') {
                        dropdown.value = currentValue;
                    }
                }
            });
            
            // Update user select dropdown in personal dashboard
            const userSelect = document.getElementById('userSelect');
            if (userSelect) {
                const currentValue = userSelect.value;
                userSelect.innerHTML = '<option value="">Select your name...</option>';
                
                // Add Private Secretaries optgroup
                const psOptgroup = document.createElement('optgroup');
                psOptgroup.label = 'Private Secretaries';
                privateSecretaries.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    psOptgroup.appendChild(option);
                });
                userSelect.appendChild(psOptgroup);
                
                // Add SpAds optgroup
                const spAdOptgroup = document.createElement('optgroup');
                spAdOptgroup.label = 'SpAds';
                spAds.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    spAdOptgroup.appendChild(option);
                });
                userSelect.appendChild(spAdOptgroup);
                
                // Restore selected value if it still exists
                if (privateSecretaries.includes(currentValue) || spAds.includes(currentValue)) {
                    userSelect.value = currentValue;
                }
            }
        }
        
        // --- Search Functionality ---
        let currentSearchTerm = '';
        
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    currentSearchTerm = searchTerm;
                    
                    if (searchTerm) {
                        searchClear.classList.add('visible');
                    } else {
                        searchClear.classList.remove('visible');
                    }
                    
                    // Perform search on current page
                    performSearch(searchTerm);
                });
                
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        clearSearch();
                    }
                });
            }
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            if (searchInput) {
                searchInput.value = '';
                currentSearchTerm = '';
                searchClear.classList.remove('visible');
                performSearch('');
            }
        }
        
        function performSearch(searchTerm) {
            // Get currently active page
            const activeSection = document.querySelector('.main-content > div:not(.hidden)');
            if (!activeSection) return;
            
            const sectionId = activeSection.id;
            
            // Apply search based on current section
            switch(sectionId) {
                case 'mainDashboard':
                    searchInGrid(searchTerm, '#mainDashboard .grid-row');
                    break;
                case 'personalDashboard':
                    if (!document.getElementById('userPrompt').classList.contains('hidden')) {
                        // User prompt is showing, no search needed
                        return;
                    }
                    searchInGrid(searchTerm, '#personalGridRows .grid-row');
                    break;
                case 'spadBox':
                    searchInGrid(searchTerm, '#spadGridRows .grid-row');
                    break;
                case 'lcBox':
                    searchInGrid(searchTerm, '#lcGridRows .grid-row');
                    break;
                case 'archiveBox':
                    searchInGrid(searchTerm, '#archiveGridRows .grid-row');
                    break;
                case 'invites':
                    searchInGrid(searchTerm, '#inviteGridRows .grid-row');
                    break;
                case 'inviteArchive':
                    searchInGrid(searchTerm, '#inviteArchiveGridRows .grid-row');
                    break;
                case 'briefings':
                    searchInGrid(searchTerm, '#briefingGridRows .grid-row');
                    break;
                case 'briefingsArchive':
                    searchInGrid(searchTerm, '#briefingsArchiveGridRows .grid-row');
                    break;
                case 'commissions':
                    searchInGrid(searchTerm, '#commissionGridRows .grid-row');
                    break;
                case 'commissionArchive':
                    searchInGrid(searchTerm, '#commissionArchiveGridRows .grid-row');
                    break;
                case 'daybook':
                    searchInGrid(searchTerm, '#daybookGridRows .grid-row');
                    break;
                case 'dutyRota':
                    searchInDutyRota(searchTerm);
                    break;
                case 'editTeam':
                    searchInTeam(searchTerm);
                    break;
                default:
                    break;
            }
        }
        
        function reapplyCurrentSearch() {
            // Reapply search filter if active
            if (currentSearchTerm) {
                performSearch(currentSearchTerm);
            }
            
            // Reapply current filter if active
            if (currentFilter) {
                switch (currentFilter.type) {
                    case 'status':
                        filterByStatus(currentFilter.value);
                        break;
                    case 'urgency':
                        filterByUrgency(currentFilter.value);
                        break;
                    case 'overdue':
                        showOverdueItems();
                        break;
                    case 'user':
                        filterByCurrentUser();
                        break;
                }
            } else {
                // If no filter is active, update buttons to show "All Items" as active
                updateFilterButtons('all');
            }
        }
        
        function searchInGrid(searchTerm, selector) {
            const rows = document.querySelectorAll(selector);
            
            rows.forEach(row => {
                if (!searchTerm) {
                    row.style.display = '';
                    return;
                }
                
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function searchInTeam(searchTerm) {
            const psMembers = document.querySelectorAll('#privateSecretariesList .team-member');
            const spadMembers = document.querySelectorAll('#spAdsList .team-member');
            
            [...psMembers, ...spadMembers].forEach(member => {
                if (!searchTerm) {
                    member.style.display = '';
                    return;
                }
                
                const text = member.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    member.style.display = '';
                } else {
                    member.style.display = 'none';
                }
            });
        }
        
        function searchInDutyRota(searchTerm) {
            const rotaRows = document.querySelectorAll('#rotaContainer .grid-row');
            const unavailableItems = document.querySelectorAll('#unavailableDatesList .team-member');
            
            [...rotaRows, ...unavailableItems].forEach(item => {
                if (!searchTerm) {
                    item.style.display = '';
                    return;
                }
                
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function updateSearchVisibility() {
            const searchContainer = document.getElementById('searchContainer');
            const activeSection = document.querySelector('.main-content > div:not(.hidden)');
            
            if (!searchContainer || !activeSection) return;
            
            const sectionId = activeSection.id;
            
            // Show search on all pages except when user prompt is visible in personal dashboard
            if (sectionId === 'personalDashboard' && !document.getElementById('userPrompt').classList.contains('hidden')) {
                searchContainer.classList.add('hidden');
            } else {
                searchContainer.classList.remove('hidden');
            }
        }
        
        // --- Update existing navigation functions to handle search ---
        
        // Initialize dropdowns on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateAllDropdowns();
            initializeSearch();
            updateSearchVisibility();
        });

        // --- Daybook Functions ---
        function filterBriefingsByDate() {
            const selectedDate = document.getElementById('daybookDatePicker').value;
            
            if (!selectedDate) {
                alert('Please select a date to view briefings.');
                return;
            }
            
            // Load briefings data
            const briefings = loadData('briefings');
            const archiveBriefings = loadData('archiveBriefings') || [];
            const allBriefings = [...briefings, ...archiveBriefings];
            
            // Filter briefings by selected date
            const filteredBriefings = allBriefings.filter(briefing => {
                return briefing.date === selectedDate;
            });
            
            // Sort by time (earliest first)
            filteredBriefings.sort((a, b) => {
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                return timeA.localeCompare(timeB);
            });
            
            // Display results
            displayDaybookResults(selectedDate, filteredBriefings);
        }
        
        function displayDaybookResults(selectedDate, briefings) {
            const resultsContainer = document.getElementById('daybookResults');
            const dateHeader = document.getElementById('daybookDateHeader');
            const gridRows = document.getElementById('daybookGridRows');
            const noResultsDiv = document.getElementById('daybookNoResults');
            
            // Show results container
            resultsContainer.style.display = 'block';
            
            // Format and display the selected date
            const formattedDate = formatDateForDisplay(selectedDate);
            dateHeader.textContent = `Briefings for ${formattedDate}`;
            
            // Clear previous results
            gridRows.innerHTML = '';
            
            if (briefings.length === 0) {
                // Show no results message
                noResultsDiv.style.display = 'block';
                document.querySelector('.submissions-grid').style.display = 'none';
            } else {
                // Hide no results message and show grid
                noResultsDiv.style.display = 'none';
                document.querySelector('#daybookResults .submissions-grid').style.display = 'block';
                
                // Populate grid with briefings
                briefings.forEach((briefing) => {
                    const row = document.createElement('div');
                    row.className = 'grid-row';
                    row.innerHTML = `
                        <div class="grid-cell">${briefing.leadPS || ''}</div>
                        <div class="grid-cell">${briefing.leadSpAd || ''}</div>
                        <div class="grid-cell">${briefing.time || ''}</div>
                        <div class="grid-cell">${briefing.title || ''}</div>
                        <div class="grid-cell">${formatDateForDisplay(briefing.commissionDeadline)}</div>
                        <div class="grid-cell">${formatUrlForDisplay(briefing.sharepointLink)}</div>
                        <div class="grid-cell">${briefing.psComments || ''}</div>
                        <div class="grid-cell">${briefing.spadComments || ''}</div>
                    `;
                    gridRows.appendChild(row);
                });
            }
        }
        
        function clearDaybookFilter() {
            document.getElementById('daybookDatePicker').value = '';
            document.getElementById('daybookResults').style.display = 'none';
        }

        // --- Duty Rota Functions ---
        
        function showDutyRota() {
            document.querySelectorAll('.main-content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById('dutyRota').classList.remove('hidden');
            
            // Update active state
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
            
            // Load and display rota
            loadDutyRota();
            loadUnavailableDates();
            populateOverrideDropdowns();
            saveCurrentPage('dutyRota');
        }
        
        function loadDutyRota() {
            const rota = loadData('dutyRota') || [];
            const container = document.getElementById('rotaContainer');
            
            if (rota.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>No duty rota generated yet.</p>
                        <p>Click "Generate New Rota" to create the duty schedule.</p>
                    </div>
                `;
                return;
            }
            
            // Create rota display
            container.innerHTML = `
                <div class="grid-header" style="grid-template-columns: 200px 150px 150px 150px 100px;">
                    <div>Shift Period</div>
                    <div>Junior PS (Duty)</div>
                    <div>Senior PS (Backup)</div>
                    <div>SpAd (Duty)</div>
                    <div>Actions</div>
                </div>
                ${rota.map((shift, index) => `
                    <div class="grid-row" style="grid-template-columns: 200px 150px 150px 150px 100px;">
                        <div class="grid-cell duty-shift-cell">
                            <strong>${shift.type === 'weekday' ? 'Mon-Thu' : 'Fri-Sun'}</strong><br>
                            <span style="font-size: 10px; color: #666;">
                                ${formatDateForDisplay(shift.startDate)} - ${formatDateForDisplay(shift.endDate)}
                            </span>
                        </div>
                        <div class="grid-cell">${shift.juniorPS}</div>
                        <div class="grid-cell">${shift.seniorPS}</div>
                        <div class="grid-cell">${shift.spad}</div>
                        <div class="grid-cell">
                            <button class="action-btn edit-btn" onclick="editShift(${index})" data-tooltip="Edit this shift">✏️</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        function generateRota() {
            const privateSecretaries = loadData('privateSecretaries') || [];
            const spads = loadData('spads') || [];
            const unavailableDates = loadData('unavailableDates') || [];
            
            const juniorPS = privateSecretaries.filter(ps => ps.seniority === 'junior');
            const seniorPS = privateSecretaries.filter(ps => ps.seniority === 'senior');
            
            if (juniorPS.length === 0 || seniorPS.length === 0 || spads.length === 0) {
                alert('Please ensure you have at least one junior PS, one senior PS, and one SpAd configured in Settings.');
                return;
            }
            
            // Generate 8 weeks of shifts (starting from next Monday)
            const rota = [];
            const startDate = getNextMonday();
            
            // Track assignments for fair distribution and consecutive shift prevention
            const juniorPSCounter = {};
            const seniorPSCounter = {};
            const spadCounter = {};
            
            // Track last assignment dates for spacing
            const juniorPSLastAssignment = {};
            const seniorPSLastAssignment = {};
            const spadLastAssignment = {};
            
            juniorPS.forEach(ps => {
                juniorPSCounter[ps.name] = { weekday: 0, weekend: 0 };
                juniorPSLastAssignment[ps.name] = null;
            });
            seniorPS.forEach(ps => {
                seniorPSCounter[ps.name] = { weekday: 0, weekend: 0 };
                seniorPSLastAssignment[ps.name] = null;
            });
            spads.forEach(spad => {
                spadCounter[spad.name] = { weekday: 0, weekend: 0 };
                spadLastAssignment[spad.name] = null;
            });
            
            for (let week = 0; week < 8; week++) {
                const weekStart = new Date(startDate);
                weekStart.setDate(startDate.getDate() + (week * 7));
                
                // Weekday shift (Monday to Thursday)
                const weekdayStart = new Date(weekStart);
                const weekdayEnd = new Date(weekStart);
                weekdayEnd.setDate(weekStart.getDate() + 3); // Thursday
                
                const weekdayShift = assignShift('weekday', weekdayStart, weekdayEnd, 
                    juniorPS, seniorPS, spads, 
                    juniorPSCounter, seniorPSCounter, spadCounter, 
                    juniorPSLastAssignment, seniorPSLastAssignment, spadLastAssignment,
                    unavailableDates, rota);
                
                if (weekdayShift) rota.push(weekdayShift);
                
                // Weekend shift (Friday to Sunday)
                const weekendStart = new Date(weekStart);
                weekendStart.setDate(weekStart.getDate() + 4); // Friday
                const weekendEnd = new Date(weekStart);
                weekendEnd.setDate(weekStart.getDate() + 6); // Sunday
                
                const weekendShift = assignShift('weekend', weekendStart, weekendEnd, 
                    juniorPS, seniorPS, spads, 
                    juniorPSCounter, seniorPSCounter, spadCounter,
                    juniorPSLastAssignment, seniorPSLastAssignment, spadLastAssignment,
                    unavailableDates, rota);
                
                if (weekendShift) rota.push(weekendShift);
            }
            
            saveData('dutyRota', rota);
            loadDutyRota();
            populateOverrideDropdowns();
            
            // Show quality analysis
            setTimeout(() => {
                displayRotaAnalysis();
            }, 100);
            
            alert('New duty rota generated successfully!');
        }
        
        function assignShift(type, startDate, endDate, juniorPS, seniorPS, spads, juniorCounter, seniorCounter, spadCounter, juniorLastAssignment, seniorLastAssignment, spadLastAssignment, unavailableDates, existingRota) {
            // Find available people (not unavailable during this period)
            const availableJuniorPS = juniorPS.filter(ps => !isUnavailable(ps.name, startDate, endDate, unavailableDates));
            const availableSeniorPS = seniorPS.filter(ps => !isUnavailable(ps.name, startDate, endDate, unavailableDates));
            const availableSpads = spads.filter(spad => !isUnavailable(spad.name, startDate, endDate, unavailableDates));
            
            if (availableJuniorPS.length === 0 || availableSeniorPS.length === 0 || availableSpads.length === 0) {
                console.warn(`Cannot assign shift for ${type} ${startDate.toDateString()} - insufficient available staff`);
                return null;
            }
            
            // Helper function to check if assignment would create consecutive shifts
            function wouldCreateConsecutiveShift(personName, currentStartDate, currentEndDate) {
                return existingRota.some(shift => {
                    const shiftStart = new Date(shift.startDate);
                    const shiftEnd = new Date(shift.endDate);
                    
                    // Check if this person is already assigned to a shift
                    const isAssigned = shift.juniorPS === personName || shift.seniorPS === personName || shift.spad === personName;
                    
                    if (!isAssigned) return false;
                    
                    // Check if shifts are consecutive (end of one is start of next, or vice versa)
                    const currentEnd = new Date(currentEndDate);
                    const currentStart = new Date(currentStartDate);
                    
                    // Check if current shift ends and existing shift starts the next day
                    const dayAfterCurrent = new Date(currentEnd);
                    dayAfterCurrent.setDate(dayAfterCurrent.getDate() + 1);
                    
                    // Check if existing shift ends and current shift starts the next day
                    const dayAfterExisting = new Date(shiftEnd);
                    dayAfterExisting.setDate(dayAfterExisting.getDate() + 1);
                    
                    return (dayAfterCurrent.getTime() === shiftStart.getTime()) || 
                           (dayAfterExisting.getTime() === currentStart.getTime());
                });
            }
            
            // Helper function to calculate days since last assignment
            function daysSinceLastAssignment(personName, lastAssignmentTracker, currentStartDate) {
                const lastDate = lastAssignmentTracker[personName];
                if (!lastDate) return Infinity; // Never assigned
                
                const daysDiff = Math.floor((new Date(currentStartDate) - new Date(lastDate)) / (1000 * 60 * 60 * 24));
                return daysDiff;
            }
            
            // Scoring function: prioritize fair distribution, avoid consecutive shifts, maximize spacing
            function calculateScore(person, personType, currentStartDate, currentEndDate) {
                const counter = personType === 'junior' ? juniorCounter : 
                               personType === 'senior' ? seniorCounter : spadCounter;
                const lastAssignment = personType === 'junior' ? juniorLastAssignment : 
                                     personType === 'senior' ? seniorLastAssignment : spadLastAssignment;
                
                let score = 0;
                
                // Primary factor: assignment count (lower is better)
                const totalAssignments = counter[person.name].weekday + counter[person.name].weekend;
                score -= totalAssignments * 100; // Heavily weight fair distribution
                
                // Secondary factor: avoid consecutive shifts (critical)
                if (wouldCreateConsecutiveShift(person.name, currentStartDate, currentEndDate)) {
                    score -= 1000; // Heavy penalty for consecutive shifts
                }
                
                // Tertiary factor: maximize spacing (higher days since last assignment is better)
                const daysSince = daysSinceLastAssignment(person.name, lastAssignment, currentStartDate);
                if (daysSince !== Infinity) {
                    score += daysSince * 10; // Bonus for longer gaps
                }
                
                // Quaternary factor: prefer different shift types if counts are equal
                const currentShiftTypeCount = counter[person.name][type];
                score -= currentShiftTypeCount * 50;
                
                return score;
            }
            
            // Select best candidates based on scoring
            let selectedJuniorPS = availableJuniorPS.reduce((best, ps) => {
                const psScore = calculateScore(ps, 'junior', startDate, endDate);
                const bestScore = calculateScore(best, 'junior', startDate, endDate);
                return psScore > bestScore ? ps : best;
            });
            
            let selectedSeniorPS = availableSeniorPS.reduce((best, ps) => {
                const psScore = calculateScore(ps, 'senior', startDate, endDate);
                const bestScore = calculateScore(best, 'senior', startDate, endDate);
                return psScore > bestScore ? ps : best;
            });
            
            let selectedSpad = availableSpads.reduce((best, spad) => {
                const spadScore = calculateScore(spad, 'spad', startDate, endDate);
                const bestScore = calculateScore(best, 'spad', startDate, endDate);
                return spadScore > bestScore ? spad : best;
            });
            
            // Final check: if selected assignments would create consecutive shifts, try alternatives
            if (wouldCreateConsecutiveShift(selectedJuniorPS.name, startDate, endDate)) {
                const alternatives = availableJuniorPS.filter(ps => 
                    !wouldCreateConsecutiveShift(ps.name, startDate, endDate));
                if (alternatives.length > 0) {
                    selectedJuniorPS = alternatives.reduce((best, ps) => 
                        juniorCounter[ps.name][type] < juniorCounter[best.name][type] ? ps : best);
                }
            }
            
            if (wouldCreateConsecutiveShift(selectedSeniorPS.name, startDate, endDate)) {
                const alternatives = availableSeniorPS.filter(ps => 
                    !wouldCreateConsecutiveShift(ps.name, startDate, endDate));
                if (alternatives.length > 0) {
                    selectedSeniorPS = alternatives.reduce((best, ps) => 
                        seniorCounter[ps.name][type] < seniorCounter[best.name][type] ? ps : best);
                }
            }
            
            if (wouldCreateConsecutiveShift(selectedSpad.name, startDate, endDate)) {
                const alternatives = availableSpads.filter(spad => 
                    !wouldCreateConsecutiveShift(spad.name, startDate, endDate));
                if (alternatives.length > 0) {
                    selectedSpad = alternatives.reduce((best, spad) => 
                        spadCounter[spad.name][type] < spadCounter[best.name][type] ? spad : best);
                }
            }
            
            // Update counters and last assignment dates
            juniorCounter[selectedJuniorPS.name][type]++;
            seniorCounter[selectedSeniorPS.name][type]++;
            spadCounter[selectedSpad.name][type]++;
            
            juniorLastAssignment[selectedJuniorPS.name] = endDate.toISOString().split('T')[0];
            seniorLastAssignment[selectedSeniorPS.name] = endDate.toISOString().split('T')[0];
            spadLastAssignment[selectedSpad.name] = endDate.toISOString().split('T')[0];
            
            return {
                type: type,
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0],
                juniorPS: selectedJuniorPS.name,
                seniorPS: selectedSeniorPS.name,
                spad: selectedSpad.name
            };
        }
        
        function isUnavailable(personName, startDate, endDate, unavailableDates) {
            return unavailableDates.some(unavailable => {
                if (unavailable.person !== personName) return false;
                
                const unavailableStart = new Date(unavailable.startDate);
                const unavailableEnd = new Date(unavailable.endDate);
                
                // Check if shift period overlaps with unavailable period
                return !(endDate < unavailableStart || startDate > unavailableEnd);
            });
        }
        
        function getNextMonday() {
            const today = new Date();
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + (1 + 7 - today.getDay()) % 7);
            return nextMonday;
        }
        
        function addUnavailableDate() {
            const person = document.getElementById('unavailablePerson').value;
            const startDate = document.getElementById('unavailableStartDate').value;
            const endDate = document.getElementById('unavailableEndDate').value;
            const justification = document.getElementById('unavailableJustification').value;
            
            if (!person || !startDate || !endDate) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date.');
                return;
            }
            
            // Check if within 1 month
            const oneMonthFromNow = new Date();
            oneMonthFromNow.setMonth(oneMonthFromNow.getMonth() + 1);
            
            const withinOneMonth = new Date(startDate) < oneMonthFromNow;
            
            if (withinOneMonth && !justification.trim()) {
                document.getElementById('justificationGroup').style.display = 'block';
                alert('Justification is required for unavailable dates within 1 month.');
                return;
            }
            
            const unavailableDates = loadData('unavailableDates') || [];
            unavailableDates.push({
                person: person,
                startDate: startDate,
                endDate: endDate,
                justification: justification || null,
                withinOneMonth: withinOneMonth,
                addedDate: new Date().toISOString()
            });
            
            saveData('unavailableDates', unavailableDates);
            loadUnavailableDates();
            
            // Reset form
            document.getElementById('unavailablePerson').value = '';
            document.getElementById('unavailableStartDate').value = '';
            document.getElementById('unavailableEndDate').value = '';
            document.getElementById('unavailableJustification').value = '';
            document.getElementById('justificationGroup').style.display = 'none';
        }
        
        function loadUnavailableDates() {
            const unavailableDates = loadData('unavailableDates') || [];
            const container = document.getElementById('unavailableDatesList');
            
            if (unavailableDates.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No unavailable dates recorded.</p>';
                return;
            }
            
            container.innerHTML = unavailableDates.map((unavailable, index) => `
                <div class="team-member" style="flex-direction: column; align-items: flex-start; padding: 10px;">
                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                        <div>
                            <strong>${unavailable.person}</strong><br>
                            <span style="font-size: 12px; color: #666;">
                                ${formatDateForDisplay(unavailable.startDate)} - ${formatDateForDisplay(unavailable.endDate)}
                            </span>
                            ${unavailable.withinOneMonth ? '<br><span style="font-size: 11px; color: #dc3545;">⚠️ Within 1 month</span>' : ''}
                        </div>
                        <button class="remove-member-btn" onclick="removeUnavailableDate(${index})">Remove</button>
                    </div>
                    ${unavailable.justification ? `<div style="margin-top: 8px; font-size: 11px; color: #666; font-style: italic;">"${unavailable.justification}"</div>` : ''}
                </div>
            `).join('');
            
            // Populate person dropdown
            populatePersonDropdown();
        }
        
        function populatePersonDropdown() {
            const privateSecretaries = loadData('privateSecretaries') || [];
            const spads = loadData('spads') || [];
            const dropdown = document.getElementById('unavailablePerson');
            
            dropdown.innerHTML = '<option value="">Select person</option>';
            
            privateSecretaries.forEach(ps => {
                dropdown.innerHTML += `<option value="${ps.name}">${ps.name} (${ps.seniority} PS)</option>`;
            });
            
            spads.forEach(spad => {
                dropdown.innerHTML += `<option value="${spad.name}">${spad.name} (SpAd)</option>`;
            });
        }
        
        function removeUnavailableDate(index) {
            const unavailableDates = loadData('unavailableDates') || [];
            unavailableDates.splice(index, 1);
            saveData('unavailableDates', unavailableDates);
            loadUnavailableDates();
        }
        
        function populateOverrideDropdowns() {
            const rota = loadData('dutyRota') || [];
            const privateSecretaries = loadData('privateSecretaries') || [];
            const spads = loadData('spads') || [];
            
            // Populate shift selector
            const shiftSelect = document.getElementById('overrideShift');
            shiftSelect.innerHTML = '<option value="">Select shift to override</option>';
            
            rota.forEach((shift, index) => {
                const shiftLabel = `${shift.type === 'weekday' ? 'Mon-Thu' : 'Fri-Sun'} (${formatDateForDisplay(shift.startDate)} - ${formatDateForDisplay(shift.endDate)})`;
                shiftSelect.innerHTML += `<option value="${index}">${shiftLabel}</option>`;
            });
            
            // Populate person dropdowns
            const juniorPS = privateSecretaries.filter(ps => ps.seniority === 'junior');
            const seniorPS = privateSecretaries.filter(ps => ps.seniority === 'senior');
            
            const juniorSelect = document.getElementById('overrideJuniorPS');
            juniorSelect.innerHTML = '<option value="">Select Junior PS</option>';
            juniorPS.forEach(ps => {
                juniorSelect.innerHTML += `<option value="${ps.name}">${ps.name}</option>`;
            });
            
            const seniorSelect = document.getElementById('overrideSeniorPS');
            seniorSelect.innerHTML = '<option value="">Select Senior PS</option>';
            seniorPS.forEach(ps => {
                seniorSelect.innerHTML += `<option value="${ps.name}">${ps.name}</option>`;
            });
            
            const spadSelect = document.getElementById('overrideSpAd');
            spadSelect.innerHTML = '<option value="">Select SpAd</option>';
            spads.forEach(spad => {
                spadSelect.innerHTML += `<option value="${spad.name}">${spad.name}</option>`;
            });
        }
        
        function applyManualOverride() {
            const shiftIndex = document.getElementById('overrideShift').value;
            const juniorPS = document.getElementById('overrideJuniorPS').value;
            const seniorPS = document.getElementById('overrideSeniorPS').value;
            const spad = document.getElementById('overrideSpAd').value;
            
            if (!shiftIndex || !juniorPS || !seniorPS || !spad) {
                alert('Please select all fields for the override.');
                return;
            }
            
            const rota = loadData('dutyRota') || [];
            
            if (rota[shiftIndex]) {
                rota[shiftIndex].juniorPS = juniorPS;
                rota[shiftIndex].seniorPS = seniorPS;
                rota[shiftIndex].spad = spad;
                rota[shiftIndex].manualOverride = true;
                rota[shiftIndex].overrideDate = new Date().toISOString();
                
                saveData('dutyRota', rota);
                loadDutyRota();
                
                // Reset form
                document.getElementById('overrideShift').value = '';
                document.getElementById('overrideJuniorPS').value = '';
                document.getElementById('overrideSeniorPS').value = '';
                document.getElementById('overrideSpAd').value = '';
                
                alert('Manual override applied successfully!');
            }
        }
        
        function editShift(index) {
            const rota = loadData('dutyRota') || [];
            const shift = rota[index];
            
            if (!shift) return;
            
            // Pre-populate the override form
            document.getElementById('overrideShift').value = index;
            document.getElementById('overrideJuniorPS').value = shift.juniorPS;
            document.getElementById('overrideSeniorPS').value = shift.seniorPS;
            document.getElementById('overrideSpAd').value = shift.spad;
            
            // Scroll to override section
            document.querySelector('.team-management h4').scrollIntoView({ behavior: 'smooth' });
        }
        
        function exportRota() {
            const rota = loadData('dutyRota') || [];
            
            if (rota.length === 0) {
                alert('No rota to export. Please generate a rota first.');
                return;
            }
            
            let csvContent = "Shift Type,Start Date,End Date,Junior PS (Duty),Senior PS (Backup),SpAd (Duty),Manual Override\n";
            
            rota.forEach(shift => {
                const shiftType = shift.type === 'weekday' ? 'Monday-Thursday' : 'Friday-Sunday';
                const override = shift.manualOverride ? 'Yes' : 'No';
                csvContent += `"${shiftType}","${shift.startDate}","${shift.endDate}","${shift.juniorPS}","${shift.seniorPS}","${shift.spad}","${override}"\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `duty-rota-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Update date change handlers for unavailable dates
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('unavailableStartDate');
            const endDateInput = document.getElementById('unavailableEndDate');
            
            if (startDateInput && endDateInput) {
                startDateInput.addEventListener('change', checkDateProximity);
                endDateInput.addEventListener('change', checkDateProximity);
            }
        });
        
        function checkDateProximity() {
            const startDate = document.getElementById('unavailableStartDate').value;
            const justificationGroup = document.getElementById('justificationGroup');
            
            if (startDate) {
                const oneMonthFromNow = new Date();
                oneMonthFromNow.setMonth(oneMonthFromNow.getMonth() + 1);
                
                if (new Date(startDate) < oneMonthFromNow) {
                    justificationGroup.style.display = 'block';
                } else {
                    justificationGroup.style.display = 'none';
                    document.getElementById('unavailableJustification').value = '';
                }
            }
        }

    </script>
</body>
</html>
